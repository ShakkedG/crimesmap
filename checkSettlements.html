<script>
  const SETTLEMENT_LAYER = "125";
  const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c"; // שים פה את הטוקן שלך

  let mapInitialized = false;

  function initGovMap() {
    govmap.createMap("map", {
      token: TOKEN,
      layers: [SETTLEMENT_LAYER],
      background: 2,
      layersMode: 1,
      zoomButtons: false,
      showXY: false,
      identifyOnClick: false
    });
    mapInitialized = true;
    console.log("GovMap initialized");
  }

  async function loadLayer125() {
    if (!mapInitialized) {
      throw new Error("המפה עדיין לא נטענה, נסה שוב.");
    }

    const params = { layerName: SETTLEMENT_LAYER };
    const entities = await govmap.getLayerEntities(params);
    console.log("getLayerEntities response:", entities);
    return entities;
  }

  function detectNameField(entities) {
    const counts = {};
    const captions = {};

    for (const ent of entities) {
      const fields = ent.Fields || [];
      for (const f of fields) {
        const val = f.Value;
        // מחפש ערכים עם אותיות בעברית
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          const key = f.FieldName;
          counts[key] = (counts[key] || 0) + 1;
          captions[key] = f.Caption;
        }
      }
    }

    let best = null;
    let bestCount = 0;
    for (const key in counts) {
      if (counts[key] > bestCount) {
        best = key;
        bestCount = counts[key];
      }
    }

    if (!best) {
      console.warn("לא נמצא שדה שם בעברית");
      return null;
    }

    const result = {
      fieldName: best,
      caption: captions[best] || "",
      count: bestCount
    };

    console.log("Detected name field:", result);
    return result;
  }

  // דוגמה לשימוש – תריץ אחרי שהמפה נטענה
  async function debugNameField() {
    try {
      const entities = await loadLayer125();
      const info = detectNameField(entities);
      if (info) {
        alert(`שדה השם כנראה: ${info.fieldName} (${info.caption})`);
      } else {
        alert("לא הצלחתי לזהות שדה שם");
      }
    } catch (err) {
      console.error(err);
      alert(err.message || err);
    }
  }
</script>

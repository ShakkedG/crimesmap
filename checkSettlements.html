<script>
  const SETTLEMENT_LAYER = "125";
  const TOKEN = "PUT_YOUR_TOKEN_HERE"; // שים פה את הטוקן שלך

  let mapInitialized = false;

  function initGovMap() {
    govmap.createMap("map", {
      token: TOKEN,
      layers: [SETTLEMENT_LAYER],
      background: 2,
      layersMode: 1,
      zoomButtons: false,
      showXY: false,
      identifyOnClick: false
    });
    mapInitialized = true;
    console.log("GovMap initialized");
  }

  async function loadLayer125() {
    if (!mapInitialized) {
      throw new Error("המפה עדיין לא נטענה, נסה שוב.");
    }

    const params = { layerName: SETTLEMENT_LAYER };
    const entities = await govmap.getLayerEntities(params);
    console.log("getLayerEntities response:", entities);
    return entities;
  }

  function detectNameField(entities) {
    const counts = {};
    const captions = {};

    for (const ent of entities) {
      const fields = ent.Fields || [];
      for (const f of fields) {
        const val = f.Value;
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          const key = f.FieldName;
          counts[key] = (counts[key] || 0) + 1;
          captions[key] = f.Caption;
        }
      }
    }

    let best = null;
    let bestCount = 0;
    for (const key in counts) {
      if (counts[key] > bestCount) {
        best = key;
        bestCount = counts[key];
      }
    }

<script>
// --- 1. טוען את ה-JSON מהקובץ ---
async function loadCrimeDB() {
  const res = await fetch("crimeDB.js"); // או crimeDB.json
  const text = await res.text();

  // אם זה קובץ JS שמכיל: const crimeDB = {...}
  if (text.includes("crimeDB")) {
    // מפעיל אותו כסקריפט
    const script = document.createElement("script");
    script.textContent = text;
    document.body.appendChild(script);

    return window.crimeDB;
  }

  // אם זה JSON רגיל
  return JSON.parse(text);
}


// --- 2. מזהה את שדה השם בשכבה ---
function detectNameField(entities) {
  const counts = {};
  const captions = {};

  for (const ent of entities) {
    const fields = ent.Fields || [];
    for (const f of fields) {
      const val = f.Value;
      if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
        const key = f.FieldName;
        counts[key] = (counts[key] || 0) + 1;
        captions[key] = f.Caption;
      }
    }
  }

  let best = null;
  let bestCount = 0;

  for (const k in counts) {
    if (counts[k] > bestCount) {
      best = k;
      bestCount = counts[k];
    }
  }

  if (!best) return null;

  return {
    fieldName: best,
    caption: captions[best],
    count: bestCount
  };
}


// --- 3. פונקציה שמחזירה Map של שמות יישובים מהשכבה ---
function extractSettlementNames(entities, fieldName) {
  const names = new Set();

  for (const ent of entities) {
    const f = ent.Fields?.find(x => x.FieldName === fieldName);
    if (!f) continue;

    let name = (f.Value || "").trim();
    if (name.length > 0) names.add(name);
  }
  return names;
}


// --- 4. פונקציית ההשוואה המרכזית ---
async function compareLayerToJson() {
  // טוען את הנתונים מהשכבה
  const entities = await loadLayer125();

  // טוען JSON
  const db = await loadCrimeDB();

  // מוצא את שדה השם
  const nameField = detectNameField(entities);
  if (!nameField) {
    alert("לא הצלחתי לזהות שדה שם בשכבה");
    return;
  }

  const layerNames = extractSettlementNames(entities, nameField.fieldName);

  // מוצא את רשימת היישובים מה-JSO

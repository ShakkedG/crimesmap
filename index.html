<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
    <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script> 

    <script type="text/javascript"> 
    function initGovMap() { 
        govmap.createMap('map', { 
            token: 'ede9a5fd-7c23-432f-8ffb-d85feffa3f3c', 
            layers: ["GASSTATIONS","PARCEL_HOKS", "KSHTANN_ASSETS", "bus_stops", "PARCEL_ALL","219111","219113","219114"], 
            showXY: true, 
            identifyOnClick: true, 
            isEmbeddedToggle: false, 
            background: 2, 
            layersMode: 1, 
            zoomButtons: false, 
            level: 9,
            extent:{xmin: 193700, ymin: 664900, xmax: 195000, ymax: 666100},
        }); 
    } 

    function toggleButton() {
        const btn = document.getElementById('showButton');
        const resultsDiv = document.getElementById('results');

        if (!btn.classList.contains('redButton')) {
            btn.classList.add('redButton');

            var params = { 
                continous: false,
                drawType: govmap.drawType.Rectangle,
                filterLayer: false,
                isZoomToExtent: true,
                layers: ["GASSTATIONS", "219111", "219113", "219114"],
                returnFields: {
                    "GASSTATIONS": ["objectid", "company"],
                    "219111": ["value0"],
                    "219113": ["value0"],
                    "219114": ["value0"]
                }
            };

            govmap.selectFeaturesOnMap(params).then(function(response1) { 
                btn.classList.remove('redButton');
                resultsDiv.style.display = 'block';

                console.log('selectFeaturesOnMap response:', response1); 
                
                // ×‘×¡×™×¡ ×œÖ¾HTML
                var html = '<div id="closeResultsBtn" onclick="closeResults()">âœ–</div>';

                if (response1 && response1.length > 0) { 
                    // ×—×œ×•×§×” ×œ×§×‘×•×¦×•×ª ×œ×¤×™ ×©×›×‘×”
                    const gasStations = [];
                    const p219111 = [];
                    const p219113 = [];
                    const p219114 = [];

                    response1.forEach(function(item) {
                        const layer =
                            item.layerName ||
                            item.layername ||
                            item.layer ||
                            ''; // fallback

                        if (layer === 'GASSTATIONS' || item.company) {
                            gasStations.push(item);
                        } else if (layer === '219111') {
                            p219111.push(item);
                        } else if (layer === '219113') {
                            p219113.push(item);
                        } else if (layer === '219114') {
                            p219114.push(item);
                        }
                    });

                    const total = response1.length;

                    html += '<h3>×ª×•×¦××•×ª ×—×™×¤×•×©</h3>'; 
                    html += '<p class="results-subtitle">×‘×—×¨×ª ××–×•×¨ ×‘××¤×”, ×”× ×” ××” ×©××¦×× ×•:</p>'; 

                    // ×›×¨×˜×™×¡×™ ×¡×™×›×•×
                    html += '<div class="results-summary">';
                    html += '  <div class="summary-chip summary-total">';
                    html += '    <div class="summary-label">×¡×”×´×› × ×§×•×“×•×ª</div>';
                    html += '    <div class="summary-value">' + total + '</div>';
                    html += '  </div>';

                    if (gasStations.length) {
                        html += '  <div class="summary-chip summary-gas">';
                        html += '    <div class="summary-label">×ª×—× ×•×ª ×“×œ×§</div>';
                        html += '    <div class="summary-value">' + gasStations.length + '</div>';
                        html += '  </div>';
                    }
                    if (p219111.length) {
                        html += '  <div class="summary-chip summary-parcel">';
                        html += '    <div class="summary-label">×©×›×‘×” 219111</div>';
                        html += '    <div class="summary-value">' + p219111.length + '</div>';
                        html += '  </div>';
                    }
                    if (p219113.length) {
                        html += '  <div class="summary-chip summary-parcel">';
                        html += '    <div class="summary-label">×©×›×‘×” 219113</div>';
                        html += '    <div class="summary-value">' + p219113.length + '</div>';
                        html += '  </div>';
                    }
                    if (p219114.length) {
                        html += '  <div class="summary-chip summary-parcel">';
                        html += '    <div class="summary-label">×©×›×‘×” 219114</div>';
                        html += '    <div class="summary-value">' + p219114.length + '</div>';
                        html += '  </div>';
                    }

                    html += '</div>'; // results-summary

                    // ×˜×‘×œ×” â€“ ×ª×—× ×•×ª ×“×œ×§
                    if (gasStations.length) {
                        html += '<h4 class="results-section-title">â›½ ×ª×—× ×•×ª ×“×œ×§ ×©× ××¦××•</h4>';
                        html += '<table class="results-table">';
                        html += '  <thead>';
                        html += '    <tr><th>#</th><th>×—×‘×¨×”</th><th>××–×”×” (objectid)</th></tr>';
                        html += '  </thead>';
                        html += '  <tbody>';

                        gasStations.forEach(function(station, index) {
                            html += '    <tr>';
                            html += '      <td>' + (index + 1) + '</td>';
                            html += '      <td>' + (station.company || '-') + '</td>';
                            html += '      <td>' + (station.objectid || '-') + '</td>';
                            html += '    </tr>';
                        });

                        html += '  </tbody>';
                        html += '</table>';
                    }

                    // ×¤×•× ×§×¦×™×” ×§×˜× ×” ×œ×™×¦×™×¨×ª ×˜×‘×œ×” ×œ×©×›×‘×•×ª 219xxx
                    function buildParcelTable(title, items) {
                        if (!items.length) return '';

                        var out = '';
                        out += '<h4 class="results-section-title">' + title + '</h4>';
                        out += '<table class="results-table results-table-parcels">';
                        out += '  <thead>';
                        out += '    <tr><th>#</th><th>value0</th></tr>';
                        out += '  </thead>';
                        out += '  <tbody>';

                        items.forEach(function(p, i) {
                            out += '    <tr>';
                            out += '      <td>' + (i + 1) + '</td>';
                            out += '      <td>' + (p.value0 || '-') + '</td>';
                            out += '    </tr>';
                        });

                        out += '  </tbody>';
                        out += '</table>';
                        return out;
                    }

                    html += buildParcelTable('ğŸ“Œ ×©×›×‘×” 219111', p219111);
                    html += buildParcelTable('ğŸ“Œ ×©×›×‘×” 219113', p219113);
                    html += buildParcelTable('ğŸ“Œ ×©×›×‘×” 219114', p219114);

                    // JSON ×’×•×œ××™ ×‘××¦×‘ ××ª×§×¤×œ
                    html += '<details class="raw-details">';
                    html += '  <summary>×”×¦×’ × ×ª×•× ×™× ×’×•×œ××™×™× (JSON)</summary>';
                    html += '  <pre>' + JSON.stringify(response1, null, 2) + '</pre>';
                    html += '</details>';
                    
                    resultsDiv.innerHTML = html; 
                    
                } else { 
                    html += '<h3>×ª×•×¦××•×ª ×—×™×¤×•×©</h3>'; 
                    html += '<p class="no-results">âŒ ×œ× × ××¦××• × ×§×•×“×•×ª ×¢× ×™×™×Ÿ ×‘××–×•×¨ ×©× ×‘×—×¨.</p>'; 
                    resultsDiv.innerHTML = html;
                } 
                
            }).catch(function(error) { 
                console.error('Error in selectFeaturesOnMap:', error); 
                btn.classList.remove('redButton');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '' +
                    '<div id="closeResultsBtn" onclick="closeResults()">âœ–</div>' +
                    '<h3>×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×—×™×¤×•×©</h3>' +
                    '<p style="color: #f44336;">âŒ ×©×’×™××”: ' + (error.message || error) + '</p>'; 
            }); 

        } else {
            btn.classList.remove('redButton');
        }
    }

    function closeResults() {
        document.getElementById('results').style.display = 'none';
    }
    </script> 

    <style> 
    body { 
        margin: 0; 
        padding: 0; 
        font-family: Arial, sans-serif; 
    } 

    #header { 
        position: absolute; 
        top: 0; 
        left: 0; 
        right: 0; 
        height: 80px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0 30px; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        z-index: 1001; 
    } 

    #header h1 { 
        margin: 0; 
        font-size: 32px; 
        font-weight: bold; 
    } 

    #map-container { 
        position: relative; 
        width: 100vw; 
        height: 100vh; 
        padding-top: 80px; 
        box-sizing: border-box; 
    } 

    #map { 
        width: 100%; 
        height: 100%; 
    } 

    #button-container { 
        position: absolute; 
        top: 100px; 
        left: 20px; 
        z-index: 1000; 
    } 

    #showButton { 
        padding: 15px 30px; 
        font-size: 18px; 
        background-color: #4CAF50; 
        color: white; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); 
        transition: all 0.3s ease;
    } 

    #showButton:hover { 
        background-color: #45a049; 
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0,0,0,0.4);
    } 

    .redButton {
        background-color: #f44336 !important;
    }

    .redButton:hover {
        background-color: #da190b !important;
    }

    #results { 
        position: absolute; 
        bottom: 20px; 
        left: 20px; 
        right: 20px; 
        max-height: 50vh; 
        overflow: auto; 
        background: white; 
        padding: 24px 24px 18px; 
        border-radius: 12px; 
        box-shadow: 0 4px 16px rgba(0,0,0,0.25); 
        z-index: 1000; 
        display: none; 
        box-sizing: border-box;
    } 

    #closeResultsBtn {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 22px;
        cursor: pointer;
        color: #444;
        font-weight: bold;
    }

    #closeResultsBtn:hover {
        color: #ff4444;
    }

    #results h3 {
        margin: 0 0 6px 0;
        color: #222;
        border-bottom: 2px solid #667eea;
        padding-bottom: 8px;
        font-size: 20px;
    }

    .results-subtitle {
        margin: 4px 0 16px 0;
        color: #555;
        font-size: 14px;
    }

    .results-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 18px;
    }

    .summary-chip {
        min-width: 120px;
        padding: 10px 14px;
        border-radius: 999px;
        background: #f5f5f5;
        display: flex;
        flex-direction: column;
        justify-content: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .summary-label {
        font-size: 12px;
        color: #777;
        margin-bottom: 2px;
    }

    .summary-value {
        font-size: 18px;
        font-weight: bold;
        color: #222;
    }

    .summary-total {
        background: #eef2ff;
    }

    .summary-gas {
        background: #e6fffa;
    }

    .summary-parcel {
        background: #fff7ed;
    }

    .results-section-title {
        margin: 10px 0 6px 0;
        color: #333;
        font-size: 16px;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 12px;
        font-size: 14px;
    }

    .results-table th,
    .results-table td {
        padding: 8px 10px;
        border: 1px solid #e0e0e0;
        text-align: right;
    }

    .results-table thead {
        background: #f3f4ff;
        font-weight: bold;
    }

    .results-table tbody tr:nth-child(even) {
        background: #fafafa;
    }

    .results-table-parcels thead {
        background: #fff3e0;
    }

    .raw-details {
        margin-top: 14px;
        font-size: 13px;
    }

    .raw-details summary {
        cursor: pointer;
        color: #667eea;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .raw-details pre { 
        background: #f5f5f5; 
        padding: 10px; 
        border-radius: 5px; 
        overflow-x: auto; 
        margin-top: 8px;
    } 

    .no-results {
        color: #f44336;
        margin-top: 12px;
        font-size: 15px;
    }
    </style> 
</head> 

<body> 
    <div id="header"> 
        <h1>×©×§×“ ×’×•×œ×Ÿ GovMap</h1> 
        <div style="font-size: 18px;">××ª×¨ ×§×™×‘×•×¥ ×¢×™× ×ª</div> 
    </div> 

    <div id="map-container"> 
        <div id="button-container"> 
            <button id="showButton" onClick="toggleButton()">ğŸ—ºï¸ ×‘×—×¨ ××–×•×¨ ×‘××¤×”</button> 
        </div> 
        
        <div id="map"></div> 
        <div id="results"></div> 
    </div> 
</body> 
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×©× ×” (2020â€“2025) | ×™×©×•×‘×™× / ××¨×—×‘×™×</title>

  <!-- × ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ×™×©×•×‘×™× -->
  <script src="crimeByYear_2020_2025.js"></script>
  <!-- × ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ××¨×—×‘×™ ××©×˜×¨×” -->
  <script src="crimeByYearMerhav.js"></script>
  <!-- ××•×›×œ×•×¡×™×™×” ×œ×¤×™ ×¨×©×•×ª/××•×¢×¦×” -->
  <script src="PopulationDB.js"></script>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
    }

    #map { width: 100%; height: 100%; position: relative; }

    #info-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: white;
      padding: 0;
      border-radius: 8px;
      width: 450px;
      max-height: calc(100vh - 30px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #panel-header {
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color: white;
      padding: 16px 20px;
      border-bottom: 1px solid #0052a3;
    }

    #panel-header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.9; }

    #tabs {
      display: flex;
      background: #fafafa;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 12px 10px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      position: relative;
    }
    .tab:hover { background: #f0f0f0; color: #333; }
    .tab.active { background: white; border-bottom-color: #0066cc; color: #0066cc; }

    #controls {
      padding: 16px 20px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    #controls-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }

    #controls label {
      font-weight: 600;
      font-size: 13px;
      color: #333;
      white-space: nowrap;
      min-width: 70px;
    }

    #yearSelect {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    #yearSelect:hover { border-color: #0066cc; }
    #yearSelect:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }

    .mode-switch { display: flex; gap: 8px; margin-bottom: 12px; }

    .mode-btn {
      flex: 1;
      padding: 10px 12px;
      border-radius: 6px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      color: #555;
      transition: all 0.2s ease;
    }

    .mode-btn:hover {
      border-color: #0066cc;
      color: #0066cc;
      transform: translateY(-1px);
    }
    .mode-btn.active {
      background: #0066cc;
      border-color: #0066cc;
      color: white;
      box-shadow: 0 2px 6px rgba(0,102,204,0.3);
    }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e0e0e0;
      transition: all 0.2s;
    }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    .stat-value { font-size: 20px; font-weight: 700; color: #0066cc; margin-bottom: 4px; }
    .stat-label { font-size: 10px; color: #777; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

    #info-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 16px;
      color: #222;
      padding-bottom: 10px;
      border-bottom: 3px solid #0066cc;
    }

    #info-body { line-height: 1.6; color: #555; }

    .total-summary {
      font-size: 28px;
      font-weight: 700;
      color: #0066cc;
      margin: 16px 0 12px 0;
      text-align: center;
      padding: 18px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
      border-radius: 8px;
      border: 2px solid #b3d9ff;
      box-shadow: 0 2px 6px rgba(0,102,204,0.1);
    }

    .sub-summary {
      margin-top: 0;
      margin-bottom: 16px;
      text-align: center;
      font-size: 13px;
      color: #444;
    }

    .crime-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .crime-item {
      background: #fafafa;
      padding: 14px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      border-right: 4px solid #0066cc;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .crime-item:hover {
      background: #f0f7ff;
      border-right-color: #0052a3;
      transform: translateX(-3px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    .crime-name {
      font-weight: 600;
      color: #333;
      font-size: 12px;
      line-height: 1.4;
      min-height: 34px;
      display: flex;
      align-items: center;
    }

    .crime-count { font-weight: 700; color: #0066cc; font-size: 16px; }

    .message {
      padding: 14px 16px;
      border-radius: 6px;
      margin-bottom: 12px;
      font-size: 13px;
      border-right: 4px solid;
      line-height: 1.5;
    }
    .message-info  { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }
    .message-error { background: #fff0f0; color: #c00; border-right-color: #ff0000; }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 16px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .compare-city-tag {
      background: #e7f3ff;
      color: #0066cc;
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #b3d9ff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    .compare-city-tag button {
      border: none;
      background: none;
      color: #0066cc;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover { background: #0066cc; color: white; }

    .compare-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 10px 0;
      padding: 10px;
      background: #fafafa;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .compare-bar-name {
      width: 130px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .compare-bar-container {
      flex: 1;
      height: 28px;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .compare-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066cc 0%, #0080ff 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 700;
      transition: width 0.5s ease;
      white-space: nowrap;
    }

    .trend-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 10px 0;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      transition: all 0.2s;
    }
    .trend-year { width: 50px; font-weight: 700; font-size: 14px; color: #333; }
    .trend-bar-container {
      flex: 1;
      height: 24px;
      background: #f0f0f0;
      border-radius: 6px;
      overflow: hidden;
    }
    .trend-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066cc, #0099ff);
      transition: width 0.5s ease;
    }
    .trend-value { min-width: 120px; text-align: left; font-weight: 700; color: #0066cc; font-size: 14px; }

    .add-compare-btn {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 16px;
    }
    .add-compare-btn:hover { background: #0052a3; }

    @media (max-width: 768px) {
      #info-panel { width: calc(100% - 30px); left: 15px; right: 15px; max-height: calc(100vh - 100px); }
      #quick-stats { grid-template-columns: repeat(2, 1fr); }
      .crime-grid { grid-template-columns: 1fr; }
      #panel-header h1 { font-size: 16px; }
    }
  </style>

  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let mapInitialized = false;
    let currentYear = "2025";
    let yearlyStats = {};
    let currentTab = "single";
    let currentMode = "muni";     // muni | merhav
    let currentMetric = "abs";    // abs | rate (×œ-10,000) â€” ×¨×§ ×œ×™×©×•×‘×™×

    let selectedCity = null;
    let selectedCityKey = null;
    let compareList = [];

    const muniIndex = {};
    const merhavIndex = {};

    // -----------------------------
    // Normalization + variants
    // -----------------------------
    function normalizeKeyBase(name) {
      if (name == null) return "";
      let s = String(name).trim();

      s = s
        .replace(/[×³×´"']/g, "")
        .replace(/[(){}\[\],.:]/g, "")
        .replace(/Ö¾/g, "-")
        .replace(/\s+/g, " ")
        .trim();

      s = s.replace(/[\s\-]/g, "");
      return s.toLowerCase();
    }

    function nameVariants(name) {
      const raw = String(name || "").trim();

      const withoutCityHall = raw
        .replace(/^×¢×™×¨×™×™×ª\s+/g, "")
        .replace(/^×¢×™×¨×™×”\s+/g, "");

      const withoutLocalCouncil = withoutCityHall
        .replace(/^××•×¢×¦×”\s+××§×•××™×ª\s+/g, "");

      const withoutRegionalCouncil = withoutLocalCouncil
        .replace(/^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g, "");

      return [raw, withoutCityHall, withoutLocalCouncil, withoutRegionalCouncil]
        .map(normalizeKeyBase)
        .filter(Boolean);
    }

    // âœ… Needed because code uses normalizeKey(...)
    function normalizeKey(name) {
      return normalizeKeyBase(name);
    }

    // -----------------------------
    // Population index (variants)
    // -----------------------------
    const populationIndex = {};

    function buildPopulationIndex() {
      for (const k in populationIndex) delete populationIndex[k];

      const raw = window.PopulationDB;
      if (!raw || typeof raw !== "object") {
        console.warn("âš ï¸ PopulationDB.js not loaded or invalid");
        return;
      }

      for (const displayName in raw) {
        const pop = Number(raw[displayName]);
        if (!Number.isFinite(pop)) continue;

        for (const v of nameVariants(displayName)) {
          populationIndex[v] = pop;
        }
      }

      console.log("âœ… Population index ready:", Object.keys(populationIndex).length);
    }

    function getPopulationForAuthority(nameFromCrime) {
      for (const v of nameVariants(nameFromCrime)) {
        const pop = populationIndex[v];
        if (pop != null) return pop;
      }
      return null;
    }

    function calcRatePer10k(total, pop) {
      if (!pop || pop <= 0 || !Number.isFinite(total)) return null;
      return Math.round((total / pop) * 10000 * 10) / 10; // 1 decimal
    }

    // -----------------------------
    // Stats
    // -----------------------------
    function calculateStats(year) {
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return { municipalities: 0, total: 0, avg: 0 };

      let total = 0, count = 0;
      for (const name in yearData) {
        const data = yearData[name];
        if (data && typeof data.total === "number") {
          total += data.total;
          count++;
        }
      }
      return { municipalities: count, total, avg: count > 0 ? Math.round(total / count) : 0 };
    }

    function updateQuickStats() {
      const stats = yearlyStats[currentYear] || { municipalities: 0, total: 0, avg: 0 };
      document.getElementById("stat-municipalities").textContent = stats.municipalities.toLocaleString();
      document.getElementById("stat-total").textContent = stats.total.toLocaleString();
      document.getElementById("stat-avg").textContent = stats.avg.toLocaleString();
    }

    // -----------------------------
    // Build indexes for current year
    // âœ… muniIndex gets ALL variants so govmap names still match
    // -----------------------------
    function buildMuniIndexForYear(year) {
      for (const k in muniIndex) delete muniIndex[k];
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return;

      for (const name in yearData) {
        const entry = { name, data: yearData[name] };
        for (const v of nameVariants(name)) {
          muniIndex[v] = entry;
        }
      }

      yearlyStats[year] = calculateStats(year);
      console.log(`âœ… Year ${year}: ${Object.keys(muniIndex).length} muni-keys indexed (variants)`);
    }

    function buildMerhavIndexForYear(year) {
      for (const k in merhavIndex) delete merhavIndex[k];
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) { console.warn(`âš ï¸ No merhav data for year ${year}`); return; }

      for (const name in yearData) {
        merhavIndex[normalizeKey(name)] = { name, data: yearData[name] };
      }
      console.log(`âœ… Year ${year}: ${Object.keys(merhavIndex).length} police districts indexed`);
    }

    // -----------------------------
    // UI helpers
    // -----------------------------
    function showInfo(title, body, type = "info") {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function showEntry(entry) {
      const d = entry.data;
      let html = "";

      const total = (typeof d.total === "number") ? d.total : null;
      const pop = (currentMode === "muni") ? getPopulationForAuthority(entry.name) : null;

      if (total != null) {
        if (currentMetric === "rate" && currentMode === "muni") {
          const rate = calcRatePer10k(total, pop);
          if (rate == null) {
            html += `<div class="total-summary">â€”</div>`;
            html += `<div class="message message-error">××™×Ÿ ××•×›×œ×•×¡×™×™×” ×¢×‘×•×¨ <strong>${entry.name}</strong> ×•×œ×›×Ÿ ×œ× × ×™×ª×Ÿ ×œ×—×©×‘ ×œ-10,000 ×ª×•×©×‘×™×.</div>`;
          } else {
            html += `<div class="total-summary">${rate.toLocaleString()} ×œ-10,000</div>`;
            html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×”: ${Number(pop).toLocaleString()} â€¢ ×¡×”"×› ××™×¨×•×¢×™×: ${Number(total).toLocaleString()}</div>`;
          }
        } else {
          html += `<div class="total-summary">${Number(total).toLocaleString()} ××™×¨×•×¢×™×</div>`;
          if (currentMode === "muni" && pop) {
            html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×”: ${Number(pop).toLocaleString()}</div>`;
          }
        }
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
        html += `<div class="crime-grid">`;
        for (const [name, count] of sorted) {
          html += `<div class="crime-item">
            <div class="crime-name">${name}</div>
            <div class="crime-count">${Number(count || 0).toLocaleString()}</div>
          </div>`;
        }
        html += `</div>`;
      }

      document.getElementById("info-title").textContent = entry.name;
      document.getElementById("info-body").innerHTML = html || `<div class="message message-info">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>`;
    }

    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll(".tab").forEach(tab =>
        tab.classList.toggle("active", tab.dataset.tab === tabName)
      );

      document.querySelectorAll(".tab-content").forEach(content =>
        content.classList.toggle("active", content.id === `tab-${tabName}`)
      );

      if (tabName === "single") {
        showInfo(
          "××¤×” ×œ×¤×™ " + (currentMode === "muni" ? "×™×©×•×‘×™×/×¨×©×•×™×•×ª" : "××¨×—×‘×™×"),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );
      } else if (tabName === "compare") {
        updateCompareView();
      } else if (tabName === "trends") {
        if (currentMode !== "muni") {
          document.getElementById("trends-content").innerHTML =
            `<div class="message message-error">×˜×¨× ×“×™× ×–××™× ×™× ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª.</div>`;
        } else if (selectedCity) {
          showTrends(selectedCity);
        } else {
          document.getElementById("trends-content").innerHTML =
            `<div class="message message-info">×‘×—×¨ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª ×˜×¨× ×“×™× ×œ××•×¨×š ×–××Ÿ</div>`;
        }
      }
    }

    function setMode(mode) {
      currentMode = mode;

      const btnM = document.getElementById("btnModeMuni");
      const btnP = document.getElementById("btnModeMerhav");
      btnM.classList.toggle("active", mode === "muni");
      btnP.classList.toggle("active", mode === "merhav");

      if (currentMetric === "rate" && mode !== "muni") {
        setMetric("abs", true);
      }

      const layerToShow = (mode === "muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
      const layerToHide = (mode === "muni") ? POLICE_MERHAV_LAYER : MUNICIPAL_LAYER;

      if (mapInitialized) {
        try { govmap.setVisibleLayers([layerToShow], [layerToHide]); }
        catch (err) { console.error("âŒ setVisibleLayers failed:", err); }
      }

      selectedCity = null;
      selectedCityKey = null;
      compareList = compareList.filter(c => c.mode === mode);

      if (mode !== "muni" && currentTab === "trends") {
        switchTab("single");
        return;
      }

      if (currentTab === "single") {
        showInfo(
          "××¤×” ×œ×¤×™ " + (mode === "muni" ? "×™×©×•×‘×™×/×¨×©×•×™×•×ª" : "××¨×—×‘×™×"),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${mode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );
      } else if (currentTab === "compare") {
        updateCompareView();
      }
    }

    function setMetric(metric, silent = false) {
      currentMetric = metric;

      const btnAbs = document.getElementById("btnMetricAbs");
      const btnRate = document.getElementById("btnMetricRate");
      btnAbs.classList.toggle("active", metric === "abs");
      btnRate.classList.toggle("active", metric === "rate");

      if (metric === "rate" && currentMode !== "muni") {
        currentMetric = "abs";
        btnAbs.classList.add("active");
        btnRate.classList.remove("active");
        if (!silent) showInfo("×œ× ×–××™×Ÿ", "×œ-10,000 ×ª×•×©×‘×™× ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª.", "error");
        return;
      }

      if (currentTab === "single" && selectedCityKey) {
        const entry = muniIndex[selectedCityKey];
        if (entry) showEntry(entry);
      }
      if (currentTab === "compare") updateCompareView();
      if (currentTab === "trends" && currentMode === "muni" && selectedCity) showTrends(selectedCity);
    }

    function addToCompare() {
      if (!selectedCity) {
        alert(`×× × ×‘×—×¨ ${currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×ª×—×™×œ×”`);
        return;
      }

      if (!compareList.some(c => c.key === selectedCityKey && c.mode === currentMode)) {
        compareList.push({ name: selectedCity, key: selectedCityKey, mode: currentMode });
        updateCompareView();
      }
    }

    function removeFromCompare(key) {
      compareList = compareList.filter(c => c.key !== key || c.mode !== currentMode);
      updateCompareView();
    }

    function updateCompareView() {
      const container = document.getElementById("compare-content");
      const entityType = currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘";

      const selectedHint = selectedCity
        ? `<div class="message message-info">× ×‘×—×¨ ×›×¢×ª: <strong>${selectedCity}</strong> (×œ×—×¥ ×¢×œ â• ×›×“×™ ×œ×”×•×¡×™×£ ×œ×”×©×•×•××”)</div>`
        : `<div class="message message-info">×œ×—×¥ ×¢×œ ${entityType} ×‘××¤×” ×•××– ×¢×œ â• ×›×“×™ ×œ×”×•×¡×™×£ ×œ×”×©×•×•××”</div>`;

      let html = `<button class="add-compare-btn" onclick="addToCompare()">â• ×”×•×¡×£ ${entityType} × ×‘×—×¨ ×œ×”×©×•×•××”</button>${selectedHint}`;

      const filteredList = compareList.filter(c => c.mode === currentMode);

      if (filteredList.length > 0) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">';
        filteredList.forEach(item => {
          html += `<div class="compare-city-tag">${item.name}<button onclick="removeFromCompare('${item.key}')" title="×”×¡×¨">Ã—</button></div>`;
        });
        html += "</div>";
      }

      if (filteredList.length >= 2) {
        const index = currentMode === "muni" ? muniIndex : merhavIndex;

        const values = filteredList.map(item => {
          const total = index[item.key]?.data?.total || 0;

          if (currentMode === "muni" && currentMetric === "rate") {
            const pop = getPopulationForAuthority(item.name);
            const rate = calcRatePer10k(total, pop);
            return {
              name: item.name,
              value: rate == null ? 0 : rate,
              label: rate == null ? "××™×Ÿ ××•×›×œ×•×¡×™×™×”" : `${rate.toLocaleString()} /10k`
            };
          }

          return { name: item.name, value: total, label: total.toLocaleString() };
        });

        const title =
          (currentMode === "muni" && currentMetric === "rate")
            ? `×”×©×•×•××” ×œ-10,000 ×ª×•×©×‘×™× ×‘-${currentYear}`
            : `×¡×”"×› ××™×¨×•×¢×™× ×‘-${currentYear}`;

        html += `<div style="margin-top:16px;"><strong style="font-size:15px;">${title}</strong></div>`;

        const maxVal = Math.max(...values.map(v => v.value), 1);

        values.forEach(item => {
          const pct = (item.value / maxVal) * 100;
          html += `<div class="compare-bar">
            <div class="compare-bar-name">${item.name}</div>
            <div class="compare-bar-container">
              <div class="compare-bar-fill" style="width:${pct}%">${item.label}</div>
            </div>
          </div>`;
        });

      } else if (filteredList.length === 1) {
        html += `<div class="message message-info">×”×•×¡×£ ×¢×•×“ ${entityType} ××—×“ ×œ×¤×—×•×ª ×›×“×™ ×œ×¨××•×ª ×”×©×•×•××”</div>`;
      }

      container.innerHTML = html;
    }

    function showTrends(cityName) {
      const container = document.getElementById("trends-content");
      if (!cityName) {
        container.innerHTML = `<div class="message message-info">×‘×—×¨ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª ×˜×¨× ×“×™×</div>`;
        return;
      }

      const years = Object.keys(window.crimeByYear || {}).sort();
      const key = normalizeKey(cityName);
      const yearlyData = [];

      years.forEach(year => {
        const yearData = window.crimeByYear?.[year];
        if (!yearData) return;

        let cityData = yearData[cityName];
        if (!cityData) {
          const matchedName = Object.keys(yearData).find(k => normalizeKey(k) === key);
          if (matchedName) cityData = yearData[matchedName];
        }
        if (cityData) yearlyData.push({ year, total: cityData.total || 0 });
      });

      if (!yearlyData.length) {
        container.innerHTML = `<div class="message message-info">××™×Ÿ × ×ª×•× ×™× ×–××™× ×™× ×¢×‘×•×¨ ${cityName}</div>`;
        return;
      }

      let series = yearlyData.map(d => ({ ...d, value: d.total, label: d.total.toLocaleString() }));

      if (currentMetric === "rate") {
        const pop = getPopulationForAuthority(cityName);
        series = yearlyData.map(d => {
          const rate = calcRatePer10k(d.total, pop);
          return {
            year: d.year,
            value: rate == null ? 0 : rate,
            label: rate == null ? "××™×Ÿ ××•×›×œ×•×¡×™×™×”" : `${rate.toLocaleString()} /10k`
          };
        });
      }

      const maxVal = Math.max(...series.map(d => d.value), 1);

      let html = `<h3 style="margin:0 0 16px 0;font-size:17px;color:#222;">${cityName}</h3>`;
      if (currentMetric === "rate") {
        const pop = getPopulationForAuthority(cityName);
        html += `<div class="message message-info" style="margin-bottom:16px;">
          ×ª×¦×•×’×” ×œ-10,000 ×ª×•×©×‘×™× â€¢ ××•×›×œ×•×¡×™×™×”: ${pop ? Number(pop).toLocaleString() : "×œ× × ××¦×"}
        </div>`;
      }

      series.forEach(d => {
        const pct = (d.value / maxVal) * 100;
        html += `<div class="trend-bar">
          <div class="trend-year">${d.year}</div>
          <div class="trend-bar-container"><div class="trend-bar-fill" style="width:${pct}%"></div></div>
          <div class="trend-value">${d.label}</div>
        </div>`;
      });

      container.innerHTML = html;
    }

    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const obj = {};
      for (const f of fields) if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
      return obj;
    }

    function detectMunicipalityName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["×©× ×¨×©×•×ª", "×©× ×¨×©×•×ª ××§×•××™×ª", "×©× ×™×©×•×‘", "×™×©×•×‘ ×¡×•×¤×™", "SHEM_YISHUV"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    function detectMerhavName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["×©× ××¨×—×‘", "×©× ××¨×—×‘ ××©×˜×¨×ª×™", "MERHAV", "SHEM_MERHAV"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      try {
        const layerName = (currentMode === "muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
        const resp = await govmap.getLayerData({
          LayerName: layerName,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp?.data || resp?.Data || [];
        if (!items.length) {
          showInfo("×œ× × ××¦×", "××™×Ÿ ××•×‘×™×™×§×˜ ×‘××–×•×¨ ×–×”", "info");
          return;
        }

        const first = items[0];
        const attrs = first.Fields || first.Attributes || first;

        if (currentMode === "muni") {
          const name = detectMunicipalityName(attrs);
          if (!name) {
            console.log("âŒ Municipality attributes:", attrs);
            showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”×¨×©×•×ª", "error");
            return;
          }

          const key = normalizeKey(name);
          selectedCity = name;
          selectedCityKey = key;

          const entry = muniIndex[key] || muniIndex[nameVariants(name)[0]];
          if (!entry) {
            showInfo("×œ× × ××¦××• × ×ª×•× ×™×", `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${name}</strong> ×‘×©× ×ª ${currentYear}`, "error");
            return;
          }

          if (currentTab === "compare") { updateCompareView(); return; }
          if (currentTab === "single") showEntry(entry);
          else if (currentTab === "trends") showTrends(name);
          return;
        }

        const merhavName = detectMerhavName(attrs);
        if (!merhavName) {
          console.log("âŒ Merhav attributes:", attrs);
          showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ××¨×—×‘ ×”××©×˜×¨×”", "error");
          return;
        }

        const key = normalizeKey(merhavName);
        selectedCity = merhavName;
        selectedCityKey = key;

        const entry = merhavIndex[key];
        if (!entry) {
          showInfo("×œ× × ××¦××• × ×ª×•× ×™×", `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${merhavName}</strong> ×‘×©× ×ª ${currentYear}`, "error");
          return;
        }

        if (currentTab === "compare") { updateCompareView(); return; }
        showEntry(entry);

      } catch (error) {
        console.error("âŒ Error in onMapClick:", error);
        showInfo("×©×’×™××”", "××™×¨×¢×” ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: " + error.message, "error");
      }
    }

    function initGovMap() {
      if (!window.crimeByYear) {
        showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×§×•×‘×¥ ×”× ×ª×•× ×™× crimeByYear_2020_2025.js", "error");
        document.getElementById("loading").style.display = "none";
        return;
      }
      if (!window.crimeByYearMerhav) console.warn("âš ï¸ crimeByYearMerhav.js ×œ× × ×˜×¢×Ÿ");

      buildPopulationIndex();

      const years = Object.keys(window.crimeByYear).sort();
      const sel = document.getElementById("yearSelect");
      sel.innerHTML = "";

      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        sel.appendChild(opt);
      });

      currentYear = years.includes("2025") ? "2025" : years[years.length - 1];
      sel.value = currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      updateQuickStats();

      sel.addEventListener("change", e => {
        currentYear = e.target.value;

        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        updateQuickStats();

        showInfo(
          "××¤×” ×œ×¤×™ " + (currentMode === "muni" ? "×™×©×•×‘×™×/×¨×©×•×™×•×ª" : "××¨×—×‘×™×"),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );

        if (currentTab === "compare") updateCompareView();
        if (currentTab === "trends" && currentMode === "muni" && selectedCity) showTrends(selectedCity);
      });

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER],
        layersMode: 1,
        background: 2,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [MUNICIPAL_LAYER],

        onLoad: () => {
          mapInitialized = true;
          setMode(currentMode);

          govmap.onEvent(govmap.events.CLICK).progress(onMapClick);

          document.getElementById("loading").style.display = "none";
          showInfo("××¤×” ×œ×¤×™ ×™×©×•×‘×™×/×¨×©×•×™×•×ª", `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, "info");
          console.log("âœ… Map initialized successfully");
        }
      });
    }

    window.initGovMap = initGovMap;
    window.switchTab = switchTab;
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.showTrends = showTrends;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:15px;color:#333;font-weight:600;">×˜×•×¢×Ÿ ××¤×”...</div>
  </div>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×” ×‘×™×©×¨××œ</h1>
      <p>×‘×—×¨ ××¦×‘ + ×ª×¦×•×’×” (×›××•×ª / ×œ-10,000 ×ª×•×©×‘×™×)</p>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">×ª×¦×•×’×”</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')">×”×©×•×•××”</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')">×˜×¨× ×“×™×</div>
    </div>

    <div id="controls">
      <div class="mode-switch">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')">ğŸ˜ï¸ ××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">ğŸš” ××¦×‘ ××¨×—×‘×™×</button>
      </div>

      <div class="mode-switch">
        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')">ğŸ”¢ ×›××•×ª</button>
        <button id="btnMetricRate" class="mode-btn" onclick="setMetric('rate')">ğŸ‘¥ ×œ-10,000 ×ª×•×©×‘×™×</button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×‘×—×¨ ×©× ×”:</label>
        <select id="yearSelect"></select>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label">×¨×©×•×™×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">×¡×”"×› ××™×¨×•×¢×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">×××•×¦×¢</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-compare">
        <div id="compare-content">
          <div class="message message-info">×‘×—×¨ ×™×©×•×‘×™×/×¨×©×•×™×•×ª ××• ××¨×—×‘×™× ×‘××¤×” ×•×”×•×¡×£ ×œ×”×©×•×•××”</div>
        </div>
      </div>

      <div class="tab-content" id="tab-trends">
        <div id="trends-content">
          <div class="message message-info">×‘×—×¨ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª ×˜×¨× ×“×™× ×œ××•×¨×š ×–××Ÿ</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

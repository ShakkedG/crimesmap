<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפת פשיעה – לפי שנה (2020–2025) | ישובים / מרחבים / תחנות</title>

  <!-- DATA -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>
  <script src="crimeByYearStations.js"></script>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
      font-size: 15px;
    }

    #map { width: 100%; height: 100%; position: relative; }

    /* hide ESRI widgets if appear */
    .esri-layer-list, .esri-legend { display: none !important; }

    /* PANEL */
    #info-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: white;
      padding: 0;
      border-radius: 14px;
      width: 440px;
      max-height: calc(100vh - 30px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      font-size: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: height .2s ease, max-height .2s ease;
    }

    #panel-header {
      background: linear-gradient(135deg, #0b63ce 0%, #084eac 100%);
      color: white;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.15);
      flex-shrink: 0;
    }
    #panel-header h1 { margin: 0; font-size: 17px; font-weight: 1000; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.94; line-height: 1.35; font-weight: 900; }

    #header-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .hbtn{
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.16);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-size: 13px;
    }
    .hbtn:active{ transform: translateY(1px); }
    .hbtn.secondary{
      background: rgba(0,0,0,.12);
      border-color: rgba(255,255,255,.22);
    }

    #tabs {
      display: flex;
      gap: 0;
      background: #fafafa;
      border-bottom: 2px solid #e6e6e6;
      flex-shrink: 0;
      overflow-x: auto;
    }
    .tab {
      flex: 1;
      padding: 11px 10px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 1000;
      color: #666;
      user-select: none;
      white-space: nowrap;
      min-width: 96px;
    }
    .tab:hover { background: #f2f6ff; color: #2a4c8a; }
    .tab.active { background: white; border-bottom-color: #0b63ce; color: #0b63ce; }

    #controls {
      padding: 12px 14px;
      background: #fafafa;
      border-bottom: 1px solid #e8e8e8;
      flex-shrink: 0;
    }

    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mode-btn {
      padding: 11px 10px;
      border-radius: 12px;
      border: 2px solid #e3e3e3;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 1000;
      color: #444;
      transition: all 0.15s ease;
      user-select: none;
      text-align: center;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .mode-btn:hover { border-color: #0b63ce; color: #0b63ce; }
    .mode-btn.active {
      background: #0b63ce;
      border-color: #0b63ce;
      color: white;
      box-shadow: 0 8px 20px rgba(11,99,206,0.18);
    }
    .mode-btn.disabled {
      opacity: 0.55;
      cursor: not-allowed !important;
      border-color: #ddd !important;
      color: #666 !important;
      background: #fff !important;
      pointer-events: none;
      box-shadow: none;
    }
    .mode-btn.full { grid-column: 1 / -1; }
    .mode-btn.primary {
      font-size: 14px;
      padding: 13px 10px;
      border-width: 3px;
    }

    #controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    #controls label {
      font-weight: 1000;
      font-size: 13px;
      color: #333;
      white-space: nowrap;
    }
    #yearSelect {
      flex: 1;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      font-size: 14px;
      background: white;
      cursor: pointer;
      font-weight: 1000;
    }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 14px;
      text-align: center;
      border: 1px solid #e7e7e7;
      box-shadow: 0 4px 14px rgba(0,0,0,0.04);
    }
    .stat-value { font-size: 18px; font-weight: 1000; color: #0b63ce; margin-bottom: 3px; }
    .stat-label { font-size: 12px; color: #777; font-weight: 1000; letter-spacing: .2px; }

    #info-content {
      padding: 14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title {
      font-weight: 1000;
      font-size: 16px;
      margin-bottom: 12px;
      color: #111;
      padding-bottom: 8px;
      border-bottom: 3px solid #0b63ce;
    }
    #info-body { line-height: 1.6; color: #444; }

    .total-summary {
      font-size: 26px;
      font-weight: 1000;
      color: #0b63ce;
      margin: 12px 0 10px 0;
      text-align: center;
      padding: 14px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f3f8ff 100%);
      border-radius: 14px;
      border: 2px solid #b3d9ff;
    }

    .sub-summary {
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
      font-size: 13px;
      color: #333;
      font-weight: 1000;
    }

    .crime-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .crime-item {
      background: #fafafa;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid #e6e6e6;
      border-right: 4px solid #0b63ce;
      display: flex;
      flex-direction: column;
      gap: 6px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.03);
    }
    .crime-name {
      font-weight: 1000;
      color: #222;
      font-size: 13px;
      line-height: 1.35;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .crime-count { font-weight: 1000; color: #0b63ce; font-size: 17px; }

    .message {
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 10px;
      font-size: 13.5px;
      border-right: 4px solid;
      line-height: 1.55;
      font-weight: 900;
    }
    .message-info  { background: #e7f3ff; color: #063a73; border-right-color: #0b63ce; }
    .message-warn  { background: #fff7e6; color: #6a3f00; border-right-color: #ffb300; }
    .message-error { background: #fff0f0; color: #b20000; border-right-color: #ff0000; }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.22);
      z-index: 10000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 14px;
      border: 4px solid #e7e7e7;
      border-top: 4px solid #0b63ce;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Compare cards */
    .compare-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
    .compare-card {
      border: 1px solid #e8e8e8;
      border-radius: 16px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }
    .compare-card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .compare-name {
      font-weight: 1000;
      color: #111;
      font-size: 14px;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      color: #333;
    }
    .badge-warn {
      border-color: #ffcc80;
      background: #fff7e6;
      color: #6a3f00;
    }
    .compare-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
    .kpi {
      border: 1px solid #eee;
      background: #fafafa;
      border-radius: 14px;
      padding: 10px;
      text-align: center;
    }
    .kpi .kpi-value { font-weight: 1000; color: #0b63ce; font-size: 14px; margin-bottom: 4px; }
    .kpi .kpi-label { font-size: 11px; font-weight: 1000; color: #666; letter-spacing: .2px; }

    .add-compare-btn {
      width: 100%;
      padding: 12px;
      background: #0b63ce;
      color: white;
      border: none;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 1000;
      cursor: pointer;
      margin-bottom: 12px;
      box-shadow: 0 10px 24px rgba(11,99,206,0.18);
    }
    .add-compare-btn:active{ transform: translateY(1px); }

    .compare-tags { display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px; }
    .compare-city-tag {
      background: #e7f3ff;
      color: #0b63ce;
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #b3d9ff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 1000;
    }
    .compare-city-tag button {
      border: none; background: none; color: #0b63ce;
      cursor: pointer; font-size: 18px; line-height: 1;
      padding: 0; width: 22px; height: 22px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover { background: #0b63ce; color: white; }

    /* Compare bars */
    .compare-bars-title { margin: 12px 0 8px; font-weight: 1000; font-size: 14px; color: #111; }
    .bar-row{
      display:grid;
      grid-template-columns: 1fr 2.2fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 14px;
      background: #fafafa;
      margin-bottom: 8px;
    }
    .bar-name{
      font-weight: 1000;
      font-size: 12.5px;
      color:#222;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bar-track{
      height: 28px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid #e5e5e5;
    }
    .bar-fill{
      height: 100%;
      background: linear-gradient(90deg, #0b63ce 0%, #1f86ff 100%);
      border-radius: 10px;
      transition: width .35s ease;
    }
    .bar-value{
      font-weight: 1000;
      color: #0b63ce;
      font-size: 13px;
      text-align:left;
      min-width: 72px;
      direction: ltr;
    }

    /* Trends (Redesign) */
    .trend-shell{
      border: 1px solid #eee;
      border-radius: 18px;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    .trend-top{
      padding: 12px 12px 10px 12px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f3f8ff 100%);
      border-bottom: 1px solid #e6e6e6;
    }
    .trend-title{
      font-weight: 1000;
      color: #063a73;
      font-size: 14px;
      margin-bottom: 6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .trend-sub{
      font-weight: 900;
      color: #222;
      font-size: 12.8px;
      opacity: 0.95;
      line-height: 1.45;
    }
    .trend-kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .trend-kpi{
      background: rgba(255,255,255,.9);
      border: 1px solid #e0e0e0;
      border-radius: 14px;
      padding: 10px;
      text-align:center;
    }
    .trend-kpi .v{ font-weight: 1000; color:#0b63ce; font-size: 14px; margin-bottom: 4px; }
    .trend-kpi .l{ font-weight: 1000; color:#666; font-size: 11px; letter-spacing: .2px; }

    .trend-list{
      padding: 10px 12px 12px 12px;
      background:#fff;
    }
    .trow{
      display:grid;
      grid-template-columns: 56px 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 14px;
      background:#fafafa;
      margin-bottom: 8px;
    }
    .trow .y{ font-weight:1000; color:#111; direction:ltr; text-align:left; }
    .tbar{
      height: 22px;
      background:#f0f0f0;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid #e5e5e5;
    }
    .tfill{
      height:100%;
      background: linear-gradient(90deg, #0b63ce 0%, #1f86ff 100%);
      border-radius: 10px;
      transition: width .35s ease;
    }
    .tval{
      font-weight:1000;
      color:#0b63ce;
      min-width: 90px;
      direction:ltr;
      text-align:left;
      font-size: 13px;
    }
    .tval small{
      display:block;
      font-weight:900;
      color:#666;
      font-size: 11px;
      direction:ltr;
      text-align:left;
      margin-top: 2px;
    }

    /* Rankings controls */
    .rank-controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 10px;
    }
    .rank-ctl-btn{
      padding: 9px 10px;
      border-radius: 12px;
      border: 2px solid #e3e3e3;
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      font-size: 13px;
      color:#333;
    }
    .rank-ctl-btn.active{
      background:#0b63ce;
      border-color:#0b63ce;
      color:#fff;
      box-shadow: 0 8px 20px rgba(11,99,206,0.18);
    }
    .rank-filter{
      flex: 1;
      min-width: 170px;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      font-weight: 900;
      font-size: 13px;
      outline: none;
    }

    /* Rankings */
    .rank-list{
      border: 1px solid #eee;
      border-radius: 16px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.05);
    }
    .rank-row{
      display:grid;
      grid-template-columns: 42px 1fr auto;
      gap: 10px;
      align-items:center;
      padding: 11px 12px;
      border-bottom: 1px solid #f0f0f0;
      background:#fff;
      cursor: pointer;
    }
    .rank-row:hover{ background:#f5f9ff; }
    .rank-row:nth-child(even){ background:#fafafa; }
    .rank-num{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      color: #063a73;
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
    }
    .rank-name{
      font-weight: 1000;
      color: #111;
      font-size: 13.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .rank-value{
      font-weight: 1000;
      color: #0b63ce;
      direction:ltr;
      font-size: 13.5px;
      min-width: 86px;
      text-align:left;
    }
    .rank-extra{
      padding: 0 12px 10px 12px;
      margin-top: -6px;
      border-bottom: 1px solid #f0f0f0;
      background: #fff;
      color: #666;
      font-weight: 900;
      font-size: 12px;
    }

    /* MODALS */
    .modal { display:none; position:fixed; inset:0; z-index:20000; }
    .modalOverlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }
    .modalCard {
      position:relative;
      width:min(760px, calc(100vw - 26px));
      max-height: calc(100vh - 26px);
      margin: 13px auto;
      background:#fff;
      border-radius:18px;
      box-shadow: 0 12px 34px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader {
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(135deg, #0b63ce 0%, #084eac 100%);
      color:#fff;
    }
    .modalHeaderTitle { font-weight:1000; font-size:15px; }
    .modalClose {
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width:42px;
      height:42px;
      border-radius:14px;
      cursor:pointer;
      font-size:20px;
      font-weight:1000;
    }
    .modalClose:active{ transform: translateY(1px); }
    .modalBody { padding:16px; overflow:auto; }

    /* Address search results */
    #addrResults {
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      margin-top: 10px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }
    .addr-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 900;
    }
    .addr-item:last-child { border-bottom: none; }
    .addr-item:hover { background: #f5f9ff; }
    .addr-sub { font-size: 12.5px; color: #666; margin-top: 3px; font-weight: 800; }

    /* Collapse behavior (more compact) */
    #info-panel.collapsed { max-height: 74px; height: 74px; }
    #info-panel.collapsed #tabs,
    #info-panel.collapsed #controls,
    #info-panel.collapsed #info-content { display:none; }

    #info-panel.collapsed #panel-header { padding: 10px 12px; }
    #info-panel.collapsed #panel-header p { display: none; }
    #info-panel.collapsed #panel-header h1 { font-size: 15px; }

    #info-panel.collapsed #header-actions { margin-top: 0; justify-content: flex-end; }

    #info-panel.collapsed #searchBtn,
    #info-panel.collapsed #aboutBtn { display: none; }

    #info-panel.collapsed #panelToggleBtn { display: inline-flex; }

    /* Mobile bottom sheet */
    @media (max-width: 768px) {
      #info-panel{
        left: 0; right: 0; top: auto; bottom: 0;
        width: 100%;
        max-height: none;
        height: 62vh;
        border-radius: 20px 20px 0 0;
      }
      #info-panel.collapsed{ height: 74px; }
      #info-content{ padding: 12px; }
      .crime-grid { grid-template-columns: 1fr; }
      .compare-kpis { grid-template-columns: 1fr; }
      .bar-row { grid-template-columns: 1fr 1.6fr auto; }
      .trend-kpis { grid-template-columns: 1fr; }
      .trow{ grid-template-columns: 52px 1fr auto; }
    }
  </style>

  <script>
    // ===================== CONFIG =====================
    const MUNICIPAL_LAYER      = "125";
    const POLICE_MERHAV_LAYER  = "200550";
    const POLICE_STATION_LAYER = "24";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    // If muni_boundaries_ITM.geojson exists alongside index.html, it will be fetched.
    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    // ===================== STATE =====================
    let lastHoverMapPoint = null;
    let lastGovmapClickAt = 0;

    let mapInitialized = false;
    let currentYear = "2025";
    let currentTab = "single";
    let currentMode = "muni";  // muni | merhav | station
    let currentMetric = "abs"; // abs | rate (rate only for muni)

    let selectedEntityName = null;
    let selectedEntityKey = null; // canonical key for the currentMode
    let compareList = []; // items: { mode, key, name }

    const muniIndex = Object.create(null);
    const merhavIndex = Object.create(null);
    const stationIndex = Object.create(null);

    const populationIndex = Object.create(null);
    const variantsCache = new Map();

    // Rankings UI state
    let rankingsOrder = "desc"; // desc | asc
    let rankingsFilter = "";

    // For efficiency:
    const wktByCrimeNameCache = new Map(); // normalizeKey(name)->wkt
    const choroplethCache = new Map(); // `${year}__${metric}` -> {payload, meta}
    let activeChoroplethNames = [];
    let choroplethEnabled = false;
    const CHORO_PREFIX = "crime_rate_choropleth";

    // Address search state
    let lastGeocodeReqId = 0;
    let lastAddrItems = [];
    let lastGeocodeQuery = "";
    let searchTimeout = null;

    // Boundaries
    let muniBoundariesLoaded = false;
    let muniBoundariesLoadError = null;
    let muniBoundariesIndex = Object.create(null); // normalizedKey -> WKT
    let muniBoundariesMeta = [];  // [{ name, wkt }]

    // ===================== NORMALIZATION =====================
    function normalizeKeyBase(name) {
      if (name == null) return "";
      let s = String(name).trim();
      s = s
        .replace(/[׳״"']/g, "")
        .replace(/[(){}\[\],.:]/g, "")
        .replace(/־/g, "-")
        .replace(/\s+/g, " ")
        .trim();
      s = s.replace(/[\s\-]/g, "");
      return s.toLowerCase();
    }
    function normalizeKey(name) { return normalizeKeyBase(name); }

    function nameVariants(name) {
      if (!name) return [];
      if (variantsCache.has(name)) return variantsCache.get(name);

      const raw = String(name).trim();
      if (!raw) return [];

      const withoutCityHall = raw.replace(/^עיריית\s+/g, "").replace(/^עיריה\s+/g, "");
      const withoutLocalCouncil = withoutCityHall.replace(/^מועצה\s+מקומית\s+/g, "");
      const withoutRegionalCouncil = withoutLocalCouncil.replace(/^מועצה\s+אזורית\s+/g, "");

      const variants = [raw, withoutCityHall, withoutLocalCouncil, withoutRegionalCouncil]
        .map(normalizeKeyBase)
        .filter(Boolean);

      variantsCache.set(name, variants);
      return variants;
    }

    function stationNameVariants(name){
      const raw = String(name || "").trim();
      if(!raw) return [];
      const v = new Set();
      const add = (s)=>{ const k=normalizeKey(s); if(k) v.add(k); };
      add(raw);
      const noPrefix = raw.replace(/^תחנת\s+/,"").trim();
      add(noPrefix);
      add("תחנת " + noPrefix);
      add(raw.replace(/\s+/g," ").trim());
      return Array.from(v);
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function fmtMaybe(num) {
      if (num == null) return "—";
      const n = Number(num);
      if (!Number.isFinite(n)) return "—";
      return n.toLocaleString();
    }

    // ===================== DATA RESOLVERS =====================
    function getStationsDataset(){
      // Resolve dataset from possible globals without recursion.
      try{
        if (window.crimeByYearStations && typeof window.crimeByYearStations === "object") return window.crimeByYearStations;
      }catch(_){}
      try{
        // eslint-disable-next-line no-undef
        if (typeof crimeByYearStations !== "undefined" && crimeByYearStations && typeof crimeByYearStations === "object") return crimeByYearStations;
      }catch(_){}
      try{
        // eslint-disable-next-line no-undef
        if (typeof CRIMEBYYEARSTATIONS !== "undefined" && CRIMEBYYEARSTATIONS && typeof CRIMEBYYEARSTATIONS === "object") return CRIMEBYYEARSTATIONS;
      }catch(_){}
      try{
        if (window.CRIMEBYYEARSTATIONS && typeof window.CRIMEBYYEARSTATIONS === "object") return window.CRIMEBYYEARSTATIONS;
      }catch(_){}
      return null;
    }

    function getModeLabel(mode){
      if(mode === "muni") return "ישובים/רשויות";
      if(mode === "merhav") return "מרחבים";
      if(mode === "station") return "תחנות משטרה";
      return "ישויות";
    }
    function getEntityLabel(mode){
      if(mode === "muni") return "רשות";
      if(mode === "merhav") return "מרחב";
      if(mode === "station") return "תחנה";
      return "ישות";
    }
    function getIndexByMode(mode){
      if(mode === "muni") return muniIndex;
      if(mode === "merhav") return merhavIndex;
      if(mode === "station") return stationIndex;
      return muniIndex;
    }
    function getYearDataByMode(mode, year){
      if(mode === "muni") return window.crimeByYear?.[year] || null;
      if(mode === "merhav") return window.crimeByYearMerhav?.[year] || null;
      if(mode === "station") return getStationsDataset()?.[year] || null;
      return null;
    }

    // ===================== POPULATION =====================
    function buildPopulationIndex() {
      for (const k in populationIndex) delete populationIndex[k];

      const raw = window.PopulationDB;
      if (!raw || typeof raw !== "object") {
        console.warn("⚠️ PopulationDB.js not loaded or invalid");
        return false;
      }
      for (const displayName in raw) {
        const pop = Number(raw[displayName]);
        if (!Number.isFinite(pop)) continue;
        for (const v of nameVariants(displayName)) populationIndex[v] = pop;
      }
      console.log("✅ Population index ready:", Object.keys(populationIndex).length);
      return true;
    }

    function getPopulationForAuthority(nameFromCrime) {
      for (const v of nameVariants(nameFromCrime)) {
        const pop = populationIndex[v];
        if (pop != null) return pop;
      }
      return null;
    }

    function calcRatePer10k(total, pop) {
      if (!Number.isFinite(Number(total))) return null;
      const p = Number(pop);
      if (!Number.isFinite(p) || p <= 0) return null;
      return Math.round((Number(total) / p) * 10000 * 10) / 10;
    }

    // ===================== UI: INFO =====================
    function showInfo(title, body, type = "info") {
      const t = document.getElementById("info-title");
      const b = document.getElementById("info-body");
      if (!t || !b) return;
      t.textContent = title;
      b.innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function updateHeaderModeLine(){
      const headerP = document.querySelector("#panel-header p");
      if (!headerP) return;

      const muniOnly = (currentMode === "muni");
      const extra = muniOnly ? "מדד ל-10,000 זמין כאן (רק אם יש נתון אוכלוסייה)" : "מדד ל-10,000 לא זמין במצב זה";
      headerP.innerHTML = `מצב נוכחי: <strong>${escapeHtml(getModeLabel(currentMode))}</strong><br>${extra}`;
    }

    function updateMetricButtonsUI() {
      const btnRate = document.getElementById("btnMetricRate");
      const muniOnly = (currentMode === "muni");

      if (btnRate) {
        btnRate.classList.toggle("disabled", !muniOnly);
        btnRate.disabled = !muniOnly;
        btnRate.onclick = muniOnly ? () => setMetric("rate") : null;
        btnRate.title = muniOnly ? "מציג עבירות ל-10,000 תושבים (רק אם יש אוכלוסייה)" : "זמין רק במצב ישובים/רשויות";
      }

      if (!muniOnly && currentMetric === "rate") {
        currentMetric = "abs";
        const bAbs = document.getElementById("btnMetricAbs");
        const bRate2 = document.getElementById("btnMetricRate");
        if (bAbs) bAbs.classList.add("active");
        if (bRate2) bRate2.classList.remove("active");
      }

      updateHeaderModeLine();
      setChoroBtnUI();
    }

    // ===================== QUICK STATS =====================
    function calculateStats(year, mode) {
      const m = mode || currentMode || "muni";
      const yearData = getYearDataByMode(m, year);
      if (!yearData) return { entities: 0, total: 0, avg: 0 };

      let total = 0, count = 0;
      for (const name in yearData) {
        const data = yearData[name];
        if (data && typeof data.total === "number") {
          total += data.total;
          count++;
        }
      }
      return { entities: count, total, avg: count > 0 ? Math.round(total / count) : 0 };
    }

    function updateQuickStats() {
      const stats = calculateStats(currentYear, currentMode);

      const a = document.getElementById("stat-municipalities");
      const b = document.getElementById("stat-total");
      const c = document.getElementById("stat-avg");
      const l = document.getElementById("stat-entities-label");

      if (a) a.textContent = Number(stats.entities || 0).toLocaleString();
      if (b) b.textContent = Number(stats.total || 0).toLocaleString();
      if (c) c.textContent = Number(stats.avg || 0).toLocaleString();
      if (l) l.textContent = (currentMode === "muni" ? "רשויות" : (currentMode === "merhav" ? "מרחבים" : "תחנות"));
    }

    // ===================== INDEX BUILDING (MUNI / MERHAV / STATION) =====================
    function clearIndex(obj){
      Object.keys(obj).forEach(k => delete obj[k]);
    }

    function buildMuniIndexForYear(year) {
      clearIndex(muniIndex);
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return;

      for (const name in yearData) {
        const canonicalKey = normalizeKey(name);
        const entry = { key: canonicalKey, name, data: yearData[name] };

        muniIndex[canonicalKey] = entry;
        for (const v of nameVariants(name)) muniIndex[v] = entry;
      }
      console.log(`✅ Year ${year}: muni index keys = ${Object.keys(muniIndex).length}`);
    }

    function buildMerhavIndexForYear(year) {
      clearIndex(merhavIndex);
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) { 
        console.warn(`⚠️ No merhav data for year ${year}`); 
        return; 
      }

      for (const name in yearData) {
        const k = normalizeKey(name);
        merhavIndex[k] = { key: k, name, data: yearData[name] };
      }
      console.log(`✅ Year ${year}: merhav index keys = ${Object.keys(merhavIndex).length}`);
    }

    function buildStationIndexForYear(year) {
      clearIndex(stationIndex);
      const yearData = getStationsDataset()?.[year] || null;
      if (!yearData) return;

      for (const stationName in yearData) {
        const canonicalKey = normalizeKey(stationName);
        const entry = { key: canonicalKey, name: String(stationName).trim(), data: yearData[stationName] || { total: 0, breakdown: {} } };

        stationIndex[canonicalKey] = entry;
        for (const v of stationNameVariants(stationName)) stationIndex[v] = entry;
      }
      console.log(`✅ Year ${year}: station index keys = ${Object.keys(stationIndex).length}`);
    }

    function buildAllIndexesForYear(year){
      buildMuniIndexForYear(year);
      buildMerhavIndexForYear(year);
      buildStationIndexForYear(year);
    }

    // ===================== ENTITY RENDER =====================
    function showEntry(entry) {
      const d = entry?.data || {};
      let html = "";

      const total = (typeof d.total === "number") ? d.total : null;

      let popRaw = null;
      let rate = null;
      if (currentMode === "muni") {
        popRaw = getPopulationForAuthority(entry.name);
        if (popRaw != null) rate = calcRatePer10k(total, popRaw);
      }

      if (total != null) {
        if (currentMetric === "rate" && currentMode === "muni") {
          if (popRaw == null || rate == null) {
            html += `<div class="total-summary">${Number(total).toLocaleString()} אירועים</div>`;
            html += `<div class="message message-warn">אין נתון אוכלוסייה עבור הרשות הזו, לכן לא מוצג חישוב ל‑10,000.</div>`;
          } else {
            html += `<div class="total-summary">${Number(rate).toLocaleString()} ל-10,000</div>`;
            html += `<div class="sub-summary">אוכלוסייה (סטטית): ${Number(popRaw).toLocaleString()} • סה"כ אירועים: ${Number(total).toLocaleString()}</div>`;
          }
        } else {
          html += `<div class="total-summary">${Number(total).toLocaleString()} אירועים</div>`;
          if (currentMode === "muni" && popRaw != null) {
            html += `<div class="sub-summary">אוכלוסייה (סטטית): ${Number(popRaw).toLocaleString()}</div>`;
          }
        }
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
        html += `<div class="crime-grid">`;
        for (const [name, count] of sorted) {
          html += `<div class="crime-item">
            <div class="crime-name">${escapeHtml(name)}</div>
            <div class="crime-count">${Number(count || 0).toLocaleString()}</div>
          </div>`;
        }
        html += `</div>`;
      }

      const it = document.getElementById("info-title");
      const ib = document.getElementById("info-body");
      if (!it || !ib) return;
      it.textContent = entry.name;
      ib.innerHTML = html || `<div class="message message-info">אין נתונים להצגה</div>`;
    }

    // ===================== TABS =====================
    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll(".tab").forEach(tab =>
        tab.classList.toggle("active", tab.dataset.tab === tabName)
      );

      document.querySelectorAll(".tab-content").forEach(content =>
        content.classList.toggle("active", content.id === `tab-${tabName}`)
      );

      if (tabName === "single") {
        showInfo(
          "מפה לפי " + getModeLabel(currentMode),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(currentMode)} במפה כדי לראות נתונים`,
          "info"
        );
      } else if (tabName === "compare") {
        updateCompareView();
      } else if (tabName === "trends") {
        const tc = document.getElementById("trends-content");
        if (!selectedEntityName) {
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(currentMode)} במפה כדי לראות נתונים היסטוריים</div>`;
          return;
        }
        showTrends(selectedEntityName, currentMode);
      } else if (tabName === "rankings") {
        renderRankings();
      }
    }

    // ===================== MODE / METRIC =====================
    function setMode(mode) {
      currentMode = mode;

      const bm = document.getElementById("btnModeMuni");
      const br = document.getElementById("btnModeMerhav");
      const bs = document.getElementById("btnModeStation");
      if (bm) bm.classList.toggle("active", mode === "muni");
      if (br) br.classList.toggle("active", mode === "merhav");
      if (bs) bs.classList.toggle("active", mode === "station");

      updateMetricButtonsUI();
      updateQuickStats();

      const layerToShow =
        (mode === "muni") ? MUNICIPAL_LAYER :
        (mode === "merhav") ? POLICE_MERHAV_LAYER :
        POLICE_STATION_LAYER;

      const layersToHide =
        (mode === "muni") ? [POLICE_MERHAV_LAYER, POLICE_STATION_LAYER] :
        (mode === "merhav") ? [MUNICIPAL_LAYER, POLICE_STATION_LAYER] :
        [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER];

      if (mapInitialized) {
        try {
          if (typeof govmap.setVisibleLayers === "function") {
            govmap.setVisibleLayers([layerToShow], layersToHide);
          }
        } catch (err) {
          console.warn("⚠️ setVisibleLayers failed:", err);
        }
      }

      if (mode !== "muni") {
        choroplethEnabled = false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      }
      setChoroBtnUI();

      selectedEntityName = null;
      selectedEntityKey = null;

      compareList = compareList.filter(c => c.mode === mode);

      if (currentTab === "compare") updateCompareView();
      else if (currentTab === "rankings") renderRankings();
      else if (currentTab === "trends") {
        const tc = document.getElementById("trends-content");
        if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(mode)} במפה כדי לראות נתונים היסטוריים</div>`;
      } else {
        showInfo(
          "מפה לפי " + getModeLabel(mode),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(mode)} במפה כדי לראות נתונים`,
          "info"
        );
      }
    }

    function setMetric(metric) {
      if (metric === "rate" && currentMode !== "muni") {
        alert("זמין רק במצב ישובים/רשויות");
        return;
      }

      currentMetric = metric;

      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");

      if (bAbs) bAbs.classList.toggle("active", metric === "abs");
      if (bRate) bRate.classList.toggle("active", metric === "rate");

      if (choroplethEnabled && currentMode === "muni") renderChoropleth();

      if (currentTab === "single" && selectedEntityKey) {
        const index = getIndexByMode(currentMode);
        const entry = index[selectedEntityKey];
        if (entry) showEntry(entry);
      }
      if (currentTab === "compare") updateCompareView();
      if (currentTab === "trends" && selectedEntityName) showTrends(selectedEntityName, currentMode);
      if (currentTab === "rankings") renderRankings();

      setChoroBtnUI();
    }

    // ===================== COMPARE =====================
    function addToCompare() {
      if (!selectedEntityName || !selectedEntityKey) {
        alert(`אנא בחר ${getEntityLabel(currentMode)} במפה תחילה`);
        return;
      }
      if (!compareList.some(c => c.mode === currentMode && c.key === selectedEntityKey)) {
        compareList.push({ mode: currentMode, key: selectedEntityKey, name: selectedEntityName });
        updateCompareView();
      }
    }

    function removeFromCompare(key) {
      compareList = compareList.filter(c => !(c.mode === currentMode && c.key === key));
      updateCompareView();
    }

    function updateCompareView() {
      const container = document.getElementById("compare-content");
      if (!container) return;

      const entityType = getEntityLabel(currentMode);
      const selectedHint = selectedEntityName
        ? `<div class="message message-info">נבחר כעת: <strong>${escapeHtml(selectedEntityName)}</strong> (לחץ על ➕ כדי להוסיף להשוואה)</div>`
        : `<div class="message message-info">לחץ על ${entityType} במפה ואז על ➕ כדי להוסיף להשוואה</div>`;

      let html = `
        <button class="add-compare-btn" onclick="addToCompare()">➕ הוסף ${entityType} נבחר להשוואה</button>
        ${selectedHint}
      `;

      const filteredList = compareList.filter(c => c.mode === currentMode);

      if (filteredList.length > 0) {
        html += '<div class="compare-tags">';
        filteredList.forEach(item => {
          html += `<div class="compare-city-tag">${escapeHtml(item.name)}
            <button onclick="removeFromCompare('${item.key}')" title="הסר">×</button></div>`;
        });
        html += "</div>";
      }

      if (filteredList.length < 2) {
        html += `<div class="message message-info">הוסף עוד ${entityType} אחד לפחות כדי לראות השוואה</div>`;
        container.innerHTML = html;
        return;
      }

      const index = getIndexByMode(currentMode);

      const metricType = (currentMode === "muni" && currentMetric === "rate") ? "rate" : "total";

      const rows = filteredList.map(item => {
        const entry = index[item.key];
        const total = entry?.data?.total ?? 0;

        if (currentMode !== "muni") {
          return { name: entry?.name || item.name, total, pop: null, rate: null, hasPop: false };
        }

        const popRaw = getPopulationForAuthority(entry?.name || item.name);
        const pop = (popRaw == null ? null : Number(popRaw));
        const rate = (popRaw == null ? null : calcRatePer10k(total, popRaw));
        return { name: entry?.name || item.name, total, pop, rate, hasPop: popRaw != null };
      });

      if (currentMode !== "muni") {
        html += `<div class="message message-info">במצב ${getModeLabel(currentMode)} ההשוואה היא לפי כמות בלבד.</div>`;
      } else if (metricType === "rate") {
        html += `<div class="message message-info">השוואה לפי <strong>ל-10,000 תושבים</strong> (רק אם יש נתון אוכלוסייה).</div>`;
      } else {
        html += `<div class="message message-info">טיפ: מעבר ל־<strong>ל-10,000</strong> משווה יחסית לגודל אוכלוסייה (אם קיים נתון).</div>`;
      }

      html += `<div class="compare-grid">`;
      rows.forEach(r => {
        const badges = [];
        if (currentMode === "muni" && !r.hasPop) badges.push(`<span class="badge badge-warn">אין נתון אוכלוסייה</span>`);

        html += `
          <div class="compare-card">
            <div class="compare-card-title">
              <div class="compare-name">${escapeHtml(r.name)}</div>
              <div class="compare-badges">${badges.join("")}</div>
            </div>

            <div class="compare-kpis">
              <div class="kpi">
                <div class="kpi-value">${Number(r.total).toLocaleString()}</div>
                <div class="kpi-label">כמות פשעים</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? fmtMaybe(r.pop) : "—"}</div>
                <div class="kpi-label">אוכלוסייה</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? fmtMaybe(r.rate) : "—"}</div>
                <div class="kpi-label">ל-10,000</div>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;

      const title = (metricType === "rate")
        ? `השוואה לפי ל-10,000 (${currentYear})`
        : `השוואה לפי כמות (${currentYear})`;

      html += `<div class="compare-bars-title">${title}</div>`;

      const values = rows
        .map(r => metricType === "rate" ? r.rate : r.total)
        .filter(v => Number.isFinite(Number(v)));

      const max = values.length ? Math.max(...values) : 0;

      rows.forEach(r => {
        const v = (metricType === "rate") ? r.rate : r.total;
        const vv = Number(v);
        const hasV = Number.isFinite(vv);
        const pct = (hasV && max > 0) ? Math.round((vv / max) * 100) : 0;
        const showText = hasV ? vv.toLocaleString() : "—";

        html += `
          <div class="bar-row" title="${escapeHtml(r.name)}">
            <div class="bar-name">${escapeHtml(r.name)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div class="bar-value">${showText}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // ===================== TRENDS =====================
    function showTrends(entityName, mode = currentMode) {
      const container = document.getElementById("trends-content");
      if (!container) return;

      if (!entityName) {
        container.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(mode)} במפה כדי לראות נתונים היסטוריים</div>`;
        return;
      }

      const dataset =
        (mode === "muni") ? window.crimeByYear :
        (mode === "merhav") ? window.crimeByYearMerhav :
        getStationsDataset();

      if (!dataset || typeof dataset !== "object") {
        container.innerHTML = `<div class="message message-error">אין נתוני היסטוריה זמינים עבור ${getModeLabel(mode)}.</div>`;
        return;
      }

      const years = Object.keys(dataset).sort();
      const targetVariants =
        (mode === "muni") ? Array.from(new Set(nameVariants(entityName).map(v => normalizeKey(v)).filter(Boolean))) :
        (mode === "station") ? stationNameVariants(entityName) :
        [normalizeKey(entityName)];

      const findEntryInYear = (yearData) => {
        if (!yearData) return null;

        if (yearData[entityName]) return { name: entityName, data: yearData[entityName] };

        for (const [k, d] of Object.entries(yearData)) {
          const kk = normalizeKey(k);
          if (targetVariants.includes(kk)) return { name: k, data: d };
        }
        return null;
      };

      // Find population (once) if muni
      let popOnce = null;
      if (mode === "muni") {
        for (const y of years) {
          const found = findEntryInYear(dataset[y]);
          const p = getPopulationForAuthority(found?.name || entityName);
          if (p != null) { popOnce = Number(p); break; }
        }
      }

      const metricType = (mode === "muni" && currentMetric === "rate" && popOnce != null) ? "rate" : "total";
      const metricLabel = (metricType === "rate") ? "ל-10,000" : "כמות";

      const yearly = years.map(y => {
        const found = findEntryInYear(dataset[y]);
        const total = Number(found?.data?.total || 0);
        const rate = (mode === "muni" && metricType === "rate") ? calcRatePer10k(total, popOnce) : null;
        return { year: y, total, rate };
      });

      const values = yearly.map(r => (metricType === "rate" ? r.rate : r.total)).filter(v => Number.isFinite(Number(v)));
      const max = values.length ? Math.max(...values) : 0;
      const min = values.length ? Math.min(...values) : 0;

      const latest = yearly[yearly.length - 1];
      const first = yearly[0];

      const latestV = (metricType === "rate") ? latest?.rate : latest?.total;
      const firstV  = (metricType === "rate") ? first?.rate : first?.total;
      const delta = (Number.isFinite(Number(latestV)) && Number.isFinite(Number(firstV))) ? (Number(latestV) - Number(firstV)) : null;

      const popLine = (mode === "muni" && popOnce != null) ? ` • אוכלוסייה (סטטית): <strong>${Number(popOnce).toLocaleString()}</strong>` : "";
      const popWarn = (mode === "muni" && popOnce == null) ? `<br><span style="opacity:.95;">אין נתון אוכלוסייה — לא מוצג חישוב ל‑10,000.</span>` : "";

      let html = `
        <div class="trend-shell">
          <div class="trend-top">
            <div class="trend-title">
              <span>${escapeHtml(entityName)}</span>
              <span style="font-weight:1000;opacity:.95;">${escapeHtml(getModeLabel(mode))}</span>
            </div>
            <div class="trend-sub">
              מציג לפי: <strong>${escapeHtml(metricLabel)}</strong>${popLine}${popWarn}
            </div>
            <div class="trend-kpis">
              <div class="trend-kpi">
                <div class="v">${fmtMaybe(latestV)}</div>
                <div class="l">שנה אחרונה (${escapeHtml(latest?.year)})</div>
              </div>
              <div class="trend-kpi">
                <div class="v">${delta == null ? "—" : (delta > 0 ? "+" : "") + Number(delta).toLocaleString()}</div>
                <div class="l">שינוי מול ${escapeHtml(first?.year)}</div>
              </div>
              <div class="trend-kpi">
                <div class="v">${fmtMaybe(min)} – ${fmtMaybe(max)}</div>
                <div class="l">טווח שנים</div>
              </div>
            </div>
          </div>

          <div class="trend-list">
      `;

      yearly.forEach(r => {
        const v = (metricType === "rate") ? r.rate : r.total;
        const vv = Number(v);
        const hasV = Number.isFinite(vv);
        const pct = (hasV && max > 0) ? Math.round((vv / max) * 100) : 0;

        const mainText = hasV ? vv.toLocaleString() : "—";
        const subText = (metricType === "rate") ? `כמות: ${Number(r.total || 0).toLocaleString()}` : "";

        html += `
          <div class="trow">
            <div class="y">${escapeHtml(r.year)}</div>
            <div class="tbar"><div class="tfill" style="width:${pct}%"></div></div>
            <div class="tval">${mainText}${subText ? `<small>${escapeHtml(subText)}</small>` : ""}</div>
          </div>
        `;
      });

      html += `
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // ===================== RANKINGS =====================
    function setRankingsOrder(order){
      rankingsOrder = (order === "asc") ? "asc" : "desc";
      const bDesc = document.getElementById("rankSortDesc");
      const bAsc  = document.getElementById("rankSortAsc");
      if (bDesc) bDesc.classList.toggle("active", rankingsOrder === "desc");
      if (bAsc)  bAsc.classList.toggle("active", rankingsOrder === "asc");
      renderRankings();
    }

    function setRankingsFilter(val){
      rankingsFilter = String(val || "").trim();
      renderRankings();
    }

    function renderRankings() {
      const container = document.getElementById("rankings-content");
      if (!container) return;

      const yearData = getYearDataByMode(currentMode, currentYear);

      if (!yearData) {
        container.innerHTML = `<div class="message message-error">אין נתונים לשנה הזו.</div>`;
        return;
      }

      const wantRate = (currentMode === "muni" && currentMetric === "rate");
      const rows = [];

      let skippedNoPop = 0;

      for (const name in yearData) {
        const d = yearData[name];
        const total = Number(d?.total || 0);

        if (wantRate) {
          const popRaw = getPopulationForAuthority(name);
          if (popRaw == null) { skippedNoPop++; continue; }
          const rate = calcRatePer10k(total, popRaw);
          if (rate == null) { skippedNoPop++; continue; }
          rows.push({ name, value: rate, extra: { pop: Number(popRaw), total } });
        } else {
          rows.push({ name, value: total, extra: { total } });
        }
      }

      const f = normalizeKey(rankingsFilter);
      const filtered = !f ? rows : rows.filter(r => normalizeKey(r.name).includes(f));

      filtered.sort((a,b)=>{
        const av = Number(a.value || 0);
        const bv = Number(b.value || 0);
        return (rankingsOrder === "asc") ? (av - bv) : (bv - av);
      });

      const metricLabel = wantRate ? "ל-10,000" : "כמות (אבסולוטי)";
      const orderLabel = (rankingsOrder === "asc") ? "מהכי מעט להכי הרבה" : "מהכי הרבה להכי מעט";

      let html = `
        <div class="rank-controls">
          <button id="rankSortDesc" class="rank-ctl-btn ${rankingsOrder === "desc" ? "active" : ""}" onclick="setRankingsOrder('desc')">⬇️ הכי הרבה → הכי מעט</button>
          <button id="rankSortAsc" class="rank-ctl-btn ${rankingsOrder === "asc" ? "active" : ""}" onclick="setRankingsOrder('asc')">⬆️ הכי מעט → הכי הרבה</button>
          <input class="rank-filter" placeholder="סינון לפי שם…" value="${escapeHtml(rankingsFilter)}" oninput="setRankingsFilter(this.value)" />
        </div>

        <div class="message message-info" style="margin-bottom:10px;">
          שנה: <strong>${escapeHtml(currentYear)}</strong> • מצב: <strong>${escapeHtml(getModeLabel(currentMode))}</strong><br>
          דירוג לפי: <strong>${escapeHtml(metricLabel)}</strong> • סדר: <strong>${escapeHtml(orderLabel)}</strong> • מוצגים: <strong>${filtered.length}</strong>
        </div>
      `;

      if (wantRate && skippedNoPop) {
        html += `<div class="message message-warn">לא הוצגו ${skippedNoPop.toLocaleString()} רשויות ללא נתון אוכלוסייה בדירוג ל‑10,000.</div>`;
      }

      html += `<div class="rank-list">`;

      filtered.forEach((r, idx) => {
        const valueText = Number(r.value || 0).toLocaleString();
        const extra =
          wantRate
            ? `<div class="rank-extra">כמות: ${Number(r.extra?.total || 0).toLocaleString()} • אוכלוסייה: ${Number(r.extra?.pop || 0).toLocaleString()}</div>`
            : ``;

        html += `
          <div class="rank-row" onclick="selectFromRank('${escapeHtml(r.name)}')">
            <div class="rank-num">${idx + 1}</div>
            <div class="rank-name">${escapeHtml(r.name)}</div>
            <div class="rank-value">${valueText}</div>
          </div>
          ${extra}
        `;
      });

      html += `</div>`;
      container.innerHTML = html;
    }

    function selectFromRank(name){
      try { switchTab("single"); } catch(_){}
      const index = getIndexByMode(currentMode);

      let entry = null;
      if (currentMode === "muni") {
        const k = normalizeKey(name);
        entry = index[k] || index[nameVariants(name)[0]] || null;
      } else if (currentMode === "station") {
        entry = index[normalizeKey(name)] || null;
        if (!entry) {
          const vars = stationNameVariants(name);
          for (const v of vars) { if (index[v]) { entry = index[v]; break; } }
        }
      } else {
        entry = index[normalizeKey(name)] || null;
      }

      if (!entry) {
        showInfo("לא נמצא", "לא הצלחתי למצוא את הישות בתוך האינדקס", "warn");
        return;
      }

      selectedEntityName = entry.name;
      selectedEntityKey = entry.key;

      showEntry(entry);
    }

    // ===================== GOVMAP CLICK HELPERS =====================
    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const obj = {};
      for (const f of fields) if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
      return obj;
    }

    function normalizeFieldName(n){
      return String(n ?? "")
        .trim()
        .replace(/\s+/g, " ")
        .replace(/[׳״"'`]/g, "")
        .replace(/[:;.,()\[\]{}<>!@#$%^&*+=?~\\|\/\-\u05be\u2010-\u2015]/g, "")
        .toLowerCase();
    }

    function getFieldFromAttrs(attrsRaw, candidates){
      const wanted = (candidates || []).map(normalizeFieldName);

      if (Array.isArray(attrsRaw)) {
        for (const f of attrsRaw) {
          const fn = normalizeFieldName(f?.FieldName ?? f?.fieldName ?? f?.name);
          if (!fn) continue;
          if (wanted.includes(fn)) return f?.Value ?? f?.value;
          for (const w of wanted) {
            if (fn.includes(w)) return f?.Value ?? f?.value;
          }
        }
      }

      const attrsObj = fieldsToObject(attrsRaw) || attrsRaw;
      if (!attrsObj || typeof attrsObj !== "object") return null;

      for (const c of (candidates || [])) {
        if (attrsObj[c] != null && String(attrsObj[c]).trim() !== "") return attrsObj[c];
      }

      const normMap = {};
      for (const k in attrsObj) normMap[normalizeFieldName(k)] = attrsObj[k];

      for (const w of wanted) {
        if (normMap[w] != null && String(normMap[w]).trim() !== "") return normMap[w];
      }

      return null;
    }

    function detectMunicipalityName(attrsRaw) {
      const candidates = ["שם רשות", "שם רשות מקומית", "שם ישוב", "ישוב סופי", "SHEM_YISHUV", "NAME", "Name"];
      const v = getFieldFromAttrs(attrsRaw, candidates);
      return (v == null) ? null : String(v).trim();
    }

    function detectMerhavName(attrsRaw) {
      const candidates = ["שם מרחב", "שם מרחב משטרתי", "MERHAV", "SHEM_MERHAV", "NAME", "Name"];
      const v = getFieldFromAttrs(attrsRaw, candidates);
      return (v == null) ? null : String(v).trim();
    }

    function detectStationName(attrsRaw) {
      const candidates = ["שם תחנה", "שם תחנת משטרה", "SHEM_TAHANA", "TAHANA", "STATION", "NAME", "Name"];
      const v = getFieldFromAttrs(attrsRaw, candidates);
      return (v == null) ? null : String(v).trim();
    }

    function normalizeMapPoint(input){
      const mp = input?.mapPoint ?? input?.Point ?? input ?? null;
      if (!mp) return null;

      const x = mp.x ?? mp.X ?? mp.lon ?? mp.Lon ?? mp.centerX ?? mp.CenterX;
      const y = mp.y ?? mp.Y ?? mp.lat ?? mp.Lat ?? mp.centerY ?? mp.CenterY;

      const nx = Number(x);
      const ny = Number(y);

      if (!Number.isFinite(nx) || !Number.isFinite(ny)) return null;
      return { x: nx, y: ny };
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      let pt = normalizeMapPoint(e);
      if (!pt && lastHoverMapPoint) pt = normalizeMapPoint(lastHoverMapPoint);

      if (!pt) {
        showInfo("רגע", "לא התקבלה נקודת מפה תקינה (X/Y). הזז עכבר על הרשות ואז לחץ.", "warn");
        return;
      }

      try {
        const layerName =
          (currentMode === "muni") ? MUNICIPAL_LAYER :
          (currentMode === "merhav") ? POLICE_MERHAV_LAYER :
          POLICE_STATION_LAYER;

        const resp = await govmap.getLayerData({
          LayerName: layerName,
          Point: { x: pt.x, y: pt.y, X: pt.x, Y: pt.y },
          Radius: 300
        });

        const items = resp?.data || resp?.Data || [];
        if (!items.length) {
          showInfo("לא נמצא", "אין אובייקט באזור זה", "info");
          return;
        }

        const first = items[0];
        const attrs = first.Fields || first.Attributes || first;
        const attrsObj = fieldsToObject(attrs) || attrs || {};
        const index = getIndexByMode(currentMode);

        if (currentMode === "muni") {
          const nameFromMap = detectMunicipalityName(attrsObj);
          if (!nameFromMap) { showInfo("שגיאה", "לא ניתן לזהות את שם הרשות", "error"); return; }

          const k = normalizeKey(nameFromMap);
          const entry = index[k] || index[nameVariants(nameFromMap)[0]] || null;
          if (!entry) { showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(nameFromMap)}</strong> בשנת ${currentYear}`, "error"); return; }

          selectedEntityName = entry.name;
          selectedEntityKey = entry.key;

          if (currentTab === "compare") updateCompareView();
          else if (currentTab === "trends") showTrends(selectedEntityName, "muni");
          else if (currentTab === "rankings") renderRankings();
          else showEntry(entry);
          return;
        }

        if (currentMode === "station") {
          const stationName = detectStationName(attrsObj);
          if (!stationName) {
            const keysList = Object.keys(attrsObj || {});
            showInfo("שגיאה",
              `לא הצלחתי לזהות <strong>שם תחנה</strong>.<br/>שדות: <              `לא הצלחתי לזהות <strong>שם תחנה</strong>.<br/>שדות קיימים: <code>${escapeHtml(keysList.join(", "))}</code>`,
              "error"
            );
            return;
          }

          // נסה למצוא את התחנה בדאטה לפי וריאציות
          let entry = index[normalizeKey(stationName)] || null;
          if (!entry) {
            for (const v of stationNameVariants(stationName)) {
              if (index[v]) { entry = index[v]; break; }
            }
          }

          if (!entry) {
            showInfo(
              "לא נמצאו נתונים",
              `אין נתוני פשיעה עבור <strong>${escapeHtml(stationName)}</strong> בשנת ${escapeHtml(currentYear)}.`,
              "error"
            );
            return;
          }

          selectedEntityName = entry.name;
          selectedEntityKey  = entry.key;

          if (currentTab === "compare") updateCompareView();
          else if (currentTab === "trends") showTrends(selectedEntityName, "station");
          else if (currentTab === "rankings") renderRankings();
          else showEntry(entry);
          return;
        }

        // MERHAV
        if (currentMode === "merhav") {
          const nameFromMap = detectMerhavName(attrsObj);
          if (!nameFromMap) {
            const keysList = Object.keys(attrsObj || {});
            showInfo(
              "שגיאה",
              `לא הצלחתי לזהות <strong>שם מרחב</strong>.<br/>שדות קיימים: <code>${escapeHtml(keysList.join(", "))}</code>`,
              "error"
            );
            return;
          }

          const k = normalizeKey(nameFromMap);
          const entry = index[k] || null;

          if (!entry) {
            showInfo(
              "לא נמצאו נתונים",
              `אין נתוני פשיעה עבור <strong>${escapeHtml(nameFromMap)}</strong> בשנת ${escapeHtml(currentYear)}.`,
              "error"
            );
            return;
          }

          selectedEntityName = entry.name;
          selectedEntityKey  = entry.key;

          if (currentTab === "compare") updateCompareView();
          else if (currentTab === "trends") showTrends(selectedEntityName, "merhav");
          else if (currentTab === "rankings") renderRankings();
          else showEntry(entry);
          return;
        }

      } catch (err) {
        console.error("❌ onMapClick error:", err);
        showInfo("שגיאה", "קרתה שגיאה בעת שליפת נתונים מהמפה.", "error");
      }
    }

    // ===================== GOVMAP INIT + EVENTS =====================
    function showLoading(on, text = "טוען…") {
      const el = document.getElementById("loading");
      const t  = document.getElementById("loadingText");
      if (!el) return;
      el.style.display = on ? "block" : "none";
      if (t) t.textContent = text;
    }

    function safeBindGovmapEvents(){
      // GovMap APIs משתנים בין גרסאות – ננסה כמה אפשרויות בלי לקרוס.
      try{
        if (typeof govmap.on === "function") {
          govmap.on("click", onMapClick);
          govmap.on("mouseMove", (e)=>{ lastHoverMapPoint = e; });
          return;
        }
      }catch(_){}

      try{
        if (typeof govmap.addEventListener === "function") {
          govmap.addEventListener("click", onMapClick);
          govmap.addEventListener("mouseMove", (e)=>{ lastHoverMapPoint = e; });
          return;
        }
      }catch(_){}

      console.warn("⚠️ לא הצלחתי לחבר אירועי click/mouseMove ל-govmap (API לא מזוהה).");
    }

    function initGovMap(){
      if (mapInitialized) return;

      if (typeof govmap === "undefined") {
        showInfo("שגיאה", "ספריית GovMap לא נטענה. ודא שיש לך script של govmap.api.js בקובץ.", "error");
        return;
      }

      showLoading(true, "מאתחל מפה…");

      try{
        govmap.createMap("map", {
          token: TOKEN,
          layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER, POLICE_STATION_LAYER],
          showXY: false,
          // חלק מהגרסאות מקבלות center/zoom. אם לא נתמך – יתעלם.
          center: { x: 186000, y: 664000 },
          zoom: 8
        });
      }catch(err){
        console.warn("⚠️ createMap options might differ. Trying minimal createMap…", err);
        try{
          govmap.createMap("map", { token: TOKEN });
        }catch(e2){
          console.error("❌ createMap failed:", e2);
          showLoading(false);
          showInfo("שגיאה", "נכשל אתחול המפה (createMap).", "error");
          return;
        }
      }

      mapInitialized = true;

      // קבע שכבה התחלתית: רשויות
      try{
        if (typeof govmap.setVisibleLayers === "function") {
          govmap.setVisibleLayers([MUNICIPAL_LAYER], [POLICE_MERHAV_LAYER, POLICE_STATION_LAYER]);
        }
      }catch(_){}

      safeBindGovmapEvents();
      showLoading(false);

      // מסך פתיחה
      updateHeaderModeLine();
      updateMetricButtonsUI();
      updateQuickStats();

      showInfo(
        "מפה לפי " + getModeLabel(currentMode),
        `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(currentMode)} במפה כדי לראות נתונים`,
        "info"
      );
    }

    // ===================== YEAR SELECT =====================
    function initYearSelect(){
      const sel = document.getElementById("yearSelect");
      if (!sel) return;

      // נסה לקרוא שנים מתוך הדאטה בפועל
      const years = new Set();
      Object.keys(window.crimeByYear || {}).forEach(y => years.add(y));
      Object.keys(window.crimeByYearMerhav || {}).forEach(y => years.add(y));
      const sds = getStationsDataset();
      Object.keys(sds || {}).forEach(y => years.add(y));

      const sorted = Array.from(years).sort();
      sel.innerHTML = sorted.map(y => `<option value="${escapeHtml(y)}">${escapeHtml(y)}</option>`).join("");
      sel.value = String(currentYear);

      sel.addEventListener("change", ()=>{
        currentYear = sel.value;
        buildAllIndexesForYear(currentYear);
        updateQuickStats();

        // נקה בחירות
        selectedEntityName = null;
        selectedEntityKey  = null;

        if (currentTab === "compare") updateCompareView();
        else if (currentTab === "rankings") renderRankings();
        else if (currentTab === "trends") {
          const tc = document.getElementById("trends-content");
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(currentMode)} במפה כדי לראות נתונים היסטוריים</div>`;
        } else {
          showInfo(
            "מפה לפי " + getModeLabel(currentMode),
            `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(currentMode)} במפה כדי לראות נתונים`,
            "info"
          );
        }
      });
    }

    // ===================== PANEL / TABS INIT =====================
    function initTabs(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=> switchTab(t.dataset.tab));
      });
    }

    function initHeaderButtons(){
      const toggleBtn = document.getElementById("panelToggleBtn");
      const panel = document.getElementById("info-panel");
      if (toggleBtn && panel) {
        toggleBtn.addEventListener("click", ()=>{
          panel.classList.toggle("collapsed");
          const isCollapsed = panel.classList.contains("collapsed");
          toggleBtn.textContent = isCollapsed ? "הגדל" : "הקטן";
        });
      }

      const searchBtn = document.getElementById("searchBtn");
      const searchModal = document.getElementById("searchModal");
      const searchClose = document.getElementById("searchClose");
      if (searchBtn && searchModal) searchBtn.addEventListener("click", ()=>{ searchModal.style.display="block"; });
      if (searchClose && searchModal) searchClose.addEventListener("click", ()=>{ searchModal.style.display="none"; });

      const aboutBtn = document.getElementById("aboutBtn");
      const aboutModal = document.getElementById("aboutModal");
      const aboutClose = document.getElementById("aboutClose");
      if (aboutBtn && aboutModal) aboutBtn.addEventListener("click", ()=>{ aboutModal.style.display="block"; });
      if (aboutClose && aboutModal) aboutClose.addEventListener("click", ()=>{ aboutModal.style.display="none"; });

      // סגירה בלחיצה על רקע
      document.querySelectorAll(".modal").forEach(m=>{
        m.addEventListener("click", (e)=>{
          if (e.target.classList.contains("modalOverlay")) m.style.display = "none";
        });
      });
    }

    // ===================== MODE BUTTONS =====================
    function initModeButtons(){
      const bm = document.getElementById("btnModeMuni");
      const br = document.getElementById("btnModeMerhav");
      const bs = document.getElementById("btnModeStation");
      if (bm) bm.addEventListener("click", ()=> setMode("muni"));
      if (br) br.addEventListener("click", ()=> setMode("merhav"));
      if (bs) bs.addEventListener("click", ()=> setMode("station"));
    }

    function initMetricButtons(){
      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");
      if (bAbs) bAbs.addEventListener("click", ()=> setMetric("abs"));
      if (bRate) bRate.addEventListener("click", ()=> setMetric("rate"));
      updateMetricButtonsUI();
    }

    // ===================== CHORO BUTTON (UI STUB) =====================
    // (כאן שמתי סטאב כדי שהקובץ לא יקרוס. אם אצלך יש פונקציות צביעה קיימות – תוכל לחבר אותן לפה.)
    function setChoroBtnUI(){
      const btn = document.getElementById("choroBtn");
      if (!btn) return;
      const muniOnly = (currentMode === "muni");
      btn.disabled = !muniOnly;
      btn.classList.toggle("disabled", !muniOnly);
      btn.textContent = choroplethEnabled ? "כיבוי צביעה" : "צביעה";
      btn.title = muniOnly ? "צביעה לפי המדד הנבחר" : "צביעה זמינה רק במצב ישובים/רשויות";
    }
    function clearChoropleth(){
      // נסה לנקות גיאומטריות אם ה-API קיים; אחרת לא עושה כלום.
      try{
        if (typeof govmap.clearGeometries === "function") govmap.clearGeometries(CHORO_PREFIX);
      }catch(_){}
      try{
        if (typeof govmap.clearGraphics === "function") govmap.clearGraphics(CHORO_PREFIX);
      }catch(_){}
    }
    function setMunicipalLayerOpacity(v){
      // אם אין API תואם, לא יקרה כלום.
      try{
        if (typeof govmap.setLayerOpacity === "function") govmap.setLayerOpacity(MUNICIPAL_LAYER, v);
      }catch(_){}
    }
    function renderChoropleth(){
      // כדי שלא יקרוס – מציג הודעה. (אם תרצה, נחבר את זה ל-GeoJSON + displayGeometries אצלך.)
      showInfo("צביעה", "כרגע כפתור הצביעה פעיל אך פונקציית הצביעה לא מחוברת בגרסה הזו. אם תרצה – אחבר אותה ל-GeoJSON המקומי שלך.", "warn");
    }
    function toggleChoropleth(){
      if (currentMode !== "muni") return;
      choroplethEnabled = !choroplethEnabled;
      if (!choroplethEnabled) {
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      } else {
        setMunicipalLayerOpacity(40);
        renderChoropleth();
      }
      setChoroBtnUI();
    }

    // ===================== ADDRESS SEARCH (UI STUB) =====================
    function initSearchUI(){
      const input = document.getElementById("addrInput");
      const results = document.getElementById("addrResults");
      const hint = document.getElementById("addrHint");
      if (!input || !results) return;

      input.addEventListener("input", ()=>{
        const q = String(input.value || "").trim();
        if (hint) hint.textContent = q ? "חיפוש כתובת: (סטאב — אם תרצה נחבר לג׳אוקוד של GovMap)" : "כתוב כתובת כדי לחפש";
        results.style.display = "none";
        results.innerHTML = "";
      });
    }

    // ===================== BOOTSTRAP =====================
    function bootstrap(){
      // בדיקות דאטה בסיסיות
      buildPopulationIndex();
      buildAllIndexesForYear(currentYear);

      initTabs();
      initHeaderButtons();
      initYearSelect();
      initModeButtons();
      initMetricButtons();
      initSearchUI();

      // מצב ברירת מחדל
      setMode(currentMode);
      switchTab("single");

      // אתחול מפה
      initGovMap();

      // כפתור צביעה
      const ch = document.getElementById("choroBtn");
      if (ch) ch.addEventListener("click", toggleChoropleth);
      setChoroBtnUI();
    }

    document.addEventListener("DOMContentLoaded", bootstrap);
  </script>
</head>

<body>
  <div id="map"></div>

  <!-- LOADING -->
  <div id="loading" style="display:none;">
    <div class="spinner"></div>
    <div id="loadingText" style="font-weight:1000;">טוען…</div>
  </div>

  <!-- PANEL -->
  <div id="info-panel">
    <div id="panel-header">
      <h1>מפת פשיעה (2020–2025)</h1>
      <p>מצב נוכחי: <strong>ישובים/רשויות</strong><br>לחץ על ישות במפה כדי לראות נתונים</p>

      <div id="header-actions">
        <button id="panelToggleBtn" class="hbtn secondary" title="הקטן/הגדל">הקטן</button>
        <button id="choroBtn" class="hbtn" title="צביעה">צביעה</button>
        <button id="searchBtn" class="hbtn secondary" title="חיפוש כתובת">חיפוש</button>
        <button id="aboutBtn" class="hbtn secondary" title="אודות">אודות</button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single">נתוני ישות</div>
      <div class="tab" data-tab="compare">השוואה</div>
      <div class="tab" data-tab="trends">מגמות</div>
      <div class="tab" data-tab="rankings">דירוגים</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <div id="btnModeMuni" class="mode-btn active">ישובים/רשויות</div>
        <div id="btnModeMerhav" class="mode-btn">מרחבים</div>
        <div id="btnModeStation" class="mode-btn full">תחנות משטרה</div>
      </div>

      <div id="controls-row">
        <label for="yearSelect">שנה:</label>
        <select id="yearSelect"></select>
      </div>

      <div class="mode-grid" style="margin-bottom:10px;">
        <div id="btnMetricAbs" class="mode-btn active">כמות</div>
        <div id="btnMetricRate" class="mode-btn">ל-10,000</div>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div id="stat-municipalities" class="stat-value">0</div>
          <div id="stat-entities-label" class="stat-label">רשויות</div>
        </div>
        <div class="stat-card">
          <div id="stat-total" class="stat-value">0</div>
          <div class="stat-label">סה״כ אירועים</div>
        </div>
        <div class="stat-card">
          <div id="stat-avg" class="stat-value">0</div>
          <div class="stat-label">ממוצע לישות</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div id="tab-single" class="tab-content active">
        <div id="info-title">מפה לפי ישובים/רשויות</div>
        <div id="info-body" class="tab-inner"></div>
      </div>

      <div id="tab-compare" class="tab-content">
        <div id="compare-content"></div>
      </div>

      <div id="tab-trends" class="tab-content">
        <div id="trends-content"></div>
      </div>

      <div id="tab-rankings" class="tab-content">
        <div id="rankings-content"></div>
      </div>
    </div>
  </div>

  <!-- SEARCH MODAL -->
  <div id="searchModal" class="modal" aria-hidden="true">
    <div class="modalOverlay"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalHeaderTitle">חיפוש כתובת</div>
        <button id="searchClose" class="modalClose" aria-label="סגור">×</button>
      </div>
      <div class="modalBody">
        <div class="message message-info" id="addrHint">כתוב כתובת כדי לחפש</div>
        <input id="addrInput" class="rank-filter" style="width:100%;padding:12px;" placeholder="לדוגמה: עינת, רחוב…"/>
        <div id="addrResults"></div>
      </div>
    </div>
  </div>

  <!-- ABOUT MODAL -->
  <div id="aboutModal" class="modal" aria-hidden="true">
    <div class="modalOverlay"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalHeaderTitle">אודות</div>
        <button id="aboutClose" class="modalClose" aria-label="סגור">×</button>
      </div>
      <div class="modalBody">
        <div class="message message-info">
          קובץ זה מציג נתוני פשיעה לפי שנה (2020–2025) בשלושה מצבים: רשויות / מרחבים / תחנות.
          <br><br>
          הערה: כפתור "צביעה" מוגדר כסטאב בקוד הזה כדי שלא יקרוס. אם תרצה – נחבר אותו ל-GeoJSON המקומי שלך ול-displayGeometries.
        </div>
      </div>
    </div>
  </div>

  <!-- GovMap API -->
  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>
</body>
</html>

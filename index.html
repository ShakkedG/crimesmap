<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>מפת פשיעה לפי רשויות מקומיות</title>

  <!-- קודם: קובץ הדאטה crimeDB.js -->
  <!-- חייב להכיל:  const crimeDB = { ... };  בלי export -->
  <script src="crimeDB.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      direction: rtl;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 280px;
      max-width: 360px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-size: 14px;
    }

    #info-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 15px;
    }

    #info-body {
      white-space: pre-line;
      line-height: 1.4;
      max-height: 60vh;
      overflow-y: auto;
    }
  </style>

  <!-- קוד המפה -->
  <script type="text/javascript">
    const MUNICIPAL_LAYER = "125"; // רשויות מקומיות
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let mapInitialized = false;
    const crimeIndex = {};
    let detectedMunicipalityField = null;

    // --- נירמול שמות רשויות (מוריד "מועצה אזורית", "עיריית" וכו') ---
    function normalizeName(name) {
      let s = (name || "").toString().trim();

      s = s
        .replace(/^מועצה\s+אזורית\s+/, "")
        .replace(/^מועצה\s+מקומית\s+/, "")
        .replace(/^עיריית\s+/, "")
        .replace(/^עיריה\s+/, "");

      s = s
        .replace(/["׳״']/g, "")
        .replace(/[\s\-]/g, "")
        .toLowerCase();

      return s;
    }

    // --- בונה אינדקס מה-crimeDB לפי שם מנורמל ---
    function buildCrimeIndex() {
      if (typeof crimeDB === "undefined") {
        console.error("crimeDB לא מוגדר. ודא ש-crimeDB.js נטען לפני הסקריפט ושאין בו export.");
        return;
      }

      for (const key of Object.keys(crimeDB)) {
        const norm = normalizeName(key);
        crimeIndex[norm] = { name: key, data: crimeDB[key] };
      }

      console.log("crimeIndex built:", Object.keys(crimeIndex).length, "entries");
    }

    // --- חיפוש התאמה לרשות ב-crimeIndex עם קצת גמישות ---
    function findCrimeEntry(muniName) {
      const norm = normalizeName(muniName);

      // התאמה מדויקת
      if (crimeIndex[norm]) return crimeIndex[norm];

      // התאמה חלקית – אם אחת המחרוזות היא סיומת של השניה
      let best = null;
      for (const key in crimeIndex) {
        if (key === norm) return crimeIndex[key];
        if (!best && (key.endsWith(norm) || norm.endsWith(key))) {
          best = crimeIndex[key];
        }
      }
      return best;
    }

    // --- יצירת המפה ורישום לאירוע CLICK ---
    function initGovMap() {
      buildCrimeIndex();

      function listener() {
        govmap
          .onEvent(govmap.events.CLICK)
          .progress(onMapClick);
      }

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER],
        background: 2,
        layersMode: 1,
        zoomButtons: true,
        showXY: true,
        identifyOnClick: false,
        onLoad: () => listener()
      });

      mapInitialized = true;
      console.log("GovMap ready (layer", MUNICIPAL_LAYER, ")");
    }

    // --- קליק על המפה ---
    async function onMapClick(e) {
      if (!mapInitialized) return;

      const x = e.mapPoint.x;
      const y = e.mapPoint.y;

      const params = {
        LayerName: MUNICIPAL_LAYER,
        Point: { x, y },
        Radius: 250 // רדיוס גדול יותר כדי לתפוס גם לחיצות קרובות לגבול
      };

      try {
        const resp = await govmap.getLayerData(params);
        console.log("getLayerData:", resp);

        const items =
          resp.data ||
          resp.Data ||
          resp.entities ||
          resp.Entities ||
          resp.features ||
          [];

        if (!items.length) {
          showInfo("לא נמצאה רשות מקומית", "אין רשות מקומית בנקודה הזו או שהשכבה אינה פעילה ברמת הזום הנוכחית.");
          return;
        }

        const feature = items[0];
        const attrs =
          feature.Attributes ||
          feature.attributes ||
          feature.fields ||
          feature.Fields ||
          feature;

        console.log("feature attrs:", attrs);

        const muniName = detectMunicipalityName(attrs);

        if (!muniName) {
          showInfo("לא זוהה שם רשות", "לא נמצא שדה מתאים לשם רשות מקומית באטריביוטים.");
          return;
        }

        const crimeEntry = findCrimeEntry(muniName);

        if (!crimeEntry) {
          showInfo(
            `רשות מקומית: ${muniName}`,
            "לא נמצאו נתוני פשיעה בקובץ crimeDB עבור רשות זו."
          );
          return;
        }

        const title = `רשות מקומית: ${crimeEntry.name}`;
        const lines = [];
        const data = crimeEntry.data;

        if (typeof data === "object" && data !== null) {
          if (typeof data.total !== "undefined") {
            lines.push(`סה"כ אירועים: ${data.total}`);
            lines.push("");
          }

          if (typeof data.breakdown === "object" && data.breakdown !== null) {
            lines.push("פירוט לפי קבוצת עבירה:\n");
            for (const k of Object.keys(data.breakdown)) {
              lines.push(`• ${k}: ${data.breakdown[k]}`);
            }
          }
        } else {
          lines.push(String(data));
        }

        showInfo(title, lines.join("\n"));

      } catch (err) {
        console.error("getLayerData error:", err);
        showInfo("שגיאה", err.message || String(err));
      }
    }

    // --- זיהוי שדה שם הרשות מתוך האטריביוטים ---
    function detectMunicipalityName(attrs) {
      if (!attrs) return null;

      if (detectedMunicipalityField && attrs[detectedMunicipalityField]) {
        return attrs[detectedMunicipalityField];
      }

      // קודם: מנסים למצוא ערך שעבורו יש התאמה ב-crimeIndex
      for (const key of Object.keys(attrs)) {
        const val = attrs[key];
        if (typeof val !== "string") continue;
        if (!/[\u0590-\u05FF]/.test(val)) continue;

        const norm = normalizeName(val);
        if (crimeIndex[norm]) {
          detectedMunicipalityField = key;
          console.log("Detected municipality field:", key, "=>", val);
          return val;
        }
      }

      // fallback: השדה העברי הראשון
      for (const key of Object.keys(attrs)) {
        const val = attrs[key];
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          detectedMunicipalityField = key;
          console.log("Fallback municipality field:", key, "=>", val);
          return val;
        }
      }

      return null;
    }

    // --- עדכון הפאנל ---
    function showInfo(title, body) {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").textContent = body;
    }
  </script>

  <!-- טעינת GOVMAP בסוף, מפעיל initGovMap -->
  <script
    src="https://www.govmap.gov.il/govmap/api/govmap.api.js"
    defer
    onload="initGovMap()">
  </script>

</head>

<body>
  <div id="map"></div>

  <div id="info-panel">
    <div id="info-title">מפת פשיעה לפי רשות</div>
    <div id="info-body">
      לחץ על רשות מקומית במפה כדי לראות נתונים מהקובץ crimeDB.
    </div>
  </div>
</body>
</html>

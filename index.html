<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפת פשיעה משופרת – מהירות מקסימלית</title>

  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <style>
    /* שמרתי על ה-CSS שלך והוספתי שיפור קטן לנראות הגרפים */
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; background: #f5f5f5; }
    #map { width: 100%; height: 100%; position: relative; }
    .esri-layer-list, .esri-legend { display: none !important; }

    #info-panel {
      position: absolute; top: 15px; left: 15px; z-index: 9999;
      background: rgba(255, 255, 255, 0.98); width: 450px;
      max-height: calc(100vh - 30px); box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
    }

    #panel-header { background: linear-gradient(135deg, #0066cc 0%, #004d99 100%); color: white; padding: 20px; }
    #panel-header h1 { margin: 0; font-size: 18px; }

    #tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #eee; }
    .tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-weight: 600; color: #666; transition: 0.2s; }
    .tab.active { background: white; color: #0066cc; border-bottom: 3px solid #0066cc; }

    #controls { padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
    .mode-switch { display: flex; gap: 8px; margin-top: 10px; }
    .mode-btn { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; font-weight: 700; }
    .mode-btn.active { background: #0066cc; color: white; border-color: #0066cc; }

    #info-content { padding: 20px; overflow-y: auto; flex: 1; }
    .total-summary { font-size: 26px; font-weight: 900; color: #0066cc; text-align: center; padding: 20px; background: #f0f7ff; border-radius: 10px; margin-bottom: 15px; }
    
    .crime-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .crime-item { background: #fcfcfc; padding: 12px; border-radius: 8px; border-right: 4px solid #0066cc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .crime-name { font-size: 12px; font-weight: 700; margin-bottom: 4px; }
    .crime-count { font-size: 16px; font-weight: 900; color: #0066cc; }

    /* טרנדים ויזואליים */
    .trend-container { margin-top: 10px; }
    .trend-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .trend-label { width: 50px; font-size: 12px; font-weight: 700; }
    .trend-bar-bg { flex: 1; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; }
    .trend-bar-fill { height: 100%; background: #0066cc; transition: width 0.6s ease-out; }

    .message { padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.5; border-right: 5px solid; }
    .message-info { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }

    @media (max-width: 768px) { #info-panel { width: calc(100% - 30px); left: 15px; } }
  </style>
</head>
<body>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>מפת פשיעה בישראל</h1>
      <p id="header-subtitle">טוען נתונים...</p>
    </div>

    <div id="tabs">
      <div class="tab active" onclick="switchTab('single')" data-tab="single">נתונים</div>
      <div class="tab" onclick="switchTab('trends')" data-tab="trends">טרנדים</div>
      <div class="tab" onclick="switchTab('compare')" data-tab="compare">השוואה</div>
    </div>

    <div id="controls">
      <div style="display:flex; align-items:center; gap:10px;">
        <label>שנה:</label>
        <select id="yearSelect" onchange="updateYear(this.value)" style="flex:1; padding:8px; border-radius:6px;">
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
          <option value="2021">2021</option>
          <option value="2020">2020</option>
        </select>
      </div>
      <div class="mode-switch">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')">ישובים</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">מרחבים</button>
      </div>
    </div>

    <div id="info-content">
        <div id="info-title" style="font-weight:900; font-size:18px; margin-bottom:15px; color:#333;">בחר אזור במפה</div>
        <div id="info-body"></div>
    </div>
  </div>

  <script>
    // --- ניהול נתונים מרכזי (Data Store) ---
    const Store = {
      muniIndex: new Map(),
      merhavIndex: new Map(),
      popIndex: new Map(),
      currentYear: "2025",
      currentMode: "muni", // muni | merhav
      selectedEntity: null,
      normCache: new Map()
    };

    // --- נורמליזציה מהירה עם Cache ---
    function fastNormalize(name) {
      if (!name) return "";
      if (Store.normCache.has(name)) return Store.normCache.get(name);
      
      const clean = String(name).trim()
        .replace(/[׳״"']/g, "")
        .replace(/[(){}\[\],.:\-]/g, "")
        .replace(/\s+/g, "")
        .toLowerCase();
      
      Store.normCache.set(name, clean);
      return clean;
    }

    // יצירת וריאנטים לשמות (עיריית/מועצה וכו')
    function getNameVariants(name) {
      const raw = String(name).trim();
      const base = raw.replace(/^(עיריית|עיריה|מועצה מקומית|מועצה אזורית)\s+/g, "");
      return [fastNormalize(raw), fastNormalize(base)];
    }

    // --- בניית האינדקסים בטעינה ראשונה ---
    function initDataIndices() {
      console.time("Indexing Performance");
      
      // 1. אוכלוסייה
      if (window.PopulationDB) {
        for (const [name, pop] of Object.entries(window.PopulationDB)) {
          const variants = getNameVariants(name);
          variants.forEach(v => Store.popIndex.set(v, Number(pop)));
        }
      }

      // 2. פשיעה ישובים
      if (window.crimeByYear) {
        for (const [year, cities] of Object.entries(window.crimeByYear)) {
          for (const [cityName, data] of Object.entries(cities)) {
            const variants = getNameVariants(cityName);
            variants.forEach(v => {
              if (!Store.muniIndex.has(v)) Store.muniIndex.set(v, { name: cityName, history: {} });
              Store.muniIndex.get(v).history[year] = data;
            });
          }
        }
      }

      // 3. פשיעה מרחבים
      if (window.crimeByYearMerhav) {
        for (const [year, districts] of Object.entries(window.crimeByYearMerhav)) {
          for (const [distName, data] of Object.entries(districts)) {
            const norm = fastNormalize(distName);
            if (!Store.merhavIndex.has(norm)) Store.merhavIndex.set(norm, { name: distName, history: {} });
            Store.merhavIndex.get(norm).history[year] = data;
          }
        }
      }

      console.timeEnd("Indexing Performance");
      document.getElementById("header-subtitle").innerText = "הנתונים מוכנים לשימוש";
    }

    // --- פונקציות UI ---

    function showEntityData(entityName) {
      Store.selectedEntity = entityName;
      const norm = fastNormalize(entityName);
      const index = Store.currentMode === 'muni' ? Store.muniIndex : Store.merhavIndex;
      const entry = index.get(norm);

      if (!entry || !entry.history[Store.currentYear]) {
        document.getElementById("info-title").innerText = entityName;
        document.getElementById("info-body").innerHTML = `<div class="message message-info">לא נמצאו נתונים לשנת ${Store.currentYear}</div>`;
        return;
      }

      const data = entry.history[Store.currentYear];
      const pop = Store.popIndex.get(norm);
      
      let html = `<div class="total-summary">${data.total.toLocaleString()} אירועים</div>`;
      if (pop) html += `<div style="text-align:center; margin-top:-10px; margin-bottom:15px; color:#666; font-size:13px;">אוכלוסייה: ${pop.toLocaleString()}</div>`;

      if (data.breakdown) {
        const sorted = Object.entries(data.breakdown).sort((a,b) => b[1] - a[1]);
        html += `<div class="crime-grid">`;
        html += sorted.map(([type, count]) => `
          <div class="crime-item">
            <div class="crime-name">${type}</div>
            <div class="crime-count">${count.toLocaleString()}</div>
          </div>
        `).join('');
        html += `</div>`;
      }

      document.getElementById("info-title").innerText = entry.name;
      document.getElementById("info-body").innerHTML = html;
    }

    function showTrends() {
      if (!Store.selectedEntity) {
        document.getElementById("info-body").innerHTML = `<div class="message message-info">בחר אזור במפה כדי לראות טרנדים</div>`;
        return;
      }

      const norm = fastNormalize(Store.selectedEntity);
      const index = Store.currentMode === 'muni' ? Store.muniIndex : Store.merhavIndex;
      const entry = index.get(norm);
      
      if (!entry) return;

      const history = Object.entries(entry.history).sort((a,b) => a[0] - b[0]);
      const maxVal = Math.max(...history.map(h => h[1].total));

      let html = `<h3>מגמת פשיעה שנתית</h3><div class="trend-container">`;
      html += history.map(([year, data]) => {
        const width = (data.total / maxVal) * 100;
        return `
          <div class="trend-row">
            <div class="trend-label">${year}</div>
            <div class="trend-bar-bg"><div class="trend-bar-fill" style="width:${width}%"></div></div>
            <div style="font-size:12px; font-weight:700;">${data.total.toLocaleString()}</div>
          </div>
        `;
      }).join('');
      html += `</div>`;

      document.getElementById("info-body").innerHTML = html;
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
      
      if (tab === 'single') showEntityData(Store.selectedEntity || "");
      if (tab === 'trends') showTrends();
      if (tab === 'compare') document.getElementById("info-body").innerHTML = "השוואה תתווסף כאן";
    }

    function setMode(mode) {
      Store.currentMode = mode;
      document.getElementById("btnModeMuni").classList.toggle("active", mode === 'muni');
      document.getElementById("btnModeMerhav").classList.toggle("active", mode === 'merhav');
      
      // כאן תוסיף את הקריאה ל-govmap.setVisibleLayers כפי שהיה לך
      console.log("Switching to mode:", mode);
    }

    function updateYear(year) {
      Store.currentYear = year;
      if (Store.selectedEntity) showEntityData(Store.selectedEntity);
    }

    // --- אתחול ---
    window.onload = () => {
      initDataIndices();
      // אתחול המפה שלך כאן...
    };

    // סימולציה של לחיצה על המפה (לצורך בדיקה)
    // showEntityData("תל אביב - יפו");

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×©× ×” (2020â€“2025) | ×™×©×•×‘×™× / ××¨×—×‘×™×</title>

  <!-- DATA -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <!-- OPTIONAL: boundaries can be provided as JS const MUNI_DATA = {type:'FeatureCollection',features:[...]} -->
  <script src="muni_boundaries.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Arial,system-ui;overflow:hidden;background:#f5f5f5}
    #map{width:100%;height:100%}
    #panel{
      position:absolute;top:12px;left:12px;z-index:9999;
      width:380px;max-height:calc(100vh - 24px);overflow:hidden;
      background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.18);
      display:flex;flex-direction:column
    }
    #panel header{padding:12px 14px;background:#0b63c7;color:#fff}
    #panel header .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button,select,input{font:inherit}
    .btn{
      border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.12);
      color:#fff;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer
    }
    .btn.secondary{background:rgba(0,0,0,.12)}
    #controls{padding:12px 14px;background:#fafafa;border-bottom:1px solid #e5e5e5}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .mode{
      background:#fff;border:1px solid #ddd;border-radius:10px;
      padding:10px;font-weight:900;cursor:pointer
    }
    .mode.active{background:#0b63c7;color:#fff;border-color:#0b63c7}
    .mode.disabled{opacity:.55;cursor:not-allowed;pointer-events:none}
    #content{padding:12px 14px;overflow:auto}
    .msg{background:#e7f3ff;border-right:4px solid #0b63c7;padding:10px 12px;border-radius:10px;color:#08335f;font-weight:800;line-height:1.5}
    .title{font-weight:900;font-size:16px;color:#222;margin:0 0 10px 0}
    .kpi{font-size:26px;font-weight:900;color:#0b63c7;text-align:center;padding:10px;border:1px solid #b3d9ff;border-radius:12px;background:#f0f7ff;margin:10px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .item{border:1px solid #e6e6e6;background:#fafafa;border-radius:12px;padding:10px}
    .item .n{font-weight:900;color:#222}
    .item .v{font-weight:900;color:#0b63c7;font-size:18px;margin-top:6px}
    #loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(245,245,245,.7);z-index:20000
    }
    #loading>div{background:#fff;border-radius:14px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.2);font-weight:900}
    @media (max-width:768px){
      #panel{left:0;right:0;top:auto;bottom:0;width:100%;max-height:none;height:60vh;border-radius:18px 18px 0 0}
      .grid2{grid-template-columns:1fr}
    }
  </style>

  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";
    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    let mapInitialized=false;
    let currentYear="2025";
    let currentMode="muni";   // muni | merhav
    let currentMetric="abs";  // abs | rate
    let selectedName=null;

    const muniIndex = {};
    const merhavIndex = {};
    const populationIndex = {};
    const variantsCache = new Map();

    // choropleth
    let choroplethEnabled=false;
    const CHORO_NAME="crime_rate_choropleth";
    let activeChoroplethNames=[];
    let muniBoundariesLoaded=false;
    let muniBoundariesLoadError=null;
    let muniBoundariesIndex={}; // normalizedKey->WKT
    let muniBoundariesMeta=[];  // [{name,wkt}]

    // ---------- normalize + variants ----------
    function normalizeKeyBase(name){
      if(name==null) return "";
      let s=String(name).trim();
      s=s.replace(/[×³×´"']/g,"").replace(/[(){}\[\],.:]/g,"").replace(/Ö¾/g,"-").replace(/\s+/g," ").trim();
      s=s.replace(/[\s\-]/g,"");
      return s.toLowerCase();
    }
    function normalizeKey(name){ return normalizeKeyBase(name); }

    function nameVariants(name){
      if(!name) return [];
      if(variantsCache.has(name)) return variantsCache.get(name);
      const raw=String(name).trim();
      const a=raw.replace(/^×¢×™×¨×™×™×ª\s+/g,"").replace(/^×¢×™×¨×™×”\s+/g,"");
      const b=a.replace(/^××•×¢×¦×”\s+××§×•××™×ª\s+/g,"");
      const c=b.replace(/^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g,"");
      const variants=[raw,a,b,c].map(normalizeKeyBase).filter(Boolean);
      variantsCache.set(name, variants);
      return variants;
    }

    // ---------- population ----------
    function buildPopulationIndex(){
      for(const k in populationIndex) delete populationIndex[k];
      const raw=window.PopulationDB;
      if(!raw || typeof raw!=="object") return;
      for(const displayName in raw){
        const pop=Number(raw[displayName]);
        if(!Number.isFinite(pop)) continue;
        for(const v of nameVariants(displayName)) populationIndex[v]=pop;
      }
    }
    function getPopulationForAuthority(name){
      for(const v of nameVariants(name)){
        const pop=populationIndex[v];
        if(pop!=null) return pop;
      }
      return null;
    }
    function calcRatePer10k(total,pop){
      const t=Number(total); const p=Number(pop);
      if(!Number.isFinite(t) || !Number.isFinite(p) || p<=0) return 0;
      return Math.round((t/p)*10000*10)/10;
    }

    // ---------- indexes ----------
    function buildMuniIndexForYear(year){
      for(const k in muniIndex) delete muniIndex[k];
      const yd=window.crimeByYear?.[year];
      if(!yd) return;
      for(const name in yd){
        const entry={name, data: yd[name]};
        for(const v of nameVariants(name)) if(!muniIndex[v]) muniIndex[v]=entry;
      }
    }
    function buildMerhavIndexForYear(year){
      for(const k in merhavIndex) delete merhavIndex[k];
      const yd=window.crimeByYearMerhav?.[year];
      if(!yd) return;
      for(const name in yd){
        merhavIndex[normalizeKey(name)]={name, data: yd[name]};
      }
    }

    // ---------- UI ----------
    function $(id){ return document.getElementById(id); }
    function escapeHtml(s){
      return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
    function setMessage(title, html){
      $("title").textContent = title;
      $("body").innerHTML = html;
    }
    function updateMetricButtons(){
      const btnRate=$("btnRate");
      if(!btnRate) return;
      const ok = currentMode==="muni";
      btnRate.classList.toggle("disabled", !ok);
      btnRate.disabled = !ok;
      if(!ok && currentMetric==="rate") setMetric("abs");
    }
    function setMode(mode){
      currentMode=mode;
      $("btnMuni").classList.toggle("active", mode==="muni");
      $("btnMerhav").classList.toggle("active", mode==="merhav");

      updateMetricButtons();

      // if switching away from muni, force choropleth off
      if(mode!=="muni"){
        choroplethEnabled=false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        setChoroBtnUI();
      }

      // layer visibility
      if(mapInitialized && typeof govmap.setVisibleLayers==="function"){
        try{
          const show = (mode==="muni")? [MUNICIPAL_LAYER] : [POLICE_MERHAV_LAYER];
          const hide = (mode==="muni")? [POLICE_MERHAV_LAYER] : [MUNICIPAL_LAYER];
          govmap.setVisibleLayers(show, hide);
        }catch(e){}
      }

      selectedName=null;
      setMessage("×ª×¦×•×’×”", `<div class="msg">×©× ×”: <b>${currentYear}</b><br>×œ×—×¥ ×¢×œ ${mode==="muni"?"×¨×©×•×ª":"××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×.</div>`);
    }
    function setMetric(metric){
      if(metric==="rate" && currentMode!=="muni") return;
      currentMetric=metric;
      $("btnAbs").classList.toggle("active", metric==="abs");
      $("btnRate").classList.toggle("active", metric==="rate");
      if(choroplethEnabled && currentMode==="muni") renderChoropleth();
      if(selectedName) showSelected(selectedName);
      setChoroBtnUI();
    }

    function showSelected(name){
      selectedName=name;
      const index = currentMode==="muni" ? muniIndex : merhavIndex;
      const key = currentMode==="muni" ? normalizeKey(name) : normalizeKey(name);
      const entry = (currentMode==="muni")
        ? (muniIndex[key] || muniIndex[nameVariants(name)[0]])
        : merhavIndex[key];

      if(!entry){
        setMessage("×œ× × ××¦×", `<div class="msg">××™×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨ <b>${escapeHtml(name)}</b> ×‘×©× ×ª ${currentYear}.</div>`);
        return;
      }

      const d=entry.data||{};
      const total=Number(d.total||0);

      let kpiText = `${total.toLocaleString()} ××™×¨×•×¢×™×`;
      let sub = "";

      if(currentMode==="muni"){
        const popRaw = getPopulationForAuthority(entry.name);
        const pop = popRaw==null?0:Number(popRaw);
        const rate = calcRatePer10k(total,pop);
        if(currentMetric==="rate"){
          kpiText = `${rate.toLocaleString()} ×œ-10,000`;
          sub = `××•×›×œ×•×¡×™×™×” (2019): ${Number(pop).toLocaleString()} â€¢ ×¡×”"×›: ${total.toLocaleString()}`;
        } else {
          sub = `××•×›×œ×•×¡×™×™×” (2019): ${Number(pop).toLocaleString()} â€¢ ×œ-10,000: ${rate.toLocaleString()}`;
        }
      }

      let breakdownHtml = "";
      if(d.breakdown && typeof d.breakdown==="object"){
        const items = Object.entries(d.breakdown).sort((a,b)=>(b[1]||0)-(a[1]||0));
        breakdownHtml = `<div class="grid2">` + items.map(([n,v])=>(
          `<div class="item"><div class="n">${escapeHtml(n)}</div><div class="v">${Number(v||0).toLocaleString()}</div></div>`
        )).join("") + `</div>`;
      }

      setMessage(entry.name, `
        <div class="kpi">${kpiText}</div>
        ${sub ? `<div class="msg" style="margin-bottom:10px">${escapeHtml(sub)}</div>` : ``}
        ${breakdownHtml || `<div class="msg">××™×Ÿ ×¤×™×¨×•×˜ ×¢×‘×™×¨×•×ª.</div>`}
      `);
    }

    // ---------- govmap click ----------
    function fieldsToObject(fields){
      if(!Array.isArray(fields)) return fields;
      const obj={};
      for(const f of fields) if(f.FieldName && f.Value!==undefined) obj[f.FieldName]=f.Value;
      return obj;
    }
    function detectMunicipalityName(attrsRaw){
      const attrs=fieldsToObject(attrsRaw)||attrsRaw;
      const candidates=["×©× ×¨×©×•×ª","×©× ×¨×©×•×ª ××§×•××™×ª","×©× ×™×©×•×‘","×™×©×•×‘ ×¡×•×¤×™","SHEM_YISHUV","NAME","Name"];
      for(const c of candidates) if(attrs && attrs[c]) return attrs[c];
      return null;
    }
    function detectMerhavName(attrsRaw){
      const attrs=fieldsToObject(attrsRaw)||attrsRaw;
      const candidates=["×©× ××¨×—×‘","×©× ××¨×—×‘ ××©×˜×¨×ª×™","MERHAV","SHEM_MERHAV","NAME","Name"];
      for(const c of candidates) if(attrs && attrs[c]) return attrs[c];
      return null;
    }

    async function onMapClick(e){
      try{
        const layerName = currentMode==="muni" ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
        const resp = await govmap.getLayerData({ LayerName: layerName, Point: e.mapPoint, Radius: 300 });
        const items = resp?.data || resp?.Data || [];
        if(!items.length){
          setMessage("×œ× × ××¦×", `<div class="msg">××™×Ÿ ××•×‘×™×™×§×˜ ×‘××–×•×¨ ×–×”.</div>`);
          return;
        }
        const first=items[0];
        const attrs=first.Fields || first.Attributes || first;

        if(currentMode==="muni"){
          const nm=detectMunicipalityName(attrs);
          if(!nm){ setMessage("×©×’×™××”", `<div class="msg">×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ×©× ×¨×©×•×ª.</div>`); return; }
          // resolve via index to canonical name if possible
          const entry = muniIndex[normalizeKey(nm)] || muniIndex[nameVariants(nm)[0]];
          showSelected(entry ? entry.name : nm);
        }else{
          const nm=detectMerhavName(attrs);
          if(!nm){ setMessage("×©×’×™××”", `<div class="msg">×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ×©× ××¨×—×‘.</div>`); return; }
          showSelected(nm);
        }
      }catch(err){
        setMessage("×©×’×™××”", `<div class="msg">××™×¨×¢×” ×©×’×™××”: ${escapeHtml(err?.message||err)}</div>`);
      }
    }

    // ===================== CHOROPLETH (with click-through fix) =====================
    function lerp(a,b,t){ return a+(b-a)*t; }
    function clamp01(x){ return Math.max(0, Math.min(1,x)); }
    function rateToColor(val,minV,maxV){
      const t = (maxV>minV)? clamp01((val-minV)/(maxV-minV)) : 0.5;
      const low=[0,210,60], mid=[255,160,0], high=[240,20,20];
      if(t<0.5){
        const tt=t/0.5;
        return [Math.round(lerp(low[0],mid[0],tt)),Math.round(lerp(low[1],mid[1],tt)),Math.round(lerp(low[2],mid[2],tt))];
      }else{
        const tt=(t-0.5)/0.5;
        return [Math.round(lerp(mid[0],high[0],tt)),Math.round(lerp(mid[1],high[1],tt)),Math.round(lerp(mid[2],high[2],tt))];
      }
    }

    function setMunicipalLayerOpacity(opacity){
      if(typeof govmap.setLayerOpacity==="function"){
        try{ govmap.setLayerOpacity({ layerName: MUNICIPAL_LAYER, opacity }); }catch(e){}
      }
    }

    function clearChoropleth(){
      const names=[...(activeChoroplethNames||[])];
      try{
        if(names.length && typeof govmap.clearGeometriesByName==="function"){
          try{ govmap.clearGeometriesByName(names); }
          catch(e){
            names.forEach(n=>{ try{ govmap.clearGeometriesByName([n]); }catch(_){} });
          }
        }
      }catch(e){}
      activeChoroplethNames=[];
    }

    function setChoroBtnUI(){
      const btn=$("btnChoro");
      if(!btn) return;
      btn.classList.toggle("active", !!choroplethEnabled);
      if(!muniBoundariesLoaded){
        btn.textContent = "ğŸ¨ ×¦×‘×™×¢×”";
        btn.title = muniBoundariesLoadError ? "× ×›×©×œ ×œ×˜×¢×•×Ÿ GeoJSON" : "×˜×•×¢×Ÿ ×’×‘×•×œ×•×ª...";
      }else{
        btn.textContent = choroplethEnabled ? `ğŸ¨ ×¦×‘×™×¢×” (${currentMetric==="rate"?"×œ-10,000":"×›××•×ª"}): ×¤×¢×™×œ` : "ğŸ¨ ×¦×‘×™×¢×” (×™×¨×•×§â†’××“×•×)";
        btn.title = "×¦×‘×™×¢×” ×œ×¤×™ ×”××“×“ ×”× ×•×›×—×™";
      }
    }

    function ensureClosedRing(coords){
      if(!Array.isArray(coords)||coords.length<3) return coords;
      const f=coords[0], l=coords[coords.length-1];
      if(f && l && f[0]===l[0] && f[1]===l[1]) return coords;
      return coords.concat([[f[0],f[1]]]);
    }
    function ringToWkt(ring){
      const r=ensureClosedRing(ring);
      return r.map(p=>`${Number(p[0]).toFixed(0)} ${Number(p[1]).toFixed(0)}`).join(", ");
    }
    function geojsonGeomToWkt(geom){
      if(!geom||!geom.type) return null;
      if(geom.type==="Polygon"){
        const rings=(geom.coordinates||[]).map(ringToWkt);
        if(!rings.length) return null;
        return `POLYGON((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
      }
      if(geom.type==="MultiPolygon"){
        const polys=geom.coordinates||[];
        const parts=polys.map(poly=>{
          const rings=(poly||[]).map(ringToWkt);
          if(!rings.length) return null;
          return `((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
        }).filter(Boolean);
        if(!parts.length) return null;
        return `MULTIPOLYGON(${parts.join(",")})`;
      }
      return null;
    }

    async function loadMuniBoundariesGeojson(){
      if(muniBoundariesLoaded) return true;
      muniBoundariesLoadError=null;
      try{
        let feats=[];
        if(window.MUNI_DATA?.features){
          feats=window.MUNI_DATA.features;
        }else{
          const res=await fetch(MUNI_BOUNDARIES_GEOJSON_URL,{cache:"no-store"});
          if(!res.ok) throw new Error(`fetch failed (${res.status})`);
          const gj=await res.json();
          feats=Array.isArray(gj?.features)?gj.features:[];
        }
        muniBoundariesIndex={};
        muniBoundariesMeta=[];
        for(const f of feats){
          const name=f?.properties?.name;
          const wkt=geojsonGeomToWkt(f?.geometry);
          if(!name || !wkt) continue;
          muniBoundariesIndex[normalizeKey(name)] = wkt;
          muniBoundariesMeta.push({name:String(name), wkt});
        }
        muniBoundariesLoaded=true;
        return true;
      }catch(e){
        muniBoundariesLoadError=e;
        return false;
      }finally{
        setChoroBtnUI();
      }
    }

    function findWktForCrimeName(crimeName){
      const vars=[crimeName, ...(nameVariants(crimeName)||[])];
      for(const v of vars){
        const wkt=muniBoundariesIndex?.[normalizeKey(v)];
        if(wkt) return wkt;
      }
      return null;
    }

    function handleChoroplethClick(ev, nameToMuniMap){
      try{
        const geomName =
          (ev && ev.data && (ev.data.name || ev.data.Name)) ||
          (ev && (ev.name || ev.Name)) ||
          (typeof ev==="string" ? ev : null);

        if(!geomName) return;
        const muniName = nameToMuniMap?.[geomName];
        if(!muniName) return;

        const entry = muniIndex[normalizeKey(muniName)] || muniIndex[nameVariants(muniName)[0]];
        showSelected(entry ? entry.name : muniName);
      }catch(e){}
    }

    async function renderChoropleth(){
      if(!mapInitialized || !choroplethEnabled || currentMode!=="muni") return;
      if(!muniBoundariesLoaded){
        const ok=await loadMuniBoundariesGeojson();
        if(!ok) return;
      }

      const yd=window.crimeByYear?.[currentYear];
      if(!yd) return;

      clearChoropleth();

      const normalRows=[];
      const NO_JUR_PREFIX="×œ×œ× ×©×™×¤×•×˜";
      const noJurRows = (muniBoundariesMeta||[])
        .filter(b => String(b?.name||"").trim().startsWith(NO_JUR_PREFIX) && b?.wkt)
        .map(b => ({name:String(b.name).trim(), wkt:b.wkt, total:0, pop:0, rate:0, value:0}));

      for(const name in yd){
        if(String(name||"").trim().startsWith(NO_JUR_PREFIX)) continue;
        const d=yd[name];
        const total=Number(d?.total||0);
        const popRaw=getPopulationForAuthority(name);
        const pop=popRaw==null?0:Number(popRaw);
        const rate=calcRatePer10k(total,pop);
        const wkt=findWktForCrimeName(name);
        if(!wkt) continue;
        const value = (currentMetric==="rate") ? rate : total;
        normalRows.push({name,wkt,total,pop,rate,value});
      }

      const refValues=normalRows.map(r=>r.value).sort((a,b)=>a-b);
      const minVal=refValues[0]||0;
      const maxVal=refValues.length>=2 ? refValues[refValues.length-2] : (refValues[refValues.length-1]||0);

      const wkts=[], names=[], symbols=[], tooltips=[];
      const nameToMuniMap={};

      normalRows.forEach((r,i)=>{
        const capped=Math.min(r.value,maxVal);
        const [rr,gg,bb]=rateToColor(capped,minVal,maxVal);
        wkts.push(r.wkt);
        const uniqueName=`${CHORO_NAME}_${i}`;
        names.push(uniqueName);
        nameToMuniMap[uniqueName]=r.name; // âœ… click mapping
        symbols.push({
          fillColor:[rr,gg,bb,0.55],
          outlineColor:[25,25,25,0.85],
          outlineWidth:2
        });
        tooltips.push(currentMetric==="rate"
          ? `${r.name} â€¢ ${r.rate.toLocaleString()} /10k`
          : `${r.name} â€¢ ${r.total.toLocaleString()} ××™×¨×•×¢×™×`);
      });

      noJurRows.forEach((r,i)=>{
        wkts.push(r.wkt);
        const uniqueName=`${CHORO_NAME}_nojur_${i}`;
        names.push(uniqueName);
        nameToMuniMap[uniqueName]=r.name;
        symbols.push({
          fillColor:[140,140,140,0.65],
          outlineColor:[25,25,25,0.85],
          outlineWidth:2
        });
        tooltips.push(`${r.name} (×œ×œ× ×©×™×¤×•×˜)`);
      });

      try{
        const payload={
          wkts, names,
          geometryType:(govmap.geometryType?.POLYGON ?? govmap.geometryType?.Polygon ?? 3),
          clearExisting:true,
          showBubble:false,
          symbols,
          data:{ tooltips }
        };
        const ret=govmap.displayGeometries(payload);

        // âœ… click through on polygons (progress callback)
        try{
          if(ret && typeof ret.progress==="function"){
            ret.progress((ev)=>handleChoroplethClick(ev, nameToMuniMap));
          }
        }catch(_){}

        if(ret && typeof ret.then==="function") await ret;

        activeChoroplethNames=names;
        setMunicipalLayerOpacity(30);

        const metricTitle = (currentMetric==="rate") ? "×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000" : "×¦×‘×™×¢×” ×œ×¤×™ ×›××•×ª";
        const rangeText = (currentMetric==="rate")
          ? `×˜×•×•×—: <b>${minVal.toLocaleString()}</b> ×¢×“ <b>${maxVal.toLocaleString()}</b> /10k`
          : `×˜×•×•×—: <b>${minVal.toLocaleString()}</b> ×¢×“ <b>${maxVal.toLocaleString()}</b> ××™×¨×•×¢×™×`;
        setMessage(metricTitle, `<div class="msg">×™×¨×•×§=× ××•×š â€¢ ×›×ª×•×=×‘×™× ×•× ×™ â€¢ ××“×•×=×’×‘×•×”<br>${rangeText}</div>`);
      }catch(e){
        setMunicipalLayerOpacity(100);
        setMessage("×©×’×™××”", `<div class="msg">× ×›×©×œ×ª×™ ×œ×¦×™×™×¨ ×¦×‘×™×¢×”: ${escapeHtml(e?.message||e)}</div>`);
      }
    }

    async function toggleChoropleth(){
      if(currentMode!=="muni") setMode("muni");
      choroplethEnabled=!choroplethEnabled;
      setChoroBtnUI();

      if(!mapInitialized) return;

      if(!choroplethEnabled){
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        setMessage("×¦×‘×™×¢×” ×›×•×‘×ª×”", `<div class="msg">×—×–×¨×ª×™ ×œ×ª×¦×•×’×” ×¨×’×™×œ×”.</div>`);
        return;
      }

      const ok=await loadMuniBoundariesGeojson();
      if(!ok){
        choroplethEnabled=false;
        setChoroBtnUI();
        setMessage("×œ× ×”×¦×œ×—×ª×™ ×œ×¦×‘×•×¢", `<div class="msg">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×§×•×‘×¥ ×’×‘×•×œ×•×ª. ×•×“× ×©×”×•× ×œ×™×“ index.html ×•×©×¤×ª×—×ª ×“×¨×š ×©×¨×ª (localhost / GitHub Pages), ×œ× ×“×¨×š file://</div>`);
        return;
      }

      await renderChoropleth();
    }

    // ---------- init ----------
    function init(){
      buildPopulationIndex();

      // year select
      const years = Object.keys(window.crimeByYear||{}).sort();
      const sel=$("year");
      sel.innerHTML="";
      years.forEach(y=>{
        const opt=document.createElement("option");
        opt.value=y; opt.textContent=y;
        sel.appendChild(opt);
      });
      currentYear = years.includes("2025") ? "2025" : years[years.length-1];
      sel.value=currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);

      sel.addEventListener("change", ()=>{
        currentYear=sel.value;
        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        selectedName=null;
        if(choroplethEnabled && currentMode==="muni") renderChoropleth();
        setMessage("×ª×¦×•×’×”", `<div class="msg">×©× ×”: <b>${currentYear}</b><br>×œ×—×¥ ×¢×œ ${currentMode==="muni"?"×¨×©×•×ª":"××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×.</div>`);
      });

      updateMetricButtons();
      setChoroBtnUI();
    }

    function initGovMap(){
      init();

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER],
        layersMode: 4,
        background: 3,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [MUNICIPAL_LAYER],
        onLoad: () => {
          mapInitialized=true;

          // single click listener
          try{ govmap.onEvent(govmap.events.CLICK).progress(onMapClick); }catch(e){}

          $("loading").style.display="none";
          setMode(currentMode);
          console.log("âœ… map loaded");
        }
      });
    }

    window.initGovMap=initGovMap;
    window.setMode=setMode;
    window.setMetric=setMetric;
    window.toggleChoropleth=toggleChoropleth;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>
<body>
  <div id="loading"><div>×˜×•×¢×Ÿ ××¤×”â€¦</div></div>
  <div id="map"></div>

  <div id="panel">
    <header>
      <div style="font-weight:900;font-size:16px">ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×”</div>
      <div class="row">
        <button class="btn" id="btnChoro" onclick="toggleChoropleth()">ğŸ¨ ×¦×‘×™×¢×” (×™×¨×•×§â†’××“×•×)</button>
      </div>
    </header>

    <div id="controls">
      <div class="grid" style="margin-bottom:8px">
        <button id="btnMuni" class="mode active" onclick="setMode('muni')">ğŸ˜ï¸ ×™×©×•×‘×™×</button>
        <button id="btnMerhav" class="mode" onclick="setMode('merhav')">ğŸš” ××¨×—×‘×™×</button>
      </div>

      <div class="grid" style="margin-bottom:10px">
        <button id="btnAbs" class="mode active" onclick="setMetric('abs')">ğŸ”¢ ×›××•×ª</button>
        <button id="btnRate" class="mode" onclick="setMetric('rate')" title="×–××™×Ÿ ×¨×§ ×‘×™×©×•×‘×™×">ğŸ‘¥ ×œ-10,000</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div style="font-weight:900;white-space:nowrap">×©× ×”:</div>
        <select id="year" style="flex:1;padding:8px 10px;border-radius:10px;border:1px solid #ccc;font-weight:900;background:#fff;cursor:pointer"></select>
      </div>
    </div>

    <div id="content">
      <div class="title" id="title">×ª×¦×•×’×”</div>
      <div id="body"><div class="msg">×˜×•×¢×Ÿâ€¦</div></div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפת פשיעה – לפי שנה (2020–2025) | ישובים / מרחבים</title>

  <!-- DATA (Processed) -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  
  <style>
    :root{
      --bg:#f2f4f8;
      --panel:#ffffff;
      --text:#0b0f1a;
      --muted:#3b4455;
      --border:#9aa4b2;
      --border2:#c6ced8;
      --brand:#0b63d8;
      --brand2:#074aa3;
      --shadow: 0 10px 28px rgba(0,0,0,.22);
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0; padding:0; height:100%;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
      overflow:hidden;
      background: var(--bg);
      color: var(--text);
      font-size: 16px; /* bigger base */
    }

    #map{ width:100%; height:100%; position:relative; }

    /* hide ESRI widgets if appear */
    .esri-layer-list, .esri-legend{ display:none !important; }

    /* PANEL */
    #info-panel{
      position:absolute;
      top: 14px;
      left: 14px;
      z-index:9999;
      background: var(--panel);
      padding:0;
      border-radius: 16px;
      width: 460px;
      max-height: calc(100vh - 28px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transition: height .2s ease, max-height .2s ease;
      border: 2px solid rgba(0,0,0,.10);
    }

    #panel-header{
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      color:#fff;
      padding: 16px 18px;
      border-bottom: 1px solid rgba(255,255,255,.22);
      flex-shrink:0;
    }

    #panel-header h1{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing: -0.2px;
    }

    #panel-header p{
      margin: 8px 0 0 0;
      font-size: 13px;
      opacity: .98;
      line-height: 1.45;
      font-weight: 800;
    }

    #header-actions{
      margin-top: 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .hbtn{
      padding: 10px 14px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.16);
      color:#fff;
      font-weight: 1000;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-size: 13px;
    }
    .hbtn:active{ transform: translateY(1px); }
    .hbtn.secondary{
      background: rgba(0,0,0,.16);
      border-color: rgba(255,255,255,.24);
    }

    #tabs{
      display:flex;
      gap:0;
      background: #fff;
      border-bottom: 2px solid rgba(0,0,0,.10);
      flex-shrink:0;
    }

    .tab{
      flex:1;
      padding: 12px 10px;
      text-align:center;
      cursor:pointer;
      border-bottom: 4px solid transparent;
      transition: all .18s ease;
      font-size: 13px;
      font-weight: 1000;
      color: #1d2433;
      user-select:none;
      white-space:nowrap;
    }
    .tab:hover{ background:#eef5ff; }
    .tab.active{
      background:#fff;
      border-bottom-color: var(--brand);
      color: var(--brand);
    }

    #controls{
      padding: 14px 16px;
      background: #fff;
      border-bottom: 2px solid rgba(0,0,0,.08);
      flex-shrink:0;
    }

    .mode-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }

    .mode-btn{
      padding: 12px 12px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.16);
      background:#fff;
      cursor:pointer;
      font-size: 13px;
      font-weight: 1000;
      color: #0f172a;
      transition: all .15s ease;
      user-select:none;
      text-align:center;
      box-shadow: 0 2px 0 rgba(0,0,0,.06);
    }
    .mode-btn:hover{
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(11,99,216,.18);
    }
    .mode-btn.active{
      background: var(--brand);
      border-color: var(--brand);
      color:#fff;
      box-shadow: 0 4px 12px rgba(11,99,216,.35);
    }
    .mode-btn.disabled{
      opacity: .55;
      cursor:not-allowed !important;
      border-color: rgba(0,0,0,.12) !important;
      color: #334155 !important;
      background:#fff !important;
      pointer-events:none;
      box-shadow:none;
    }
    .mode-btn.full{ grid-column: 1 / -1; }

    #controls-row{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom: 12px;
    }
    #controls label{
      font-weight: 1000;
      font-size: 13px;
      color: var(--text);
      white-space:nowrap;
    }
    #yearSelect{
      flex:1;
      padding: 12px 12px;
      border-radius: 12px;
      border: 2px solid rgba(0,0,0,.16);
      font-size: 14px;
      background:#fff;
      cursor:pointer;
      font-weight: 900;
      color: var(--text);
    }

    #quick-stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .stat-card{
      background:#fff;
      padding: 12px;
      border-radius: 14px;
      text-align:center;
      border: 2px solid rgba(0,0,0,.12);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .stat-value{
      font-size: 22px; /* bigger numbers */
      font-weight: 1100;
      color: var(--brand);
      margin-bottom: 4px;
      letter-spacing: -0.2px;
    }
    .stat-label{
      font-size: 12px; /* bigger labels */
      color: #0f172a;
      font-weight: 1000;
      letter-spacing: .2px;
      opacity: .90;
    }

    #info-content{
      padding: 16px;
      overflow-y:auto;
      flex:1;
      min-height:0;
      background:#fff;
    }

    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    #info-title{
      font-weight: 1100;
      font-size: 16px;
      margin-bottom: 12px;
      color: #0b0f1a;
      padding-bottom: 10px;
      border-bottom: 4px solid var(--brand);
    }

    #info-body{ line-height: 1.65; color:#0f172a; font-weight: 800; }

    .total-summary{
      font-size: 26px;
      font-weight: 1100;
      color: var(--brand);
      margin: 12px 0 10px 0;
      text-align:center;
      padding: 16px;
      background: linear-gradient(135deg, #d7ebff 0%, #eef6ff 100%);
      border-radius: 14px;
      border: 2px solid rgba(11,99,216,.35);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    .sub-summary{
      margin-top: 0;
      margin-bottom: 12px;
      text-align:center;
      font-size: 13px;
      color: #0f172a;
      font-weight: 1000;
      opacity: .92;
    }

    .crime-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .crime-item{
      background: #f8fafc;
      padding: 12px;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.10);
      border-right: 6px solid var(--brand);
      display:flex;
      flex-direction:column;
      gap: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }
    .crime-name{
      font-weight: 1000;
      color: #0b0f1a;
      font-size: 13px;
      line-height: 1.35;
      min-height: 34px;
      display:flex;
      align-items:center;
    }
    .crime-count{
      font-weight: 1100;
      color: var(--brand);
      font-size: 17px;
    }

    .message{
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 12px;
      font-size: 13px;
      border-right: 6px solid;
      line-height: 1.6;
      font-weight: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
    }
    .message-info{  background: #d7ebff; color: #062145; border-right-color: var(--brand); }
    .message-warn{  background: #ffe7b8; color: #3b2100; border-right-color: #c26b00; }
    .message-error{ background: #ffd0d0; color: #4a0000; border-right-color: #d10000; }

    #loading{
      position:absolute;
      top:50%;
      left:50%;
      transform: translate(-50%, -50%);
      background:#fff;
      padding: 26px 30px;
      border-radius: 16px;
      box-shadow: 0 12px 36px rgba(0,0,0,.28);
      z-index:10000;
      text-align:center;
      border: 2px solid rgba(0,0,0,.10);
    }
    .spinner{
      width: 44px;
      height: 44px;
      margin: 0 auto 14px;
      border: 4px solid rgba(0,0,0,.10);
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin{ 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }

    /* Compare UI */
    .compare-city-tag{
      background:#d7ebff;
      color: var(--brand);
      padding: 9px 12px;
      border-radius: 12px;
      border: 2px solid rgba(11,99,216,.25);
      display:inline-flex;
      align-items:center;
      gap: 10px;
      font-size: 13px;
      font-weight: 1100;
    }
    .compare-city-tag button{
      border:none; background:none; color: var(--brand);
      cursor:pointer; font-size: 20px; line-height:1;
      padding:0; width: 22px; height: 22px;
      display:flex; align-items:center; justify-content:center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover{ background: var(--brand); color:#fff; }

    .add-compare-btn{
      width:100%;
      padding: 13px;
      background: var(--brand);
      color:#fff;
      border:none;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 1100;
      cursor:pointer;
      margin-bottom: 12px;
      box-shadow: 0 6px 16px rgba(11,99,216,.28);
    }
    .add-compare-btn:active{ transform: translateY(1px); }

    .compare-grid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 10px; }

    .compare-card{
      border: 2px solid rgba(0,0,0,.10);
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .compare-card-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .compare-name{
      font-weight: 1100;
      color:#0b0f1a;
      font-size: 14px;
      max-width: 300px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .compare-badges{ display:flex; gap: 6px; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      font-size: 11px;
      font-weight: 1100;
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.12);
      background:#f8fafc;
      color:#0f172a;
    }
    .badge-warn{
      border-color: rgba(194,107,0,.35);
      background:#ffe7b8;
      color:#3b2100;
    }

    .compare-kpis{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .kpi{
      border: 2px solid rgba(0,0,0,.10);
      background:#f8fafc;
      border-radius: 14px;
      padding: 10px;
      text-align:center;
    }
    .kpi .kpi-value{ font-weight: 1100; color: var(--brand); font-size: 14px; margin-bottom: 4px; }
    .kpi .kpi-label{ font-size: 11px; font-weight: 1100; color:#0f172a; opacity: .85; letter-spacing:.2px; }

    .compare-bars-title{ margin-top: 14px; font-weight: 1100; font-size: 14px; color:#0b0f1a; }
    .compare-bar{
      display:flex;
      align-items:center;
      gap: 12px;
      margin: 10px 0;
      padding: 10px;
      background:#f8fafc;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.10);
    }
    .compare-bar-name{
      width: 130px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: 13px;
      font-weight: 1100;
      color:#0b0f1a;
    }
    .compare-bar-container{
      flex:1;
      height: 28px;
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      overflow:hidden;
      position:relative;
    }
    .compare-bar-fill{
      height:100%;
      background: linear-gradient(90deg, var(--brand) 0%, #00a3ff 100%);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding: 0 10px;
      font-size: 13px;
      font-weight: 1100;
      transition: width .35s ease;
      white-space:nowrap;
      min-width: 44px;
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }

    /* MODALS */
    .modal{ display:none; position:fixed; inset:0; z-index:20000; }
    .modalOverlay{ position:absolute; inset:0; background: rgba(0,0,0,.55); }
    .modalCard{
      position:relative;
      width: min(780px, calc(100vw - 26px));
      max-height: calc(100vh - 26px);
      margin: 13px auto;
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,.30);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border: 2px solid rgba(0,0,0,.10);
    }
    .modalHeader{
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.20);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 100%);
      color:#fff;
    }
    .modalHeaderTitle{ font-weight: 1100; font-size: 15px; }
    .modalClose{
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 22px;
      font-weight: 1100;
    }
    .modalBody{ padding: 16px; overflow:auto; }

    /* Search results list */
    #addrResults{
      border: 2px solid rgba(0,0,0,.12);
      background:#fff;
      border-radius: 14px;
      overflow:hidden;
      max-height: 340px;
      overflow-y:auto;
      display:none;
      margin-top: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
    }
    .addr-item{
      padding: 12px 12px;
      cursor:pointer;
      font-size: 13px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      font-weight: 900;
      color:#0b0f1a;
    }
    .addr-item:last-child{ border-bottom:none; }
    .addr-item:hover{ background:#eef5ff; }
    .addr-sub{ font-size: 12px; color:#0f172a; margin-top: 4px; opacity: .85; font-weight: 900; }

    /* Collapse behavior */
    #info-panel.collapsed{ max-height: 128px; height: 128px; }
    #info-panel.collapsed #tabs,
    #info-panel.collapsed #controls,
    #info-panel.collapsed #info-content{ display:none; }

    /* Mobile bottom sheet */
    @media (max-width: 768px){
      #info-panel{
        left: 0; right: 0; top: auto; bottom: 0;
        width: 100%;
        max-height: none;
        height: 66vh;
        border-radius: 18px 18px 0 0;
      }
      #info-panel.collapsed{ height: 128px; }
      #info-content{ padding: 14px; }
      .crime-grid{ grid-template-columns: 1fr; }
      .compare-kpis{ grid-template-columns: 1fr; }
      #tabs{ overflow-x:auto; }
      #tabs .tab{ min-width: 98px; }
    }
  </style>


  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    // ⬅️ שים את הקובץ הזה ליד index.html (אותה תיקייה)
    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    let mapInitialized = false;
    let currentYear = "2025";
    let yearlyStats = {};
    let currentTab = "single";
    let currentMode = "muni";
    let currentMetric = "abs";

    let selectedCity = null;
    let selectedCityKey = null;
    let compareList = [];

    const muniIndex = {};
    const merhavIndex = {};
    const populationIndex = {};
    const variantsCache = new Map();

    let rankingMetric = "total";
    let rankingCrimeType = "";
    let rankingTopN = 10;

    let lastGeocodeReqId = 0;
    let lastAddrItems = [];
    let lastGeocodeQuery = "";
    let searchTimeout = null;

    let choroplethEnabled = false;
    const CHORO_NAME = "crime_rate_choropleth";

    // ⬅️ אינדקס גיאומטריות (מה-GeoJSON)
    let muniBoundariesIndex = {}; // normalizedKey -> esri polygon geometry

    // -------------------- Normalize & Variants --------------------
    function normalizeKeyBase(name) {
      if (name == null) return "";
      let s = String(name).trim();
      s = s
        .replace(/[׳״"']/g, "")
        .replace(/[(){}\[\],.:]/g, "")
        .replace(/־/g, "-")
        .replace(/\s+/g, " ")
        .trim();
      s = s.replace(/[\s\-]/g, "");
      return s.toLowerCase();
    }
    function normalizeKey(name) { return normalizeKeyBase(name); }

    function nameVariants(name) {
      if (!name) return [];
      if (variantsCache.has(name)) return variantsCache.get(name);

      const raw = String(name).trim();
      if (!raw) return [];

      const withoutCityHall = raw.replace(/^עיריית\s+/g, "").replace(/^עיריה\s+/g, "");
      const withoutLocalCouncil = withoutCityHall.replace(/^מועצה\s+מקומית\s+/g, "");
      const withoutRegionalCouncil = withoutLocalCouncil.replace(/^מועצה\s+אזורית\s+/g, "");

      const variants = [raw, withoutCityHall, withoutLocalCouncil, withoutRegionalCouncil]
        .map(normalizeKeyBase)
        .filter(Boolean);

      variantsCache.set(name, variants);
      return variants;
    }

    // -------------------- Population --------------------
    function buildPopulationIndex() {
      for (const k in populationIndex) delete populationIndex[k];
      const raw = window.PopulationDB;
      if (!raw || typeof raw !== "object") {
        console.warn("⚠️ PopulationDB.js not loaded or invalid");
        return false;
      }
      for (const displayName in raw) {
        const pop = Number(raw[displayName]);
        if (!Number.isFinite(pop)) continue;
        for (const v of nameVariants(displayName)) populationIndex[v] = pop;
      }
      console.log("✅ Population index ready:", Object.keys(populationIndex).length);
      return true;
    }

    function getPopulationForAuthority(nameFromCrime) {
      for (const v of nameVariants(nameFromCrime)) {
        const pop = populationIndex[v];
        if (pop != null) return pop;
      }
      return null;
    }

    function calcRatePer10k(total, pop) {
      if (!pop || pop <= 0 || !Number.isFinite(total)) return null;
      return Math.round((total / pop) * 10000 * 10) / 10;
    }

    function fmtMaybe(num) {
      if (num == null) return "לא נמצא";
      return Number(num).toLocaleString();
    }

    // -------------------- UI: metric buttons --------------------
    function updateMetricButtonsUI() {
      const btnRate = document.getElementById("btnMetricRate");
      if (!btnRate) return;

      const rateAvailable = (currentMode === "muni");
      btnRate.classList.toggle("disabled", !rateAvailable);
      btnRate.disabled = !rateAvailable;

      if (!rateAvailable) btnRate.onclick = null;
      else btnRate.onclick = () => setMetric("rate");

      btnRate.title = rateAvailable
        ? "מציג עבירות ל-10,000 תושבים (דורש אוכלוסייה)"
        : "זמין רק במצב ישובים/רשויות";

      const headerP = document.querySelector("#panel-header p");
      if (headerP) {
        headerP.innerHTML = rateAvailable
          ? `מצב נוכחי: <strong>ישובים/רשויות</strong><br>ל-10,000 זמין רק כאן`
          : `מצב נוכחי: <strong>מרחבים</strong><br>ל-10,000 לא זמין במרחבים`;
      }

      if (!rateAvailable && currentMetric === "rate") {
        currentMetric = "abs";
        const bAbs = document.getElementById("btnMetricAbs");
        const bRate = document.getElementById("btnMetricRate");
        if (bAbs) bAbs.classList.add("active");
        if (bRate) bRate.classList.remove("active");
      }
    }

    // -------------------- Stats --------------------
    function calculateStats(year) {
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return { municipalities: 0, total: 0, avg: 0 };

      let total = 0, count = 0;
      for (const name in yearData) {
        const data = yearData[name];
        if (data && typeof data.total === "number") {
          total += data.total;
          count++;
        }
      }
      return { municipalities: count, total, avg: count > 0 ? Math.round(total / count) : 0 };
    }

    function updateQuickStats() {
      const stats = yearlyStats[currentYear] || { municipalities: 0, total: 0, avg: 0 };
      const a = document.getElementById("stat-municipalities");
      const b = document.getElementById("stat-total");
      const c = document.getElementById("stat-avg");
      if (a) a.textContent = stats.municipalities.toLocaleString();
      if (b) b.textContent = stats.total.toLocaleString();
      if (c) c.textContent = stats.avg.toLocaleString();
    }

    // -------------------- Index building --------------------
    function buildMuniIndexForYear(year) {
      for (const k in muniIndex) delete muniIndex[k];
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return;

      for (const name in yearData) {
        const entry = { name, data: yearData[name] };
        const variants = nameVariants(name);
        for (const v of variants) if (!muniIndex[v]) muniIndex[v] = entry;
      }

      yearlyStats[year] = calculateStats(year);
      console.log(`✅ Year ${year}: ${Object.keys(muniIndex).length} muni keys indexed`);
    }

    function buildMerhavIndexForYear(year) {
      for (const k in merhavIndex) delete merhavIndex[k];
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) { 
        console.warn(`⚠️ No merhav data for year ${year}`); 
        return; 
      }

      for (const name in yearData) {
        merhavIndex[normalizeKey(name)] = { name, data: yearData[name] };
      }
      console.log(`✅ Year ${year}: ${Object.keys(merhavIndex).length} merhav keys indexed`);
    }

    // -------------------- UI helpers --------------------
    function showInfo(title, body, type = "info") {
      const t = document.getElementById("info-title");
      const b = document.getElementById("info-body");
      if (!t || !b) return;
      t.textContent = title;
      b.innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function showEntry(entry) {
      const d = entry.data;
      let html = "";

      const total = (typeof d.total === "number") ? d.total : null;
      const pop = (currentMode === "muni") ? getPopulationForAuthority(entry.name) : null;

      if (total != null) {
        if (currentMetric === "rate" && currentMode === "muni") {
          const rate = calcRatePer10k(total, pop);
          if (rate == null) {
            html += `<div class="total-summary">${Number(total).toLocaleString()} אירועים</div>`;
            html += `<div class="message message-warn">אין נתון אוכלוסייה עבור <strong>${escapeHtml(entry.name)}</strong>, לכן תצוגת <strong>ל-10,000</strong> לא זמינה ליישוב הזה.</div>`;
          } else {
            html += `<div class="total-summary">${rate.toLocaleString()} ל-10,000</div>`;
            html += `<div class="sub-summary">אוכלוסייה (2019): ${Number(pop).toLocaleString()} • סה"כ אירועים: ${Number(total).toLocaleString()}</div>`;
          }
        } else {
          html += `<div class="total-summary">${Number(total).toLocaleString()} אירועים</div>`;
          if (currentMode === "muni") {
            html += `<div class="sub-summary">אוכלוסייה (2019): ${pop ? Number(pop).toLocaleString() : "לא נמצא"}</div>`;
          }
        }
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
        html += `<div class="crime-grid">`;
        for (const [name, count] of sorted) {
          html += `<div class="crime-item">
            <div class="crime-name">${escapeHtml(name)}</div>
            <div class="crime-count">${Number(count || 0).toLocaleString()}</div>
          </div>`;
        }
        html += `</div>`;
      }

      const it = document.getElementById("info-title");
      const ib = document.getElementById("info-body");
      if (!it || !ib) return;
      it.textContent = entry.name;
      ib.innerHTML = html || `<div class="message message-info">אין נתונים להצגה</div>`;
    }

    // -------------------- Tabs --------------------
    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll(".tab").forEach(tab =>
        tab.classList.toggle("active", tab.dataset.tab === tabName)
      );

      document.querySelectorAll(".tab-content").forEach(content =>
        content.classList.toggle("active", content.id === `tab-${tabName}`)
      );

      if (tabName === "single") {
        showInfo(
          "מפה לפי " + (currentMode === "muni" ? "ישובים/רשויות" : "מרחבים"),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${currentMode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים`,
          "info"
        );
      } else if (tabName === "compare") {
        updateCompareView();
      } else if (tabName === "trends") {
        const tc = document.getElementById("trends-content");
        if (!selectedCity) {
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${currentMode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים היסטוריים</div>`;
          return;
        }
        showTrends(selectedCity, currentMode);
      } else if (tabName === "rankings") {
        renderRankings();
      }
    }

    // -------------------- Mode / Metric --------------------
    function setMode(mode) {
      currentMode = mode;

      const bm = document.getElementById("btnModeMuni");
      const br = document.getElementById("btnModeMerhav");
      if (bm) bm.classList.toggle("active", mode === "muni");
      if (br) br.classList.toggle("active", mode === "merhav");

      updateMetricButtonsUI();

      const layerToShow = (mode === "muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
      const layerToHide = (mode === "muni") ? POLICE_MERHAV_LAYER : MUNICIPAL_LAYER;

      if (mapInitialized) {
        try {
          if (typeof govmap.setVisibleLayers === "function") {
            govmap.setVisibleLayers([layerToShow], [layerToHide]);
          }
        } catch (err) {
          console.warn("⚠️ setVisibleLayers failed:", err);
        }
      }

      if (mode !== "muni") {
        choroplethEnabled = false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      }
      setChoroBtnUI();

      selectedCity = null;
      selectedCityKey = null;
      compareList = compareList.filter(c => c.mode === mode);

      if (choroplethEnabled && mode === "muni") renderChoropleth();

      if (currentTab === "compare") updateCompareView();
      else if (currentTab === "rankings") renderRankings();
      else if (currentTab === "trends") {
        const tc = document.getElementById("trends-content");
        if (tc) tc.innerHTML = `<div class="message message-info">בחר ${mode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים היסטוריים</div>`;
      } else {
        showInfo(
          "מפה לפי " + (mode === "muni" ? "ישובים/רשויות" : "מרחבים"),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${mode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים`,
          "info"
        );
      }
    }

    function setMetric(metric) {
      if (metric === "rate" && currentMode !== "muni") {
        showInfo("לא זמין", "תצוגת אוכלוסייה / ל-10,000 זמינה רק במצב ישובים/רשויות.", "error");
        return;
      }

      currentMetric = metric;

      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");
      if (bAbs) bAbs.classList.toggle("active", metric === "abs");
      if (bRate) bRate.classList.toggle("active", metric === "rate");

      if (choroplethEnabled && currentMode === "muni") renderChoropleth();

      if (currentTab === "single" && selectedCityKey) {
        const entry = muniIndex[selectedCityKey] || muniIndex[nameVariants(selectedCityKey)[0]];
        if (entry) showEntry(entry);
      }
      if (currentTab === "compare") updateCompareView();
      if (currentTab === "trends" && selectedCity) showTrends(selectedCity, currentMode);
      if (currentTab === "rankings") renderRankings();
    }

    // -------------------- Compare --------------------
    function addToCompare() {
      if (!selectedCity) { 
        alert(`אנא בחר ${currentMode === "muni" ? "רשות" : "מרחב"} במפה תחילה`); 
        return; 
      }
      if (!compareList.some(c => c.key === selectedCityKey && c.mode === currentMode)) {
        compareList.push({ name: selectedCity, key: selectedCityKey, mode: currentMode });
        updateCompareView();
      }
    }

    function removeFromCompare(key) {
      compareList = compareList.filter(c => c.key !== key || c.mode !== currentMode);
      updateCompareView();
    }

    function updateCompareView() {
      const container = document.getElementById("compare-content");
      if (!container) return;

      const entityType = currentMode === "muni" ? "רשות" : "מרחב";

      const selectedHint = selectedCity
        ? `<div class="message message-info">נבחר כעת: <strong>${escapeHtml(selectedCity)}</strong> (לחץ על ➕ כדי להוסיף להשוואה)</div>`
        : `<div class="message message-info">לחץ על ${entityType} במפה ואז על ➕ כדי להוסיף להשוואה</div>`;

      let html = `
        <button class="add-compare-btn" onclick="addToCompare()">➕ הוסף ${entityType} נבחר להשוואה</button>
        ${selectedHint}
      `;

      const filteredList = compareList.filter(c => c.mode === currentMode);

      if (filteredList.length > 0) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
        filteredList.forEach(item => {
          html += `<div class="compare-city-tag">${escapeHtml(item.name)}<button onclick="removeFromCompare('${escapeHtml(item.key)}')" title="הסר">×</button></div>`;
        });
        html += "</div>";
      }

      if (filteredList.length < 2) {
        html += `<div class="message message-info">הוסף עוד ${entityType} אחד לפחות כדי לראות השוואה</div>`;
        container.innerHTML = html;
        return;
      }

      const index = currentMode === "muni" ? muniIndex : merhavIndex;
      const metricIsRate = (currentMode === "muni" && currentMetric === "rate");

      const rows = filteredList.map(item => {
        const total = index[item.key]?.data?.total ?? 0;
        const pop = (currentMode === "muni") ? getPopulationForAuthority(item.name) : null;
        const rate = (currentMode === "muni") ? calcRatePer10k(total, pop) : null;
        return { name: item.name, total, pop, rate, hasPop: pop != null };
      });

      if (currentMode !== "muni") {
        html += `<div class="message message-info">במצב מרחבים ההשוואה היא לפי כמות בלבד (אין אוכלוסייה).</div>`;
      } else if (metricIsRate) {
        const missing = rows.filter(r => r.rate == null).length;
        if (missing > 0) {
          html += `<div class="message message-warn">יש <strong>${missing}</strong> רשויות בלי אוכלוסייה: יוצגו כ-"לא נמצא".</div>`;
        } else {
          html += `<div class="message message-info">השוואה לפי <strong>ל-10,000 תושבים</strong> (אוכלוסייה 2019).</div>`;
        }
      } else {
        html += `<div class="message message-info">טיפ: מעבר ל־<strong>ל-10,000</strong> משווה יחסית לגודל אוכלוסייה (2019).</div>`;
      }

      html += `<div class="compare-grid">`;
      rows.forEach(r => {
        const badges = [];
        badges.push(metricIsRate ? `<span class="badge">מדד: ל-10,000</span>` : `<span class="badge">מדד: כמות</span>`);
        if (currentMode === "muni" && !r.hasPop) badges.push(`<span class="badge badge-warn">אין אוכלוסייה</span>`);

        html += `
          <div class="compare-card">
            <div class="compare-card-title">
              <div class="compare-name">${escapeHtml(r.name)}</div>
              <div class="compare-badges">${badges.join("")}</div>
            </div>

            <div class="compare-kpis">
              <div class="kpi">
                <div class="kpi-value">${Number(r.total).toLocaleString()}</div>
                <div class="kpi-label">כמות</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? fmtMaybe(r.pop) : "—"}</div>
                <div class="kpi-label">אוכלוסייה</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? (r.rate == null ? "לא נמצא" : r.rate.toLocaleString()) : "—"}</div>
                <div class="kpi-label">ל-10,000</div>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;

      const title = metricIsRate ? `השוואה לפי ל-10,000 (${currentYear})` : `השוואה לפי כמות (${currentYear})`;
      html += `<div class="compare-bars-title">${title}</div>`;

      const values = rows
        .map(r => metricIsRate ? r.rate : r.total)
        .filter(v => v != null && Number.isFinite(v));
      const maxVal = Math.max(...values, 1);

      const sorted = [...rows].sort((a, b) => {
        const va = metricIsRate ? (a.rate == null ? -1 : a.rate) : a.total;
        const vb = metricIsRate ? (b.rate == null ? -1 : b.rate) : b.total;
        return vb - va;
      });

      sorted.forEach(r => {
        const value = metricIsRate ? r.rate : r.total;

        let pct, label;
        if (metricIsRate) {
          if (value == null) { pct = 7; label = "לא נמצא"; }
          else { pct = (value / maxVal) * 100; label = `${value.toLocaleString()} /10k`; }
        } else {
          pct = (value / maxVal) * 100;
          label = Number(value).toLocaleString();
        }

        html += `<div class="compare-bar">
          <div class="compare-bar-name">${escapeHtml(r.name)}</div>
          <div class="compare-bar-container">
            <div class="compare-bar-fill" style="width:${pct}%">${label}</div>
          </div>
        </div>`;
      });

      container.innerHTML = html;
    }

    // -------------------- Trends --------------------
    function showTrends(entityName, mode = currentMode) {
      const container = document.getElementById("trends-content");
      if (!container) return;

      if (!entityName) {
        container.innerHTML = `<div class="message message-info">בחר ${mode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים היסטוריים</div>`;
        return;
      }

      const dataset = (mode === "muni") ? window.crimeByYear : window.crimeByYearMerhav;
      if (!dataset || typeof dataset !== "object") {
        container.innerHTML = `<div class="message message-error">אין נתוני ${mode === "muni" ? "ישובים/רשויות" : "מרחבים"} זמינים.</div>`;
        return;
      }

      const years = Object.keys(dataset).sort();
      const yearlyData = [];
      const targetKey = normalizeKey(entityName);

      const tryMatchInYear = (yearData) => {
        if (!yearData) return null;
        if (yearData[entityName]) return { matchedName: entityName, data: yearData[entityName] };

        const keys = Object.keys(yearData);
        for (const k of keys) {
          if (normalizeKey(k) === targetKey) return { matchedName: k, data: yearData[k] };
        }

        if (mode === "muni") {
          const variants = nameVariants(entityName);
          for (const k of keys) {
            const nk = normalizeKey(k);
            if (variants.includes(nk)) return { matchedName: k, data: yearData[k] };
          }
        }

        return null;
      };

      years.forEach(year => {
        const yearData = dataset?.[year];
        const match = tryMatchInYear(yearData);
        if (match?.data) {
          yearlyData.push({ year, total: Number(match.data.total || 0), matchedName: match.matchedName });
        }
      });

      if (!yearlyData.length) {
        container.innerHTML = `<div class="message message-info">אין נתונים זמינים עבור ${escapeHtml(entityName)}</div>`;
        return;
      }

      let series = yearlyData.map(d => ({ year: d.year, value: d.total, label: d.total.toLocaleString() }));

      if (mode === "muni" && currentMetric === "rate") {
        const pop = getPopulationForAuthority(entityName);
        series = yearlyData.map(d => {
          const rate = calcRatePer10k(d.total, pop);
          return {
            year: d.year,
            value: rate == null ? 0 : rate,
            label: rate == null ? "אין אוכלוסייה" : `${rate.toLocaleString()} /10k`
          };
        });
      }

      const maxVal = Math.max(...series.map(d => d.value), 1);

      let html = `<h3 style="margin:0 0 12px 0;font-size:16px;color:#222;font-weight:1000;">${escapeHtml(entityName)}</h3>`;

      const foundYears = new Set(yearlyData.map(d => d.year));
      const missingYears = years.filter(y => !foundYears.has(y));
      if (missingYears.length) {
        html += `<div class="message message-warn">אין נתונים עבור ${mode === "muni" ? "הרשות" : "המרחב"} בשנים: <strong>${missingYears.join(", ")}</strong></div>`;
      }

      if (mode === "muni" && currentMetric === "rate") {
        const pop = getPopulationForAuthority(entityName);
        if (!pop) html += `<div class="message message-warn">אין אוכלוסייה לרשות הזו — תצוגת ל-10,000 מסומנת כ-"אין אוכלוסייה".</div>`;
        else html += `<div class="message message-info">אוכלוסייה (2019): ${Number(pop).toLocaleString()}</div>`;
      }

      series.forEach(d => {
        const pct = (d.value / maxVal) * 100;
        html += `<div class="compare-bar">
          <div class="compare-bar-name">${d.year}</div>
          <div class="compare-bar-container">
            <div class="compare-bar-fill" style="width:${pct}%">${d.label}</div>
          </div>
        </div>`;
      });

      container.innerHTML = html;
    }

    // -------------------- Map click helpers --------------------
    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const obj = {};
      for (const f of fields) if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
      return obj;
    }

    function detectMunicipalityName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["שם רשות", "שם רשות מקומית", "שם ישוב", "ישוב סופי", "SHEM_YISHUV", "NAME", "Name"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    function detectMerhavName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["שם מרחב", "שם מרחב משטרתי", "MERHAV", "SHEM_MERHAV", "NAME", "Name"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      try {
        const layerName = (currentMode === "muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
        const resp = await govmap.getLayerData({
          LayerName: layerName,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp?.data || resp?.Data || [];
        if (!items.length) { 
          showInfo("לא נמצא", "אין אובייקט באזור זה", "info"); 
          return; 
        }

        const first = items[0];
        const attrs = first.Fields || first.Attributes || first;

        if (currentMode === "muni") {
          const nameFromMap = detectMunicipalityName(attrs);
          if (!nameFromMap) { 
            showInfo("שגיאה", "לא ניתן לזהות את שם הרשות", "error"); 
            return; 
          }

          const key = normalizeKey(nameFromMap);
          const entry = muniIndex[key] || muniIndex[nameVariants(nameFromMap)[0]];
          if (!entry) { 
            showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(nameFromMap)}</strong> בשנת ${currentYear}`, "error"); 
            return; 
          }

          selectedCity = entry.name;
          selectedCityKey = nameVariants(entry.name)[0];

          if (currentTab === "compare") { updateCompareView(); return; }
          if (currentTab === "single") { showEntry(entry); return; }
          if (currentTab === "trends") { showTrends(selectedCity, "muni"); return; }
          if (currentTab === "rankings") { renderRankings(); return; }

          showEntry(entry);
          return;
        }

        const merhavName = detectMerhavName(attrs);
        if (!merhavName) { 
          showInfo("שגיאה", "לא ניתן לזהות את שם מרחב המשטרה", "error"); 
          return; 
        }

        const key = normalizeKey(merhavName);
        selectedCity = merhavName;
        selectedCityKey = key;

        const entry = merhavIndex[key];
        if (!entry) { 
          showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(merhavName)}</strong> בשנת ${currentYear}`, "error"); 
          return; 
        }

        if (currentTab === "compare") { updateCompareView(); return; }
        if (currentTab === "rankings") { renderRankings(); return; }
        if (currentTab === "trends") { showTrends(selectedCity, "merhav"); return; }

        showEntry(entry);

      } catch (error) {
        console.error("❌ Error in onMapClick:", error);
        showInfo("שגיאה", `אירעה שגיאה: ${error?.message || 'שגיאה לא מוגדרת'}`, "error");
      }
    }

    // -------------------- MODALS --------------------
    function openModal(id){ 
      const m=document.getElementById(id); 
      if(m) m.style.display="block"; 
    }
    function closeModal(id){ 
      const m=document.getElementById(id); 
      if(m) m.style.display="none"; 
    }

    function initModals(){
      const aboutBtn = document.getElementById("aboutBtn");
      const aboutClose = document.getElementById("aboutCloseBtn");
      const aboutOverlay = document.getElementById("aboutOverlay");
      if (aboutBtn) aboutBtn.addEventListener("click", ()=>openModal("aboutModal"));
      if (aboutClose) aboutClose.addEventListener("click", ()=>closeModal("aboutModal"));
      if (aboutOverlay) aboutOverlay.addEventListener("click", ()=>closeModal("aboutModal"));

      const searchBtn = document.getElementById("searchBtn");
      const searchClose = document.getElementById("searchCloseBtn");
      const searchOverlay = document.getElementById("searchOverlay");
      if (searchBtn) searchBtn.addEventListener("click", ()=>{
        openModal("searchModal");
        const inp = document.getElementById("addrInput");
        if (inp) setTimeout(()=>inp.focus(), 50);
      });
      if (searchClose) searchClose.addEventListener("click", ()=>closeModal("searchModal"));
      if (searchOverlay) searchOverlay.addEventListener("click", ()=>closeModal("searchModal"));

      document.addEventListener("keydown", (e)=>{
        if(e.key==="Escape"){
          closeModal("aboutModal");
          closeModal("searchModal");
        }
      });
    }

    function togglePanel(){
      const panel = document.getElementById("info-panel");
      if(!panel) return;
      panel.classList.toggle("collapsed");

      const btn = document.getElementById("panelToggleBtn");
      if (btn) {
        const collapsed = panel.classList.contains("collapsed");
        btn.textContent = collapsed ? "➕ הגדל" : "➖ הקטן";
        btn.title = collapsed ? "הגדל" : "הקטן/הגדל (במיוחד לנייד)";
      }
    }

    // -------------------- Rankings (כמו אצלך) --------------------
    function getAllCrimeTypesForYearMuni(year) {
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return [];
      const set = new Set();
      for (const cityName in yearData) {
        const br = yearData?.[cityName]?.breakdown;
        if (!br) continue;
        for (const t of Object.keys(br)) set.add(t);
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"he"));
    }

    function getAllCrimeTypesForYearMerhav(year) {
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) return [];
      const set = new Set();
      for (const name in yearData) {
        const br = yearData?.[name]?.breakdown;
        if (!br) continue;
        for (const t of Object.keys(br)) set.add(t);
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"he"));
    }

    function formatValueByMetric(row) {
      if (rankingMetric === "rate") return `${row.value.toLocaleString()} /10k`;
      return row.value.toLocaleString();
    }

    function buildRankingsRows() {
      const isMerhav = (currentMode === "merhav");

      if (isMerhav) {
        const yearData = window.crimeByYearMerhav?.[currentYear];
        if (!yearData) return { rows: [], note: "אין נתוני מרחבים לשנה הזו." };
        if (rankingMetric === "rate") return { rows: [], note: "דירוג לפי אוכלוסייה לא זמין במצב מרחבים." };

        const rows = [];
        for (const name in yearData) {
          const d = yearData[name];
          let value = 0;
          if (rankingMetric === "total") value = Number(d?.total || 0);
          else if (rankingMetric === "type") {
            const br = d?.breakdown || {};
            value = Number(br?.[rankingCrimeType] || 0);
          }
          rows.push({ name, value, extra: null });
        }
        rows.sort((a,b)=>b.value - a.value);
        return { rows, note: null };
      }

      const yearData = window.crimeByYear?.[currentYear];
      if (!yearData) return { rows: [], note: "אין נתוני ישובים לשנה הזו." };

      const rows = [];
      for (const name in yearData) {
        const d = yearData[name];
        const total = Number(d?.total || 0);

        if (rankingMetric === "total") { 
          rows.push({ name, value: total, extra: null }); 
          continue; 
        }

        if (rankingMetric === "type") {
          const br = d?.breakdown || {};
          const v = Number(br?.[rankingCrimeType] || 0);
          rows.push({ name, value: v, extra: null });
          continue;
        }

        const pop = getPopulationForAuthority(name);
        const rate = calcRatePer10k(total, pop);
        if (rate == null) continue;
        rows.push({ name, value: rate, extra: { pop, total } });
      }

      rows.sort((a,b)=>b.value - a.value);

      let note = null;
      if (rankingMetric === "rate") {
        const totalCities = Object.keys(yearData).length;
        const usedCities = rows.length;
        note = (usedCities < totalCities)
          ? `דירוג ל-10,000 משתמש רק ביישובים שיש להם אוכלוסייה (2019). חסרים: ${totalCities - usedCities}.`
          : "דירוג ל-10,000 משתמש באוכלוסייה (2019) כבסיס אחיד לכל השנים.";
      }

      return { rows, note };
    }

    function wireRankingsControls(types) {
      const mSel = document.getElementById("rankMetricSelect");
      const nSel = document.getElementById("rankTopNSelect");
      const tSel = document.getElementById("rankCrimeTypeSelect");
      if (!mSel || !nSel || !tSel) return;

      if (currentMode === "merhav" && rankingMetric === "rate") rankingMetric = "total";
      if (rankingMetric === "type" && !types.length) rankingMetric = "total";

      if (rankingMetric === "type") {
        if (!rankingCrimeType || !types.includes(rankingCrimeType)) rankingCrimeType = types[0] || "";
      }

      mSel.value = rankingMetric;
      nSel.value = String(rankingTopN);
      if (types.length) tSel.value = rankingCrimeType;

      tSel.disabled = !(rankingMetric === "type" && types.length);

      mSel.onchange = () => { rankingMetric = mSel.value; renderRankings(); };
      nSel.onchange = () => { rankingTopN = Number(nSel.value) || 10; renderRankings(); };
      tSel.onchange = () => { rankingCrimeType = tSel.value; renderRankings(); };
    }

    function renderRankings() {
      const container = document.getElementById("rankings-content");
      if (!container) return;

      const isMerhav = (currentMode === "merhav");
      const types = isMerhav ? getAllCrimeTypesForYearMerhav(currentYear) : getAllCrimeTypesForYearMuni(currentYear);

      if (rankingMetric === "type" && (!rankingCrimeType || !types.includes(rankingCrimeType))) {
        rankingCrimeType = types[0] || "";
      }

      const { rows, note } = buildRankingsRows();
      const top = rows.slice(0, rankingTopN);

      const metricOptions = isMerhav
        ? `<option value="total">סה״כ פשעים</option><option value="type">סוג עבירה ספציפי</option>`
        : `<option value="total">סה״כ פשעים</option><option value="type">סוג עבירה ספציפי</option><option value="rate">יחסית לאוכלוסייה (ל־10,000)</option>`;

      const typeDisabled = (rankingMetric !== "type" || !types.length) ? "disabled" : "";

      let html = `
        <div class="message message-info" style="margin-bottom:10px;">
          שנה: <strong>${currentYear}</strong> • מצב: <strong>${isMerhav ? "מרחבים" : "ישובים/רשויות"}</strong>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
          <select id="rankMetricSelect" style="padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:1000;font-size:13px;">
            ${metricOptions}
          </select>
          <select id="rankTopNSelect" style="padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:1000;font-size:13px;">
            <option value="5">Top 5</option>
            <option value="10">Top 10</option>
            <option value="20">Top 20</option>
          </select>

          <select id="rankCrimeTypeSelect" style="grid-column: 1 / -1; padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;font-weight:1000;font-size:13px;" ${typeDisabled}>
            ${types.length ? types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("")
              : `<option value="">אין רשימת סוגים</option>`}
          </select>
        </div>
      `;

      if (note) html += `<div class="message message-warn">${note}</div>`;

      if (!top.length) {
        html += `<div class="message message-error">אין מספיק נתונים להצגת דירוג לפי הבחירה הנוכחית.</div>`;
        container.innerHTML = html;
        wireRankingsControls(types);
        return;
      }

      html += `<div style="display:grid; gap:10px;">`;
      top.forEach((r, idx) => {
        const sub = (rankingMetric === "rate" && r.extra)
          ? `<div style="font-size:12.5px;color:#666;margin-top:6px;font-weight:800;">
              אוכלוסייה (2019): ${Number(r.extra.pop).toLocaleString()} • סה״כ אירועים: ${Number(r.extra.total).toLocaleString()}
            </div>`
          : ``;

        html += `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border:1px solid #e6e6e6;background:#fafafa;border-radius:14px;">
            <div style="display:flex;align-items:center;gap:10px;min-width:0;">
              <div style="width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:#e7f3ff;color:#0066cc;font-weight:1000;flex:0 0 auto;">
                ${idx + 1}
              </div>
              <div style="min-width:0;">
                <div style="font-weight:1000;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;" title="${escapeHtml(r.name)}">
                  ${escapeHtml(r.name)}
                </div>
                ${sub}
              </div>
            </div>
            <div style="font-weight:1000;color:#0066cc;white-space:nowrap;">
              ${formatValueByMetric(r)}
            </div>
          </div>
        `;
      });
      html += `</div>`;

      container.innerHTML = html;
      wireRankingsControls(types);
    }

    // -------------------- Address Search --------------------
    function parseGeocodeList(resp) {
      const list = resp?.data || resp?.Data || resp?.results || resp;
      if (Array.isArray(list)) return list;
      if (Array.isArray(list?.Result)) return list.Result;
      return [];
    }

    function extractXY(item) {
      const x = item?.X ?? item?.x ?? item?.CenterX ?? item?.centerX ?? item?.Lon ?? item?.lon;
      const y = item?.Y ?? item?.y ?? item?.CenterY ?? item?.centerY ?? item?.Lat ?? item?.lat;
      return { x: Number(x), y: Number(y) };
    }

    function isBadTitle(t){
      const s = String(t ?? "").trim();
      if (!s) return true;
      const low = s.toLowerCase();
      return (s === "תוצאה" || low === "result" || low === "results" || low === "unknown");
    }

    function renderAddrResults(items) {
      const box = document.getElementById("addrResults");
      if (!box) return;

      lastAddrItems = items || [];

      if (!items || !items.length) {
        box.style.display = "block";
        box.innerHTML = `<div class="addr-item">לא נמצאו תוצאות</div>`;
        return;
      }

      box.style.display = "block";
      box.innerHTML = items.map((it, idx) => {
        const title = escapeHtml(it.__title || lastGeocodeQuery || "תוצאה");
        const sub = escapeHtml(it.__sub || "");
        return `
          <div class="addr-item" data-idx="${idx}">
            <div style="font-weight:1000; color:#222;">${title}</div>
            ${sub ? `<div class="addr-sub">${sub}</div>` : ""}
          </div>
        `;
      }).join("");

      box.querySelectorAll(".addr-item").forEach(el => {
        el.addEventListener("click", () => {
          const idx = Number(el.dataset.idx);
          const picked = lastAddrItems[idx];
          if (picked) focusToGeocodeItem(picked);
          box.style.display = "none";
          closeModal("searchModal");
        });
      });
    }

    function focusToGeocodeItem(item) {
      if (!mapInitialized) return;

      const { x, y } = extractXY(item);
      if (!Number.isFinite(x) || !Number.isFinite(y)) {
        showInfo("שגיאה", "התקבלה תוצאה בלי קואורדינטות X/Y", "error");
        return;
      }

      try { govmap.zoomToXY({ x, y, level: 10, marker: true }); } catch (e) {}

      const label = (!isBadTitle(item.__title) ? item.__title : (lastGeocodeQuery || "תוצאה"));
      showInfo("כתובת", `התמקדתי לכתובת: <strong>${escapeHtml(label)}</strong>`, "info");
    }

    function setAddrLoading(msg) {
      const box = document.getElementById("addrResults");
      if (!box) return;
      box.style.display = "block";
      box.innerHTML = `<div class="addr-item">${escapeHtml(msg || "מחפש…")}</div>`;
    }

    function runGeocode(query) {
      const q = String(query || "").trim();
      if (!q) return;

      lastGeocodeQuery = q;

      if (!mapInitialized) {
        showInfo("רגע", "המפה עדיין נטענת, נסה שוב בעוד רגע.", "warn");
        return;
      }

      const myId = ++lastGeocodeReqId;

      showInfo("חיפוש כתובת", `מחפש: <strong>${escapeHtml(q)}</strong>`, "info");
      setAddrLoading("מחפש כתובת…");

      const payload = { keyword: q };
      if (govmap.geocodeType?.AccuracyOnly) payload.type = govmap.geocodeType.AccuracyOnly;

      let res;
      try { res = govmap.geocode(payload); } catch (e) {
        showInfo("חיפוש כתובת", `שגיאה בחיפוש עבור: <strong>${escapeHtml(q)}</strong>`, "error");
        renderAddrResults([]);
        return;
      }

      const onSuccess = (resp) => {
        if (myId !== lastGeocodeReqId) return;

        const list = parseGeocodeList(resp);
        if (!list || !list.length) {
          showInfo("חיפוש כתובת", `לא נמצאו תוצאות עבור: <strong>${escapeHtml(q)}</strong>`, "warn");
          renderAddrResults([]);
          return;
        }

        const mapped = list.slice(0, 10).map(r => {
          const candidates = [
            r?.SettlementName, r?.settlementName,
            r?.PlaceName, r?.placeName,
            r?.Name, r?.name,
            r?.ResultLabel, r?.resultLabel,
            r?.Address, r?.address,
            r?.Title, r?.title,
            r?.label
          ].map(x => (x == null ? "" : String(x).trim())).filter(Boolean);

          let title = candidates.find(t => !isBadTitle(t)) || q;
          let sub = (r?.City || r?.city || r?.Region || r?.region || r?.Street || r?.street || r?.SubTitle || r?.subTitle || "");
          sub = String(sub || "").trim();
          return { ...r, __title: title, __sub: sub };
        });

        renderAddrResults(mapped);
      };

      const onFail = (err) => {
        if (myId !== lastGeocodeReqId) return;
        showInfo("חיפוש כתובת", `לא ניתן לבצע חיפוש עבור: <strong>${escapeHtml(q)}</strong>`, "error");
        renderAddrResults([]);
      };

      if (res && typeof res.then === "function") res.then(onSuccess).catch(onFail);
      else if (res && typeof res.done === "function") res.done(onSuccess).fail(onFail);
      else onFail(new Error("Unknown geocode return type"));
    }

    function initAddressSearchUI() {
      const input = document.getElementById("addrInput");
      const btn = document.getElementById("addrBtn");
      const box = document.getElementById("addrResults");
      if (!input || !btn || !box) return;

      btn.addEventListener("click", () => runGeocode(input.value));

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runGeocode(input.value);
        if (e.key === "Escape") box.style.display = "none";
      });

      input.addEventListener("input", () => {
        if (searchTimeout) clearTimeout(searchTimeout);
        const v = input.value.trim();
        if (v.length < 3) { box.style.display = "none"; return; }
        searchTimeout = setTimeout(() => runGeocode(v), 350);
      });

      document.addEventListener("click", (e) => {
        if (!box.contains(e.target) && e.target !== input && e.target !== btn) {
          box.style.display = "none";
        }
      });
    }

    
    // -------------------- Choropleth (GeoJSON -> GovMap overlay) --------------------
    /**
     * NOTES (חשוב):
     * 1) GovMap לא תמיד מאפשר להביא "גיאומטריות" דרך API לשכבה (קיבלת 500).
     *    לכן הצביעה כאן מבוססת על GeoJSON מקומי של גבולות הרשויות (muni_boundaries_ITM.geojson).
     * 2) הקובץ חייב להיות באותה תיקייה של index.html בגיטהאב-פייג'ס.
     * 3) הקואורדינטות בקובץ שצרפת הן ITM (EPSG:2039) וזה תואם ל-GovMap.
     */

    const MUNI_GEOJSON_URL = "muni_boundaries_ITM.geojson"; // אותו שם בדיוק כמו בקובץ בריפו

    let muniGeojson = null;
    let muniFeatures = [];           // features[] מה-GeoJSON
    let muniFeatByKey = new Map();   // normalizeKey(name) -> feature

    function promiseFromGovmap(ret){
      if (!ret) return Promise.resolve(ret);
      if (typeof ret.then === "function") return ret;
      if (typeof ret.done === "function") return new Promise((res, rej) => ret.done(res).fail(rej));
      return Promise.resolve(ret);
    }

    async function displayGeometriesCompat(payload){
      // GovMap API לפעמים מחזיר Promise ולפעמים jqDeferred - נתמוך בשניהם
      try {
        return await promiseFromGovmap(govmap.displayGeometries(payload));
      } catch (e1) {
        // חתימה חלופית (יש גרסאות שעובדות אחרת)
        try {
          return await promiseFromGovmap(govmap.displayGeometries(payload.geometries || payload, payload.name || CHORO_NAME));
        } catch (e2) {
          throw e2;
        }
      }
    }

    function clearChoropleth(){
      try { govmap.clearGeometriesByName(CHORO_NAME); } catch(e){}
      try { govmap.clearGeometriesByName({ name: CHORO_NAME }); } catch(e){}
    }

    function setMunicipalLayerOpacity(opacity){
      if (typeof govmap.setLayerOpacity === "function") {
        try { govmap.setLayerOpacity({ layerName: MUNICIPAL_LAYER, opacity }); } catch(e){}
      }
    }

    function setChoroBtnUI(){
      const btn = document.getElementById("btnChoro");
      if (!btn) return;

      btn.classList.remove("disabled");
      btn.disabled = false;

      btn.classList.toggle("active", !!choroplethEnabled);
      btn.textContent = choroplethEnabled ? "🎨 צביעה ל-10,000: פעיל" : "🎨 צביעה ל-10,000 (ירוק→אדום)";
      btn.title = "צביעה לפי פשעים ל-10,000 (מבוסס GeoJSON גבולות רשויות)";
    }

    function isClosedRing(coords){
      if (!coords || coords.length < 2) return false;
      const a = coords[0];
      const b = coords[coords.length - 1];
      return a[0] === b[0] && a[1] === b[1];
    }

    function closeRing(coords){
      if (!coords || coords.length < 2) return coords;
      if (isClosedRing(coords)) return coords;
      return coords.concat([coords[0]]);
    }

    function ringToWkt(ring){
      // ring: [[x,y],...]
      const c = closeRing(ring);
      return c.map(p => `${Number(p[0])} ${Number(p[1])}`).join(",");
    }

    function geomToWkt(geom){
      if (!geom) return null;

      // GeoJSON Polygon / MultiPolygon -> WKT (ITM)
      if (geom.type === "Polygon") {
        const rings = geom.coordinates || [];
        if (!rings.length) return null;
        const parts = rings.map(r => `(${ringToWkt(r)})`).join(",");
        return `POLYGON(${parts})`;
      }

      if (geom.type === "MultiPolygon") {
        const polys = geom.coordinates || [];
        if (!polys.length) return null;
        const parts = polys.map(poly => {
          const rings = (poly || []).map(r => `(${ringToWkt(r)})`).join(",");
          return `(${rings})`;
        }).join(",");
        return `MULTIPOLYGON(${parts})`;
      }

      return null;
    }

    function getFeatNameFromProps(props){
      if (!props) return null;
      const candidates = [
        "שם רשות", "שם רשות מקומית", "שם ישוב", "שם_רשות", "SHEM_YISHUV", "SHEM_YISH", "NAME", "Name",
        "MUN_HEB", "MUN_NAME", "MUNIC_NAME", "Municipality", "AUTH_NAME"
      ];
      for (const c of candidates){
        if (props[c]) return String(props[c]).trim();
      }
      // fallback: first string-ish prop
      for (const k in props){
        const v = props[k];
        if (typeof v === "string" && v.trim()) return v.trim();
      }
      return null;
    }

    async function loadMuniBoundaries(){
      if (muniGeojson) return muniGeojson;

      const resp = await fetch(MUNI_GEOJSON_URL, { cache: "no-store" });
      if (!resp.ok) {
        throw new Error(`לא הצלחתי לטעון ${MUNI_GEOJSON_URL} (HTTP ${resp.status}). ודא שהקובץ באותה תיקייה של index.html.`);
      }

      muniGeojson = await resp.json();
      muniFeatures = Array.isArray(muniGeojson?.features) ? muniGeojson.features : [];

      muniFeatByKey = new Map();
      for (const f of muniFeatures){
        const name = getFeatNameFromProps(f?.properties) || "";
        const key = normalizeKey(name);
        if (!key) continue;
        if (!muniFeatByKey.has(key)) {
          // מחשבים WKT פעם אחת ושומרים
          f.__wkt = geomToWkt(f.geometry);
          muniFeatByKey.set(key, f);
        }
      }

      console.log("✅ Boundaries loaded:", muniFeatByKey.size);
      return muniGeojson;
    }

    function lerp(a,b,t){ return a + (b-a)*t; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    // קונטרסט חזק: ירוק -> אדום, עם שקיפות גבוהה וקווי מתאר שחורים.
    function rateToColorStrong(rate, minR, maxR){
      const t = (maxR > minR) ? clamp01((rate - minR) / (maxR - minR)) : 0.5;
      const r = Math.round(lerp(0, 255, t));
      const g = Math.round(lerp(255, 0, t));
      const b = 0;
      return [r,g,b];
    }

    async function renderChoropleth(){
      if (!mapInitialized || !choroplethEnabled) return;
      if (currentMode !== "muni") return;

      // 1) טעינת גבולות
      try {
        await loadMuniBoundaries();
      } catch (e) {
        console.error("❌ Failed to load boundaries:", e);
        showInfo("שגיאה", `${e?.message || "נכשלתי לטעון GeoJSON גבולות."}`, "error");
        return;
      }

      const yearData = window.crimeByYear?.[currentYear];
      if (!yearData) {
        showInfo("שגיאה", "אין נתונים לשנה שנבחרה.", "error");
        return;
      }

      // 2) בונים רשומות לצביעה: רק מי שיש לו גם גבול וגם אוכלוסייה
      const rows = [];
      for (const [key, feat] of muniFeatByKey.entries()){
        const entry = muniIndex[key];
        if (!entry?.data) continue;

        const total = Number(entry.data.total || 0);
        const pop = getPopulationForAuthority(entry.name);
        const rate = calcRatePer10k(total, pop);
        if (rate == null) continue;

        const wkt = feat.__wkt || geomToWkt(feat.geometry);
        if (!wkt) continue;

        rows.push({ key, name: entry.name, total, pop, rate, wkt });
      }

      if (!rows.length) {
        showInfo("אין מספיק נתונים", "לא נמצאו רשויות עם גבול + אוכלוסייה כדי לחשב ל-10,000.", "warn");
        return;
      }

      const rates = rows.map(r => r.rate);
      const minR = Math.min(...rates);
      const maxR = Math.max(...rates);

      // 3) מכינים payload ל-GovMap displayGeometries (חתימה שעובדת טוב)
      const bubbleHTML = `
        <div style="direction:rtl;font-family:Arial;padding:8px 6px;line-height:1.65;">
          <div style="font-weight:1000;font-size:15px;margin-bottom:8px;">{0}</div>
          <div style="font-size:14px;">
            ל-10,000: <b>{1}</b><br/>
            אוכלוסייה (2019): <b>{2}</b><br/>
            סה״כ אירועים: <b>{3}</b>
          </div>
        </div>`;

      const wkts = [];
      const symbols = [];
      const tooltips = [];
      const bubbleHTMLParameters = [];

      for (const r of rows){
        const [rr, gg, bb] = rateToColorStrong(r.rate, minR, maxR);

        wkts.push(r.wkt);

        symbols.push({
          type: "esriSFS",
          style: "esriSFSSolid",
          color: [rr, gg, bb, 200], // יותר שקוף/בולט
          outline: { type: "esriSLS", style: "esriSLSSolid", color: [0,0,0,255], width: 2 } // קונטרסט גבוה
        });

        tooltips.push({
          title: r.name,
          content: `ל-10,000: <b>${r.rate.toLocaleString()}</b><br>אוכלוסייה: ${Number(r.pop).toLocaleString()}<br>סה״כ אירועים: ${Number(r.total).toLocaleString()}`
        });

        bubbleHTMLParameters.push([
          r.name,
          r.rate.toLocaleString(),
          Number(r.pop).toLocaleString(),
          Number(r.total).toLocaleString()
        ]);
      }

      const payload = {
        name: CHORO_NAME,
        geometryType: govmap.geometryType?.POLYGON ?? "POLYGON",
        wkts,
        symbols,
        showBubble: true,
        bubbleHTML,
        bubbleHTMLParameters,
        data: { tooltips }
      };

      // 4) מציירים (ומכבים את שכבת הרשויות מתחת)
      clearChoropleth();
      setMunicipalLayerOpacity(0);

      try {
        await displayGeometriesCompat(payload);
      } catch (e) {
        console.error("❌ displayGeometries failed:", e);
        showInfo("שגיאה", "הצביעה נכשלה מול GovMap (displayGeometries). פתח Console לראות פרטים.", "error");
        // מחזירים את שכבת הרשויות כדי שלא יישאר ריק
        setMunicipalLayerOpacity(100);
        return;
      }

      showInfo(
        "צביעה לפי ל-10,000",
        `קונטרסט גבוה: ירוק = נמוך • אדום = גבוה<br>טווח: <b>${minR.toLocaleString()}</b> עד <b>${maxR.toLocaleString()}</b><br><span style="font-size:13px;opacity:.95;">טיפ: לחץ על פוליגון צבוע כדי לראות bubble.</span>`,
        "info"
      );
    }

    function toggleChoropleth(force){
      if (currentMode !== "muni") setMode("muni");

      choroplethEnabled = (typeof force === "boolean") ? force : !choroplethEnabled;
      setChoroBtnUI();

      if (!mapInitialized) return;

      if (!choroplethEnabled){
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        showInfo("צביעה כובתה", "חזרתי לתצוגה רגילה.", "info");
        return;
      }

      // אם מפעילים צביעה - עוברים למדד rate (ל-10,000)
      currentMetric = "rate";
      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");
      if (bAbs) bAbs.classList.remove("active");
      if (bRate) bRate.classList.add("active");

      renderChoropleth();
    }


    // -------------------- GovMap init --------------------
    function initGovMap() {
      if (!window.crimeByYear || typeof window.crimeByYear !== "object") {
        showInfo("שגיאה", "לא ניתן לטעון את קובץ הנתונים crimeByYear_2020_2025.js", "error");
        const l = document.getElementById("loading");
        if (l) l.style.display = "none";
        return;
      }
      if (!window.crimeByYearMerhav) console.warn("⚠️ crimeByYearMerhav.js לא נטען");

      const popOk = buildPopulationIndex();
      if (!popOk) console.warn("⚠️ Population data missing -> rate view will be partially unavailable");

      updateMetricButtonsUI();

      const years = Object.keys(window.crimeByYear).sort();
      const sel = document.getElementById("yearSelect");
      if (!sel) return;
      sel.innerHTML = "";

      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        sel.appendChild(opt);
      });

      currentYear = years.includes("2025") ? "2025" : years[years.length - 1];
      sel.value = currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      yearlyStats[currentYear] = calculateStats(currentYear);
      updateQuickStats();

      sel.addEventListener("change", e => {
        currentYear = e.target.value;

        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        yearlyStats[currentYear] = calculateStats(currentYear);
        updateQuickStats();

        selectedCity = null;
        selectedCityKey = null;

        if (choroplethEnabled && currentMode === "muni") renderChoropleth();

        if (currentTab === "compare") updateCompareView();
        else if (currentTab === "trends") {
          const tc = document.getElementById("trends-content");
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${currentMode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים היסטוריים</div>`;
        } else if (currentTab === "rankings") renderRankings();
        else {
          showInfo(
            "מפה לפי " + (currentMode === "muni" ? "ישובים/רשויות" : "מרחבים"),
            `שנה נבחרת: ${currentYear}<br>לחץ על ${currentMode === "muni" ? "רשות" : "מרחב"} במפה כדי לראות נתונים`,
            "info"
          );
        }
      });

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER],
        layersMode: 4,
        background: 3,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [MUNICIPAL_LAYER],
        onLoad: () => {
          mapInitialized = true;

          // Preload municipality boundaries GeoJSON (for choropleth)
          loadMuniBoundaries().catch(err => console.warn("⚠️ Boundaries preload failed:", err));


          setMode(currentMode);
          setChoroBtnUI();

          try { govmap.onEvent(govmap.events.CLICK).progress(onMapClick); } catch (e) {}

          initModals();
          initAddressSearchUI();

          const toggleBtn = document.getElementById("panelToggleBtn");
          if (toggleBtn) toggleBtn.addEventListener("click", togglePanel);

          const l = document.getElementById("loading");
          if (l) l.style.display = "none";

          // לא טוענים גבולות ישר — רק כשנלחץ על צביעה (כדי להאיץ טעינה).
          showInfo("מפה לפי ישובים/רשויות", `שנה נבחרת: ${currentYear}<br>לחץ על רשות במפה כדי לראות נתונים`, "info");

          console.log("✅ Map initialized successfully");
        }
      });
    }

    window.initGovMap = initGovMap;
    window.switchTab = switchTab;
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.showTrends = showTrends;
    window.renderRankings = renderRankings;
    window.toggleChoropleth = toggleChoropleth;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:14px;color:#333;font-weight:900;">טוען מפה...</div>
  </div>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>🗺️ מפת פשיעה בישראל</h1>
      <p>מצב נוכחי: <strong>ישובים/רשויות</strong><br>ל-10,000 זמין רק כאן</p>

      <div id="header-actions">
        <button id="searchBtn" class="hbtn" aria-label="חיפוש כתובת">🔎 חיפוש כתובת</button>
        <button id="aboutBtn" class="hbtn secondary" aria-label="אודות ומקורות">ℹ️ אודות + מקורות</button>
        <button id="panelToggleBtn" class="hbtn secondary" aria-label="הקטן או הגדל פאנל">➖ הקטן</button>
      </div>
    </div>

    <div id="tabs" role="tablist">
      <div class="tab active" data-tab="single" onclick="switchTab('single')" role="tab" aria-selected="true">תצוגה</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')" role="tab" aria-selected="false">השוואה</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')" role="tab" aria-selected="false">היסטוריה</div>
      <div class="tab" data-tab="rankings" onclick="switchTab('rankings')" role="tab" aria-selected="false">דירוגים</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')" aria-label="מצב ישובים ורשויות">🏘️ ישובים/רשויות</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')" aria-label="מצב מרחבים משטרתיים">🚔 מרחבים</button>

        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')" aria-label="תצוגת כמות">🔢 כמות</button>
        <button id="btnMetricRate" class="mode-btn" aria-label="תצוגת ל-10,000 תושבים">👥 ל-10,000</button>

        <button id="btnChoro" class="mode-btn full" onclick="toggleChoropleth()" aria-label="צביעה לפי ל-10,000">
          🎨 צביעה ל-10,000 (ירוק→אדום)
        </button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">שנה:</label>
        <select id="yearSelect" aria-label="בחירת שנה"></select>
      </div>

      <div id="quick-stats" role="region" aria-label="סטטיסטיקות מהירות">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label">רשויות</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">סה"כ אירועים</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">ממוצע</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single" role="tabpanel">
        <div id="info-title">טוען נתונים...</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-compare" role="tabpanel">
        <div id="compare-content">
          <div class="message message-info">בחר ישובים/רשויות או מרחבים במפה והוסף להשוואה</div>
        </div>
      </div>

      <div class="tab-content" id="tab-trends" role="tabpanel">
        <div id="trends-content">
          <div class="message message-info">בחר רשות/מרחב במפה כדי לראות נתונים היסטוריים</div>
        </div>
      </div>

      <div class="tab-content" id="tab-rankings" role="tabpanel">
        <div id="rankings-content">
          <div class="message message-info">בחר שנה ומצב ואז כנס לדירוגים כדי לראות Top 5/10/20.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal" aria-hidden="true">
    <div id="aboutOverlay" class="modalOverlay" aria-hidden="true"></div>
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="אודות ומקורות">
      <div class="modalHeader">
        <div class="modalHeaderTitle">ℹ️ אודות + מקורות</div>
        <button id="aboutCloseBtn" class="modalClose" aria-label="סגור">×</button>
      </div>
      <div class="modalBody">
        <div class="message message-info" style="margin-bottom:12px;">
          האתר מציג נתוני פשיעה לפי שנה (2020–2025) בשתי תצוגות: <strong>ישובים/רשויות</strong> ו־<strong>מרחבים</strong>.
          במצב ישובים ניתן גם להציג <strong>ל־10,000</strong> לפי אוכלוסייה (קובץ PopulationDB.js).
        </div>

        <div class="message message-warn" style="margin-top:12px;">
          הצביעה מבוססת על קובץ גבולות: <code>muni_boundaries_ITM.geojson</code> (חייב להיות ליד index.html).<br>
          אם אין צביעה – לרוב זו בעיית התאמת שמות או שהקובץ לא נטען.
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="searchModal" class="modal" aria-hidden="true">
    <div id="searchOverlay" class="modalOverlay" aria-hidden="true"></div>
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="חיפוש כתובת">
      <div class="modalHeader">
        <div class="modalHeaderTitle">🔎 חיפוש כתובת</div>
        <button id="searchCloseBtn" class="modalClose" aria-label="סגור">×</button>
      </div>
      <div class="modalBody">
        <div style="display:flex; gap:10px; align-items:center;">
          <input
            id="addrInput"
            type="text"
            placeholder="לדוגמה: עינת / תל אביב / רחוב + מספר"
            style="flex:1; padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:14px; font-weight:800;"
            aria-label="הקלד כתובת לחיפוש"
          />
          <button
            id="addrBtn"
            style="padding:12px 14px; border-radius:12px; border:none; background:#0066cc; color:#fff; font-weight:1000; cursor:pointer;"
            aria-label="חפש"
          >חפש</button>
        </div>

        <div id="addrResults" aria-label="תוצאות חיפוש כתובת"></div>

        <div class="message message-info" style="margin-top:12px;">
          טיפ: אפשר פשוט להקליד שם יישוב (למשל <strong>עינת</strong>) — התוצאות יוצגו עם שם ברור.
        </div>
      </div>
    </div>
  </div>

</body>
</html>

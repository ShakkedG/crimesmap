<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ 2020â€“2025</title>

  <!-- DATA -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;font-size:16px}
    #map{width:100%;height:100%}
    
    /* Loading */
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:10000;background:rgba(255,255,255,0.95)}
    #loading .box{background:#fff;padding:20px 28px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.2);font-weight:900;font-size:18px}
    
    /* Panel */
    #info-panel{position:absolute;top:15px;left:15px;z-index:9999;width:480px;max-height:calc(100vh - 30px);display:flex;flex-direction:column;overflow:hidden;background:#fff;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.18)}
    
    /* Header */
    #panel-header{padding:16px 18px;background:linear-gradient(135deg,#0066cc,#004d99);color:#fff}
    #panel-header h1{margin:0;font-size:19px;font-weight:900;letter-spacing:-0.3px}
    #panel-header p{margin:8px 0 0;font-size:13px;opacity:.93;line-height:1.4}
    #header-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .hbtn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.4);background:rgba(255,255,255,.18);color:#fff;font-weight:900;cursor:pointer;font-size:13px;transition:all 0.2s}
    .hbtn:hover{background:rgba(255,255,255,.28)}
    .hbtn.secondary{background:rgba(0,0,0,.15);border-color:rgba(255,255,255,.25)}
    .hbtn.secondary:hover{background:rgba(0,0,0,.25)}
    
    /* Tabs */
    #tabs{display:flex;background:#fafafa;border-bottom:2px solid #e0e0e0}
    .tab{flex:1;padding:12px 8px;text-align:center;cursor:pointer;border-bottom:3px solid transparent;font-size:13px;font-weight:900;color:#666;user-select:none;white-space:nowrap;transition:all 0.2s}
    .tab:hover{background:#f0f0f0}
    .tab.active{background:#fff;border-bottom-color:#0066cc;color:#0066cc}
    
    /* Controls */
    #controls{padding:14px 16px;background:#fafafa;border-bottom:1px solid #e0e0e0}
    .mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px}
    .mode-btn{padding:12px 11px;border-radius:11px;border:2px solid #ddd;background:#fff;cursor:pointer;font-size:13px;font-weight:900;color:#555;user-select:none;transition:all 0.2s}
    .mode-btn:hover:not(.disabled){background:#f8f8f8;border-color:#bbb}
    .mode-btn.active{background:#0066cc;border-color:#0066cc;color:#fff;box-shadow:0 3px 8px rgba(0,102,204,.3)}
    .mode-btn.disabled{opacity:.5;cursor:not-allowed!important;border-color:#ddd!important;color:#999!important;background:#f5f5f5!important;pointer-events:none}
    .mode-btn.full{grid-column:1/-1}
    
    #controls-row{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    #controls label{font-weight:900;font-size:13px;color:#333}
    #yearSelect{flex:1;padding:12px 14px;border-radius:11px;border:2px solid #ccc;font-size:14px;font-weight:900;background:#fff;transition:border 0.2s}
    #yearSelect:focus{outline:none;border-color:#0066cc}
    
    /* Quick Stats */
    #quick-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat-card{background:#fff;padding:14px;border-radius:12px;text-align:center;border:2px solid #e8e8e8;transition:all 0.2s}
    .stat-card:hover{border-color:#0066cc;box-shadow:0 2px 8px rgba(0,102,204,.15)}
    .stat-value{font-size:23px;font-weight:900;color:#0066cc;margin-bottom:4px}
    .stat-label{font-size:12px;font-weight:800;color:#777}
    
    /* Content */
    #info-content{padding:16px;overflow:auto;flex:1;min-height:0}
    .tab-content{display:none}
    .tab-content.active{display:block}
    #info-title{font-weight:900;font-size:17px;margin-bottom:14px;color:#222;padding-bottom:10px;border-bottom:3px solid #0066cc}
    
    /* Messages */
    .message{padding:14px 16px;border-radius:11px;margin-bottom:12px;font-size:14px;border-right:4px solid;font-weight:800;line-height:1.6}
    .message-info{background:#e7f3ff;color:#004080;border-right-color:#0066cc}
    .message-warn{background:#fff7e6;color:#7a4a00;border-right-color:#ffb300}
    .message-error{background:#fff0f0;color:#c00;border-right-color:#ff0000}
    
    /* Summary */
    .total-summary{font-size:28px;font-weight:900;color:#0066cc;margin:14px 0 12px;text-align:center;padding:16px;background:linear-gradient(135deg,#e7f3ff,#f0f7ff);border-radius:13px;border:2px solid #b3d9ff}
    .sub-summary{margin:0 0 14px;text-align:center;font-size:13px;color:#444;font-weight:900}
    
    /* Crime Grid */
    .crime-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .crime-item{background:#fafafa;padding:14px;border-radius:12px;border:2px solid #e8e8e8;border-right:4px solid #0066cc;display:flex;flex-direction:column;gap:7px;transition:all 0.2s}
    .crime-item:hover{border-color:#0066cc;box-shadow:0 2px 8px rgba(0,102,204,.12)}
    .crime-name{font-weight:900;color:#333;font-size:13px;line-height:1.4;min-height:36px;display:flex;align-items:center}
    .crime-count{font-weight:900;color:#0066cc;font-size:17px}
    
    /* Mobile */
    @media (max-width:768px){
      #info-panel{left:0;right:0;top:auto;bottom:0;width:100%;height:68vh;border-radius:20px 20px 0 0}
      .crime-grid{grid-template-columns:1fr}
      #tabs{overflow-x:auto}
      #tabs .tab{min-width:100px}
      .mode-grid{grid-template-columns:1fr}
      #quick-stats{grid-template-columns:1fr}
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .tab-content.active{animation:fadeIn 0.3s}
  </style>

  <script>
    // ========= CONFIG =========
    const CONFIG = {
      MUNICIPAL_LAYER: "125",
      POLICE_MERHAV_LAYER: "200550",
      TOKEN: "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c",
      MUNI_GEOJSON_URL: "muni_boundaries_ITM.geojson"
    };

    // ========= STATE =========
    const state = {
      mapInitialized: false,
      currentYear: "2025",
      yearlyStats: {},
      currentTab: "single",
      currentMode: "muni",
      currentMetric: "abs",
      selectedCity: null,
      selectedCityKey: null,
      choroplethEnabled: false,
      muniGeojsonLoaded: false,
      muniGeojsonLoadError: null
    };

    const indices = {
      muni: {},
      merhav: {},
      population: {},
      muniWktByName: {}
    };

    const cache = {
      variants: new Map()
    };

    // ========= UTILITIES =========
    const utils = {
      escapeHtml(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      },

      normalizeKey(name) {
        if (!name) return "";
        let s = String(name).trim()
          .replace(/[×³×´"']/g, "")
          .replace(/[(){}\[\],.:]/g, "")
          .replace(/Ö¾/g, "-")
          .replace(/\s+/g, " ")
          .trim()
          .replace(/[\s\-]/g, "");
        return s.toLowerCase();
      },

      nameVariants(name) {
        if (!name) return [];
        if (cache.variants.has(name)) return cache.variants.get(name);
        
        const raw = String(name).trim();
        const variants = [
          raw,
          raw.replace(/^×¢×™×¨×™×™×ª\s+/g, "").replace(/^×¢×™×¨×™×”\s+/g, ""),
          raw.replace(/^××•×¢×¦×”\s+××§×•××™×ª\s+/g, ""),
          raw.replace(/^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g, "")
        ].map(v => this.normalizeKey(v)).filter(Boolean);
        
        cache.variants.set(name, variants);
        return variants;
      },

      formatNumber(num) {
        return Number(num).toLocaleString('he-IL');
      },

      calcRatePer10k(total, pop) {
        if (!pop || pop <= 0 || !Number.isFinite(total)) return null;
        return Math.round((total / pop) * 10000 * 10) / 10;
      }
    };

    // ========= POPULATION =========
    const population = {
      build() {
        for (const k in indices.population) delete indices.population[k];
        const raw = window.PopulationDB;
        if (!raw || typeof raw !== "object") return false;
        
        for (const displayName in raw) {
          const pop = Number(raw[displayName]);
          if (!Number.isFinite(pop)) continue;
          for (const v of utils.nameVariants(displayName)) {
            indices.population[v] = pop;
          }
        }
        console.log("âœ… Population index:", Object.keys(indices.population).length);
        return true;
      },

      get(name) {
        for (const v of utils.nameVariants(name)) {
          const p = indices.population[v];
          if (p != null) return p;
        }
        return null;
      }
    };

    // ========= STATS =========
    const stats = {
      calculate(year) {
        const y = window.crimeByYear?.[year];
        if (!y) return { municipalities: 0, total: 0, avg: 0 };
        
        let total = 0, count = 0;
        for (const name in y) {
          const d = y[name];
          if (d && typeof d.total === "number") {
            total += d.total;
            count++;
          }
        }
        return { municipalities: count, total, avg: count ? Math.round(total / count) : 0 };
      },

      updateDisplay() {
        const s = state.yearlyStats[state.currentYear] || { municipalities: 0, total: 0, avg: 0 };
        document.getElementById("stat-municipalities").textContent = utils.formatNumber(s.municipalities);
        document.getElementById("stat-total").textContent = utils.formatNumber(s.total);
        document.getElementById("stat-avg").textContent = utils.formatNumber(s.avg);
      }
    };

    // ========= INDEX BUILDERS =========
    const indexBuilder = {
      buildMuni(year) {
        for (const k in indices.muni) delete indices.muni[k];
        const y = window.crimeByYear?.[year];
        if (!y) return;
        
        for (const name in y) {
          const entry = { name, data: y[name] };
          for (const v of utils.nameVariants(name)) {
            if (!indices.muni[v]) indices.muni[v] = entry;
          }
        }
        console.log("âœ… muniIndex keys:", Object.keys(indices.muni).length);
      },

      buildMerhav(year) {
        for (const k in indices.merhav) delete indices.merhav[k];
        const y = window.crimeByYearMerhav?.[year];
        if (!y) return;
        
        for (const name in y) {
          indices.merhav[utils.normalizeKey(name)] = { name, data: y[name] };
        }
        console.log("âœ… merhavIndex keys:", Object.keys(indices.merhav).length);
      }
    };

    // ========= UI =========
    const ui = {
      showInfo(title, body, type = "info") {
        document.getElementById("info-title").textContent = title;
        document.getElementById("info-body").innerHTML = 
          `<div class="message message-${type}">${body}</div>`;
      },

      showEntry(entry) {
        const d = entry.data || {};
        let html = "";
        const total = typeof d.total === "number" ? d.total : null;
        const pop = state.currentMode === "muni" ? population.get(entry.name) : null;

        if (total != null) {
          if (state.currentMetric === "rate" && state.currentMode === "muni") {
            const rate = utils.calcRatePer10k(total, pop);
            if (rate == null) {
              html += `<div class="total-summary">${utils.formatNumber(total)} ××™×¨×•×¢×™×</div>`;
              html += `<div class="message message-warn">××™×Ÿ × ×ª×•×Ÿ ××•×›×œ×•×¡×™×™×” ×¢×‘×•×¨ <strong>${utils.escapeHtml(entry.name)}</strong>, ×œ×›×Ÿ ×œ-10,000 ×œ× ×–××™×Ÿ ×›××Ÿ.</div>`;
            } else {
              html += `<div class="total-summary">${utils.formatNumber(rate)} ×œ-10,000</div>`;
              html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${utils.formatNumber(pop)} â€¢ ×¡×”×´×› ××™×¨×•×¢×™×: ${utils.formatNumber(total)}</div>`;
            }
          } else {
            html += `<div class="total-summary">${utils.formatNumber(total)} ××™×¨×•×¢×™×</div>`;
            if (state.currentMode === "muni") {
              html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${pop ? utils.formatNumber(pop) : "×œ× × ××¦×"}</div>`;
            }
          }
        }

        if (d.breakdown && Object.keys(d.breakdown).length) {
          const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
          html += `<div class="crime-grid">`;
          for (const [name, count] of sorted) {
            html += `<div class="crime-item"><div class="crime-name">${utils.escapeHtml(name)}</div><div class="crime-count">${utils.formatNumber(count || 0)}</div></div>`;
          }
          html += `</div>`;
        }

        document.getElementById("info-title").textContent = entry.name;
        document.getElementById("info-body").innerHTML = html || 
          `<div class="message message-info">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>`;
      }
    };

    // ========= GEOMETRY =========
    const geometry = {
      ensureClosedRing(coords) {
        if (!Array.isArray(coords) || coords.length < 3) return coords;
        const first = coords[0], last = coords[coords.length - 1];
        if (first && last && first[0] === last[0] && first[1] === last[1]) return coords;
        return coords.concat([[first[0], first[1]]]);
      },

      ringToWkt(ring) {
        const r = this.ensureClosedRing(ring);
        return r.map(p => `${Number(p[0]).toFixed(3)} ${Number(p[1]).toFixed(3)}`).join(", ");
      },

      geomToWkt(geom) {
        if (!geom || !geom.type) return null;
        
        if (geom.type === "Polygon") {
          const rings = (geom.coordinates || []).map(r => this.ringToWkt(r));
          if (!rings.length) return null;
          return `POLYGON((${rings[0]})${rings.slice(1).map(h => `,(${h})`).join("")})`;
        }
        
        if (geom.type === "MultiPolygon") {
          const polys = geom.coordinates || [];
          const parts = polys.map(poly => {
            const rings = (poly || []).map(r => this.ringToWkt(r));
            if (!rings.length) return null;
            return `((${rings[0]})${rings.slice(1).map(h => `,(${h})`).join("")})`;
          }).filter(Boolean);
          if (!parts.length) return null;
          return `MULTIPOLYGON(${parts.join(",")})`;
        }
        
        return null;
      },

      async loadBoundaries() {
        if (state.muniGeojsonLoaded) return true;
        state.muniGeojsonLoadError = null;
        
        try {
          const res = await fetch(CONFIG.MUNI_GEOJSON_URL, { cache: "no-store" });
          if (!res.ok) throw new Error(`fetch failed (${res.status})`);
          
          const gj = await res.json();
          const idx = {};
          const feats = Array.isArray(gj?.features) ? gj.features : [];
          
          for (const f of feats) {
            const name = f?.properties?.name;
            const wkt = this.geomToWkt(f?.geometry);
            if (!name || !wkt) continue;
            idx[utils.normalizeKey(name)] = wkt;
          }
          
          indices.muniWktByName = idx;
          state.muniGeojsonLoaded = true;
          console.log("âœ… Boundaries loaded:", Object.keys(indices.muniWktByName).length);
          return true;
        } catch (e) {
          state.muniGeojsonLoadError = e;
          console.error("âŒ Failed loading boundaries:", e);
          return false;
        } finally {
          choropleth.updateButtonUI();
        }
      },

      findWkt(crimeName) {
        const vars = [crimeName, ...utils.nameVariants(crimeName)];
        for (const v of vars) {
          const wkt = indices.muniWktByName[utils.normalizeKey(v)];
          if (wkt) return wkt;
        }
        return null;
      }
    };

    // ========= CHOROPLETH =========
    const choropleth = {
      lerp(a, b, t) { return a + (b - a) * t; },
      clamp01(x) { return Math.max(0, Math.min(1, x)); },

      rateToColor(rate, minR, maxR) {
        const t = maxR > minR ? this.clamp01((rate - minR) / (maxR - minR)) : 0.5;
        const r = Math.round(this.lerp(0, 220, t));
        const g = Math.round(this.lerp(200, 20, t));
        const b = 20;
        return [r, g, b];
      },

      clear() {
        try {
          if (typeof govmap.clearGeometries === "function") govmap.clearGeometries();
        } catch (e) {}
      },

      setLayerOpacity(opacity) {
        if (typeof govmap.setLayerOpacity === "function") {
          try {
            govmap.setLayerOpacity({ layerName: CONFIG.MUNICIPAL_LAYER, opacity });
          } catch (e) {}
        }
      },

      updateButtonUI() {
        const btn = document.getElementById("btnChoro");
        if (!btn) return;
        
        btn.classList.toggle("active", state.choroplethEnabled);
        btn.classList.toggle("disabled", false);
        btn.disabled = false;

        if (!state.muniGeojsonLoaded) {
          btn.textContent = "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×˜×•×¢×Ÿ ×’×‘×•×œ×•×ª...)";
          btn.title = state.muniGeojsonLoadError
            ? "× ×›×©×œ ×œ×˜×¢×•×Ÿ GeoJSON. ×•×“× ×©×”×§×•×‘×¥ ×§×™×™× + ×©×¨×ª ××§×•××™."
            : "×˜×•×¢×Ÿ GeoJSON ×©×œ ×’×‘×•×œ×•×ª ×”×¨×©×•×™×•×ª...";
        } else {
          btn.textContent = state.choroplethEnabled ? 
            "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000: ×¤×¢×™×œ" : 
            "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)";
          btn.title = "×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000";
        }
      },

      async toggle() {
        if (state.currentMode !== "muni") modeController.set("muni");
        state.choroplethEnabled = !state.choroplethEnabled;
        this.updateButtonUI();

        if (!state.mapInitialized) return;

        if (!state.choroplethEnabled) {
          this.clear();
          this.setLayerOpacity(100);
          ui.showInfo("×¦×‘×™×¢×” ×›×•×‘×ª×”", "×—×–×¨×ª×™ ×œ×ª×¦×•×’×” ×¨×’×™×œ×”.", "info");
          return;
        }

        const ok = await geometry.loadBoundaries();
        if (!ok) {
          state.choroplethEnabled = false;
          this.updateButtonUI();
          ui.showInfo("×œ× ×”×¦×œ×—×ª×™ ×œ×¦×‘×•×¢", 
            `×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª <code>${utils.escapeHtml(CONFIG.MUNI_GEOJSON_URL)}</code>.<br>×•×“× ×©×”×•× ×œ×™×“ <code>index.html</code> ×•×©××ª×” ××¨×™×¥ ×©×¨×ª ××§×•××™ (<code>python -m http.server</code>).`, 
            "error");
          return;
        }

        state.currentMetric = "rate";
        document.getElementById("btnMetricAbs").classList.remove("active");
        document.getElementById("btnMetricRate").classList.add("active");

        await this.render();
      },

      async render() {
        if (!state.mapInitialized || !state.choroplethEnabled) return;
        if (state.currentMode !== "muni") return;

        if (!state.muniGeojsonLoaded) {
          const ok = await geometry.loadBoundaries();
          if (!ok) return;
        }

        const yearData = window.crimeByYear?.[state.currentYear];
        if (!yearData) {
          ui.showInfo("×©×’×™××”", "××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×©× ×‘×—×¨×ª.", "error");
          return;
        }

        const rows = [];
        const missingGeom = [];
        
        for (const name in yearData) {
          const d = yearData[name];
          const total = Number(d?.total || 0);
          const pop = population.get(name);
          const rate = utils.calcRatePer10k(total, pop);
          if (rate == null) continue;

          const wkt = geometry.findWkt(name);
          if (!wkt) {
            missingGeom.push(name);
            continue;
          }

          rows.push({ name, wkt, total, pop, rate });
        }

        if (!rows.length) {
          ui.showInfo("××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™×", 
            "×œ× × ××¦××• ×¨×©×•×™×•×ª ×¢× ××•×›×œ×•×¡×™×™×” + ×’×‘×•×œ ×›×“×™ ×œ×—×©×‘ ×œ-10,000.", "warn");
          return;
        }

        const rates = rows.map(r => r.rate);
        const minR = Math.min(...rates);
        const maxR = Math.max(...rates);

        const wkts = [], names = [], symbols = [];
        const tooltips = [], headers = [];
        const bubbleHTML = `
          <div style="direction:rtl;font-family:Arial;padding:8px 6px;line-height:1.7;">
            <div style="font-weight:900;font-size:15px;margin-bottom:7px;">{0}</div>
            <div style="font-size:13px;">
              ×œ-10,000: <b>{1}</b><br/>
              ××•×›×œ×•×¡×™×™×” (2019): <b>{2}</b><br/>
              ×¡×”×´×› ××™×¨×•×¢×™×: <b>{3}</b>
            </div>
          </div>`;
        const bubbleHTMLParameters = [];

        for (let i = 0; i < rows.length; i++) {
          const r = rows[i];
          const [rr, gg, bb] = this.rateToColor(r.rate, minR, maxR);

          wkts.push(r.wkt);
          names.push(`CHORO_${i}`);
          symbols.push({ 
            fillColor: [rr, gg, bb, 0.45], 
            outlineColor: [60, 60, 60, 0.65], 
            outlineWidth: 1 
          });

          tooltips.push(`${r.name} â€¢ ${utils.formatNumber(r.rate)} /10k`);
          headers.push(r.name);
          bubbleHTMLParameters.push([
            r.name,
            `${utils.formatNumber(r.rate)} /10k`,
            utils.formatNumber(r.pop),
            utils.formatNumber(r.total)
          ]);
        }

        try {
          this.clear();

          const payload = {
            wkts,
            names,
            geometryType: govmap.geometryType?.POLYGON ?? govmap.geometryType?.Polygon ?? 3,
            clearExisting: true,
            showBubble: true,
            symbols,
            data: { tooltips, headers, bubbleHTML, bubbleHTMLParameters }
          };

          const ret = govmap.displayGeometries(payload);
          if (ret && typeof ret.then === "function") await ret;

          this.setLayerOpacity(0);

        } catch (e) {
          console.error("displayGeometries failed:", e);
          this.setLayerOpacity(100);
          ui.showInfo("×©×’×™××”", `× ×›×©×œ×ª×™ ×œ×¦×™×™×¨ ×’×™××•××˜×¨×™×•×ª: ${utils.escapeHtml(e?.message || e)}`, "error");
          return;
        }

        let extra = "";
        if (missingGeom.length) {
          extra = `<br><span style="font-size:12px;opacity:.9;">×œ× × ××¦××” ×’×™××•××˜×¨×™×” ×œ-${missingGeom.length} ×¨×©×•×™×•×ª (×‘×“×•×§ ×”×ª×××ª ×©××•×ª ×‘×§×•×‘×¥ ×”×’×‘×•×œ×•×ª).</span>`;
          console.log("Missing geometry for:", missingGeom);
        }

        ui.showInfo("×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000", 
          `×™×¨×•×§ = × ××•×š â€¢ ××“×•× = ×’×‘×•×”<br>×˜×•×•×—: <b>${utils.formatNumber(minR)}</b> ×¢×“ <b>${utils.formatNumber(maxR)}</b>${extra}`, 
          "info");
      }
    };

    // ========= MAP CONTROLLER =========
    const mapController = {
      fieldsToObject(fields) {
        if (!Array.isArray(fields)) return fields;
        const obj = {};
        for (const f of fields) {
          if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
        }
        return obj;
      },

      detectMunicipalityName(attrsRaw) {
        const attrs = this.fieldsToObject(attrsRaw) || attrsRaw;
        const cands = ["×©× ×¨×©×•×ª", "×©× ×¨×©×•×ª ××§×•××™×ª", "×©× ×™×©×•×‘", "×™×©×•×‘ ×¡×•×¤×™", "SHEM_YISHUV", "NAME", "Name"];
        for (const c of cands) if (attrs && attrs[c]) return attrs[c];
        return null;
      },

      detectMerhavName(attrsRaw) {
        const attrs = this.fieldsToObject(attrsRaw) || attrsRaw;
        const cands = ["×©× ××¨×—×‘", "×©× ××¨×—×‘ ××©×˜×¨×ª×™", "MERHAV", "SHEM_MERHAV", "NAME", "Name"];
        for (const c of cands) if (attrs && attrs[c]) return attrs[c];
        return null;
      },

      async onClick(e) {
        if (!state.mapInitialized) return;
        
        try {
          const layerName = state.currentMode === "muni" ? 
            CONFIG.MUNICIPAL_LAYER : 
            CONFIG.POLICE_MERHAV_LAYER;
          
          const resp = await govmap.getLayerData({ 
            LayerName: layerName, 
            Point: e.mapPoint, 
            Radius: 300 
          });
          
          const items = resp?.data || resp?.Data || [];
          if (!items.length) {
            ui.showInfo("×œ× × ××¦×", "××™×Ÿ ××•×‘×™×™×§×˜ ×‘××–×•×¨ ×–×”", "info");
            return;
          }

          const first = items[0];
          const attrs = first.Fields || first.Attributes || first;

          if (state.currentMode === "muni") {
            const nameFromMap = this.detectMunicipalityName(attrs);
            if (!nameFromMap) {
              ui.showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”×¨×©×•×ª", "error");
              return;
            }

            const key = utils.normalizeKey(nameFromMap);
            const entry = indices.muni[key] || indices.muni[utils.nameVariants(nameFromMap)[0]];
            
            if (!entry) {
              ui.showInfo("×œ× × ××¦××• × ×ª×•× ×™×", 
                `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${utils.escapeHtml(nameFromMap)}</strong> ×‘×©× ×ª ${state.currentYear}`, 
                "error");
              return;
            }

            state.selectedCity = entry.name;
            state.selectedCityKey = utils.nameVariants(entry.name)[0];
            ui.showEntry(entry);
            return;
          }

          const merhavName = this.detectMerhavName(attrs);
          if (!merhavName) {
            ui.showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”××¨×—×‘", "error");
            return;
          }

          const key = utils.normalizeKey(merhavName);
          const entry = indices.merhav[key];
          state.selectedCity = merhavName;
          state.selectedCityKey = key;

          if (!entry) {
            ui.showInfo("×œ× × ××¦××• × ×ª×•× ×™×", 
              `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${utils.escapeHtml(merhavName)}</strong> ×‘×©× ×ª ${state.currentYear}`, 
              "error");
            return;
          }

          ui.showEntry(entry);

        } catch (err) {
          console.error("onMapClick failed:", err);
          ui.showInfo("×©×’×™××”", `××™×¨×¢×” ×©×’×™××”: ${utils.escapeHtml(err?.message || err)}`, "error");
        }
      }
    };

    // ========= MODE CONTROLLER =========
    const modeController = {
      updateMetricButtons() {
        const btnRate = document.getElementById("btnMetricRate");
        const rateOk = state.currentMode === "muni";
        
        btnRate.classList.toggle("disabled", !rateOk);
        btnRate.disabled = !rateOk;
        btnRate.onclick = rateOk ? () => this.setMetric("rate") : null;

        if (!rateOk && state.currentMetric === "rate") {
          state.currentMetric = "abs";
          document.getElementById("btnMetricAbs").classList.add("active");
          btnRate.classList.remove("active");
        }
      },

      set(mode) {
        state.currentMode = mode;
        document.getElementById("btnModeMuni").classList.toggle("active", mode === "muni");
        document.getElementById("btnModeMerhav").classList.toggle("active", mode === "merhav");
        this.updateMetricButtons();

        if (state.mapInitialized) {
          try {
            const layerToShow = mode === "muni" ? CONFIG.MUNICIPAL_LAYER : CONFIG.POLICE_MERHAV_LAYER;
            const layerToHide = mode === "muni" ? CONFIG.POLICE_MERHAV_LAYER : CONFIG.MUNICIPAL_LAYER;
            govmap.setVisibleLayers([layerToShow], [layerToHide]);
          } catch (e) {
            console.warn("setVisibleLayers failed:", e);
          }
        }

        if (mode !== "muni") {
          state.choroplethEnabled = false;
          choropleth.clear();
          choropleth.setLayerOpacity(100);
        }
        choropleth.updateButtonUI();

        state.selectedCity = null;
        state.selectedCityKey = null;

        ui.showInfo("××¤×”", 
          `×©× ×” × ×‘×—×¨×ª: ${state.currentYear}<br>×œ×—×¥ ×¢×œ ${mode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, 
          "info");
      },

      setMetric(metric) {
        if (metric === "rate" && state.currentMode !== "muni") {
          ui.showInfo("×œ× ×–××™×Ÿ", "×œ-10,000 ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª.", "error");
          return;
        }

        state.currentMetric = metric;
        document.getElementById("btnMetricAbs").classList.toggle("active", metric === "abs");
        document.getElementById("btnMetricRate").classList.toggle("active", metric === "rate");

        if (state.choroplethEnabled && state.currentMode === "muni") {
          choropleth.render();
        }

        if (state.currentTab === "single" && state.selectedCityKey) {
          const entry = state.currentMode === "muni" ? 
            indices.muni[state.selectedCityKey] : 
            indices.merhav[state.selectedCityKey];
          if (entry) ui.showEntry(entry);
        }
      }
    };

    // ========= TAB CONTROLLER =========
    const tabController = {
      switch(tab) {
        state.currentTab = tab;
        document.querySelectorAll(".tab").forEach(t => 
          t.classList.toggle("active", t.dataset.tab === tab)
        );
        document.querySelectorAll(".tab-content").forEach(c => 
          c.classList.toggle("active", c.id === `tab-${tab}`)
        );
      }
    };

    // ========= YEAR CONTROLLER =========
    const yearController = {
      setup() {
        const years = Object.keys(window.crimeByYear).sort();
        const sel = document.getElementById("yearSelect");
        sel.innerHTML = "";
        
        for (const y of years) {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          sel.appendChild(opt);
        }

        state.currentYear = years.includes("2025") ? "2025" : years[years.length - 1];
        sel.value = state.currentYear;

        sel.addEventListener("change", (e) => this.onChange(e.target.value));
      },

      onChange(year) {
        state.currentYear = year;
        indexBuilder.buildMuni(year);
        indexBuilder.buildMerhav(year);
        state.yearlyStats[year] = stats.calculate(year);
        stats.updateDisplay();

        state.selectedCity = null;
        state.selectedCityKey = null;

        if (state.choroplethEnabled && state.currentMode === "muni") {
          choropleth.render();
        }

        ui.showInfo("××¤×”", 
          `×©× ×” × ×‘×—×¨×ª: ${year}<br>×œ×—×¥ ×¢×œ ${state.currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, 
          "info");
      }
    };

    // ========= INITIALIZATION =========
    function initGovMap() {
      if (!window.crimeByYear || typeof window.crimeByYear !== "object") {
        ui.showInfo("×©×’×™××”", "crimeByYear_2020_2025.js ×œ× × ×˜×¢×Ÿ", "error");
        document.getElementById("loading").style.display = "none";
        return;
      }

      const popOk = population.build();
      modeController.updateMetricButtons();
      geometry.loadBoundaries(); // background load

      yearController.setup();
      indexBuilder.buildMuni(state.currentYear);
      indexBuilder.buildMerhav(state.currentYear);
      state.yearlyStats[state.currentYear] = stats.calculate(state.currentYear);
      stats.updateDisplay();

      govmap.createMap("map", {
        token: CONFIG.TOKEN,
        layers: [CONFIG.MUNICIPAL_LAYER, CONFIG.POLICE_MERHAV_LAYER],
        layersMode: 4,
        background: 3,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [CONFIG.MUNICIPAL_LAYER],
        onLoad: () => {
          state.mapInitialized = true;
          modeController.set("muni");
          choropleth.updateButtonUI();

          try {
            govmap.onEvent(govmap.events.CLICK).progress(mapController.onClick);
          } catch (e) {
            console.warn("click hook failed", e);
          }

          document.getElementById("loading").style.display = "none";
          
          if (!popOk) {
            ui.showInfo("×©×™× ×œ×‘", 
              "PopulationDB.js ×œ× × ×˜×¢×Ÿ ××• ×œ× ×ª×§×™×Ÿ â€“ ×œ-10,000 ×™×”×™×” ×—×œ×§×™.", 
              "warn");
          } else {
            ui.showInfo("××¤×”", 
              `×©× ×” × ×‘×—×¨×ª: ${state.currentYear}<br>×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, 
              "info");
          }
        }
      });
    }

    // ========= GLOBAL EXPORTS =========
    window.switchTab = (tab) => tabController.switch(tab);
    window.setMode = (mode) => modeController.set(mode);
    window.setMetric = (metric) => modeController.setMetric(metric);
    window.toggleChoropleth = () => choropleth.toggle();
    window.initGovMap = initGovMap;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="box">×˜×•×¢×Ÿ ××¤×”â€¦</div>
  </div>
  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×” ×‘×™×©×¨××œ</h1>
      <p>×™×©×•×‘×™×/×¨×©×•×™×•×ª + ××¨×—×‘×™× â€¢ 2020â€“2025</p>
      <div id="header-actions">
        <button class="hbtn secondary" onclick="choropleth.setLayerOpacity(100); choropleth.clear(); state.choroplethEnabled=false; choropleth.updateButtonUI();">
          â†©ï¸ ××™×¤×•×¡ ×¦×‘×™×¢×”
        </button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">×ª×¦×•×’×”</div>
      <div class="tab" data-tab="help" onclick="switchTab('help')">×¢×–×¨×”</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')">
          ğŸ˜ï¸ ×™×©×•×‘×™×/×¨×©×•×™×•×ª
        </button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">
          ğŸš” ××¨×—×‘×™×
        </button>

        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')">
          ğŸ”¢ ×›××•×ª
        </button>
        <button id="btnMetricRate" class="mode-btn">
          ğŸ‘¥ ×œ-10,000
        </button>

        <button id="btnChoro" class="mode-btn full" onclick="toggleChoropleth()">
          ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)
        </button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×©× ×”:</label>
        <select id="yearSelect"></select>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label">×¨×©×•×™×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">×¡×”×´×› ××™×¨×•×¢×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">×××•×¦×¢</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">×˜×•×¢×Ÿâ€¦</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-help">
        <div class="message message-info">
          <strong>ğŸ¨ ×”×¤×¢×œ×ª ×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000:</strong><br><br>
          1ï¸âƒ£ ×”×§×•×‘×¥ <code>muni_boundaries_ITM.geojson</code> ×—×™×™×‘ ×œ×”×™×•×ª ×œ×™×“ <code>index.html</code><br>
          2ï¸âƒ£ ×œ×¤×ª×•×— ×“×¨×š ×©×¨×ª ××§×•××™ (×œ× file://):<br>
          <code style="background:#f0f0f0;padding:4px 8px;border-radius:6px;display:inline-block;margin:6px 0;">python -m http.server 8000</code><br>
          3ï¸âƒ£ ×œ×œ×—×•×¥ ×¢×œ "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000"<br><br>
          
          <strong>ğŸ’¡ ×˜×™×¤×™×:</strong><br>
          â€¢ ×× ×”×’×‘×•×œ "× ×¢×œ× ×‘×œ×™ ×¦×‘×¢" â€“ ×–×” ××•××¨ ×©×”×™×™×ª×” ×©×’×™××” ×‘-<code>displayGeometries</code> ××• ×©×”×§×•×‘×¥ ×œ× × ×˜×¢×Ÿ<br>
          â€¢ ×•×“× ×©×”×©××•×ª ×‘-GeoJSON ×ª×•×××™× ×œ×©××•×ª ×‘-crimeByYear<br>
          â€¢ ×”×©×ª××© ×‘-DevTools Console ×œ×–×™×”×•×™ ×‘×¢×™×•×ª<br><br>
          
          <strong>ğŸ“Š ××§×¨× ×¦×‘×¢×™×:</strong><br>
          ğŸŸ¢ ×™×¨×•×§ = ×©×™×¢×•×¨ ×¤×©×™×¢×” × ××•×š<br>
          ğŸŸ¡ ×¦×”×•×‘ = ×©×™×¢×•×¨ ×¤×©×™×¢×” ×‘×™× ×•× ×™<br>
          ğŸ”´ ××“×•× = ×©×™×¢×•×¨ ×¤×©×™×¢×” ×’×‘×•×”
        </div>
      </div>
    </div>
  </div>
</body>
</html>

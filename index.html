<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ 2020â€“2025</title>

  <!-- DATA -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;font-size:16px}
    #map{width:100%;height:100%}
    #loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:10000}
    #loading .box{background:#fff;padding:18px 22px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.18);font-weight:900}
    #info-panel{position:absolute;top:15px;left:15px;z-index:9999;width:460px;max-height:calc(100vh - 30px);display:flex;flex-direction:column;overflow:hidden;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    #panel-header{padding:14px 16px;background:linear-gradient(135deg,#0066cc,#0052a3);color:#fff}
    #panel-header h1{margin:0;font-size:18px;font-weight:1000}
    #panel-header p{margin:6px 0 0;font-size:13px;opacity:.92;line-height:1.35}
    #header-actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .hbtn{padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15);color:#fff;font-weight:1000;cursor:pointer;font-size:13px}
    .hbtn.secondary{background:rgba(0,0,0,.12);border-color:rgba(255,255,255,.22)}
    #tabs{display:flex;background:#fafafa;border-bottom:2px solid #e0e0e0}
    .tab{flex:1;padding:11px 8px;text-align:center;cursor:pointer;border-bottom:3px solid transparent;font-size:13px;font-weight:1000;color:#666;user-select:none;white-space:nowrap}
    .tab.active{background:#fff;border-bottom-color:#0066cc;color:#0066cc}
    #controls{padding:12px 14px;background:#fafafa;border-bottom:1px solid #e0e0e0}
    .mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
    .mode-btn{padding:11px 10px;border-radius:10px;border:2px solid #ddd;background:#fff;cursor:pointer;font-size:13px;font-weight:1000;color:#555;user-select:none}
    .mode-btn.active{background:#0066cc;border-color:#0066cc;color:#fff;box-shadow:0 2px 6px rgba(0,102,204,.25)}
    .mode-btn.disabled{opacity:.55;cursor:not-allowed!important;border-color:#ddd!important;color:#666!important;background:#fff!important;pointer-events:none}
    .mode-btn.full{grid-column:1/-1}
    #controls-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    #controls label{font-weight:1000;font-size:13px}
    #yearSelect{flex:1;padding:11px 12px;border-radius:10px;border:1px solid #ccc;font-size:14px;font-weight:1000;background:#fff}
    #quick-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat-card{background:#fff;padding:12px;border-radius:12px;text-align:center;border:1px solid #e0e0e0}
    .stat-value{font-size:22px;font-weight:1000;color:#0066cc;margin-bottom:3px}
    .stat-label{font-size:13px;font-weight:900;color:#777}
    #info-content{padding:14px;overflow:auto;flex:1;min-height:0}
    .tab-content{display:none}
    .tab-content.active{display:block}
    #info-title{font-weight:1000;font-size:16px;margin-bottom:12px;color:#222;padding-bottom:8px;border-bottom:3px solid #0066cc}
    .message{padding:12px 14px;border-radius:10px;margin-bottom:10px;font-size:14px;border-right:4px solid;font-weight:800;line-height:1.55}
    .message-info{background:#e7f3ff;color:#004080;border-right-color:#0066cc}
    .message-warn{background:#fff7e6;color:#7a4a00;border-right-color:#ffb300}
    .message-error{background:#fff0f0;color:#c00;border-right-color:#ff0000}
    .total-summary{font-size:26px;font-weight:1000;color:#0066cc;margin:12px 0 10px;text-align:center;padding:14px;background:linear-gradient(135deg,#e7f3ff,#f0f7ff);border-radius:12px;border:2px solid #b3d9ff}
    .sub-summary{margin:0 0 12px;text-align:center;font-size:13px;color:#444;font-weight:900}
    .crime-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:10px}
    .crime-item{background:#fafafa;padding:12px;border-radius:12px;border:1px solid #e0e0e0;border-right:4px solid #0066cc;display:flex;flex-direction:column;gap:6px}
    .crime-name{font-weight:900;color:#333;font-size:13px;line-height:1.35;min-height:32px;display:flex;align-items:center}
    .crime-count{font-weight:1000;color:#0066cc;font-size:16px}
    /* Mobile */
    @media (max-width:768px){
      #info-panel{left:0;right:0;top:auto;bottom:0;width:100%;height:66vh;border-radius:18px 18px 0 0}
      .crime-grid{grid-template-columns:1fr}
      #tabs{overflow-x:auto}
      #tabs .tab{min-width:96px}
    }
  </style>

  <script>
    // ========= CONFIG =========
    const MUNICIPAL_LAYER="125";
    const POLICE_MERHAV_LAYER="200550";
    const TOKEN="ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";
    const MUNI_GEOJSON_URL="muni_boundaries_ITM.geojson";

    // ========= STATE =========
    let mapInitialized=false;
    let currentYear="2025";
    let yearlyStats={};
    let currentTab="single";
    let currentMode="muni";
    let currentMetric="abs";
    let selectedCity=null;
    let selectedCityKey=null;

    const muniIndex={};
    const merhavIndex={};
    const populationIndex={};
    const variantsCache=new Map();

    // Choropleth
    let choroplethEnabled=false;
    let muniGeojsonLoaded=false;
    let muniWktByName={};
    let muniGeojsonLoadError=null;

    // ========= HELPERS =========
    function escapeHtml(s){
      return String(s??"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }
    function normalizeKeyBase(name){
      if(name==null) return "";
      let s=String(name).trim();
      s=s.replace(/[×³×´"']/g,"").replace(/[(){}\[\],.:]/g,"").replace(/Ö¾/g,"-").replace(/\s+/g," ").trim();
      s=s.replace(/[\s\-]/g,"");
      return s.toLowerCase();
    }
    const normalizeKey = normalizeKeyBase;

    function nameVariants(name){
      if(!name) return [];
      if(variantsCache.has(name)) return variantsCache.get(name);
      const raw=String(name).trim();
      const v1=raw.replace(/^×¢×™×¨×™×™×ª\s+/g,"").replace(/^×¢×™×¨×™×”\s+/g,"");
      const v2=v1.replace(/^××•×¢×¦×”\s+××§×•××™×ª\s+/g,"");
      const v3=v2.replace(/^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g,"");
      const vars=[raw,v1,v2,v3].map(normalizeKeyBase).filter(Boolean);
      variantsCache.set(name,vars);
      return vars;
    }

    function buildPopulationIndex(){
      for(const k in populationIndex) delete populationIndex[k];
      const raw=window.PopulationDB;
      if(!raw || typeof raw!=="object") return false;
      for(const displayName in raw){
        const pop=Number(raw[displayName]);
        if(!Number.isFinite(pop)) continue;
        for(const v of nameVariants(displayName)) populationIndex[v]=pop;
      }
      console.log("âœ… Population index:", Object.keys(populationIndex).length);
      return true;
    }
    function getPopulationForAuthority(name){
      for(const v of nameVariants(name)){
        const p=populationIndex[v];
        if(p!=null) return p;
      }
      return null;
    }
    function calcRatePer10k(total,pop){
      if(!pop || pop<=0 || !Number.isFinite(total)) return null;
      return Math.round((total/pop)*10000*10)/10;
    }

    function calculateStats(year){
      const y=window.crimeByYear?.[year];
      if(!y) return {municipalities:0,total:0,avg:0};
      let total=0,count=0;
      for(const name in y){
        const d=y[name];
        if(d && typeof d.total==="number"){ total+=d.total; count++; }
      }
      return {municipalities:count,total,avg:count?Math.round(total/count):0};
    }

    function updateQuickStats(){
      const s=yearlyStats[currentYear] || {municipalities:0,total:0,avg:0};
      document.getElementById("stat-municipalities").textContent = s.municipalities.toLocaleString();
      document.getElementById("stat-total").textContent = s.total.toLocaleString();
      document.getElementById("stat-avg").textContent = s.avg.toLocaleString();
    }

    function showInfo(title, body, type="info"){
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function buildMuniIndexForYear(year){
      for(const k in muniIndex) delete muniIndex[k];
      const y=window.crimeByYear?.[year];
      if(!y) return;
      for(const name in y){
        const entry={name,data:y[name]};
        for(const v of nameVariants(name)) if(!muniIndex[v]) muniIndex[v]=entry;
      }
      console.log("âœ… muniIndex keys:", Object.keys(muniIndex).length);
    }
    function buildMerhavIndexForYear(year){
      for(const k in merhavIndex) delete merhavIndex[k];
      const y=window.crimeByYearMerhav?.[year];
      if(!y) return;
      for(const name in y){
        merhavIndex[normalizeKey(name)] = {name,data:y[name]};
      }
      console.log("âœ… merhavIndex keys:", Object.keys(merhavIndex).length);
    }

    function updateMetricButtonsUI(){
      const btnRate=document.getElementById("btnMetricRate");
      const rateOk = (currentMode==="muni");
      btnRate.classList.toggle("disabled", !rateOk);
      btnRate.disabled = !rateOk;
      btnRate.onclick = rateOk ? ()=>setMetric("rate") : null;

      if(!rateOk && currentMetric==="rate"){
        currentMetric="abs";
        document.getElementById("btnMetricAbs").classList.add("active");
        btnRate.classList.remove("active");
      }
    }

    function setMode(mode){
      currentMode=mode;
      document.getElementById("btnModeMuni").classList.toggle("active", mode==="muni");
      document.getElementById("btnModeMerhav").classList.toggle("active", mode==="merhav");
      updateMetricButtonsUI();

      if(mapInitialized){
        try{
          const layerToShow = (mode==="muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
          const layerToHide = (mode==="muni") ? POLICE_MERHAV_LAYER : MUNICIPAL_LAYER;
          govmap.setVisibleLayers([layerToShow],[layerToHide]);
        }catch(e){ console.warn("setVisibleLayers failed:", e); }
      }

      if(mode!=="muni"){
        choroplethEnabled=false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      }
      setChoroBtnUI();

      selectedCity=null;
      selectedCityKey=null;

      showInfo("××¤×”", `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${mode==="muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, "info");
    }

    function setMetric(metric){
      if(metric==="rate" && currentMode!=="muni"){
        showInfo("×œ× ×–××™×Ÿ", "×œ-10,000 ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª.", "error");
        return;
      }
      currentMetric=metric;
      document.getElementById("btnMetricAbs").classList.toggle("active", metric==="abs");
      document.getElementById("btnMetricRate").classList.toggle("active", metric==="rate");
      if(choroplethEnabled && currentMode==="muni") renderChoropleth();
      if(currentTab==="single" && selectedCityKey){
        const entry = (currentMode==="muni") ? muniIndex[selectedCityKey] : merhavIndex[selectedCityKey];
        if(entry) showEntry(entry);
      }
    }

    function showEntry(entry){
      const d=entry.data || {};
      let html="";
      const total = (typeof d.total==="number") ? d.total : null;
      const pop = (currentMode==="muni") ? getPopulationForAuthority(entry.name) : null;

      if(total!=null){
        if(currentMetric==="rate" && currentMode==="muni"){
          const rate=calcRatePer10k(total,pop);
          if(rate==null){
            html += `<div class="total-summary">${Number(total).toLocaleString()} ××™×¨×•×¢×™×</div>`;
            html += `<div class="message message-warn">××™×Ÿ × ×ª×•×Ÿ ××•×›×œ×•×¡×™×™×” ×¢×‘×•×¨ <strong>${escapeHtml(entry.name)}</strong>, ×œ×›×Ÿ ×œ-10,000 ×œ× ×–××™×Ÿ ×›××Ÿ.</div>`;
          }else{
            html += `<div class="total-summary">${rate.toLocaleString()} ×œ-10,000</div>`;
            html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${Number(pop).toLocaleString()} â€¢ ×¡×”×´×› ××™×¨×•×¢×™×: ${Number(total).toLocaleString()}</div>`;
          }
        }else{
          html += `<div class="total-summary">${Number(total).toLocaleString()} ××™×¨×•×¢×™×</div>`;
          if(currentMode==="muni"){
            html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${pop ? Number(pop).toLocaleString() : "×œ× × ××¦×"}</div>`;
          }
        }
      }

      if(d.breakdown && Object.keys(d.breakdown).length){
        const sorted=Object.entries(d.breakdown).sort((a,b)=>(b[1]||0)-(a[1]||0));
        html += `<div class="crime-grid">`;
        for(const [name,count] of sorted){
          html += `<div class="crime-item"><div class="crime-name">${escapeHtml(name)}</div><div class="crime-count">${Number(count||0).toLocaleString()}</div></div>`;
        }
        html += `</div>`;
      }

      document.getElementById("info-title").textContent = entry.name;
      document.getElementById("info-body").innerHTML = html || `<div class="message message-info">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>`;
    }

    // ========= GEOJSON -> WKT =========
    function ensureClosedRing(coords){
      if(!Array.isArray(coords) || coords.length<3) return coords;
      const first=coords[0], last=coords[coords.length-1];
      if(first && last && first[0]===last[0] && first[1]===last[1]) return coords;
      return coords.concat([[first[0], first[1]]]);
    }
    function ringToWkt(ring){
      const r=ensureClosedRing(ring);
      return r.map(p=>`${Number(p[0]).toFixed(3)} ${Number(p[1]).toFixed(3)}`).join(", ");
    }
    function geojsonGeomToWkt(geom){
      if(!geom || !geom.type) return null;
      if(geom.type==="Polygon"){
        const rings=(geom.coordinates||[]).map(ringToWkt);
        if(!rings.length) return null;
        return `POLYGON((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
      }
      if(geom.type==="MultiPolygon"){
        const polys=geom.coordinates||[];
        const parts=polys.map(poly=>{
          const rings=(poly||[]).map(ringToWkt);
          if(!rings.length) return null;
          return `((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
        }).filter(Boolean);
        if(!parts.length) return null;
        return `MULTIPOLYGON(${parts.join(",")})`;
      }
      return null;
    }
    async function loadMuniBoundariesGeojson(){
      if(muniGeojsonLoaded) return true;
      muniGeojsonLoadError=null;
      try{
        const res=await fetch(MUNI_GEOJSON_URL,{cache:"no-store"});
        if(!res.ok) throw new Error(`fetch failed (${res.status})`);
        const gj=await res.json();
        const idx={};
        const feats=Array.isArray(gj?.features)?gj.features:[];
        for(const f of feats){
          const name=f?.properties?.name;
          const wkt=geojsonGeomToWkt(f?.geometry);
          if(!name || !wkt) continue;
          idx[normalizeKey(name)] = wkt;
        }
        muniWktByName=idx;
        muniGeojsonLoaded=true;
        console.log("âœ… Boundaries loaded:", Object.keys(muniWktByName).length);
        return true;
      }catch(e){
        muniGeojsonLoadError=e;
        console.error("âŒ Failed loading muni boundaries:", e);
        return false;
      }finally{
        setChoroBtnUI();
      }
    }
    function findWktForCrimeName(crimeName){
      const vars=[crimeName, ...nameVariants(crimeName)];
      for(const v of vars){
        const wkt=muniWktByName[normalizeKey(v)];
        if(wkt) return wkt;
      }
      return null;
    }

    // ========= CHOROPLETH =========
    function lerp(a,b,t){ return a+(b-a)*t; }
    function clamp01(x){ return Math.max(0,Math.min(1,x)); }
    function rateToColor(rate,minR,maxR){
      const t=(maxR>minR)?clamp01((rate-minR)/(maxR-minR)):0.5;
      const r=Math.round(lerp(0,220,t));
      const g=Math.round(lerp(200,20,t));
      const b=20;
      return [r,g,b];
    }

    function clearChoropleth(){
      // NOTE: × ×™×§×•×™ ×¤×©×•×˜ ×•×‘×˜×•×—
      try{
        if(typeof govmap.clearGeometries==="function") govmap.clearGeometries();
      }catch(e){}
    }

    function setMunicipalLayerOpacity(opacity){
      if(typeof govmap.setLayerOpacity==="function"){
        try{ govmap.setLayerOpacity({layerName:MUNICIPAL_LAYER, opacity}); }catch(e){}
      }
    }

    function setChoroBtnUI(){
      const btn=document.getElementById("btnChoro");
      if(!btn) return;
      btn.classList.toggle("active", !!choroplethEnabled);
      btn.classList.toggle("disabled", false);
      btn.disabled=false;

      if(!muniGeojsonLoaded){
        btn.textContent="ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×˜×•×¢×Ÿ ×’×‘×•×œ×•×ª...)";
        btn.title = muniGeojsonLoadError
          ? "× ×›×©×œ ×œ×˜×¢×•×Ÿ GeoJSON. ×•×“× ×©×”×§×•×‘×¥ ×§×™×™× + ×©×¨×ª ××§×•××™."
          : "×˜×•×¢×Ÿ GeoJSON ×©×œ ×’×‘×•×œ×•×ª ×”×¨×©×•×™×•×ª...";
      }else{
        btn.textContent = choroplethEnabled ? "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000: ×¤×¢×™×œ" : "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)";
        btn.title="×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000";
      }
    }

    async function toggleChoropleth(){
      if(currentMode!=="muni") setMode("muni");
      choroplethEnabled = !choroplethEnabled;
      setChoroBtnUI();

      if(!mapInitialized) return;

      if(!choroplethEnabled){
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        showInfo("×¦×‘×™×¢×” ×›×•×‘×ª×”","×—×–×¨×ª×™ ×œ×ª×¦×•×’×” ×¨×’×™×œ×”.","info");
        return;
      }

      const ok=await loadMuniBoundariesGeojson();
      if(!ok){
        choroplethEnabled=false;
        setChoroBtnUI();
        showInfo("×œ× ×”×¦×œ×—×ª×™ ×œ×¦×‘×•×¢", `×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª <code>${escapeHtml(MUNI_GEOJSON_URL)}</code>.<br>×•×“× ×©×”×•× ×œ×™×“ <code>index.html</code> ×•×©××ª×” ××¨×™×¥ ×©×¨×ª ××§×•××™ (<code>python -m http.server</code>).`, "error");
        return;
      }

      // ×¦×‘×™×¢×” ×”×™× ×ª××™×“ "×œ-10,000"
      currentMetric="rate";
      document.getElementById("btnMetricAbs").classList.remove("active");
      document.getElementById("btnMetricRate").classList.add("active");

      await renderChoropleth();
    }

    async function renderChoropleth(){
      if(!mapInitialized || !choroplethEnabled) return;
      if(currentMode!=="muni") return;

      if(!muniGeojsonLoaded){
        const ok=await loadMuniBoundariesGeojson();
        if(!ok) return;
      }

      const yearData=window.crimeByYear?.[currentYear];
      if(!yearData){
        showInfo("×©×’×™××”","××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×©× ×‘×—×¨×”.","error");
        return;
      }

      const rows=[];
      const missingGeom=[];
      for(const name in yearData){
        const d=yearData[name];
        const total=Number(d?.total||0);
        const pop=getPopulationForAuthority(name);
        const rate=calcRatePer10k(total,pop);
        if(rate==null) continue;

        const wkt=findWktForCrimeName(name);
        if(!wkt){ missingGeom.push(name); continue; }

        rows.push({name,wkt,total,pop,rate});
      }

      if(!rows.length){
        showInfo("××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™×","×œ× × ××¦××• ×¨×©×•×™×•×ª ×¢× ××•×›×œ×•×¡×™×™×” + ×’×‘×•×œ ×›×“×™ ×œ×—×©×‘ ×œ-10,000.","warn");
        return;
      }

      const rates=rows.map(r=>r.rate);
      const minR=Math.min(...rates);
      const maxR=Math.max(...rates);

      const wkts=[], names=[], symbols=[];
      const tooltips=[], headers=[];
      const bubbleHTML = `
        <div style="direction:rtl;font-family:Arial;padding:6px 4px;line-height:1.6;">
          <div style="font-weight:900;font-size:14px;margin-bottom:6px;">{0}</div>
          <div style="font-size:13px;">
            ×œ-10,000: <b>{1}</b><br/>
            ××•×›×œ×•×¡×™×™×” (2019): <b>{2}</b><br/>
            ×¡×”×´×› ××™×¨×•×¢×™×: <b>{3}</b>
          </div>
        </div>`;
      const bubbleHTMLParameters=[];

      for(let i=0;i<rows.length;i++){
        const r=rows[i];
        const [rr,gg,bb]=rateToColor(r.rate,minR,maxR);

        wkts.push(r.wkt);
        names.push(`CHORO_${i}`);
        symbols.push({ fillColor:[rr,gg,bb,0.42], outlineColor:[60,60,60,0.60], outlineWidth:1 });

        tooltips.push(`${r.name} â€¢ ${r.rate.toLocaleString()} /10k`);
        headers.push(r.name);
        bubbleHTMLParameters.push([
          r.name,
          `${r.rate.toLocaleString()} /10k`,
          Number(r.pop).toLocaleString(),
          Number(r.total).toLocaleString()
        ]);
      }

      try{
        clearChoropleth();

        const payload={
          wkts,
          names,
          geometryType:(govmap.geometryType?.POLYGON ?? govmap.geometryType?.Polygon ?? 3),
          clearExisting:true,
          showBubble:true,
          symbols,
          data:{ tooltips, headers, bubbleHTML, bubbleHTMLParameters }
        };

        const ret=govmap.displayGeometries(payload);
        if(ret && typeof ret.then==="function") await ret;

        // ×¨×§ ××—×¨×™ ×”×¦×œ×—×”:
        setMunicipalLayerOpacity(0);

      }catch(e){
        console.error("displayGeometries failed:", e);
        setMunicipalLayerOpacity(100);
        showInfo("×©×’×™××”", `× ×›×©×œ×ª×™ ×œ×¦×™×™×¨ ×’×™××•××˜×¨×™×•×ª: ${escapeHtml(e?.message||e)}`, "error");
        return;
      }

      let extra="";
      if(missingGeom.length){
        extra=`<br><span style="font-size:12px;opacity:.9;">×œ× × ××¦××” ×’×™××•××˜×¨×™×” ×œ-${missingGeom.length} ×¨×©×•×™×•×ª (×‘×“×•×§ ×”×ª×××ª ×©××•×ª ×‘×§×•×‘×¥ ×”×’×‘×•×œ×•×ª).</span>`;
        console.log("Missing geometry for:", missingGeom);
      }

      showInfo("×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000", `×™×¨×•×§ = × ××•×š â€¢ ××“×•× = ×’×‘×•×”<br>×˜×•×•×—: <b>${minR.toLocaleString()}</b> ×¢×“ <b>${maxR.toLocaleString()}</b>${extra}`, "info");
    }

    // ========= MAP CLICK =========
    function fieldsToObject(fields){
      if(!Array.isArray(fields)) return fields;
      const obj={};
      for(const f of fields) if(f.FieldName && f.Value!==undefined) obj[f.FieldName]=f.Value;
      return obj;
    }
    function detectMunicipalityName(attrsRaw){
      const attrs=fieldsToObject(attrsRaw)||attrsRaw;
      const cands=["×©× ×¨×©×•×ª","×©× ×¨×©×•×ª ××§×•××™×ª","×©× ×™×©×•×‘","×™×©×•×‘ ×¡×•×¤×™","SHEM_YISHUV","NAME","Name"];
      for(const c of cands) if(attrs && attrs[c]) return attrs[c];
      return null;
    }
    function detectMerhavName(attrsRaw){
      const attrs=fieldsToObject(attrsRaw)||attrsRaw;
      const cands=["×©× ××¨×—×‘","×©× ××¨×—×‘ ××©×˜×¨×ª×™","MERHAV","SHEM_MERHAV","NAME","Name"];
      for(const c of cands) if(attrs && attrs[c]) return attrs[c];
      return null;
    }
    async function onMapClick(e){
      if(!mapInitialized) return;
      try{
        const layerName = (currentMode==="muni") ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
        const resp = await govmap.getLayerData({ LayerName: layerName, Point: e.mapPoint, Radius: 300 });
        const items = resp?.data || resp?.Data || [];
        if(!items.length){
          showInfo("×œ× × ××¦×","××™×Ÿ ××•×‘×™×™×§×˜ ×‘××–×•×¨ ×–×”","info");
          return;
        }
        const first=items[0];
        const attrs=first.Fields || first.Attributes || first;

        if(currentMode==="muni"){
          const nameFromMap=detectMunicipalityName(attrs);
          if(!nameFromMap){ showInfo("×©×’×™××”","×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”×¨×©×•×ª","error"); return; }
          const key=normalizeKey(nameFromMap);
          const entry = muniIndex[key] || muniIndex[nameVariants(nameFromMap)[0]];
          if(!entry){ showInfo("×œ× × ××¦××• × ×ª×•× ×™×", `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${escapeHtml(nameFromMap)}</strong> ×‘×©× ×ª ${currentYear}`, "error"); return; }
          selectedCity=entry.name;
          selectedCityKey=nameVariants(entry.name)[0];
          showEntry(entry);
          return;
        }

        const merhavName=detectMerhavName(attrs);
        if(!merhavName){ showInfo("×©×’×™××”","×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”××¨×—×‘","error"); return; }
        const key=normalizeKey(merhavName);
        const entry=merhavIndex[key];
        selectedCity=merhavName;
        selectedCityKey=key;
        if(!entry){ showInfo("×œ× × ××¦××• × ×ª×•× ×™×", `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${escapeHtml(merhavName)}</strong> ×‘×©× ×ª ${currentYear}`, "error"); return; }
        showEntry(entry);

      }catch(err){
        console.error("onMapClick failed:", err);
        showInfo("×©×’×™××”", `××™×¨×¢×” ×©×’×™××”: ${escapeHtml(err?.message||err)}`, "error");
      }
    }

    // ========= TABS =========
    function switchTab(tab){
      currentTab=tab;
      document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.toggle("active", c.id===`tab-${tab}`));
    }

    // ========= INIT =========
    function initGovMap(){
      if(!window.crimeByYear || typeof window.crimeByYear!=="object"){
        showInfo("×©×’×™××”","crimeByYear_2020_2025.js ×œ× × ×˜×¢×Ÿ","error");
        document.getElementById("loading").style.display="none";
        return;
      }

      const popOk = buildPopulationIndex();
      updateMetricButtonsUI();
      loadMuniBoundariesGeojson(); // background

      const years=Object.keys(window.crimeByYear).sort();
      const sel=document.getElementById("yearSelect");
      sel.innerHTML="";
      for(const y of years){
        const opt=document.createElement("option");
        opt.value=y; opt.textContent=y;
        sel.appendChild(opt);
      }
      currentYear = years.includes("2025") ? "2025" : years[years.length-1];
      sel.value=currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      yearlyStats[currentYear]=calculateStats(currentYear);
      updateQuickStats();

      sel.addEventListener("change",(e)=>{
        currentYear=e.target.value;
        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        yearlyStats[currentYear]=calculateStats(currentYear);
        updateQuickStats();

        selectedCity=null;
        selectedCityKey=null;

        if(choroplethEnabled && currentMode==="muni") renderChoropleth();
        showInfo("××¤×”", `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${currentMode==="muni"?"×¨×©×•×ª":"××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, "info");
      });

      govmap.createMap("map",{
        token:TOKEN,
        layers:[MUNICIPAL_LAYER,POLICE_MERHAV_LAYER],
        layersMode:4,
        background:3,
        zoomButtons:true,
        identifyOnClick:false,
        visibleLayers:[MUNICIPAL_LAYER],
        onLoad:()=>{
          mapInitialized=true;
          setMode("muni");
          setChoroBtnUI();

          try{ govmap.onEvent(govmap.events.CLICK).progress(onMapClick); }catch(e){ console.warn("click hook failed", e); }

          document.getElementById("loading").style.display="none";
          if(!popOk){
            showInfo("×©×™× ×œ×‘","PopulationDB.js ×œ× × ×˜×¢×Ÿ ××• ×œ× ×ª×§×™×Ÿ â€” ×œ-10,000 ×™×”×™×” ×—×œ×§×™.","warn");
          }else{
            showInfo("××¤×”", `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, "info");
          }
        }
      });
    }

    window.switchTab=switchTab;
    window.setMode=setMode;
    window.setMetric=setMetric;
    window.toggleChoropleth=toggleChoropleth;
    window.initGovMap=initGovMap;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading"><div class="box">×˜×•×¢×Ÿ ××¤×”â€¦</div></div>
  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×” ×‘×™×©×¨××œ</h1>
      <p>×™×©×•×‘×™×/×¨×©×•×™×•×ª + ××¨×—×‘×™× â€¢ 2020â€“2025</p>
      <div id="header-actions">
        <button class="hbtn secondary" onclick="setMunicipalLayerOpacity(100); clearChoropleth(); choroplethEnabled=false; setChoroBtnUI();">â†©ï¸ ××™×¤×•×¡ ×¦×‘×™×¢×”</button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">×ª×¦×•×’×”</div>
      <div class="tab" data-tab="help" onclick="switchTab('help')">×¢×–×¨×”</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')">ğŸ˜ï¸ ×™×©×•×‘×™×/×¨×©×•×™×•×ª</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">ğŸš” ××¨×—×‘×™×</button>

        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')">ğŸ”¢ ×›××•×ª</button>
        <button id="btnMetricRate" class="mode-btn">ğŸ‘¥ ×œ-10,000</button>

        <button id="btnChoro" class="mode-btn full" onclick="toggleChoropleth()">ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)</button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×©× ×”:</label>
        <select id="yearSelect"></select>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label">×¨×©×•×™×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">×¡×”"×› ××™×¨×•×¢×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">×××•×¦×¢</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">×˜×•×¢×Ÿâ€¦</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-help">
        <div class="message message-info">
          ×›×“×™ ×©×”×¦×‘×™×¢×” ×ª×¢×‘×•×“:<br>
          1) ×”×§×•×‘×¥ <code>muni_boundaries_ITM.geojson</code> ×—×™×™×‘ ×œ×”×™×•×ª ×œ×™×“ <code>index.html</code><br>
          2) ×œ×¤×ª×•×— ×“×¨×š ×©×¨×ª ××§×•××™ (×œ× file://): <code>python -m http.server 8000</code><br>
          3) ×œ×œ×—×•×¥ ×¢×œ â€œğŸ¨ ×¦×‘×™×¢×” ×œ-10,000â€.<br><br>
          ×× ×”×’×‘×•×œ "× ×¢×œ×" ×‘×œ×™ ×¦×‘×¢ â€” ×–×” ××•××¨ ×©×”×™×™×ª×” ×©×’×™××” ×‘Ö¾<code>displayGeometries</code> ××• ×©×”×§×•×‘×¥ ×œ× × ×˜×¢×Ÿ.
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>מפת פשיעה לפי רשויות מקומיות</title>

  <!-- קובץ הדאטה: חייב להכיל const crimeDB = { ... }; בלי export -->
  <script src="crimeDB.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      direction: rtl;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 280px;
      max-width: 360px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-size: 14px;
    }

    #info-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 15px;
    }

    #info-body {
      white-space: pre-line;
      line-height: 1.4;
      max-height: 60vh;
      overflow-y: auto;
    }
  </style>

  <script type="text/javascript">
    const MUNICIPAL_LAYER = "125"; // שכבת רשויות/יישובים שאתה משתמש בה
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let mapInitialized = false;
    const crimeIndex = {};
    let detectedMunicipalityField = null;

    // --- נירמול שמות (מוריד "מועצה אזורית", "עיריית" וכו') ---
    function normalizeName(name) {
      let s = (name || "").toString().trim();

      s = s
        .replace(/^מועצה\s+אזורית\s+/, "")
        .replace(/^מועצה\s+מקומית\s+/, "")
        .replace(/^עיריית\s+/, "")
        .replace(/^עיריה\s+/, "");

      s = s
        .replace(/["׳״']/g, "")
        .replace(/[\s\-]/g, "")
        .toLowerCase();

      return s;
    }

    // --- בניית אינדקס שמות מה-crimeDB ---
    function buildCrimeIndex() {
      if (typeof crimeDB === "undefined") {
        console.error("crimeDB לא מוגדר. בדוק ש-crimeDB.js נטען ושאין בו export.");
        return;
      }

      for (const key of Object.keys(crimeDB)) {
        const norm = normalizeName(key);
        crimeIndex[norm] = { name: key, data: crimeDB[key] };
      }

      console.log("crimeIndex built:", Object.keys(crimeIndex).length, "entries");
    }

    // --- חיפוש רשות בדאטה עם קצת גמישות ---
    function findCrimeEntry(muniName) {
      const norm = normalizeName(muniName);

      if (crimeIndex[norm]) return crimeIndex[norm];

      let best = null;
      for (const key in crimeIndex) {
        if (key === norm) return crimeIndex[key];
        if (!best && (key.endsWith(norm) || norm.endsWith(key))) {
          best = crimeIndex[key];
        }
      }
      return best;
    }

    // --- יצירת מפה + הרשמה לאירוע CLICK ---
    function initGovMap() {
      buildCrimeIndex();

      function listener() {
        govmap
          .onEvent(govmap.events.CLICK)
          .progress(onMapClick);
      }

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER],
        background: 2,
        layersMode: 1,
        zoomButtons: true,
        showXY: true,
        identifyOnClick: false,
        onLoad: () => listener()
      });

      mapInitialized = true;
      console.log("GovMap ready (layer", MUNICIPAL_LAYER, ")");
    }

    // --- המרה של מערך {FieldName, Value} ל-Object רגיל ---
    function fieldsArrayToObject(arr) {
      if (!Array.isArray(arr)) return arr;
      const obj = {};
      for (const f of arr) {
        if (f && f.FieldName) {
          obj[f.FieldName] = f.Value;
        }
      }
      return obj;
    }

    // --- קליק על המפה ---
    async function onMapClick(e) {
      if (!mapInitialized) return;

      const x = e.mapPoint.x;
      const y = e.mapPoint.y;

      const params = {
        LayerName: MUNICIPAL_LAYER,
        Point: { x, y },
        Radius: 250
      };

      try {
        const resp = await govmap.getLayerData(params);
        console.log("getLayerData:", resp);

        const items =
          resp.data ||
          resp.Data ||
          resp.entities ||
          resp.Entities ||
          resp.features ||
          [];

        if (!items.length) {
          showInfo("לא נמצאה רשות / ישוב", "אין ישות מתאימה בנקודה הזו או שהשכבה אינה פעילה.");
          return;
        }

        const feature = items[0];

        let attrs =
          feature.Attributes ||
          feature.attributes ||
          feature.fields ||
          feature.Fields ||
          feature;

        // אם attrs הוא מערך של {FieldName, Value} – ממפים לאובייקט
        attrs = fieldsArrayToObject(attrs);

        console.log("feature attrs (after map):", attrs);

        const muniName = detectMunicipalityName(attrs);

        if (!muniName) {
          showInfo("לא זוהה שם ישוב/רשות", "לא נמצא שדה עברי שמתאים לשם.");
          return;
        }

        const crimeEntry = findCrimeEntry(muniName);

        if (!crimeEntry) {
          showInfo(
            `שם מהשכבה: ${muniName}`,
            "לא נמצאו נתוני פשיעה בקובץ crimeDB עבור שם זה.\nבדוק אם השם מופיע בעמודת \"ישוב סופי\" בקובץ האקסל."
          );
          return;
        }

        const title = `יישוב / רשות: ${crimeEntry.name}`;
        const lines = [];
        const data = crimeEntry.data;

        if (typeof data === "object" && data !== null) {
          if (typeof data.total !== "undefined") {
            lines.push(`סה\"כ אירועים: ${data.total}`);
            lines.push("");
          }

          if (typeof data.breakdown === "object" && data.breakdown !== null) {
            lines.push("פירוט לפי קבוצת עבירה:\n");
            for (const k of Object.keys(data.breakdown)) {
              lines.push(`• ${k}: ${data.breakdown[k]}`);
            }
          }
        } else {
          lines.push(String(data));
        }

        showInfo(title, lines.join("\n"));

      } catch (err) {
        console.error("getLayerData error:", err);
        showInfo("שגיאה", err.message || String(err));
      }
    }

    // --- זיהוי שם היישוב / רשות מתוך attrs (עכשיו זה Object של FieldName -> Value) ---
    function detectMunicipalityName(attrs) {
      if (!attrs) return null;

      if (detectedMunicipalityField && attrs[detectedMunicipalityField]) {
        return attrs[detectedMunicipalityField];
      }

      const CANDIDATE_FIELDS = [
        "ישוב סופי",
        "שם ישות",
        "שם ישוב",
        "שם יישוב",
        "שם רשות",
        "שם רשות מקומית"
      ];

      // קודם – שדות ידועים בשמות נפוצים
      for (const field of CANDIDATE_FIELDS) {
        if (attrs[field] && typeof attrs[field] === "string") {
          detectedMunicipalityField = field;
          console.log("Detected municipality field (by name):", field, "=>", attrs[field]);
          return attrs[field];
        }
      }

      // אם לא – חיפוש כללי על כל המפתחות (צריך להיות string בעברית)
      for (const key of Object.keys(attrs)) {
        const val = attrs[key];
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          detectedMunicipalityField = key;
          console.log("Fallback municipality field:", key, "=>", val);
          return val;
        }
      }

      return null;
    }

    function showInfo(title, body) {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").textContent = body;
    }
  </script>

  <!-- GOVMAP נטען בסוף ומפעיל initGovMap -->
  <script
    src="https://www.govmap.gov.il/govmap/api/govmap.api.js"
    defer
    onload="initGovMap()">
  </script>
</head>

<body>
  <div id="map"></div>

  <div id="info-panel">
    <div id="info-title">מפת פשיעה לפי רשות / ישוב</div>
    <div id="info-body">
      לחץ על עצם בשכבת "רשויות מקומיות" כדי לראות את נתוני הפשיעה מהקובץ.
    </div>
  </div>
</body>
</html>

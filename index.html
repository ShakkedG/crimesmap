<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>× ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ×¨×©×•×ª</title>

  <!-- GOVMAP API -->
  <script
    src="https://www.govmap.gov.il/govmap/api/govmap.api.js"
    defer
    onload="initGovMap()">
  </script>

  <!-- ×”×§×•×‘×¥ ×©× ×•×¦×¨ ××”-Pivot: ××›×™×œ const crimeDB = {...} -->
  <script src="crimeDB.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #map {
      flex: 3;
    }

    #infoPanel {
      flex: 1;
      padding: 15px;
      background: #f5f5f5;
      box-sizing: border-box;
      border-left: 1px solid #ccc;
      overflow-y: auto;
    }

    #infoPanel h2 {
      margin-top: 0;
    }

    .crime-type {
      margin: 4px 0;
    }

    .city-name {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 6px;
    }

    .total-crime {
      font-size: 18px;
      margin-bottom: 10px;
    }

    ul {
      padding-right: 18px;
    }
  </style>
</head>

<body>
  <div id="container">
    <!-- ×¤×× ×œ ×”××™×“×¢ -->
    <div id="infoPanel">
      <h2>× ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ×¨×©×•×ª</h2>
      <div id="cityInfo">
        ×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×” (×©×›×‘×ª "×•×¢×“×™× ××§×•××™×™×") ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×.
      </div>
    </div>

    <!-- ×”××¤×” -->
    <div id="map"></div>
  </div>

  <script>
    // ×©×›×‘×ª ×•×¢×“×™× ××§×•××™×™× â€“ 124 ×œ×¤×™ GOVMAP
    const SETTLEMENT_LAYER = "124";

    // ××ª ×–×” × ×¢×“×›×Ÿ ××—×¨×™ ×©× ×¨××” ××” ×—×•×–×¨ ×‘-console
    const CITY_FIELD = "SHEM_RASHUT"; // × ×—×œ×™×£ ×œ×©× ×”× ×›×•×Ÿ ××—×¨×™ ×©× ×¨××” response

    // ××•×¤×¢×œ ×›×©×¡×§×¨×™×¤×˜ GOVMAP × ×˜×¢×Ÿ
    function initGovMap() {
      console.log("initGovMap â€“ ××ª×—×™×œ ×œ×™×¦×•×¨ ××¤×”");

      function registerClickListener() {
        console.log("map loaded â€“ × ×¨×©××™× ×œ××™×¨×•×¢ CLICK");

        govmap.onEvent(govmap.events.CLICK).progress(onMapClick);
      }

      govmap.createMap("map", {
        token: "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c", // ×”×˜×•×§×Ÿ ×©×œ×š
        layers: [SETTLEMENT_LAYER],
        background: 2,
        layersMode: 1,
        zoomButtons: true,
        level: 10,
        showXY: true,
        identifyOnClick: false,
        onLoad: registerClickListener      // ğŸ‘ˆ ×—×©×•×‘! ×”×”××–× ×” × ×¨×©××ª ×¨×§ ××—×¨×™ ×©×”××¤×” ×¢×œ×ª×”
      });
    }

    // ××” ×§×•×¨×” ×›×©××©×ª××© ×œ×•×—×¥ ×¢×œ ×”××¤×”
  async function onMapClick(e) {
  console.log("onMapClick â€“ ××™×¨×•×¢ ×œ×—×™×¦×”:", e);

  // ×‘×“×™×§×”: ××” ×™×© ×‘×ª×•×š mapPoint?
  console.log("mapPoint:", e.mapPoint);
  console.log("mapPoint keys:", Object.keys(e.mapPoint || {}));

  try {
    const res = await govmap.selectFeaturesOnMap({
      drawType: govmap.drawType.Point,
      x: e.mapPoint && e.mapPoint.x,
      y: e.mapPoint && e.mapPoint.y,
      layers: [SETTLEMENT_LAYER],
      filterLayer: true,
      isZoomToExtent: false,
      returnFields: {
        [SETTLEMENT_LAYER]: [CITY_FIELD]
      }
    });

    console.log("selectFeaturesOnMap response:", res);

    const cityName = extractCityName(res);

    if (!cityName) {
      showMessage("×œ× ×–×•×”×ª×” ×¨×©×•×ª ×‘× ×§×•×“×” ×©× ×‘×—×¨×”.");
      return;
    }

    console.log("×¨×©×•×ª ×©×–×•×”×ª×”:", cityName);
    showCrimeData(cityName);

  } catch (err) {
    console.error("×©×’×™××” ×‘×§×¨×™××” ×œ-selectFeaturesOnMap:", err);
    showMessage("××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×§×¨×™××ª ×”× ×ª×•× ×™× ××”××¤×”.");
  }
}

    // ××•×¦×™× ××ª ×©× ×”×¨×©×•×ª ××”×ª×©×•×‘×” ×©×œ GOVMAP
    function extractCityName(res) {
      if (!res) return null;

      // ×§×•×“× × × ×¡×” ×‘××‘× ×” ×©×œ ××•×‘×™×™×§×˜ ×œ×¤×™ ×©× ×©×›×‘×” ("124")
      if (res[SETTLEMENT_LAYER] && res[SETTLEMENT_LAYER].length > 0) {
        const feature = res[SETTLEMENT_LAYER][0];
        const name = feature[CITY_FIELD];
        return name ? name.toString().trim() : null;
      }

      // ×‘×™×˜×•×— â€“ ×× ×–×” ×¤×©×•×˜ ××¢×¨×š
      if (Array.isArray(res) && res.length > 0) {
        const feature = res[0];
        if (feature && feature[CITY_FIELD]) {
          return feature[CITY_FIELD].toString().trim();
        }
      }

      return null;
    }

    // ××¦×™×’ ×”×•×“×¢×” ×›×œ×œ×™×ª ×‘×¤×× ×œ
    function showMessage(text) {
      const panel = document.getElementById("cityInfo");
      panel.innerHTML = `<p>${text}</p>`;
    }

    // ××¦×™×’ × ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ×¨×©×•×ª ××ª×•×š crimeDB
    function showCrimeData(cityName) {
      const panel = document.getElementById("cityInfo");

      const data = crimeDB[cityName];

      if (!data) {
        panel.innerHTML = `
          <div class="city-name">${cityName}</div>
          <p>××™×Ÿ × ×ª×•× ×™× ×‘×˜×‘×œ×ª ×”×¤×©×™×¢×” ×¢×‘×•×¨ ×¨×©×•×ª ×–×•.</p>
        `;
        return;
      }

      let html = "";
      html += `<div class="city-name">${cityName}</div>`;
      html += `<div class="total-crime"><strong>×¡×”"×› ×¢×‘×™×¨×•×ª:</strong> ${data.total}</div>`;
      html += `<h4>×¤×™×¨×•×˜ ×œ×¤×™ ×§×‘×•×¦×ª ×¢×‘×™×¨×”:</h4>`;
      html += `<ul>`;

      for (const [type, count] of Object.entries(data.breakdown)) {
        html += `<li class="crime-type"><strong>${type}:</strong> ${count}</li>`;
      }

      html += `</ul>`;

      panel.innerHTML = html;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×¨×©×•×ª / ×ª×—× ×ª ××©×˜×¨×”</title>

  <!-- ×˜×•×¢×Ÿ ××ª ×”×“××˜×”×‘×™×™×¡×™× -->
  <script src="policeDB.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map { width: 100%; height: 100%; }

    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      width: 380px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      font-size: 14px;
    }

    #mode-switch { margin-bottom: 8px; }
    #info-title { font-weight: bold; margin-bottom: 6px; }
    #info-body  { white-space: pre-line; max-height: 60vh; overflow-y: auto; }
    
    .debug-info {
      background: #f0f0f0;
      padding: 8px;
      margin-top: 8px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid #ccc;
      max-height: 400px;
      overflow-y: auto;
    }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10000;
    }
  </style>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>

  <script>
    const MUNICIPAL_LAYER = "125";
    const STATION_LAYER   = "24";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let currentMode = "station";
    let mapInitialized = false;

    const unitIndex = {};
    let detectedStationField = null;

    /* × ×™×¨××•×œ ××©×•×¤×¨ */
    function normalizeUnitKey(raw) {
      if (!raw) return "";
      
      let s = raw.toString().trim();
      
      console.log("ğŸ” Raw name from map:", s);
      
      // × ×™×§×•×™ unicode
      s = s.normalize("NFKC")
           .replace(/\p{Cf}/gu, "")
           .replace(/\p{Mn}/gu, "");
      
      // ×”×—×œ×¤×ª ×¨×•×•×—×™× ××™×•×—×“×™×
      s = s.replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g, " ");
      
      // ×”×¡×¨×ª ×§×™×“×•××•×ª
      s = s.replace(/^×ª×—× ×ª\s+××©×˜×¨×”\s+/gi, "")
           .replace(/^×ª×—× ×ª\s+/gi, "")
           .replace(/^××¨×—×‘\s+/gi, "")
           .replace(/^××©×˜×¨×ª\s+/gi, "")
           .trim();
      
      // ×”×¡×¨×ª ×’×¨×©×™×™×, ××§×¤×™×, ×¨×•×•×—×™×
      s = s.replace(/[×´"×³']/g, "")
           .replace(/[â€“â€”\-]/g, "")
           .replace(/\s+/g, "")
           .toLowerCase();
      
      console.log("ğŸ”‘ Normalized key:", s);
      
      return s;
    }

    /* ×‘× ×™×™×ª ××™× ×“×§×¡ */
    function buildIndexes() {
      console.log("ğŸ“‹ Building police station index...");
      
      for (const k in policeDB) {
        if (k === "Grand Total" || k === "(blank)" || k === "×›×œ ×”××¨×¥") continue;
        
        const rawName = k.toString().trim();
        const key = normalizeUnitKey(rawName);
        
        if (!key) continue;
        
        console.log(`  Adding: "${rawName}" -> "${key}"`);
        
        if (!unitIndex[key]) {
          unitIndex[key] = { name: rawName, data: policeDB[k] };
        } else if (Array.isArray(unitIndex[key])) {
          unitIndex[key].push({ name: rawName, data: policeDB[k] });
        } else {
          unitIndex[key] = [unitIndex[key], { name: rawName, data: policeDB[k] }];
        }
      }

      console.log("âœ… Index built with", Object.keys(unitIndex).length, "entries");
      console.log("ğŸ“Š Sample keys:", Object.keys(unitIndex).slice(0, 10));
    }

    /* UI */
    function showInfo(title, body) {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").innerHTML = body;
    }

    function showEntry(label, entry) {
      const lines = [];
      const d = entry.data;

      if (d.total !== undefined) {
        lines.push(`<strong>×¡×”×´×› ××™×¨×•×¢×™×: ${d.total.toLocaleString()}</strong>\n`);
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        lines.push("\n<strong>×¤×™×¨×•×˜ ×¢×‘×™×¨×•×ª:</strong>");
        const sorted = Object.entries(d.breakdown)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        for (const [k, v] of sorted) {
          lines.push(`â€¢ ${k}: ${v.toLocaleString()}`);
        }
      }

      showInfo(`${label}: ${entry.name}`, lines.join("\n"));
    }

    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const o = {};
      for (const f of fields) o[f.FieldName] = f.Value;
      return o;
    }

    function pickHebrewField(attrs) {
      for (const k in attrs) {
        if (typeof attrs[k] === "string" && /[\u0590-\u05FF]/.test(attrs[k])) {
          return { key: k, value: attrs[k] };
        }
      }
      return null;
    }

    /* ×–×™×”×•×™ ×©× ×ª×—× ×” */
    function detectStationName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw);
      
      console.log("ğŸ—ºï¸ GovMap attributes:", attrs);
      
      if (detectedStationField && attrs[detectedStationField]) {
        return attrs[detectedStationField];
      }
      
      const candidates = [
        "×©× ×ª×—× ×”", "×©× ×ª×—× ×ª ××©×˜×¨×”", "×©×", 
        "SHEM_TACHANA", "NAME", "Station_Name"
      ];
      
      for (const c of candidates) {
        if (attrs[c]) {
          detectedStationField = c;
          console.log(`âœ… Found field: ${c} = ${attrs[c]}`);
          return attrs[c];
        }
      }
      
      const any = pickHebrewField(attrs);
      if (any) {
        detectedStationField = any.key;
        console.log(`âœ… Found Hebrew field: ${any.key} = ${any.value}`);
        return any.value;
      }
      
      return null;
    }

    /* MAP */
    function initGovMap() {
      console.log("ğŸš€ Initializing map...");
      
      buildIndexes();

      try {
        govmap.createMap("map", {
          token: TOKEN,
          layers: [STATION_LAYER],
          layersMode: 1,
          background: 2,
          zoomButtons: true,
          identifyOnClick: false,
          onLoad: () => {
            console.log("âœ… Map loaded!");
            document.getElementById('loading').style.display = 'none';
            mapInitialized = true;
            govmap.onEvent(govmap.events.CLICK).progress(onMapClick);
            showInfo("××¤×ª ×¤×©×™×¢×”", "×œ×—×¥ ×¢×œ ×ª×—× ×ª ××©×˜×¨×” ×‘××¤×”");
          }
        });
      } catch (error) {
        console.error("âŒ Error:", error);
        document.getElementById('loading').innerHTML = "×©×’×™××”: " + error.message;
      }
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      try {
        const resp = await govmap.getLayerData({
          LayerName: STATION_LAYER,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp.data || resp.Data || [];
        if (!items.length) {
          showInfo("×œ× × ××¦×", "××™×Ÿ ×ª×—× ×ª ××©×˜×¨×” ×‘××–×•×¨ ×–×”");
          return;
        }

        const attrs = items[0].Fields || items[0].Attributes || items[0];
        const name = detectStationName(attrs);
        const raw = (name ?? "").toString().trim();
        const key = normalizeUnitKey(raw);
        const hit = unitIndex[key];

        if (!hit) {
          const debugInfo = `
<div class="debug-info">
<strong>ğŸ” ××™×“×¢ ×œ×“×™×‘×•×’:</strong><br><br>
<strong>×©× ××”-GovMap:</strong> ${raw}<br>
<strong>××¤×ª×— ×× ×•×¨××œ:</strong> ${key}<br><br>
<strong>×›×œ ×”×©×“×•×ª:</strong><br>
<pre>${JSON.stringify(attrs, null, 2)}</pre><br>
<strong>×“×•×’×××•×ª ×××¤×ª×—×•×ª ×§×™×™××™×:</strong><br>
${Object.keys(unitIndex).slice(0, 15).join(", ")}
</div>`;
          
          showInfo("âŒ ×œ× × ××¦××” ×”×ª×××”", debugInfo);
          return;
        }

        if (Array.isArray(hit)) {
          showInfo(
            "âš ï¸ ×›××” ×”×ª×××•×ª",
            `×©×: ${raw}\n\n` + hit.map(x => `- ${x.name}`).join("\n")
          );
          return;
        }

        showEntry("×ª×—× ×ª ××©×˜×¨×”", hit);
        
      } catch (error) {
        console.error("Error:", error);
        showInfo("×©×’×™××”", error.message);
      }
    }

    window.addEventListener('load', function() {
      if (typeof govmap !== 'undefined' && typeof policeDB !== 'undefined') {
        console.log("âœ… All resources loaded");
        initGovMap();
      } else {
        console.error("âŒ Missing resources!");
        if (typeof govmap === 'undefined') console.error("- govmap not loaded");
        if (typeof policeDB === 'undefined') console.error("- policeDB not loaded");
        document.getElementById('loading').innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×ª ××©××‘×™×";
      }
    });
  </script>
</head>

<body>
  <div id="loading">×˜×•×¢×Ÿ ××¤×”...</div>
  <div id="map"></div>

  <div id="info-panel">
    <div id="info-title">××¤×ª ×¤×©×™×¢×”</div>
    <div id="info-body">×××ª×™×Ÿ ×œ×˜×¢×™× ×”...</div>
  </div>
</body>
</html>

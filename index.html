<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×©× ×” (2020â€“2025) | ×™×©×•×‘×™× / ××¨×—×‘×™×</title>

  <!-- GOVMAP API -->
  <script
    src="https://www.govmap.gov.il/govmap/api/govmap.api.js"
    defer
    onload="initGovMap()"></script>

  <!-- DATA -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>
  <script src="crimeByYearStations.js"></script>

  <!-- Optional boundaries helper (if you have it) -->
  <script src="muni_boundaries.js"></script>

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
      font-size: 15px;
    }

    #map { width: 100%; height: 100%; position: relative; }
    .esri-layer-list, .esri-legend { display: none !important; }

    #info-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: white;
      padding: 0;
      border-radius: 12px;
      width: 430px;
      max-height: calc(100vh - 30px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: height .2s ease, max-height .2s ease;
    }

    #panel-header {
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color: white;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.15);
      flex-shrink: 0;
    }
    #panel-header h1 { margin: 0; font-size: 17px; font-weight: 900; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.94; line-height: 1.35; font-weight: 800; }

    #header-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .hbtn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.15);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-size: 13px;
    }
    .hbtn:active{ transform: translateY(1px); }
    .hbtn.secondary{
      background: rgba(0,0,0,.12);
      border-color: rgba(255,255,255,.22);
    }

    #tabs {
      display: flex;
      gap: 0;
      background: #fafafa;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
    }
    .tab {
      flex: 1;
      padding: 11px 8px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 1000;
      color: #666;
      user-select: none;
      white-space: nowrap;
    }
    .tab:hover { background: #f0f0f0; color: #333; }
    .tab.active { background: white; border-bottom-color: #0066cc; color: #0066cc; }

    #controls {
      padding: 12px 14px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mode-btn {
      padding: 11px 10px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 1000;
      color: #555;
      transition: all 0.15s ease;
      user-select: none;
      text-align: center;
    }
    .mode-btn:hover { border-color: #0066cc; color: #0066cc; }
    .mode-btn.active {
      background: #0066cc;
      border-color: #0066cc;
      color: white;
      box-shadow: 0 2px 6px rgba(0,102,204,0.25);
    }
    .mode-btn.disabled {
      opacity: 0.55;
      cursor: not-allowed !important;
      border-color: #ddd !important;
      color: #666 !important;
      background: #fff !important;
      pointer-events: none;
    }
    .mode-btn.full { grid-column: 1 / -1; }
    .mode-btn.primary {
      font-size: 14px;
      padding: 13px 10px;
      border-width: 3px;
    }

    #controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    #controls label {
      font-weight: 1000;
      font-size: 13px;
      color: #333;
      white-space: nowrap;
    }
    #yearSelect {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
      cursor: pointer;
      font-weight: 900;
    }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .stat-value { font-size: 18px; font-weight: 1000; color: #0066cc; margin-bottom: 3px; }
    .stat-label { font-size: 12px; color: #777; font-weight: 1000; letter-spacing: .2px; }

    #info-content {
      padding: 14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title {
      font-weight: 1000;
      font-size: 16px;
      margin-bottom: 12px;
      color: #222;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    #info-body { line-height: 1.6; color: #555; }

    .total-summary {
      font-size: 26px;
      font-weight: 1000;
      color: #0066cc;
      margin: 12px 0 10px 0;
      text-align: center;
      padding: 14px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
      border-radius: 12px;
      border: 2px solid #b3d9ff;
    }

    .sub-summary {
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
      font-size: 13px;
      color: #444;
      font-weight: 900;
    }

    .crime-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .crime-item {
      background: #fafafa;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      border-right: 4px solid #0066cc;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .crime-name {
      font-weight: 1000;
      color: #333;
      font-size: 13px;
      line-height: 1.35;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .crime-count { font-weight: 1000; color: #0066cc; font-size: 17px; }

    .message {
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 13.5px;
      border-right: 4px solid;
      line-height: 1.55;
      font-weight: 800;
    }
    .message-info  { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }
    .message-warn  { background: #fff7e6; color: #7a4a00; border-right-color: #ffb300; }
    .message-error { background: #fff0f0; color: #c00; border-right-color: #ff0000; }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px 28px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 14px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .compare-city-tag {
      background: #e7f3ff;
      color: #0066cc;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #b3d9ff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 1000;
    }
    .compare-city-tag button {
      border: none; background: none; color: #0066cc;
      cursor: pointer; font-size: 18px; line-height: 1;
      padding: 0; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover { background: #0066cc; color: white; }

    .add-compare-btn {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 1000;
      cursor: pointer;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    .add-compare-btn:hover {
      background: #0052a3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,102,204,0.3);
    }

    .compare-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 10px; }
    .compare-card {
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.2s ease;
    }
    .compare-card:hover {
      border-color: #b3d9ff;
      box-shadow: 0 4px 12px rgba(0,102,204,0.15);
      transform: translateY(-2px);
    }
    .compare-card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e7f3ff;
    }
    .compare-name {
      font-weight: 1000;
      color: #222;
      font-size: 15px;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      font-size: 11px;
      font-weight: 1000;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      color: #555;
    }
    .badge-warn {
      border-color: #ffcc80;
      background: #fff7e6;
      color: #7a4a00;
    }
    .compare-kpis {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    .kpi {
      border: 1px solid #e7f3ff;
      background: white;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: all 0.2s ease;
    }
    .kpi:hover {
      border-color: #b3d9ff;
      background: #f8fbff;
    }
    .kpi .kpi-value { font-weight: 1000; color: #0066cc; font-size: 16px; margin-bottom: 4px; }
    .kpi .kpi-label { font-size: 11px; font-weight: 1000; color: #666; letter-spacing: .2px; text-transform: uppercase; }

    .compare-bars-title {
      margin: 18px 0 12px 0;
      font-weight: 1000;
      font-size: 15px;
      color: #222;
      padding: 10px 12px;
      background: #f0f7ff;
      border-radius: 10px;
      border-right: 4px solid #0066cc;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 140px 1fr 80px;
      gap: 10px;
      align-items: center;
      margin: 8px 0;
      padding: 10px;
      background: #fafafa;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s ease;
    }
    .bar-row:hover {
      background: #f8fbff;
      border-color: #b3d9ff;
    }
    .bar-name {
      font-size: 13px;
      font-weight: 1000;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bar-track {
      height: 32px;
      background: #e7f3ff;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      border: 1px solid #b3d9ff;
    }
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066cc 0%, #0080ff 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      font-size: 13px;
      font-weight: 1000;
      transition: width 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
      white-space: nowrap;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .bar-value {
      font-size: 14px;
      font-weight: 1000;
      color: #0066cc;
      text-align: left;
    }

    .trend-table{
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .trend-row{
      display: grid;
      grid-template-columns: 90px 1fr 1fr 1fr;
      gap: 12px;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 900;
      color: #222;
      transition: all 0.2s ease;
    }
    .trend-row:last-child{ border-bottom: none; }
    .trend-row > div{
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 13px;
    }
    .trend-row.trend-head{
      background: linear-gradient(135deg, #0066cc 0%, #0080ff 100%);
      color: white;
      font-weight: 1000;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .trend-row:not(.trend-head):nth-child(even){
      background: #f8fbff;
    }
    .trend-row:not(.trend-head):hover {
      background: #e7f3ff;
      transform: translateX(-2px);
    }

    .rank-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .rank-row {
      display: grid;
      grid-template-columns: 50px 1fr 100px;
      gap: 12px;
      align-items: center;
      padding: 14px;
      background: linear-gradient(135deg, #ffffff 0%, #f8fbff 100%);
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      transition: all 0.2s ease;
    }
    .rank-row:hover {
      border-color: #b3d9ff;
      background: linear-gradient(135deg, #f8fbff 0%, #e7f3ff 100%);
      transform: translateX(-4px);
      box-shadow: 0 4px 12px rgba(0,102,204,0.15);
    }
    .rank-num {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, #0066cc 0%, #0080ff 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 1000;
      box-shadow: 0 2px 6px rgba(0,102,204,0.3);
    }
    .rank-name {
      font-size: 14px;
      font-weight: 1000;
      color: #222;
    }
    .rank-value {
      font-size: 17px;
      font-weight: 1000;
      color: #0066cc;
      text-align: left;
    }
    .rank-extra {
      grid-column: 2 / -1;
      font-size: 12px;
      color: #666;
      font-weight: 800;
      padding: 8px 12px;
      background: #f0f7ff;
      border-radius: 8px;
      margin-top: 8px;
    }

    .modal { display:none; position:fixed; inset:0; z-index:20000; }
    .modal.show { display:block; }
    .modalOverlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }
    .modalCard {
      position:relative;
      width:min(760px, calc(100vw - 26px));
      max-height: calc(100vh - 26px);
      margin: 13px auto;
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader {
      padding:14px 16px;
      border-bottom:1px solid #e5e5e5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color:#fff;
    }
    .modalHeaderTitle { font-weight:1000; font-size:15px; }
    .modalClose {
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width:40px;
      height:40px;
      border-radius:12px;
      cursor:pointer;
      font-size:20px;
      font-weight:1000;
    }
    .modalBody { padding:16px; overflow:auto; }

    #addrResults {
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      margin-top: 10px;
    }
    .addr-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 800;
    }
    .addr-item:last-child { border-bottom: none; }
    .addr-item:hover { background: #f5f9ff; }
    .addr-sub { font-size: 12.5px; color: #666; margin-top: 3px; font-weight: 700; }

    #info-panel.collapsed { max-height: 120px; height: 120px; }
    #info-panel.collapsed #tabs,
    #info-panel.collapsed #controls,
    #info-panel.collapsed #info-content { display:none; }

    .rowBtns { display:flex; gap:8px; }
    .btn {
      padding: 11px 10px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 1000;
      color: #555;
      transition: all 0.15s ease;
      user-select: none;
      text-align: center;
      flex:1;
    }
    .btn:hover { border-color: #0066cc; color: #0066cc; }
    .btn.active { background:#0066cc; border-color:#0066cc; color:#fff; }
    .btn.disabled { opacity:.55; pointer-events:none; }

    @media (max-width: 768px) {
      #info-panel{
        left: 0; right: 0; top: auto; bottom: 0;
        width: 100%;
        max-height: none;
        height: 62vh;
        border-radius: 18px 18px 0 0;
      }
      #info-panel.collapsed{ height: 120px; }
      #info-content{ padding: 12px; }
      .crime-grid { grid-template-columns: 1fr; }
      .compare-kpis { grid-template-columns: 1fr; }
      #tabs { overflow-x:auto; }
      #tabs .tab{ min-width: 95px; }
      .trend-row { grid-template-columns: 70px 1fr 80px 80px; gap: 8px; padding: 10px; }
      .bar-row { grid-template-columns: 100px 1fr 70px; gap: 8px; }
    }
  </style>

  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const POLICE_STATION_LAYER = "24";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";
    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    let mapInitialized = false;
    let currentYear = "2025";
    let yearlyStats = {};
    let currentTab = "single";
    let currentMode = "muni";
    let currentMetric = "abs";

    let selectedCity = null;
    let selectedCityKey = null;
    let compareList = [];

    const muniIndex = {};
    const merhavIndex = {};
    const stationIndex = {};
    const populationIndex = {};
    const variantsCache = new Map();

    let choroplethEnabled = false;
    const CHORO_NAME = "crime_rate_choropleth";
    let activeChoroplethNames = [];

    let muniBoundariesIndex = {};
    let muniBoundariesMeta = [];

    function normalizeKeyBase(name) {
      if (name == null) return "";
      let s = String(name).trim();
      s = s
        .replace(/[×³×´"'`]/g, "")
        .replace(/[(){}\[\],.:;]/g, "")
        .replace(/Ö¾/g, "-")
        .replace(/\u200f/g, "")
        .replace(/\u200e/g, "")
        .replace(/\s+/g, " ")
        .trim();
      s = s.replace(/[\s\-_]/g, "");
      return s.toLowerCase();
    }

    function normalizeKey(name) { return normalizeKeyBase(name); }

    function nameVariants(name) {
      if (!name) return [];
      if (variantsCache.has(name)) return variantsCache.get(name);

      const raw = String(name).trim();
      if (!raw) return [];

      const variants = new Set();
      variants.add(normalizeKeyBase(raw));

      const prefixes = [
        /^×¢×™×¨×™×™×ª\s+/g, /^×¢×™×¨×™×”\s+/g,
        /^××•×¢×¦×”\s+××§×•××™×ª\s+/g, /^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g,
        /^×\.×\.\s+/g, /^×\.×\.\s+/g,
        /^×"×\s+/g, /^×"×\s+/g,
        /^×ª×—× ×ª\s+/g, /^×ª×—× ×”\s+/g
      ];

      let current = raw;
      for (const prefix of prefixes) {
        current = current.replace(prefix, "");
        variants.add(normalizeKeyBase(current));
      }

      const withDash = current.replace(/\s+/g, "-");
      const withoutDash = current.replace(/-/g, " ");
      variants.add(normalizeKeyBase(withDash));
      variants.add(normalizeKeyBase(withoutDash));

      if (current.startsWith("×”")) variants.add(normalizeKeyBase(current.substring(1)));
      else variants.add(normalizeKeyBase("×”" + current));

      const result = Array.from(variants).filter(Boolean);
      variantsCache.set(name, result);
      return result;
    }

    function getStationsDataset(){
      try{
        if (window.crimeByYearStations && typeof window.crimeByYearStations === "object") return window.crimeByYearStations;
      }catch(_){}
      try{
        if (typeof crimeByYearStations !== "undefined" && crimeByYearStations && typeof crimeByYearStations === "object") return crimeByYearStations;
      }catch(_){}
      try{
        if (typeof CRIMEBYYEARSTATIONS !== "undefined" && CRIMEBYYEARSTATIONS && typeof CRIMEBYYEARSTATIONS === "object") return CRIMEBYYEARSTATIONS;
      }catch(_){}
      try{
        if (window.CRIMEBYYEARSTATIONS && typeof window.CRIMEBYYEARSTATIONS === "object") return window.CRIMEBYYEARSTATIONS;
      }catch(_){}
      return null;
    }

    function getModeLabel(mode){
      if(mode === "muni") return "×™×©×•×‘×™×/×¨×©×•×™×•×ª";
      if(mode === "merhav") return "××¨×—×‘×™×";
      if(mode === "station") return "×ª×—× ×•×ª ××©×˜×¨×”";
      return "×™×©×•×™×•×ª";
    }

    function getEntityLabel(mode){
      if(mode === "muni") return "×¨×©×•×ª";
      if(mode === "merhav") return "××¨×—×‘";
      if(mode === "station") return "×ª×—× ×”";
      return "×™×©×•×ª";
    }

    function getIndexByMode(mode){
      if(mode === "muni") return muniIndex;
      if(mode === "merhav") return merhavIndex;
      if(mode === "station") return stationIndex;
      return muniIndex;
    }

    function getYearDataByMode(mode, year){
      if(mode === "muni") return window.crimeByYear?.[year] || null;
      if(mode === "merhav") return window.crimeByYearMerhav?.[year] || null;
      if(mode === "station") return getStationsDataset()?.[year] || null;
      return null;
    }

    function buildPopulationIndex() {
      for (const k in populationIndex) delete populationIndex[k];
      const raw = window.PopulationDB;
      if (!raw || typeof raw !== "object") {
        console.warn("âš ï¸ PopulationDB.js not loaded");
        return false;
      }
      for (const displayName in raw) {
        const pop = Number(raw[displayName]);
        if (!Number.isFinite(pop)) continue;
        for (const v of nameVariants(displayName)) populationIndex[v] = pop;
      }
      console.log("âœ… Population index ready:", Object.keys(populationIndex).length);
      return true;
    }

    function getPopulationForAuthority(nameFromCrime) {
      for (const v of nameVariants(nameFromCrime)) {
        const pop = populationIndex[v];
        if (pop != null) return pop;
      }
      return null;
    }

    function calcRatePer10k(total, pop) {
      if (!Number.isFinite(Number(total))) return 0;
      const p = Number(pop);
      if (!Number.isFinite(p) || p <= 0) return 0;
      return Math.round((Number(total) / p) * 10000 * 10) / 10;
    }

    function fmtMaybe(num) {
      if (num == null) return "0";
      return Number(num).toLocaleString();
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function updateMetricButtonsUI() {
      const btnRate = document.getElementById("btnMetricRate");
      const muniOnly = (currentMode === "muni");

      if (btnRate) {
        btnRate.classList.toggle("disabled", !muniOnly);
        btnRate.disabled = !muniOnly;
        btnRate.onclick = muniOnly ? () => setMetric("rate") : null;
        btnRate.title = muniOnly ? "××¦×™×’ ×¢×‘×™×¨×•×ª ×œ-10,000 ×ª×•×©×‘×™×" : "×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª";
      }

      const headerP = document.querySelector("#panel-header p");
      if (headerP) {
        const extra = muniOnly ? "×œ-10,000 ×–××™×Ÿ ×›××Ÿ" : "×œ-10,000 ×œ× ×–××™×Ÿ ×‘××¦×‘ ×–×”";
        headerP.innerHTML = `××¦×‘ × ×•×›×—×™: <strong>${escapeHtml(getModeLabel(currentMode))}</strong><br>${extra}`;
      }

      if (!muniOnly && currentMetric === "rate") {
        currentMetric = "abs";
        const bAbs = document.getElementById("btnMetricAbs");
        const bRate2 = document.getElementById("btnMetricRate");
        if (bAbs) bAbs.classList.add("active");
        if (bRate2) bRate2.classList.remove("active");
      }
    }

    function calculateStats(year, mode) {
      const m = mode || currentMode || "muni";
      const yearData = getYearDataByMode(m, year);
      if (!yearData) return { entities: 0, total: 0, avg: 0 };

      let total = 0, count = 0;
      for (const name in yearData) {
        const data = yearData[name];
        if (data && typeof data.total === "number") {
          total += data.total;
          count++;
        }
      }
      return { entities: count, total, avg: count > 0 ? Math.round(total / count) : 0 };
    }

    function updateQuickStats() {
      const key = `${currentYear}__${currentMode}`;
      if (!yearlyStats[key]) yearlyStats[key] = calculateStats(currentYear, currentMode);
      const stats = yearlyStats[key] || { entities: 0, total: 0, avg: 0 };

      const a = document.getElementById("stat-municipalities");
      const b = document.getElementById("stat-total");
      const c = document.getElementById("stat-avg");
      const l = document.getElementById("stat-entities-label");

      if (a) a.textContent = Number(stats.entities || 0).toLocaleString();
      if (b) b.textContent = Number(stats.total || 0).toLocaleString();
      if (c) c.textContent = Number(stats.avg || 0).toLocaleString();
      if (l) l.textContent = (currentMode === "muni" ? "×¨×©×•×™×•×ª" : (currentMode === "merhav" ? "××¨×—×‘×™×" : "×ª×—× ×•×ª"));
    }

    function buildMuniIndexForYear(year) {
      for (const k in muniIndex) delete muniIndex[k];
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return;

      for (const name in yearData) {
        const entry = { name, data: yearData[name] };
        const variants = nameVariants(name);

        for (const v of variants) {
          if (!muniIndex[v]) muniIndex[v] = entry;
        }

        const simpleNorm = normalizeKey(name);
        if (!muniIndex[simpleNorm]) muniIndex[simpleNorm] = entry;
      }

      yearlyStats[`${year}__muni`] = calculateStats(year, "muni");
      console.log(`âœ… Year ${year}: ${Object.keys(muniIndex).length} muni keys indexed`);
    }

    function buildMerhavIndexForYear(year) {
      for (const k in merhavIndex) delete merhavIndex[k];
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) {
        console.warn(`âš ï¸ No merhav data for year ${year}`);
        return;
      }

      for (const name in yearData) {
        const entry = { name, data: yearData[name] };
        const variants = nameVariants(name);

        for (const v of variants) {
          if (!merhavIndex[v]) merhavIndex[v] = entry;
        }

        const simpleNorm = normalizeKey(name);
        if (!merhavIndex[simpleNorm]) merhavIndex[simpleNorm] = entry;
      }
      yearlyStats[`${year}__merhav`] = calculateStats(year, "merhav");
      console.log(`âœ… Year ${year}: ${Object.keys(merhavIndex).length} merhav keys indexed`);
    }

    function buildStationIndexForYear(year) {
      Object.keys(stationIndex).forEach(k => delete stationIndex[k]);

      const yearData = getStationsDataset()?.[year] || null;
      if (!yearData) {
        console.warn(`âš ï¸ No station data for year ${year}`);
        return;
      }

      for (const [stationName, payload] of Object.entries(yearData)) {
        const entry = { name: String(stationName).trim(), data: payload || { total: 0, breakdown: {} } };
        const variants = nameVariants(stationName);

        variants.forEach(k => { if (k) stationIndex[k] = entry; });

        const simpleNorm = normalizeKey(stationName);
        if (!stationIndex[simpleNorm]) stationIndex[simpleNorm] = entry;
      }

      yearlyStats[`${year}__station`] = calculateStats(year, "station");
      console.log(`âœ… Year ${year}: ${Object.keys(stationIndex).length} station keys indexed`);
    }

    function showInfo(title, body, type = "info") {
      const t = document.getElementById("info-title");
      const b = document.getElementById("info-body");
      if (!t || !b) return;
      t.textContent = title;
      b.innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function showEntry(entry) {
      const d = entry.data;
      let html = "";

      const total = (typeof d.total === "number") ? d.total : null;
      const popRaw = (currentMode === "muni") ? getPopulationForAuthority(entry.name) : null;
      const pop = (popRaw == null ? 0 : Number(popRaw));

      if (total != null) {
        if (currentMetric === "rate" && currentMode === "muni") {
          const rate = calcRatePer10k(total, pop);
          html += `<div class="total-summary">${rate.toLocaleString()} ×œ-10,000</div>`;
          html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${Number(pop).toLocaleString()} â€¢ ×¡×”"×› ××™×¨×•×¢×™×: ${Number(total).toLocaleString()}</div>`;
        } else {
          html += `<div class="total-summary">${Number(total).toLocaleString()} ××™×¨×•×¢×™×</div>`;
          if (currentMode === "muni") html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×” (2019): ${Number(pop).toLocaleString()}</div>`;
        }
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
        html += `<div class="crime-grid">`;
        for (const [name, count] of sorted) {
          html += `<div class="crime-item">
            <div class="crime-name">${escapeHtml(name)}</div>
            <div class="crime-count">${Number(count || 0).toLocaleString()}</div>
          </div>`;
        }
        html += `</div>`;
      }

      const it = document.getElementById("info-title");
      const ib = document.getElementById("info-body");
      if (!it || !ib) return;
      it.textContent = entry.name;
      ib.innerHTML = html || `<div class="message message-info">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>`;
    }

    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll(".tab").forEach(tab =>
        tab.classList.toggle("active", tab.dataset.tab === tabName)
      );

      document.querySelectorAll(".tab-content").forEach(content =>
        content.classList.toggle("active", content.id === `tab-${tabName}`)
      );

      if (tabName === "single") {
        showInfo(
          "××¤×” ×œ×¤×™ " + getModeLabel(currentMode),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${getEntityLabel(currentMode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );
      } else if (tabName === "compare") {
        updateCompareView();
      } else if (tabName === "trends") {
        const tc = document.getElementById("trends-content");
        if (!selectedCity) {
          if (tc) tc.innerHTML = `<div class="message message-info">×‘×—×¨ ${getEntityLabel(currentMode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>`;
          return;
        }
        showTrends(selectedCity, currentMode);
      } else if (tabName === "rankings") {
        renderRankings();
      }
    }

    function setMode(mode) {
      currentMode = mode;

      const bm = document.getElementById("btnModeMuni");
      const br = document.getElementById("btnModeMerhav");
      const bs = document.getElementById("btnModeStation");
      if (bm) bm.classList.toggle("active", mode === "muni");
      if (br) br.classList.toggle("active", mode === "merhav");
      if (bs) bs.classList.toggle("active", mode === "station");

      updateMetricButtonsUI();
      updateQuickStats();

      const layerToShow =
        (mode === "muni") ? MUNICIPAL_LAYER :
        (mode === "merhav") ? POLICE_MERHAV_LAYER :
        POLICE_STATION_LAYER;

      const layersToHide =
        (mode === "muni") ? [POLICE_MERHAV_LAYER, POLICE_STATION_LAYER] :
        (mode === "merhav") ? [MUNICIPAL_LAYER, POLICE_STATION_LAYER] :
        [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER];

      if (mapInitialized) {
        try {
          if (typeof govmap.setVisibleLayers === "function") {
            govmap.setVisibleLayers([layerToShow], layersToHide);
          }
        } catch (err) {
          console.warn("âš ï¸ setVisibleLayers failed:", err);
        }
      }

      if (mode !== "muni") {
        choroplethEnabled = false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      }
      setChoroBtnUI();

      selectedCity = null;
      selectedCityKey = null;
      compareList = compareList.filter(c => c.mode === mode);

      if (choroplethEnabled && mode === "muni") renderChoropleth();

      if (currentTab === "compare") updateCompareView();
      else if (currentTab === "rankings") renderRankings();
      else if (currentTab === "trends") {
        const tc = document.getElementById("trends-content");
        if (tc) tc.innerHTML = `<div class="message message-info">×‘×—×¨ ${getEntityLabel(mode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>`;
      } else {
        showInfo(
          "××¤×” ×œ×¤×™ " + getModeLabel(mode),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${getEntityLabel(mode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );
      }
    }

    function setMetric(metric) {
      if (metric === "rate" && currentMode !== "muni") {
        alert("×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª");
        return;
      }

      currentMetric = metric;

      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");

      if (bAbs) bAbs.classList.toggle("active", metric === "abs");
      if (bRate) bRate.classList.toggle("active", metric === "rate");

      if (choroplethEnabled && currentMode === "muni") renderChoropleth();

      if (currentTab === "single" && selectedCityKey) {
        const index = getIndexByMode(currentMode);
        const entry = index[selectedCityKey];
        if (entry) showEntry(entry);
      }
      if (currentTab === "compare") updateCompareView();
      if (currentTab === "trends" && selectedCity) showTrends(selectedCity, currentMode);
      if (currentTab === "rankings") renderRankings();
    }

    function addToCompare() {
      if (!selectedCity) {
        alert(`×× × ×‘×—×¨ ${getEntityLabel(currentMode)} ×‘××¤×” ×ª×—×™×œ×”`);
        return;
      }
      if (!compareList.some(c => c.key === selectedCityKey && c.mode === currentMode)) {
        compareList.push({ name: selectedCity, key: selectedCityKey, mode: currentMode });
        updateCompareView();
      }
    }

    function removeFromCompare(key) {
      compareList = compareList.filter(c => c.key !== key || c.mode !== currentMode);
      updateCompareView();
    }

    function updateCompareView() {
      const container = document.getElementById("compare-content");
      if (!container) return;

      const entityType = getEntityLabel(currentMode);

      const selectedHint = selectedCity
        ? `<div class="message message-info">× ×‘×—×¨ ×›×¢×ª: <strong>${escapeHtml(selectedCity)}</strong> (×œ×—×¥ ×¢×œ â• ×›×“×™ ×œ×”×•×¡×™×£ ×œ×”×©×•×•××”)</div>`
        : `<div class="message message-info">×œ×—×¥ ×¢×œ ${entityType} ×‘××¤×” ×•××– ×¢×œ â• ×›×“×™ ×œ×”×•×¡×™×£ ×œ×”×©×•×•××”</div>`;

      let html = `
        <button class="add-compare-btn" onclick="addToCompare()">â• ×”×•×¡×£ ${entityType} × ×‘×—×¨ ×œ×”×©×•×•××”</button>
        ${selectedHint}
      `;

      const filteredList = compareList.filter(c => c.mode === currentMode);

      if (filteredList.length > 0) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
        filteredList.forEach(item => {
          html += `<div class="compare-city-tag">${escapeHtml(item.name)}
            <button onclick='removeFromCompare(${JSON.stringify(item.key)})' title="×”×¡×¨">Ã—</button></div>`;
        });
        html += "</div>";
      }

      if (filteredList.length < 2) {
        html += `<div class="message message-info">×”×•×¡×£ ×¢×•×“ ${entityType} ××—×“ ×œ×¤×—×•×ª ×›×“×™ ×œ×¨××•×ª ×”×©×•×•××”</div>`;
        container.innerHTML = html;
        return;
      }

      const index = getIndexByMode(currentMode);

      const metricType =
        (currentMode === "muni" && currentMetric === "rate") ? "rate" : "total";

      const rows = filteredList.map(item => {
        const entry = index[item.key];
        const total = entry?.data?.total ?? 0;
        const popRaw = (currentMode === "muni") ? getPopulationForAuthority(item.name) : null;
        const pop = (popRaw == null ? 0 : Number(popRaw));
        const rate = (currentMode === "muni") ? calcRatePer10k(total, pop) : null;
        return { name: item.name, total, pop, rate, hasPop: popRaw != null };
      });

      if (currentMode !== "muni") {
        html += `<div class="message message-info">×‘××¦×‘ ${getModeLabel(currentMode)} ×”×”×©×•×•××” ×”×™× ×œ×¤×™ ×›××•×ª ×‘×œ×‘×“ (××™×Ÿ ××•×›×œ×•×¡×™×™×”).</div>`;
      } else if (metricType === "rate") {
        html += `<div class="message message-info">×”×©×•×•××” ×œ×¤×™ <strong>×œ-10,000 ×ª×•×©×‘×™×</strong> (××•×›×œ×•×¡×™×™×” 2019; ×—×¡×¨ = 0).</div>`;
      } else {
        html += `<div class="message message-info">×˜×™×¤: ××¢×‘×¨ ×œÖ¾<strong>×œ-10,000</strong> ××©×•×•×” ×™×—×¡×™×ª ×œ×’×•×“×œ ××•×›×œ×•×¡×™×™×” (2019).</div>`;
      }

      const metricBadge = metricType === "rate" ? "××“×“: ×œ-10,000" : "××“×“: ×›××•×ª";

      html += `<div class="compare-grid">`;
      rows.forEach(r => {
        const badges = [];
        badges.push(`<span class="badge">${metricBadge}</span>`);
        if (currentMode === "muni" && !r.hasPop) badges.push(`<span class="badge badge-warn">××•×›×œ×•×¡×™×™×” ×”×•× ×—×” 0</span>`);

        html += `
          <div class="compare-card">
            <div class="compare-card-title">
              <div class="compare-name">${escapeHtml(r.name)}</div>
              <div class="compare-badges">${badges.join("")}</div>
            </div>

            <div class="compare-kpis">
              <div class="kpi">
                <div class="kpi-value">${Number(r.total).toLocaleString()}</div>
                <div class="kpi-label">×›××•×ª</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? fmtMaybe(r.pop) : "â€”"}</div>
                <div class="kpi-label">××•×›×œ×•×¡×™×™×”</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? (r.rate == null ? "â€”" : r.rate.toLocaleString()) : "â€”"}</div>
                <div class="kpi-label">×œ-10,000</div>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;

      const title = metricType === "rate" ? `×”×©×•×•××” ×œ×¤×™ ×œ-10,000 (${currentYear})` : `×”×©×•×•××” ×œ×¤×™ ×›××•×ª (${currentYear})`;
      html += `<div class="compare-bars-title">${title}</div>`;

      const values = rows
        .map(r => metricType === "rate" ? r.rate : r.total)
        .filter(v => v != null && Number.isFinite(v));
      const max = values.length ? Math.max(...values) : 0;

      rows.forEach(r => {
        const v = metricType === "rate" ? (r.rate ?? 0) : r.total;
        const pct = max > 0 ? Math.round((v / max) * 100) : 0;
        html += `
          <div class="bar-row">
            <div class="bar-name">${escapeHtml(r.name)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div class="bar-value">${Number(v || 0).toLocaleString()}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function showTrends(entityName, mode = currentMode) {
      const container = document.getElementById("trends-content");
      if (!container) return;

      if (!entityName) {
        container.innerHTML = `<div class="message message-info">×‘×—×¨ ${getEntityLabel(mode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>`;
        return;
      }

      const dataset =
        (mode === "muni") ? window.crimeByYear :
        (mode === "merhav") ? window.crimeByYearMerhav :
        getStationsDataset();

      if (!dataset || typeof dataset !== "object") {
        container.innerHTML = `<div class="message message-error">××™×Ÿ × ×ª×•× ×™ ×”×™×¡×˜×•×¨×™×” ×–××™× ×™× ×¢×‘×•×¨ ${getModeLabel(mode)}.</div>`;
        return;
      }

      const years = Object.keys(dataset).sort();
      const targetVariants = nameVariants(entityName);

      const findEntryInYear = (yearData) => {
        if (!yearData) return null;

        // direct by normalized key (rare; but keep)
        for (const v of targetVariants) {
          if (!v) continue;
          if (yearData[v]) return { name: v, data: yearData[v] };
        }

        if (yearData[entityName]) return { name: entityName, data: yearData[entityName] };

        for (const [k, d] of Object.entries(yearData)) {
          const kk = normalizeKey(k);
          if (targetVariants.includes(kk)) return { name: k, data: d };
        }
        return null;
      };

      const metricType = (mode === "muni" && currentMetric === "rate") ? "rate" : "total";

      const yearly = years.map(y => {
        const found = findEntryInYear(dataset[y]);
        const total = Number(found?.data?.total || 0);
        const popRaw = (mode === "muni") ? getPopulationForAuthority(found?.name || entityName) : null;
        const pop = (popRaw == null ? 0 : Number(popRaw));
        const rate = (mode === "muni") ? calcRatePer10k(total, pop) : null;

        const value = metricType === "rate" ? rate : total;

        return { year: y, total, pop, rate, value, has: !!found };
      });

      const metricLabel = metricType === "rate" ? "×œ-10,000" : "×›××•×ª";

      let html = `
        <div class="message message-info" style="margin-bottom:10px;">
          <strong>${escapeHtml(entityName)}</strong> â€¢ ××¦×‘: <strong>${getModeLabel(mode)}</strong><br>
          ××¦×™×’ ×œ×¤×™: <strong>${metricLabel}</strong>
        </div>
      `;

      html += `<div class="trend-table">`;
      html += `<div class="trend-row trend-head">
          <div>×©× ×”</div>
          <div>×›××•×ª</div>
          <div>××•×›×œ×•×¡×™×™×”</div>
          <div>×œ-10,000</div>
        </div>`;

      yearly.forEach(r => {
        html += `
          <div class="trend-row">
            <div>${escapeHtml(r.year)}</div>
            <div>${Number(r.total || 0).toLocaleString()}</div>
            <div>${mode === "muni" ? fmtMaybe(r.pop) : "â€”"}</div>
            <div>${mode === "muni" ? (r.rate == null ? "â€”" : Number(r.rate || 0).toLocaleString()) : "â€”"}</div>
          </div>
        `;
      });

      html += `</div>`;
      container.innerHTML = html;
    }

    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const obj = {};
      for (const f of fields) if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
      return obj;
    }

    function detectMunicipalityName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = [
        "×©× ×¨×©×•×ª", "×©× ×¨×©×•×ª ××§×•××™×ª", "×©× ×™×©×•×‘", "×™×©×•×‘ ×¡×•×¤×™",
        "SHEM_YISHUV", "SHEM_RASHUT", "NAME", "Name", "name",
        "YISHUV_NAME", "CITY_NAME"
      ];

      for (const c of candidates) {
        if (attrs && attrs[c]) {
          const val = String(attrs[c]).trim();
          if (val && val !== "") return val;
        }
      }
      return null;
    }

    function detectMerhavName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["×©× ××¨×—×‘", "×©× ××¨×—×‘ ××©×˜×¨×ª×™", "MERHAV", "SHEM_MERHAV", "NAME", "Name"];
      for (const c of candidates) if (attrs && attrs[c]) return String(attrs[c]).trim();
      return null;
    }

    function detectStationName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = [
        "×©× ×ª×—× ×”", "×©× ×ª×—× ×ª ××©×˜×¨×”", "SHEM_TAHANA", "TAHANA",
        "STATION", "NAME", "Name", "name"
      ];
      for (const c of candidates) {
        if (attrs && attrs[c]) {
          const val = String(attrs[c]).trim();
          if (val && val !== "") return val;
        }
      }
      return null;
    }

    function findEntryByName(nameFromMap, mode = currentMode) {
      const index = getIndexByMode(mode);
      const variants = nameVariants(nameFromMap);

      for (const v of variants) {
        if (index[v]) return { entry: index[v], key: v, match: "variant" };
      }

      const normalized = normalizeKey(nameFromMap);
      if (index[normalized]) return { entry: index[normalized], key: normalized, match: "normalized" };

      // soft contains (fallback)
      for (const key in index) {
        if (!key) continue;
        if (key === normalized || key.includes(normalized) || normalized.includes(key)) {
          return { entry: index[key], key, match: "soft" };
        }
      }

      return { entry: null, key: null, match: "none" };
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      try {
        const layerName =
          (currentMode === "muni") ? MUNICIPAL_LAYER :
          (currentMode === "merhav") ? POLICE_MERHAV_LAYER :
          POLICE_STATION_LAYER;

        const resp = await govmap.getLayerData({
          LayerName: layerName,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp?.data || resp?.Data || [];
        if (!items.length) {
          showInfo("×œ× × ××¦×", "××™×Ÿ ××•×‘×™×™×§×˜ ×‘××–×•×¨ ×–×”", "info");
          return;
        }

        const first = items[0];
        const attrs = first.Fields || first.Attributes || first;

        let nameFromMap = null;

        if (currentMode === "muni") nameFromMap = detectMunicipalityName(attrs);
        else if (currentMode === "merhav") nameFromMap = detectMerhavName(attrs);
        else nameFromMap = detectStationName(attrs);

        if (!nameFromMap) {
          showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×–×”×•×ª ××ª ×©× ×”×™×©×•×ª", "error");
          return;
        }

        console.log("ğŸ” Looking for:", currentMode, nameFromMap);

        const { entry, key, match } = findEntryByName(nameFromMap, currentMode);

        if (!entry) {
          console.error("âŒ No match found for:", nameFromMap);
          showInfo(
            "×œ× × ××¦××• × ×ª×•× ×™×",
            `××™×Ÿ × ×ª×•× ×™ ×¤×©×™×¢×” ×¢×‘×•×¨ <strong>${escapeHtml(nameFromMap)}</strong> ×‘×©× ×ª ${currentYear}<br><small>×©× ×× ×•×¨××œ: ${escapeHtml(normalizeKey(nameFromMap))}</small>`,
            "warn"
          );
          return;
        }

        console.log("âœ… Match:", match, key, entry?.name);

        selectedCity = entry.name;
        selectedCityKey = key;

        if (currentTab === "single") {
          showEntry(entry);
        } else if (currentTab === "compare") {
          updateCompareView();
        } else if (currentTab === "trends") {
          showTrends(selectedCity, currentMode);
        } else if (currentTab === "rankings") {
          renderRankings();
        } else {
          showEntry(entry);
        }
      } catch (err) {
        console.error("âŒ onMapClick error:", err);
        showInfo("×©×’×™××”", "×©×’×™××” ×‘×§×¨×™××ª × ×ª×•× ×™ ×©×›×‘×” (×‘×“×•×§ Console)", "error");
      }
    }

    // ---------------------------
    // Choropleth helpers (safe)
    // ---------------------------
    function setMunicipalLayerOpacity(percent){
      try{
        if (!govmap || !govmap.setLayersOpacity) return;
        govmap.setLayersOpacity([{ layerName: MUNICIPAL_LAYER, opacity: Math.max(0, Math.min(100, Number(percent)||0)) }]);
      }catch(err){
        console.warn("âš ï¸ setLayersOpacity failed:", err);
      }
    }

    function setChoroBtnUI(){
      const btn = document.getElementById("btnChoro");
      if (!btn) return;
      btn.classList.toggle("active", !!choroplethEnabled);
      btn.textContent = choroplethEnabled ? "ğŸ¨ ×¦×‘×™×¢×”: ×¤×¢×™×œ×”" : "ğŸ¨ ×¦×‘×™×¢×”: ×›×‘×•×™×”";
      btn.title = (currentMode === "muni") ? "×¦×‘×™×¢×” ×œ×¤×™ ×”××“×“ ×©×‘×—×¨×ª" : "×¦×‘×™×¢×” ×–××™× ×” ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª";
      btn.classList.toggle("disabled", currentMode !== "muni");
    }

    function clearChoropleth(){
      try{
        if (govmap && typeof govmap.removeDisplayedGeometries === "function") {
          // try remove by name if supported
          if (activeChoroplethNames.length) {
            activeChoroplethNames.forEach(n => {
              try{ govmap.removeDisplayedGeometries({ names:[n] }); }catch(_){}
            });
          } else {
            try{ govmap.removeDisplayedGeometries({ names:[CHORO_NAME] }); }catch(_){}
          }
        }
      }catch(err){
        console.warn("âš ï¸ clearChoropleth failed:", err);
      }finally{
        activeChoroplethNames = [];
      }
    }

    async function loadMuniBoundaries(){
      if (muniBoundariesMeta.length) return true;
      try{
        const res = await fetch(MUNI_BOUNDARIES_GEOJSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const geo = await res.json();
        const feats = geo?.features || [];
        muniBoundariesMeta = feats;

        muniBoundariesIndex = {};
        for (const f of feats) {
          const props = f.properties || {};
          const name = props["×©× ×¨×©×•×ª"] || props["×©× ×¨×©×•×ª ××§×•××™×ª"] || props["×©× ×™×©×•×‘"] || props["SHEM_RASHUT"] || props["SHEM_YISHUV"] || props["NAME"] || props["Name"];
          if (!name) continue;
          for (const v of nameVariants(name)) muniBoundariesIndex[v] = f;
        }

        console.log("âœ… Loaded muni boundaries:", feats.length);
        return true;
      }catch(err){
        console.warn("âš ï¸ Failed to load muni boundaries geojson:", err);
        return false;
      }
    }

    function colorForValue(value, min, max){
      // value -> gradient green->red
      const v = Number(value);
      if (!Number.isFinite(v) || max <= min) return "rgba(0, 102, 204, 0.25)";
      const t = Math.max(0, Math.min(1, (v - min) / (max - min)));
      const r = Math.round(60 + 195 * t);
      const g = Math.round(200 - 160 * t);
      const b = Math.round(80 - 50 * t);
      return `rgba(${r},${g},${b},0.55)`;
    }

    async function renderChoropleth(){
      if (currentMode !== "muni") return;
      const ok = await loadMuniBoundaries();
      if (!ok) {
        showInfo("×¦×‘×™×¢×”", "×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×§×•×‘×¥ ×”×’×‘×•×œ×•×ª muni_boundaries_ITM.geojson (×•×“× ×©×”×•× ×œ×™×“ index.html).", "warn");
        choroplethEnabled = false;
        setChoroBtnUI();
        return;
      }

      clearChoropleth();

      const yearData = getYearDataByMode("muni", currentYear) || {};
      const rows = [];

      for (const [name, payload] of Object.entries(yearData)) {
        const total = Number(payload?.total || 0);
        const popRaw = getPopulationForAuthority(name);
        const pop = popRaw == null ? 0 : Number(popRaw);
        const rate = calcRatePer10k(total, pop);
        const val = (currentMetric === "rate") ? rate : total;

        // match boundary feature
        let feature = null;
        for (const v of nameVariants(name)) {
          if (muniBoundariesIndex[v]) { feature = muniBoundariesIndex[v]; break; }
        }
        if (!feature) continue;

        rows.push({ name, total, rate, val, feature });
      }

      const vals = rows.map(r => r.val).filter(v => Number.isFinite(v));
      const min = vals.length ? Math.min(...vals) : 0;
      const max = vals.length ? Math.max(...vals) : 0;

      // Try to display geometries in govmap. The API accepts different formats on different versions;
      // we attempt a couple of common ones and fail gracefully.
      const geometries = rows.map((r, i) => {
        const color = colorForValue(r.val, min, max);
        return {
          geometry: r.feature.geometry,
          attributes: { name: r.name, value: r.val },
          symbol: { fillColor: color, outlineColor: "rgba(0,0,0,0.25)", outlineWidth: 1 }
        };
      });

      const payloadCandidates = [
        // common wrapper name used in older examples
        { geometries, name: CHORO_NAME },
        // govmap-style (sometimes "Data")
        { Data: geometries, name: CHORO_NAME }
      ];

      let displayed = false;
      for (const p of payloadCandidates) {
        try{
          if (typeof govmap.displayGeometries === "function") {
            await govmap.displayGeometries(p);
            displayed = true;
            break;
          }
        }catch(err){
          console.warn("displayGeometries attempt failed:", err);
        }
      }

      if (displayed) {
        activeChoroplethNames = [CHORO_NAME];
        setMunicipalLayerOpacity(35);
      } else {
        showInfo("×¦×‘×™×¢×”", "×œ× ×”×¦×œ×—×ª×™ ×œ×¦×™×™×¨ ××ª ×”×¦×‘×™×¢×” (displayGeometries ×œ× ×§×™×‘×œ ××ª ×”×¤×•×¨××˜). ×× ×ª×¨×¦×”, ×ª×©×œ×— ×¦×™×œ×•× ×©×œ ×”-Console ×•× ×›×•×•×Ÿ ×œ×¤×•×¨××˜ ×”××“×•×™×§.", "warn");
        choroplethEnabled = false;
      }

      setChoroBtnUI();
    }

    function toggleChoropleth(){
      if (currentMode !== "muni") return;
      choroplethEnabled = !choroplethEnabled;
      if (choroplethEnabled) renderChoropleth();
      else { clearChoropleth(); setMunicipalLayerOpacity(100); }
      setChoroBtnUI();
    }

    // ---------------------------
    // Rankings
    // ---------------------------
    function renderRankings(){
      const container = document.getElementById("rankings-content");
      if (!container) return;

      const yearData = getYearDataByMode(currentMode, currentYear);
      if (!yearData) {
        container.innerHTML = `<div class="message message-warn">××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ${escapeHtml(currentYear)} ×‘××¦×‘ ${escapeHtml(getModeLabel(currentMode))}.</div>`;
        return;
      }

      const rows = [];
      for (const [name, payload] of Object.entries(yearData)) {
        const total = Number(payload?.total || 0);
        const popRaw = (currentMode === "muni") ? getPopulationForAuthority(name) : null;
        const pop = popRaw == null ? 0 : Number(popRaw);
        const rate = (currentMode === "muni") ? calcRatePer10k(total, pop) : null;
        const value = (currentMode === "muni" && currentMetric === "rate") ? (rate ?? 0) : total;

        rows.push({ name, total, pop, rate, value, hasPop: popRaw != null });
      }

      rows.sort((a,b) => (b.value||0) - (a.value||0));
      const top = rows.slice(0, 25);

      const metricLabel = (currentMode === "muni" && currentMetric === "rate") ? "×œ-10,000" : "×›××•×ª";

      let html = `
        <div class="message message-info">
          ×“×™×¨×•×’ ×œ×¤×™ <strong>${metricLabel}</strong> â€¢ ×©× ×”: <strong>${escapeHtml(currentYear)}</strong> â€¢ ××¦×‘: <strong>${escapeHtml(getModeLabel(currentMode))}</strong>
        </div>
        <div class="rank-list">
      `;

      top.forEach((r, idx) => {
        const extra =
          currentMode === "muni"
            ? `××•×›×œ×•×¡×™×™×”: ${fmtMaybe(r.pop)} â€¢ ×œ-10,000: ${(r.rate == null ? "â€”" : Number(r.rate).toLocaleString())}`
            : `×œ-10,000: â€” (××™×Ÿ ××•×›×œ×•×¡×™×™×”)`;

        html += `
          <div class="rank-row" onclick='jumpToEntity(${JSON.stringify(r.name)})' title="×œ×—×¥ ×œ×”×ª××§×“×•×ª ×‘×¨×©×•×ª (×‘××™×“×” ×•×”-API ×××¤×©×¨)">
            <div class="rank-num">${idx+1}</div>
            <div>
              <div class="rank-name">${escapeHtml(r.name)}</div>
              <div class="rank-extra">${escapeHtml(extra)}</div>
            </div>
            <div class="rank-value">${Number(r.value||0).toLocaleString()}</div>
          </div>
        `;
      });

      html += `</div>`;
      container.innerHTML = html;
    }

    // optional: try focus map on entity (best effort)
    function jumpToEntity(name){
      // Select in panel too
      const { entry, key } = findEntryByName(name, currentMode);
      if (entry) {
        selectedCity = entry.name;
        selectedCityKey = key;
        if (currentTab === "single") showEntry(entry);
        if (currentTab === "trends") showTrends(selectedCity, currentMode);
      }

      // Attempt a focus/zoom function if govmap supports it.
      try{
        if (typeof govmap.search === "function") {
          govmap.search({ query: name });
        } else if (typeof govmap.zoomToExtent === "function") {
          // no extent known; skip
        }
      }catch(_){}
    }

    // ---------------------------
    // Init
    // ---------------------------
    function showLoading(show, msg){
      const el = document.getElementById("loading");
      if (!el) return;
      el.style.display = show ? "block" : "none";
      const t = el.querySelector(".loadingText");
      if (t && msg) t.textContent = msg;
    }

    async function initGovMap(){
      try{
        showLoading(true, "×˜×•×¢×Ÿ ××¤×”...");
        if (!window.govmap) throw new Error("govmap not loaded");

        // try create map in a few common ways
        if (typeof govmap.createMap === "function") {
          await govmap.createMap("map", {
            token: TOKEN,
            layers: [MUNICIPAL_LAYER],
            center: { x: 177000, y: 663000 }, // Israel ITM-ish center (best-effort)
            zoom: 7
          });
        } else if (typeof govmap.initMap === "function") {
          await govmap.initMap("map", TOKEN);
        }

        // bind click handler (best-effort)
        let bound = false;
        try{
          if (typeof govmap.on === "function") { govmap.on("click", onMapClick); bound = true; }
        }catch(_){}
        try{
          if (!bound && govmap.events && typeof govmap.events.register === "function") {
            govmap.events.register("click", onMapClick);
            bound = true;
          }
        }catch(_){}
        try{
          if (!bound && typeof govmap.registerEvent === "function") {
            govmap.registerEvent("click", onMapClick);
            bound = true;
          }
        }catch(_){}

        mapInitialized = true;

        // Build indexes
        buildPopulationIndex();
        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        buildStationIndexForYear(currentYear);

        updateMetricButtonsUI();
        updateQuickStats();
        setChoroBtnUI();

        showInfo(
          "××¤×” ×œ×¤×™ " + getModeLabel(currentMode),
          `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${getEntityLabel(currentMode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
          "info"
        );
      }catch(err){
        console.error("âŒ initGovMap error:", err);
        showInfo("×©×’×™××”", "×”××¤×” ×œ× × ×˜×¢× ×”. ×‘×“×•×§ Console + ×•×“× ×©×”×“×•××™×™×Ÿ ×××•×©×¨ ×‘×˜×•×§×Ÿ.", "error");
      }finally{
        showLoading(false);
      }
    }

    function onYearChange(year){
      currentYear = String(year);
      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      buildStationIndexForYear(currentYear);
      updateQuickStats();

      selectedCity = null;
      selectedCityKey = null;

      if (choroplethEnabled && currentMode === "muni") renderChoropleth();
      if (currentTab === "rankings") renderRankings();

      showInfo(
        "××¤×” ×œ×¤×™ " + getModeLabel(currentMode),
        `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${getEntityLabel(currentMode)} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
        "info"
      );
    }

    function togglePanel(){
      const panel = document.getElementById("info-panel");
      if (!panel) return;
      panel.classList.toggle("collapsed");
      const btn = document.getElementById("btnCollapse");
      if (btn) btn.textContent = panel.classList.contains("collapsed") ? "â¬†ï¸ ×¤×ª×—" : "â¬‡ï¸ ×›×•×•×¥";
    }

    // expose for inline handlers
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.switchTab = switchTab;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.toggleChoropleth = toggleChoropleth;
    window.onYearChange = onYearChange;
    window.togglePanel = togglePanel;
    window.jumpToEntity = jumpToEntity;
  </script>
</head>

<body>
  <div id="map"></div>

  <div id="loading" style="display:none;">
    <div class="spinner"></div>
    <div class="loadingText" style="font-weight:1000;">×˜×•×¢×Ÿ...</div>
  </div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>××¤×ª ×¤×©×™×¢×” 2020â€“2025</h1>
      <p>××¦×‘ × ×•×›×—×™: <strong>×™×©×•×‘×™×/×¨×©×•×™×•×ª</strong><br>×œ-10,000 ×–××™×Ÿ ×›××Ÿ</p>

      <div id="header-actions">
        <button id="btnCollapse" class="hbtn secondary" onclick="togglePanel()">â¬‡ï¸ ×›×•×•×¥</button>
        <button id="btnChoro" class="hbtn" onclick="toggleChoropleth()">ğŸ¨ ×¦×‘×™×¢×”: ×›×‘×•×™×”</button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">× ×ª×•×Ÿ × ×‘×—×¨</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')">×”×©×•×•××”</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')">××’××•×ª</div>
      <div class="tab" data-tab="rankings" onclick="switchTab('rankings')">×“×™×¨×•×’×™×</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <div id="btnModeMuni" class="mode-btn active primary" onclick="setMode('muni')">ğŸ™ï¸ ×™×©×•×‘×™×/×¨×©×•×™×•×ª</div>
        <div id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">ğŸ›¡ï¸ ××¨×—×‘×™×</div>
        <div id="btnModeStation" class="mode-btn" onclick="setMode('station')">ğŸš“ ×ª×—× ×•×ª</div>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×©× ×”:</label>
        <select id="yearSelect" onchange="onYearChange(this.value)">
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
        </select>
      </div>

      <div class="rowBtns" style="margin-bottom:10px;">
        <button id="btnMetricAbs" class="btn active" onclick="setMetric('abs')">×›××•×ª</button>
        <button id="btnMetricRate" class="btn" onclick="setMetric('rate')">×œ-10,000</button>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">0</div>
          <div class="stat-label" id="stat-entities-label">×¨×©×•×™×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">×¡×”"×› ××™×¨×•×¢×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">0</div>
          <div class="stat-label">×××•×¦×¢ ×œ×™×©×•×ª</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">×˜×•×¢×Ÿâ€¦</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-compare">
        <div id="compare-content"></div>
      </div>

      <div class="tab-content" id="tab-trends">
        <div id="trends-content"></div>
      </div>

      <div class="tab-content" id="tab-rankings">
        <div id="rankings-content"></div>
      </div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>מפת פשיעה – לפי שנה (2020–2025) | ישובים / מרחבים</title>

  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>
  <script src="crimeByYearStations.js"></script>

  <script src="muni_boundaries.js"></script> 

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
      font-size: 15px;
    }

    #map { width: 100%; height: 100%; position: relative; }

    /* hide ESRI widgets if appear */
    .esri-layer-list, .esri-legend { display: none !important; }

    /* PANEL */
    #info-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: white;
      padding: 0;
      border-radius: 12px;
      width: 430px;
      max-height: calc(100vh - 30px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: height .2s ease, max-height .2s ease;
    }

    #panel-header {
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color: white;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.15);
      flex-shrink: 0;
    }
    #panel-header h1 { margin: 0; font-size: 17px; font-weight: 900; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.94; line-height: 1.35; font-weight: 800; }

    #header-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .hbtn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.15);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-size: 13px;
    }
    .hbtn:active{ transform: translateY(1px); }
    .hbtn.secondary{
      background: rgba(0,0,0,.12);
      border-color: rgba(255,255,255,.22);
    }

    #tabs {
      display: flex;
      gap: 0;
      background: #fafafa;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
    }
    .tab {
      flex: 1;
      padding: 11px 8px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 1000;
      color: #666;
      user-select: none;
      white-space: nowrap;
    }
    .tab:hover { background: #f0f0f0; color: #333; }
    .tab.active { background: white; border-bottom-color: #0066cc; color: #0066cc; }

    #controls {
      padding: 12px 14px;
      background: #fafafa;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mode-btn {
      padding: 11px 10px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 1000;
      color: #555;
      transition: all 0.15s ease;
      user-select: none;
      text-align: center;
    }
    .mode-btn:hover { border-color: #0066cc; color: #0066cc; }
    .mode-btn.active {
      background: #0066cc;
      border-color: #0066cc;
      color: white;
      box-shadow: 0 2px 6px rgba(0,102,204,0.25);
    }
    .mode-btn.disabled {
      opacity: 0.55;
      cursor: not-allowed !important;
      border-color: #ddd !important;
      color: #666 !important;
      background: #fff !important;
      pointer-events: none;
    }
    .mode-btn.full { grid-column: 1 / -1; }
    .mode-btn.primary {
      font-size: 14px;
      padding: 13px 10px;
      border-width: 3px;
    }

    #controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    #controls label {
      font-weight: 1000;
      font-size: 13px;
      color: #333;
      white-space: nowrap;
    }
    #yearSelect {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
      cursor: pointer;
      font-weight: 900;
    }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .stat-value { font-size: 18px; font-weight: 1000; color: #0066cc; margin-bottom: 3px; }
    .stat-label { font-size: 12px; color: #777; font-weight: 1000; letter-spacing: .2px; }

    #info-content {
      padding: 14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title {
      font-weight: 1000;
      font-size: 16px;
      margin-bottom: 12px;
      color: #222;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    #info-body { line-height: 1.6; color: #555; }

    .total-summary {
      font-size: 26px;
      font-weight: 1000;
      color: #0066cc;
      margin: 12px 0 10px 0;
      text-align: center;
      padding: 14px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
      border-radius: 12px;
      border: 2px solid #b3d9ff;
    }

    .sub-summary {
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
      font-size: 13px;
      color: #444;
      font-weight: 900;
    }

    .crime-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .crime-item {
      background: #fafafa;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      border-right: 4px solid #0066cc;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .crime-name {
      font-weight: 1000;
      color: #333;
      font-size: 13px;
      line-height: 1.35;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .crime-count { font-weight: 1000; color: #0066cc; font-size: 17px; }

    .message {
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 13.5px;
      border-right: 4px solid;
      line-height: 1.55;
      font-weight: 800;
    }
    .message-info  { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }
    .message-warn  { background: #fff7e6; color: #7a4a00; border-right-color: #ffb300; }
    .message-error { background: #fff0f0; color: #c00; border-right-color: #ff0000; }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px 28px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 14px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Compare UI */
    .compare-city-tag {
      background: #e7f3ff;
      color: #0066cc;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #b3d9ff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 1000;
    }
    .compare-city-tag button {
      border: none; background: none; color: #0066cc;
      cursor: pointer; font-size: 18px; line-height: 1;
      padding: 0; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover { background: #0066cc; color: white; }

    .add-compare-btn {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 1000;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .compare-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
    .compare-card {
      border: 1px solid #e0e0e0;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .compare-card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .compare-name {
      font-weight: 1000;
      color: #222;
      font-size: 14px;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      font-size: 12px;
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      color: #333;
    }
    .badge-warn {
      border-color: #ffcc80;
      background: #fff7e6;
      color: #7a4a00;
    }
    .compare-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
    .kpi {
      border: 1px solid #eee;
      background: #fafafa;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .kpi .kpi-value { font-weight: 1000; color: #0066cc; font-size: 14px; margin-bottom: 4px; }
    .kpi .kpi-label { font-size: 11px; font-weight: 1000; color: #666; letter-spacing: .2px; }

    .compare-bars-title { margin-top: 12px; font-weight: 1000; font-size: 14px; color: #222; }
    .compare-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: #fafafa;
      border-radius: 12px;
      border: 1px solid #e0e0e0;
    }
    .compare-bar-name {
      width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12.5px;
      font-weight: 1000;
      color: #333;
    }
    .compare-bar-container {
      flex: 1;
      height: 28px;
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    .compare-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066cc 0%, #0080ff 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      font-size: 13px;
      font-weight: 1000;
      transition: width 0.35s ease;
      white-space: nowrap;
      min-width: 48px;
    }

    /* MODALS */
    .modal { display:none; position:fixed; inset:0; z-index:20000; }
    .modalOverlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }
    .modalCard {
      position:relative;
      width:min(760px, calc(100vw - 26px));
      max-height: calc(100vh - 26px);
      margin: 13px auto;
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader {
      padding:14px 16px;
      border-bottom:1px solid #e5e5e5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color:#fff;
    }
    .modalHeaderTitle { font-weight:1000; font-size:15px; }
    .modalClose {
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width:40px;
      height:40px;
      border-radius:12px;
      cursor:pointer;
      font-size:20px;
      font-weight:1000;
    }
    .modalBody { padding:16px; overflow:auto; }

    /* Search results list */
    #addrResults {
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      margin-top: 10px;
    }
    .addr-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 1px solid #f0f0f0;
      font-weight: 800;
    }
    .addr-item:last-child { border-bottom: none; }
    .addr-item:hover { background: #f5f9ff; }
    .addr-sub { font-size: 12.5px; color: #666; margin-top: 3px; font-weight: 700; }

    /* Collapse behavior (desktop + mobile) */
    #info-panel.collapsed { max-height: 120px; height: 120px; }
    #info-panel.collapsed #tabs,
    #info-panel.collapsed #controls,
    #info-panel.collapsed #info-content { display:none; }

    /* Mobile bottom sheet */
    @media (max-width: 768px) {
      #info-panel{
        left: 0; right: 0; top: auto; bottom: 0;
        width: 100%;
        max-height: none;
        height: 62vh;
        border-radius: 18px 18px 0 0;
      }
      #info-panel.collapsed{ height: 120px; }
      #info-content{ padding: 12px; }
      .crime-grid { grid-template-columns: 1fr; }
      .compare-kpis { grid-template-columns: 1fr; }
      #tabs { overflow-x:auto; }
      #tabs .tab{ min-width: 95px; }
    }
  </style>

  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const POLICE_STATION_LAYER = "24";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    let mapInitialized = false;
    let currentYear = "2025";
    let yearlyStats = {};
    let currentTab = "single";
    let currentMode = "muni";
    let currentMetric = "abs";

    let selectedCity = null;
    let selectedCityKey = null;
    let compareList = [];

    const muniIndex = {};
    const merhavIndex = {};
    const stationIndex = {};
    const populationIndex = {};
    const variantsCache = new Map();

    let lastGeocodeReqId = 0;
    let lastAddrItems = [];
    let lastGeocodeQuery = "";
    let searchTimeout = null;

    let choroplethEnabled = false;
    const CHORO_NAME = "crime_rate_choropleth";
    let activeChoroplethNames = [];

    let muniBoundariesIndex = {}; // normalizedKey -> WKT
    let muniBoundariesMeta = [];  // [{ name, wkt }]

    // -------------------- Normalize & Variants --------------------
    function normalizeKeyBase(name) {
      if (name == null) return "";
      let s = String(name).trim();
      s = s
        .replace(/[׳״"']/g, "")
        .replace(/[(){}\[\],.:]/g, "")
        .replace(/־/g, "-")
        .replace(/\s+/g, " ")
        .trim();
      s = s.replace(/[\s\-]/g, "");
      return s.toLowerCase();
    }
    function normalizeKey(name) { return normalizeKeyBase(name); }

    function nameVariants(name) {
      if (!name) return [];
      if (variantsCache.has(name)) return variantsCache.get(name);

      const raw = String(name).trim();
      if (!raw) return [];

      const withoutCityHall = raw.replace(/^עיריית\s+/g, "").replace(/^עיריה\s+/g, "");
      const withoutLocalCouncil = withoutCityHall.replace(/^מועצה\s+מקומית\s+/g, "");
      const withoutRegionalCouncil = withoutLocalCouncil.replace(/^מועצה\s+אזורית\s+/g, "");

      const variants = [raw, withoutCityHall, withoutLocalCouncil, withoutRegionalCouncil]
        .map(normalizeKeyBase)
        .filter(Boolean);

      variantsCache.set(name, variants);
      return variants;
    }

    function getModeLabel(mode){
      if(mode === "muni") return "ישובים/רשויות";
      if(mode === "merhav") return "מרחבים";
      if(mode === "station") return "תחנות משטרה";
      return "ישויות";
    }
    function getEntityLabel(mode){
      if(mode === "muni") return "רשות";
      if(mode === "merhav") return "מרחב";
      if(mode === "station") return "תחנה";
      return "ישות";
    }
    function getIndexByMode(mode){
      if(mode === "muni") return muniIndex;
      if(mode === "merhav") return merhavIndex;
      if(mode === "station") return stationIndex;
      return muniIndex;
    }
    function getYearDataByMode(mode, year){
      if(mode === "muni") return window.crimeByYear?.[year] || null;
      if(mode === "merhav") return window.crimeByYearMerhav?.[year] || null;
      if(mode === "station") return getStationsDataset()?.[year] || null;
      return null;
    }

    function stationNameVariants(name){
      // מחזיר וריאציות שמקלות על התאמה בין שכבת GovMap לשמות בקובץ
      const raw0 = String(name || "").trim();
      if(!raw0) return [];
      const v = new Set();
      const add = (s)=>{ const k=normalizeKey(s); if(k) v.add(k); };

      // ניקוי בסיסי
      const raw = raw0.replace(/\s+/g," ").trim();
      add(raw);

      // אם מגיע משהו כמו "אזורי תחנת משטרה ..."
      const noAreas = raw
        .replace(/^אזורי\s+תחנת\s+משטרה\s*/,"")
        .replace(/^אזורי\s+/,"")
        .trim();
      if (noAreas && noAreas !== raw) add(noAreas);

      // הורדת "תחנת ..." / "תחנת משטרה ..."
      const noPoliceWord = noAreas.replace(/^תחנת\s+משטרה\s*/,"").trim();
      if (noPoliceWord && noPoliceWord !== noAreas) add(noPoliceWord);

      const noPrefix = noPoliceWord.replace(/^תחנת\s+/,"").trim();
      if(noPrefix && noPrefix !== noPoliceWord) add(noPrefix);

      // החזרה עם/בלי תחנת
      if (noPrefix) add("תחנת " + noPrefix);

      return Array.from(v);
    }

    // -------------------- Stations dataset resolver --------------------
    // חשוב: אם בקובץ תחנות מוגדר const CRIMEBYYEARSTATIONS או const crimeByYearStations,
    // זה לא תמיד יופיע בתוך window.*. לכן אנחנו מנסים כמה שמות אפשריים.
    function getStationsDataset(){
      // crimeByYearStations.js defines: window.crimeByYearStations = { [year]: { [stationName]: {total, breakdown} } }
      if (window.crimeByYearStations && typeof window.crimeByYearStations === "object") return window.crimeByYearStations;

      // fallback: some builds may export without window prefix
      try{
        // eslint-disable-next-line no-undef
        if (typeof crimeByYearStations !== "undefined" && crimeByYearStations && typeof crimeByYearStations === "object") return crimeByYearStations;
      }catch(_){}

      // fallback legacy / older naming
      if (window.CRIMEBYYEARSTATIONS && typeof window.CRIMEBYYEARSTATIONS === "object") return window.CRIMEBYYEARSTATIONS;
      try{
        // eslint-disable-next-line no-undef
        if (typeof CRIMEBYYEARSTATIONS !== "undefined" && CRIMEBYYEARSTATIONS && typeof CRIMEBYYEARSTATIONS === "object") return CRIMEBYYEARSTATIONS;
      }catch(_){}

      return null;
    }
// -------------------- Population --------------------
    function buildPopulationIndex() {
      for (const k in populationIndex) delete populationIndex[k];
      const raw = window.PopulationDB;
      if (!raw || typeof raw !== "object") {
        console.warn("⚠️ PopulationDB.js not loaded or invalid");
        return false;
      }
      for (const displayName in raw) {
        const pop = Number(raw[displayName]);
        if (!Number.isFinite(pop)) continue;
        for (const v of nameVariants(displayName)) populationIndex[v] = pop;
      }
      console.log("✅ Population index ready:", Object.keys(populationIndex).length);
      return true;
    }

    function getPopulationForAuthority(nameFromCrime) {
      for (const v of nameVariants(nameFromCrime)) {
        const pop = populationIndex[v];
        if (pop != null) return pop;
      }
      return null;
    }

    function calcRatePer10k(total, pop) {
      if (!Number.isFinite(Number(total))) return 0;
      const p = Number(pop);
      if (!Number.isFinite(p) || p <= 0) return 0;
      return Math.round((Number(total) / p) * 10000 * 10) / 10;
    }

    function fmtMaybe(num) {
      if (num == null) return "0";
      return Number(num).toLocaleString();
    }

    // -------------------- UI: metric buttons --------------------
    function updateMetricButtonsUI() {
      const btnRate = document.getElementById("btnMetricRate");
      const muniOnly = (currentMode === "muni");

      if (btnRate) {
        btnRate.classList.toggle("disabled", !muniOnly);
        btnRate.disabled = !muniOnly;
        btnRate.onclick = muniOnly ? () => setMetric("rate") : null;
        btnRate.title = muniOnly ? "מציג עבירות ל-10,000 תושבים (דורש אוכלוסייה)" : "זמין רק במצב ישובים/רשויות";
      }

      const headerP = document.querySelector("#panel-header p");
      if (headerP) {
        const extra = muniOnly ? "ל-10,000 זמין כאן" : "ל-10,000 לא זמין במצב זה";
        headerP.innerHTML = `מצב נוכחי: <strong>${escapeHtml(getModeLabel(currentMode))}</strong><br>${extra}`;
      }

      // אם יצאנו ממצב ישובים, לא משאירים מדד ל-10,000 פעיל
      if (!muniOnly && currentMetric === "rate") {
        currentMetric = "abs";
        const bAbs = document.getElementById("btnMetricAbs");
        const bRate2 = document.getElementById("btnMetricRate");
        if (bAbs) bAbs.classList.add("active");
        if (bRate2) bRate2.classList.remove("active");
      }
    }

    // -------------------- Stats --------------------
    function calculateStats(year, mode) {
      const m = mode || currentMode || "muni";
      const yearData = getYearDataByMode(m, year);
      if (!yearData) return { entities: 0, total: 0, avg: 0 };

      let total = 0, count = 0;
      for (const name in yearData) {
        const data = yearData[name];
        if (data && typeof data.total === "number") {
          total += data.total;
          count++;
        }
      }
      return { entities: count, total, avg: count > 0 ? Math.round(total / count) : 0 };
    }

    function updateQuickStats() {
      const key = `${currentYear}__${currentMode}`;
      if (!yearlyStats[key]) yearlyStats[key] = calculateStats(currentYear, currentMode);
      const stats = yearlyStats[key] || { entities: 0, total: 0, avg: 0 };

      const a = document.getElementById("stat-municipalities");
      const b = document.getElementById("stat-total");
      const c = document.getElementById("stat-avg");
      const l = document.getElementById("stat-entities-label");

      if (a) a.textContent = Number(stats.entities || 0).toLocaleString();
      if (b) b.textContent = Number(stats.total || 0).toLocaleString();
      if (c) c.textContent = Number(stats.avg || 0).toLocaleString();
      if (l) l.textContent = (currentMode === "muni" ? "רשויות" : (currentMode === "merhav" ? "מרחבים" : "תחנות"));
    }

    // -------------------- Index building --------------------
    function buildMuniIndexForYear(year) {
      for (const k in muniIndex) delete muniIndex[k];
      const yearData = window.crimeByYear?.[year];
      if (!yearData) return;

      for (const name in yearData) {
        const entry = { name, data: yearData[name] };
        const variants = nameVariants(name);
        for (const v of variants) if (!muniIndex[v]) muniIndex[v] = entry;
      }

      yearlyStats[year] = calculateStats(year);
      console.log(`✅ Year ${year}: ${Object.keys(muniIndex).length} muni keys indexed`);
    }

    function buildMerhavIndexForYear(year) {
      for (const k in merhavIndex) delete merhavIndex[k];
      const yearData = window.crimeByYearMerhav?.[year];
      if (!yearData) { 
        console.warn(`⚠️ No merhav data for year ${year}`); 
        return; 
      }

      for (const name in yearData) {
        merhavIndex[normalizeKey(name)] = { name, data: yearData[name] };
      }
      console.log(`✅ Year ${year}: ${Object.keys(merhavIndex).length} merhav keys indexed`);
    }

    function buildStationIndexForYear(year) {
      // מנקה אינדקס קיים
      Object.keys(stationIndex).forEach(k => delete stationIndex[k]);

      const yearData = getStationsDataset()?.[year] || null;
      if (!yearData) return;

      for (const [stationName, payload] of Object.entries(yearData)) {
        const entry = { name: String(stationName).trim(), data: payload || { total: 0, breakdown: {} } };
        const keys = stationNameVariants(stationName);
        keys.forEach(k => { if (k) stationIndex[k] = entry; });
      }
    }


    // -------------------- UI helpers --------------------
    function showInfo(title, body, type = "info") {
      const t = document.getElementById("info-title");
      const b = document.getElementById("info-body");
      if (!t || !b) return;
      t.textContent = title;
      b.innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function showEntry(entry) {
      const d = entry.data;
      let html = "";

      const total = (typeof d.total === "number") ? d.total : null;
      const popRaw = (currentMode === "muni") ? getPopulationForAuthority(entry.name) : null;
      const pop = (popRaw == null ? 0 : Number(popRaw));

      if (total != null) {
        if (currentMetric === "rate" && currentMode === "muni") {
          const rate = calcRatePer10k(total, pop);
          html += `<div class="total-summary">${rate.toLocaleString()} ל-10,000</div>`;
          html += `<div class="sub-summary">אוכלוסייה (2019): ${Number(pop).toLocaleString()} • סה"כ אירועים: ${Number(total).toLocaleString()}</div>`;
        } else {
          html += `<div class="total-summary">${Number(total).toLocaleString()} אירועים</div>`;
          if (currentMode === "muni") {
            html += `<div class="sub-summary">אוכלוסייה (2019): ${Number(pop).toLocaleString()}</div>`;
          }
        }
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        const sorted = Object.entries(d.breakdown).sort((a, b) => (b[1] || 0) - (a[1] || 0));
        html += `<div class="crime-grid">`;
        for (const [name, count] of sorted) {
          html += `<div class="crime-item">
            <div class="crime-name">${escapeHtml(name)}</div>
            <div class="crime-count">${Number(count || 0).toLocaleString()}</div>
          </div>`;
        }
        html += `</div>`;
      }

      const it = document.getElementById("info-title");
      const ib = document.getElementById("info-body");
      if (!it || !ib) return;
      it.textContent = entry.name;
      ib.innerHTML = html || `<div class="message message-info">אין נתונים להצגה</div>`;
    }

    // -------------------- Tabs --------------------
    function switchTab(tabName) {
      currentTab = tabName;

      document.querySelectorAll(".tab").forEach(tab =>
        tab.classList.toggle("active", tab.dataset.tab === tabName)
      );

      document.querySelectorAll(".tab-content").forEach(content =>
        content.classList.toggle("active", content.id === `tab-${tabName}`)
      );

      if (tabName === "single") {
        showInfo(
          "מפה לפי " + getModeLabel(currentMode),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(currentMode)} במפה כדי לראות נתונים`,
          "info"
        );
      } else if (tabName === "compare") {
        updateCompareView();
      } else if (tabName === "trends") {
        const tc = document.getElementById("trends-content");
        if (!selectedCity) {
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(currentMode)} במפה כדי לראות נתונים היסטוריים</div>`;
          return;
        }
        showTrends(selectedCity, currentMode);
      } else if (tabName === "rankings") {
        renderRankings();
      }
    }

    // -------------------- Mode / Metric --------------------
    function setMode(mode) {
      currentMode = mode;

      const bm = document.getElementById("btnModeMuni");
      const br = document.getElementById("btnModeMerhav");
      const bs = document.getElementById("btnModeStation");
      if (bm) bm.classList.toggle("active", mode === "muni");
      if (br) br.classList.toggle("active", mode === "merhav");
      if (bs) bs.classList.toggle("active", mode === "station");

      updateMetricButtonsUI();
      updateQuickStats();

      const layerToShow =
        (mode === "muni") ? MUNICIPAL_LAYER :
        (mode === "merhav") ? POLICE_MERHAV_LAYER :
        POLICE_STATION_LAYER;

      const layersToHide =
        (mode === "muni") ? [POLICE_MERHAV_LAYER, POLICE_STATION_LAYER] :
        (mode === "merhav") ? [MUNICIPAL_LAYER, POLICE_STATION_LAYER] :
        [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER];

      if (mapInitialized) {
        try {
          if (typeof govmap.setVisibleLayers === "function") {
            govmap.setVisibleLayers([layerToShow], layersToHide);
          }
        } catch (err) {
          console.warn("⚠️ setVisibleLayers failed:", err);
        }
      }

      if (mode !== "muni") {
        choroplethEnabled = false;
        clearChoropleth();
        setMunicipalLayerOpacity(100);
      }
      setChoroBtnUI();

      selectedCity = null;
      selectedCityKey = null;
      compareList = compareList.filter(c => c.mode === mode);

      if (choroplethEnabled && mode === "muni") renderChoropleth();

      if (currentTab === "compare") updateCompareView();
      else if (currentTab === "rankings") renderRankings();
      else if (currentTab === "trends") {
        const tc = document.getElementById("trends-content");
        if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(mode)} במפה כדי לראות נתונים היסטוריים</div>`;
      } else {
        showInfo(
          "מפה לפי " + getModeLabel(mode),
          `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(mode)} במפה כדי לראות נתונים`,
          "info"
        );
      }
    }

    function setMetric(metric) {
      if (metric === "rate" && currentMode !== "muni") {
        alert("זמין רק במצב ישובים/רשויות");
        return;
      }

      currentMetric = metric;

      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");

      if (bAbs) bAbs.classList.toggle("active", metric === "abs");
      if (bRate) bRate.classList.toggle("active", metric === "rate");

      if (choroplethEnabled && currentMode === "muni") renderChoropleth();

      // רענון אוטומטי של היישות שנבחרה (כדי שהשנה/המדד יתעדכנו בלי לבחור מחדש)
      if (currentTab === "single" && selectedCityKey) {
        const index = getIndexByMode(currentMode);
        const entry = index[selectedCityKey];
        if (entry) showEntry(entry);
      }
      if (currentTab === "compare") updateCompareView();
      if (currentTab === "trends" && selectedCity) showTrends(selectedCity, currentMode);
      if (currentTab === "rankings") renderRankings();
    }

// -------------------- Compare --------------------
    function addToCompare() {
      if (!selectedCity) { 
        alert(`אנא בחר ${getEntityLabel(currentMode)} במפה תחילה`); 
        return; 
      }
      if (!compareList.some(c => c.key === selectedCityKey && c.mode === currentMode)) {
        compareList.push({ name: selectedCity, key: selectedCityKey, mode: currentMode });
        updateCompareView();
      }
    }

    function removeFromCompare(key) {
      compareList = compareList.filter(c => c.key !== key || c.mode !== currentMode);
      updateCompareView();
    }

    function updateCompareView() {
      const container = document.getElementById("compare-content");
      if (!container) return;

      const entityType = getEntityLabel(currentMode);

      const selectedHint = selectedCity
        ? `<div class="message message-info">נבחר כעת: <strong>${escapeHtml(selectedCity)}</strong> (לחץ על ➕ כדי להוסיף להשוואה)</div>`
        : `<div class="message message-info">לחץ על ${entityType} במפה ואז על ➕ כדי להוסיף להשוואה</div>`;

      let html = `
        <button class="add-compare-btn" onclick="addToCompare()">➕ הוסף ${entityType} נבחר להשוואה</button>
        ${selectedHint}
      `;

      const filteredList = compareList.filter(c => c.mode === currentMode);

      if (filteredList.length > 0) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
        filteredList.forEach(item => {
          html += `<div class="compare-city-tag">${escapeHtml(item.name)}
            <button class="remove-tag-btn" onclick="removeFromCompare('${escapeHtml(item.key)}')" title="הסר">×</button></div>`;
        });
        html += "</div>";
      }

      if (filteredList.length < 2) {
        html += `<div class="message message-info">הוסף עוד ${entityType} אחד לפחות כדי לראות השוואה</div>`;
        container.innerHTML = html;
        return;
      }

      const index = getIndexByMode(currentMode);

      const metricType =
        (currentMode === "muni" && currentMetric === "rate") ? "rate" :
        "total";

      const rows = filteredList.map(item => {
        const entry = index[item.key];
        const total = entry?.data?.total ?? 0;
        const popRaw = (currentMode === "muni") ? getPopulationForAuthority(item.name) : null;
        const pop = (popRaw == null ? 0 : Number(popRaw));
        const rate = (currentMode === "muni") ? calcRatePer10k(total, pop) : null;
        return { name: item.name, total, pop, rate, hasPop: popRaw != null };
      });

      if (currentMode !== "muni") {
        html += `<div class="message message-info">במצב ${getModeLabel(currentMode)} ההשוואה היא לפי כמות בלבד (אין אוכלוסייה).</div>`;
      } else if (metricType === "rate") {
        html += `<div class="message message-info">השוואה לפי <strong>ל-10,000 תושבים</strong> (אוכלוסייה 2019; חסר = 0).</div>`;
      } else if (false) {
        html += `<div class="message message-info">השוואה לפי <strong>אוכלוסייה כוללת</strong> (2019).</div>`;
      } else {
        html += `<div class="message message-info">טיפ: מעבר ל־<strong>ל-10,000</strong> משווה יחסית לגודל אוכלוסייה (2019).</div>`;
      }

      const metricBadge =
        metricType === "rate" ? "מדד: ל-10,000" :
        "מדד: כמות";

      html += `<div class="compare-grid">`;
      rows.forEach(r => {
        const badges = [];
        badges.push(`<span class="badge">${metricBadge}</span>`);
        if (currentMode === "muni" && !r.hasPop) badges.push(`<span class="badge badge-warn">אוכלוסייה הונחה 0</span>`);

        html += `
          <div class="compare-card">
            <div class="compare-card-title">
              <div class="compare-name">${escapeHtml(r.name)}</div>
              <div class="compare-badges">${badges.join("")}</div>
            </div>

            <div class="compare-kpis">
              <div class="kpi">
                <div class="kpi-value">${Number(r.total).toLocaleString()}</div>
                <div class="kpi-label">כמות</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? fmtMaybe(r.pop) : "—"}</div>
                <div class="kpi-label">אוכלוסייה</div>
              </div>
              <div class="kpi">
                <div class="kpi-value">${currentMode === "muni" ? (r.rate == null ? "—" : r.rate.toLocaleString()) : "—"}</div>
                <div class="kpi-label">ל-10,000</div>
              </div>
            </div>
          </div>
        `;
      });
      html += `</div>`;

      const title =
        metricType === "rate" ? `השוואה לפי ל-10,000 (${currentYear})` :
        `השוואה לפי כמות (${currentYear})`;
      html += `<div class="compare-bars-title">${title}</div>`;

      const values = rows
        .map(r => metricType === "rate" ? r.rate : r.total)
        .filter(v => v != null && Number.isFinite(v));
      const max = values.length ? Math.max(...values) : 0;

      html += `<div class="compare-bars">`;
      rows.forEach(r => {
        const v = metricType === "rate" ? (r.rate ?? 0) : r.total;
        const pct = max > 0 ? Math.round((v / max) * 100) : 0;
        html += `
          <div class="bar-row">
            <div class="bar-name">${escapeHtml(r.name)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
            <div class="bar-value">${Number(v || 0).toLocaleString()}</div>
          </div>
        `;
      });
      html += `</div>`;

      container.innerHTML = html;
    }

    // -------------------- Trends --------------------
    function showTrends(entityName, mode = currentMode) {
      const container = document.getElementById("trends-content");
      if (!container) return;

      if (!entityName) {
        container.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(mode)} במפה כדי לראות נתונים היסטוריים</div>`;
        return;
      }

      const dataset = (mode === "muni") ? window.crimeByYear : (mode === "merhav") ? window.crimeByYearMerhav : getStationsDataset();

      if (!dataset || typeof dataset !== "object") {
        container.innerHTML = `<div class="message message-error">אין נתוני היסטוריה זמינים עבור ${getModeLabel(mode)}.</div>`;
        return;
      }

      const years = Object.keys(dataset).sort();
      const targetVariants =
        (mode === "muni") ? Array.from(new Set(nameVariants(entityName).map(v => normalizeKey(v)).filter(Boolean))) :
        (mode === "station") ? stationNameVariants(entityName) :
        [normalizeKey(entityName)];

      const findEntryInYear = (yearData) => {
        if (!yearData) return null;

        // 1) התאמה ישירה לפי מפתח
        for (const v of targetVariants) {
          if (!v) continue;
          // yearData keys הם שמות מקוריים; ננסה למצוא התאמה ע"י מעבר עליהם רק אם אין התאמה ישירה
          // לכן פה רק נבדוק אם יש מפתח בדיוק (למשל במקרה של station שמפתח הוא שם התחנה)
          if (yearData[v]) return { name: v, data: yearData[v] };
        }

        // 2) התאמה ישירה לפי שם גולמי
        if (yearData[entityName]) return { name: entityName, data: yearData[entityName] };

        // 3) סריקה לפי normalizeKey (מאט אבל מספיק קטן)
        for (const [k, d] of Object.entries(yearData)) {
          const kk = normalizeKey(k);
          if (targetVariants.includes(kk)) return { name: k, data: d };
        }
        return null;
      };

      const metricType =
        (mode === "muni" && currentMetric === "rate") ? "rate" :
        "total";

      const yearly = years.map(y => {
        const found = findEntryInYear(dataset[y]);
        const total = Number(found?.data?.total || 0);
        const popRaw = (mode === "muni") ? getPopulationForAuthority(found?.name || entityName) : null;
        const pop = (popRaw == null ? 0 : Number(popRaw));
        const rate = (mode === "muni") ? calcRatePer10k(total, pop) : null;

        const value =
          metricType === "rate" ? rate :
          false ? pop :
          total;

        return { year: y, total, pop, rate, value, has: !!found };
      });

      const metricLabel =
        metricType === "rate" ? "ל-10,000" :
        false ? "אוכלוסייה" :
        "כמות";

      let html = `
        <div class="message message-info" style="margin-bottom:10px;">
          <strong>${escapeHtml(entityName)}</strong> • מצב: <strong>${getModeLabel(mode)}</strong><br>
          מציג לפי: <strong>${metricLabel}</strong>
        </div>
      `;

      html += `<div class="trend-table">`;
      html += `<div class="trend-row trend-head">
          <div>שנה</div>
          <div>כמות</div>
          <div>אוכלוסייה</div>
          <div>ל-10,000</div>
        </div>`;

      yearly.forEach(r => {
        html += `
          <div class="trend-row">
            <div>${escapeHtml(r.year)}</div>
            <div>${Number(r.total || 0).toLocaleString()}</div>
            <div>${mode === "muni" ? fmtMaybe(r.pop) : "—"}</div>
            <div>${mode === "muni" ? (r.rate == null ? "—" : Number(r.rate || 0).toLocaleString()) : "—"}</div>
          </div>
        `;
      });

      html += `</div>`;
      container.innerHTML = html;
    }

    // -------------------- Map click helpers --------------------
    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const obj = {};
      for (const f of fields) if (f.FieldName && f.Value !== undefined) obj[f.FieldName] = f.Value;
      return obj;
    }

    function detectMunicipalityName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["שם רשות", "שם רשות מקומית", "שם ישוב", "ישוב סופי", "SHEM_YISHUV", "NAME", "Name"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    function detectMerhavName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      const candidates = ["שם מרחב", "שם מרחב משטרתי", "MERHAV", "SHEM_MERHAV", "NAME", "Name"];
      for (const c of candidates) if (attrs && attrs[c]) return attrs[c];
      return null;
    }

    function detectStationName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw) || attrsRaw;
      if (!attrs) return null;

      // עדיפות לשדה הרשמי בשכבה: "שם תחנה"
      const preferred = [
        "שם תחנה",
        "SHEM_TAHANA",
        "TAHANA",
        "STATION",
        "Name",
        "NAME",
        "שם תחנת משטרה",
        "תחנה",
        "SHEM_TAHANA_MISHTARA"
      ];

      for (const c of preferred) {
        const val = attrs[c];
        if (val != null && String(val).trim()) return String(val).trim();
      }
      return null;
    }


    async function onMapClick(e) {
      if (!mapInitialized) return;

      try {
        const layerName = (currentMode === "muni") ? MUNICIPAL_LAYER : (currentMode === "merhav" ? POLICE_MERHAV_LAYER : POLICE_STATION_LAYER);
        const resp = await govmap.getLayerData({
          LayerName: layerName,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp?.data || resp?.Data || [];
        if (!items.length) { 
          showInfo("לא נמצא", "אין אובייקט באזור זה", "info"); 
          return; 
        }

        const first = items[0];
        const attrs = first.Fields || first.Attributes || first;

        if (currentMode === "muni") {
          const nameFromMap = detectMunicipalityName(attrs);
          if (!nameFromMap) { 
            showInfo("שגיאה", "לא ניתן לזהות את שם הרשות", "error"); 
            return; 
          }

          const key = normalizeKey(nameFromMap);
          const entry = muniIndex[key] || muniIndex[nameVariants(nameFromMap)[0]];
          if (!entry) { 
            showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(nameFromMap)}</strong> בשנת ${currentYear}`, "error"); 
            return; 
          }

          selectedCity = entry.name;
          selectedCityKey = nameVariants(entry.name)[0];

          if (currentTab === "compare") { updateCompareView(); return; }
          if (currentTab === "single") { showEntry(entry); return; }
          if (currentTab === "trends") { showTrends(selectedCity, "muni"); return; }
          if (currentTab === "rankings") { renderRankings(); return; }

          showEntry(entry);
          return;
        }

        if (currentMode === "station") {
          const stationName = detectStationName(attrs);
          if (!stationName) {
            showInfo("שגיאה", "לא ניתן לזהות את שם תחנת המשטרה", "error");
            return;
          }

          const keys = stationNameVariants(stationName);
          let entry = null;
          let pickedKey = null;
          for (const k of keys) {
            if (stationIndex[k]) { entry = stationIndex[k]; pickedKey = k; break; }
          }
          if (!entry) {
            // נסה חיפוש גמיש
            const nk = normalizeKey(stationName);
            entry = stationIndex[nk] || null;
            pickedKey = nk;
          }

          if (!entry) {
            showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(stationName)}</strong> בשנת ${currentYear}`, "error");
            return;
          }

          selectedCity = entry.name;
          selectedCityKey = pickedKey || stationNameVariants(entry.name)[0] || normalizeKey(entry.name);

          if (currentTab === "compare") { updateCompareView(); return; }
          if (currentTab === "single") { showEntry(entry); return; }
          if (currentTab === "trends") { showTrends(selectedCity, "station"); return; }
          if (currentTab === "rankings") { renderRankings(); return; }

          showEntry(entry);
          return;
        }


        const merhavName = detectMerhavName(attrs);
        if (!merhavName) { 
          showInfo("שגיאה", "לא ניתן לזהות את שם מרחב המשטרה", "error"); 
          return; 
        }

        const key = normalizeKey(merhavName);
        selectedCity = merhavName;
        selectedCityKey = key;

        const entry = merhavIndex[key];
        if (!entry) { 
          showInfo("לא נמצאו נתונים", `אין נתוני פשיעה עבור <strong>${escapeHtml(merhavName)}</strong> בשנת ${currentYear}`, "error"); 
          return; 
        }

        if (currentTab === "compare") { updateCompareView(); return; }
        if (currentTab === "rankings") { renderRankings(); return; }
        if (currentTab === "trends") { showTrends(selectedCity, "merhav"); return; }

        showEntry(entry);

      } catch (error) {
        console.error("❌ Error in onMapClick:", error);
        showInfo("שגיאה", `אירעה שגיאה: ${error?.message || 'שגיאה לא מוגדרת'}`, "error");
      }
    }

    // -------------------- MODALS --------------------
    function openModal(id){ 
      const m=document.getElementById(id); 
      if(m) m.style.display="block"; 
    }
    function closeModal(id){ 
      const m=document.getElementById(id); 
      if(m) m.style.display="none"; 
    }

    function initModals(){
      const aboutBtn = document.getElementById("aboutBtn");
      const aboutClose = document.getElementById("aboutCloseBtn");
      const aboutOverlay = document.getElementById("aboutOverlay");
      if (aboutBtn) aboutBtn.addEventListener("click", ()=>openModal("aboutModal"));
      if (aboutClose) aboutClose.addEventListener("click", ()=>closeModal("aboutModal"));
      if (aboutOverlay) aboutOverlay.addEventListener("click", ()=>closeModal("aboutModal"));

      const searchBtn = document.getElementById("searchBtn");
      const searchClose = document.getElementById("searchCloseBtn");
      const searchOverlay = document.getElementById("searchOverlay");
      if (searchBtn) searchBtn.addEventListener("click", ()=>{
        openModal("searchModal");
        const inp = document.getElementById("addrInput");
        if (inp) setTimeout(()=>inp.focus(), 50);
      });
      if (searchClose) searchClose.addEventListener("click", ()=>closeModal("searchModal"));
      if (searchOverlay) searchOverlay.addEventListener("click", ()=>closeModal("searchModal"));

      document.addEventListener("keydown", (e)=>{
        if(e.key==="Escape"){
          closeModal("aboutModal");
          closeModal("searchModal");
        }
      });
    }

    function togglePanel(){
      const panel = document.getElementById("info-panel");
      if(!panel) return;
      panel.classList.toggle("collapsed");

      const btn = document.getElementById("panelToggleBtn");
      if (btn) {
        const collapsed = panel.classList.contains("collapsed");
        btn.textContent = collapsed ? "➕ הגדל" : "➖ הקטן";
        btn.title = collapsed ? "הגדל" : "הקטן/הגדל (במיוחד לנייד)";
      }
    }

    // -------------------- Rankings (תמיד Top 20, לפי מצב המדד באתר) --------------------
    function renderRankings() {
      const container = document.getElementById("rankings-content");
      if (!container) return;

      const topN = 20;

      const yearData = getYearDataByMode(currentMode, currentYear);
      if (!yearData) {
        container.innerHTML = `<div class="message message-error">אין נתונים לשנה הזו.</div>`;
        return;
      }

      const metricType =
        (currentMode === "muni" && currentMetric === "rate") ? "rate" :
        "total";

      const rows = [];
      for (const name in yearData) {
        const d = yearData[name];
        const total = Number(d?.total || 0);

        if (currentMode === "muni" && metricType === "rate") {
          const popRaw = getPopulationForAuthority(name);
          const pop = (popRaw == null ? 0 : Number(popRaw));
          const rate = calcRatePer10k(total, pop);
          rows.push({ name, value: rate, extra: { pop, total }, hasPop: popRaw != null });
        } else if (currentMode === "muni" && false) {
          const popRaw = getPopulationForAuthority(name);
          const pop = (popRaw == null ? 0 : Number(popRaw));
          rows.push({ name, value: pop, extra: { pop, total }, hasPop: popRaw != null });
        } else {
          rows.push({ name, value: total, extra: { total }, hasPop: true });
        }
      }

      rows.sort((a,b)=> (b.value || 0) - (a.value || 0));
      const top = rows.slice(0, topN);

      const metricLabel =
        metricType === "rate" ? "ל-10,000" :
        false ? "אוכלוסייה" :
        "כמות (אבסולוטי)";

      const header = `
        <div class="message message-info" style="margin-bottom:10px;">
          שנה: <strong>${currentYear}</strong> • מצב: <strong>${getModeLabel(currentMode)}</strong><br>
          דירוג אוטומטי לפי: <strong>${metricLabel}</strong> • Top ${topN}
        </div>
      `;

      if (!top.length) {
        container.innerHTML = header + `<div class="message message-error">אין מספיק נתונים להצגת דירוג.</div>`;
        return;
      }

      let note = "";
      if (currentMode === "muni" && (metricType === "rate" || false)) {
        note = `<div class="message message-warn">אוכלוסייה מבוססת על נתון 2019; חסר = 0.</div>`;
      }

      let html = header + note;
      html += `<div class="rank-list">`;

      top.forEach((r, idx) => {
        const valueText = (metricType === "rate") ? Number(r.value || 0).toLocaleString() :
                          (false) ? Number(r.value || 0).toLocaleString() :
                          Number(r.value || 0).toLocaleString();

        const extra =
          (currentMode === "muni" && metricType === "rate")
            ? `<div class="rank-extra">כמות: ${Number(r.extra?.total || 0).toLocaleString()} • אוכלוסייה: ${fmtMaybe(r.extra?.pop)}</div>`
            : (currentMode === "muni" && false)
              ? `<div class="rank-extra">כמות עבירות: ${Number(r.extra?.total || 0).toLocaleString()}</div>`
              : ``;

        html += `
          <div class="rank-row">
            <div class="rank-num">${idx + 1}</div>
            <div class="rank-name">${escapeHtml(r.name)}</div>
            <div class="rank-value">${valueText}</div>
          </div>
          ${extra}
        `;
      });

      html += `</div>`;
      container.innerHTML = html;
    }

    // -------------------- Address Search --------------------
    function parseGeocodeList(resp) {
      const list = resp?.data || resp?.Data || resp?.results || resp;
      if (Array.isArray(list)) return list;
      if (Array.isArray(list?.Result)) return list.Result;
      return [];
    }

    function extractXY(item) {
      const x = item?.X ?? item?.x ?? item?.CenterX ?? item?.centerX ?? item?.Lon ?? item?.lon;
      const y = item?.Y ?? item?.y ?? item?.CenterY ?? item?.centerY ?? item?.Lat ?? item?.lat;
      return { x: Number(x), y: Number(y) };
    }

    function isBadTitle(t){
      const s = String(t ?? "").trim();
      if (!s) return true;
      const low = s.toLowerCase();
      return (s === "תוצאה" || low === "result" || low === "results" || low === "unknown");
    }

    function renderAddrResults(items) {
      const box = document.getElementById("addrResults");
      if (!box) return;

      lastAddrItems = items || [];

      if (!items || !items.length) {
        box.style.display = "block";
        box.innerHTML = `<div class="addr-item">לא נמצאו תוצאות</div>`;
        return;
      }

      box.style.display = "block";
      box.innerHTML = items.map((it, idx) => {
        const title = escapeHtml(it.__title || lastGeocodeQuery || "תוצאה");
        const sub = escapeHtml(it.__sub || "");
        return `
          <div class="addr-item" data-idx="${idx}">
            <div style="font-weight:1000; color:#222;">${title}</div>
            ${sub ? `<div class="addr-sub">${sub}</div>` : ""}
          </div>
        `;
      }).join("");

      box.querySelectorAll(".addr-item").forEach(el => {
        el.addEventListener("click", () => {
          const idx = Number(el.dataset.idx);
          const picked = lastAddrItems[idx];
          if (picked) focusToGeocodeItem(picked);
          box.style.display = "none";
          closeModal("searchModal");
        });
      });
    }

    function focusToGeocodeItem(item) {
      if (!mapInitialized) return;

      const { x, y } = extractXY(item);
      if (!Number.isFinite(x) || !Number.isFinite(y)) {
        showInfo("שגיאה", "התקבלה תוצאה בלי קואורדינטות X/Y", "error");
        return;
      }

      try { govmap.zoomToXY({ x, y, level: 10, marker: true }); } catch (e) {}

      const label = (!isBadTitle(item.__title) ? item.__title : (lastGeocodeQuery || "תוצאה"));
      showInfo("כתובת", `התמקדתי לכתובת: <strong>${escapeHtml(label)}</strong>`, "info");
    }

    function setAddrLoading(msg) {
      const box = document.getElementById("addrResults");
      if (!box) return;
      box.style.display = "block";
      box.innerHTML = `<div class="addr-item">${escapeHtml(msg || "מחפש…")}</div>`;
    }

    function runGeocode(query) {
      const q = String(query || "").trim();
      if (!q) return;

      lastGeocodeQuery = q;

      if (!mapInitialized) {
        showInfo("רגע", "המפה עדיין נטענת, נסה שוב בעוד רגע.", "warn");
        return;
      }

      const myId = ++lastGeocodeReqId;

      showInfo("חיפוש כתובת", `מחפש: <strong>${escapeHtml(q)}</strong>`, "info");
      setAddrLoading("מחפש כתובת…");

      const payload = { keyword: q };
      if (govmap.geocodeType?.AccuracyOnly) payload.type = govmap.geocodeType.AccuracyOnly;

      let res;
      try { res = govmap.geocode(payload); } catch (e) {
        showInfo("חיפוש כתובת", `שגיאה בחיפוש עבור: <strong>${escapeHtml(q)}</strong>`, "error");
        renderAddrResults([]);
        return;
      }

      const onSuccess = (resp) => {
        if (myId !== lastGeocodeReqId) return;

        const list = parseGeocodeList(resp);
        if (!list || !list.length) {
          showInfo("חיפוש כתובת", `לא נמצאו תוצאות עבור: <strong>${escapeHtml(q)}</strong>`, "warn");
          renderAddrResults([]);
          return;
        }

        const mapped = list.slice(0, 10).map(r => {
          const candidates = [
            r?.SettlementName, r?.settlementName,
            r?.PlaceName, r?.placeName,
            r?.Name, r?.name,
            r?.ResultLabel, r?.resultLabel,
            r?.Address, r?.address,
            r?.Title, r?.title,
            r?.label
          ].map(x => (x == null ? "" : String(x).trim())).filter(Boolean);

          let title = candidates.find(t => !isBadTitle(t)) || q;
          let sub = (r?.City || r?.city || r?.Region || r?.region || r?.Street || r?.street || r?.SubTitle || r?.subTitle || "");
          sub = String(sub || "").trim();
          return { ...r, __title: title, __sub: sub };
        });

        renderAddrResults(mapped);
      };

      const onFail = (err) => {
        if (myId !== lastGeocodeReqId) return;
        showInfo("חיפוש כתובת", `לא ניתן לבצע חיפוש עבור: <strong>${escapeHtml(q)}</strong>`, "error");
        renderAddrResults([]);
      };

      if (res && typeof res.then === "function") res.then(onSuccess).catch(onFail);
      else if (res && typeof res.done === "function") res.done(onSuccess).fail(onFail);
      else onFail(new Error("Unknown geocode return type"));
    }

    function initAddressSearchUI() {
      const input = document.getElementById("addrInput");
      const btn = document.getElementById("addrBtn");
      const box = document.getElementById("addrResults");
      if (!input || !btn || !box) return;

      btn.addEventListener("click", () => runGeocode(input.value));

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") runGeocode(input.value);
        if (e.key === "Escape") box.style.display = "none";
      });

      input.addEventListener("input", () => {
        if (searchTimeout) clearTimeout(searchTimeout);
        const v = input.value.trim();
        if (v.length < 3) { box.style.display = "none"; return; }
        searchTimeout = setTimeout(() => runGeocode(v), 350);
      });

      document.addEventListener("click", (e) => {
        if (!box.contains(e.target) && e.target !== input && e.target !== btn) {
          box.style.display = "none";
        }
      });
    }

    // ===================== GEOJSON -> WKT =====================
    let muniBoundariesLoaded = false;
    let muniBoundariesLoadError = null;

    function ensureClosedRing(coords){
      if(!Array.isArray(coords) || coords.length<3) return coords;
      const first = coords[0];
      const last  = coords[coords.length-1];
      if(first && last && first[0]===last[0] && first[1]===last[1]) return coords;
      return coords.concat([[first[0], first[1]]]);
    }
    function ringToWkt(ring){
      const r = ensureClosedRing(ring);
      return r.map(p => `${Number(p[0]).toFixed(3)} ${Number(p[1]).toFixed(3)}`).join(", ");
    }
    function geojsonGeomToWkt(geom){
      if(!geom || !geom.type) return null;

      if(geom.type === "Polygon"){
        const rings = (geom.coordinates||[]).map(ringToWkt);
        if(!rings.length) return null;
        return `POLYGON((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
      }
      if(geom.type === "MultiPolygon"){
        const polys = geom.coordinates || [];
        const parts = polys.map(poly=>{
          const rings = (poly||[]).map(ringToWkt);
          if(!rings.length) return null;
          return `((${rings[0]})${rings.slice(1).map(h=>`,(${h})`).join("")})`;
        }).filter(Boolean);
        if(!parts.length) return null;
        return `MULTIPOLYGON(${parts.join(",")})`;
      }
      return null;
    }

    async function loadMuniBoundariesGeojson(){
      if(muniBoundariesLoaded) return true;

      muniBoundariesLoadError = null;
      try{
        let feats = [];

        // 1) Try loading from variable (local file bypass)
        if (window.MUNI_DATA && window.MUNI_DATA.features) {
             console.log("✅ Using window.MUNI_DATA");
             feats = window.MUNI_DATA.features;
        } else {
             // 2) Try loading via fetch
             const res = await fetch(MUNI_BOUNDARIES_GEOJSON_URL, { cache: "no-store" });
             if(!res.ok) throw new Error(`fetch failed (${res.status})`);
             const gj = await res.json();
             feats = Array.isArray(gj?.features) ? gj.features : [];
        }

        muniBoundariesIndex = {};
        muniBoundariesMeta = [];

        for(const f of feats){
          const name = f?.properties?.name;
          const wkt  = geojsonGeomToWkt(f?.geometry);
          if(!name || !wkt) continue;
          muniBoundariesIndex[normalizeKey(name)] = wkt;
          muniBoundariesMeta.push({ name: String(name), wkt });
        }


        muniBoundariesLoaded = true;
        console.log("✅ Boundaries loaded:", Object.keys(muniBoundariesIndex).length);
        return true;

      }catch(e){
        muniBoundariesLoadError = e;
        console.error("❌ Failed loading muni boundaries:", e);
        return false;

      }finally{
        setChoroBtnUI();
      }
    }

    function findWktForCrimeName(crimeName){
      const vars = [crimeName, ...(Array.isArray(nameVariants(crimeName)) ? nameVariants(crimeName) : [])];
      for(const v of vars){
        const wkt = muniBoundariesIndex?.[normalizeKey(v)];
        if(wkt) return wkt;
      }
      const wkt2 = muniBoundariesIndex?.[normalizeKey(crimeName)];
      return wkt2 || null;
    }

    // -------------------- Choropleth helpers --------------------
    function lerp(a,b,t){ return a + (b-a)*t; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function rateToColor(rate, minR, maxR){
      const t = (maxR > minR) ? clamp01((rate - minR) / (maxR - minR)) : 0.5;

      const low  = [  0, 210,  60];
      const mid  = [255, 160,   0];
      const high = [240,  20,  20];

      if (t < 0.5) {
        const tt = t / 0.5;
        return [
          Math.round(lerp(low[0], mid[0], tt)),
          Math.round(lerp(low[1], mid[1], tt)),
          Math.round(lerp(low[2], mid[2], tt)),
        ];
      } else {
        const tt = (t - 0.5) / 0.5;
        return [
          Math.round(lerp(mid[0], high[0], tt)),
          Math.round(lerp(mid[1], high[1], tt)),
          Math.round(lerp(mid[2], high[2], tt)),
        ];
      }
    }

    // ✅ ניקוי משודרג (לא משנה לוגיקה, רק יותר יציב)
    function clearChoropleth() {
      const namesToClear = Array.isArray(activeChoroplethNames) ? [...activeChoroplethNames] : [];

      try {
        // קודם ננסה למחוק לפי שמות (הכי מדויק)
        if (namesToClear.length && typeof govmap.clearGeometriesByName === "function") {
          try {
            govmap.clearGeometriesByName(namesToClear);
          } catch (e) {
            // אם יש גרסה שמקבלת שם בודד / פורמט אחר – ננסה אחד אחד
            namesToClear.forEach(n => {
              try { govmap.clearGeometriesByName([n]); } catch (_) {}
              try { govmap.clearGeometriesByName(n); } catch (_) {}
            });
          }
        }

        // ואז ניקוי כללי
        if (typeof govmap.clearGeometries === "function") {
          govmap.clearGeometries();
        }
      } catch (e) {
        console.warn("Clear failed", e);
      }

      // איפוס רק בסוף
      activeChoroplethNames = [];
    }

    function setMunicipalLayerOpacity(opacity){
      if(typeof govmap.setLayerOpacity === "function"){
        try{ govmap.setLayerOpacity({ layerName: MUNICIPAL_LAYER, opacity }); }catch(e){}
      }
    }

    function setChoroBtnUI(){
      const btn = document.getElementById("btnChoro");
      if(!btn) return;

      const muniOnly = (currentMode === "muni");
      const metricLabel = (currentMetric === "rate") ? "ל-10,000" : "כמות";

      if(!muniOnly){
        btn.classList.remove("active");
        btn.classList.add("disabled");
        btn.disabled = true;
        btn.textContent = "🎨 צביעה (זמין בישובים)";
        btn.title = "צביעה זמינה רק במצב ישובים/רשויות";
        return;
      }

      btn.classList.toggle("active", !!choroplethEnabled);
      btn.classList.remove("disabled");
      btn.disabled = false;

      if(!muniBoundariesLoaded){
        btn.textContent = `🎨 צביעה (${metricLabel})`;
        btn.title = muniBoundariesLoadError
          ? "נכשל לטעון GeoJSON. ודא שהקובץ קיים ושאתה בשרת (GitHub Pages/localhost)."
          : "טוען GeoJSON של גבולות הרשויות...";
      }else{
        btn.textContent = choroplethEnabled ? `🎨 צביעה (${metricLabel}): פעיל` : `🎨 צביעה (${metricLabel})`;
        btn.title = `צביעה לפי ${metricLabel}`;
      }
    }

    async function toggleChoropleth(){
      if(currentMode !== "muni") setMode("muni");

      choroplethEnabled = !choroplethEnabled;
      setChoroBtnUI();

      if(!mapInitialized) return;

      if(!choroplethEnabled){
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        showInfo("צביעה כובתה","חזרתי לתצוגה רגילה.","info");
        return;
      }

      const ok = await loadMuniBoundariesGeojson();
      if(!ok){
        choroplethEnabled = false;
        setChoroBtnUI();
        return;
      }

      setMunicipalLayerOpacity(0);
      await renderChoropleth();
    }

    async function renderChoropleth(){
      if(!mapInitialized || !choroplethEnabled) return;
      if(currentMode !== "muni") return;

      if(!muniBoundariesLoaded){
        const ok = await loadMuniBoundariesGeojson();
        if(!ok) return;
      }

      const yearData = window.crimeByYear?.[currentYear];
      if(!yearData){
        showInfo("שגיאה","אין נתונים לשנה שנבחרה.","error");
        return;
      }

            clearChoropleth();

      const normalRows = [];
      const missingGeom = [];

      const NO_JUR_PREFIX = "ללא שיפוט";

      // Collect all boundaries whose NAME starts with "ללא שיפוט" (from the boundaries GeoJSON),
      // even if they do not appear in the crime dataset for this year.
      const noJurRows = (Array.isArray(muniBoundariesMeta) ? muniBoundariesMeta : [])
        .filter(b => String(b?.name || "").trim().startsWith(NO_JUR_PREFIX) && b?.wkt)
        .map(b => ({
          name: String(b.name).trim(),
          wkt: b.wkt,
          total: 0,
          pop: 0,
          rate: 0
        }));

      for(const name in yearData){
        // Always render "ללא שיפוט" as gray based on the map/boundaries names
        if (String(name || "").trim().startsWith(NO_JUR_PREFIX)) continue;

        const d = yearData[name];
        const total = Number(d?.total || 0);

        const popRaw = getPopulationForAuthority(name);
        const pop = (popRaw == null ? 0 : Number(popRaw));
        const rate = calcRatePer10k(total, pop);

        const wkt = findWktForCrimeName(name);
        if(!wkt){ 
          missingGeom.push(name); 
          continue; 
        }

        const value = (currentMetric === "rate") ? rate : total;
        normalRows.push({ name, wkt, total, pop, rate, value });
      }

      const allRows = [...normalRows, ...noJurRows];

      if(!allRows.length){
        showInfo("אין מספיק נתונים","לא נמצאו רשויות עם גבול כדי לצבוע.","warn");
        return;
      }

      // טווח לצביעה ירוק→אדום: רק הרשויות שאינן "ללא שיפוט"
      const refVals = normalRows.length ? normalRows.map(r => r.value) : allRows.map(r => r.value);
      const minV  = Math.min(...refVals);
      const sortedDesc = [...refVals].sort((a,b)=>b-a);
      const maxV = (sortedDesc.length >= 2) ? sortedDesc[1] : sortedDesc[0];

      const wkts = [], names = [], symbols = [], tooltips = [];

      // צביעה רגילה (ירוק→אדום)
      for(let i = 0; i < normalRows.length; i++){
        const r = normalRows[i];
        const [rr, gg, bb] = rateToColor(r.value, minV, maxV);

        wkts.push(r.wkt);
        const uniqueName = `${CHORO_NAME}_${i}`;
        names.push(uniqueName);

        symbols.push({
          fillColor: [rr, gg, bb, 0.55],
          outlineColor: [25, 25, 25, 0.85],
          outlineWidth: 2
        });

        const tip =  (currentMetric === "rate") ? `${r.name} • ל-10,000: ${fmtMaybe(r.rate)} • כמות: ${Number(r.total || 0).toLocaleString()}` : `${r.name} • כמות: ${Number(r.total || 0).toLocaleString()}`;
        tooltips.push(tip);
      }

      // "ללא שיפוט" → אפור
      const base = normalRows.length;
      for(let i = 0; i < noJurRows.length; i++){
        const r = noJurRows[i];

        wkts.push(r.wkt);
        names.push(`${CHORO_NAME}_nojur_${i}`);

        symbols.push({
          fillColor: [140, 140, 140, 0.65],
          outlineColor: [25, 25, 25, 0.85],
          outlineWidth: 2
        });

        tooltips.push(`${r.name} (ללא שיפוט)`);
      }

   try {
        const payload = {
          wkts,
          names,
          geometryType: (govmap.geometryType?.POLYGON ?? govmap.geometryType?.Polygon ?? 3),
          clearExisting: true,
          showBubble: false,
          symbols,
          data: { tooltips },
          allowIdentify: false  // ✅ השורה החדשה
        };

        const ret = govmap.displayGeometries(payload);
        if (ret && typeof ret.then === "function") await ret;

        activeChoroplethNames = names;
        setMunicipalLayerOpacity(30);  // ✅ שונה מ-0 ל-30
      } catch (e) {
        console.error("displayGeometries failed:", e);
        setMunicipalLayerOpacity(100);
        showInfo("שגיאה", `נכשלתי לצייר גיאומטריות: ${escapeHtml(e?.message || e)}`, "error");
        return;
      }

      let extra = "";
      if (missingGeom.length) {
        extra = `<br><span style="font-size:13px;opacity:.9;">לא נמצאה גיאומטריה ל-${missingGeom.length} רשויות (פערי שמות בין הנתונים לגבולות).</span>`;
        console.log("Missing geometry for:", missingGeom);
      }

      const noj = noJurRows.length ? `<br><span style="font-size:13px;opacity:.9;">"ללא שיפוט" צבוע באפור.</span>` : "";

      showInfo(
        (currentMetric === "rate") ? "צביעה לפי ל-10,000" : "צביעה לפי כמות",
        `ירוק = נמוך • כתום = בינוני • אדום = גבוה (מוגבל למקום 2)<br>טווח: <b>${minV.toLocaleString()}</b> עד <b>${maxV.toLocaleString()}</b>${noj}${extra}`,
        "info"
      );
    }

    // -------------------- GovMap init --------------------
    function initGovMap() {
      if (!window.crimeByYear || typeof window.crimeByYear !== "object") {
        showInfo("שגיאה", "לא ניתן לטעון את קובץ הנתונים crimeByYear_2020_2025.js", "error");
        const l = document.getElementById("loading");
        if (l) l.style.display = "none";
        return;
      }
      if (!window.crimeByYearMerhav) console.warn("⚠️ crimeByYearMerhav.js לא נטען");

      buildPopulationIndex();
      updateMetricButtonsUI();

      const years = Object.keys(window.crimeByYear).sort();
      const sel = document.getElementById("yearSelect");
      if (!sel) return;
      sel.innerHTML = "";

      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        sel.appendChild(opt);
      });

      currentYear = years.includes("2025") ? "2025" : years[years.length - 1];
      sel.value = currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      buildStationIndexForYear(currentYear);
updateQuickStats();

      sel.addEventListener("change", e => {
        currentYear = e.target.value;

        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        buildStationIndexForYear(currentYear);
        updateQuickStats();

        if (choroplethEnabled && currentMode === "muni") renderChoropleth();

        // אם כבר נבחרה ישות – רענון אוטומטי לשנה החדשה
        if (selectedCityKey) {
          const index = getIndexByMode(currentMode);
          const entry = index[selectedCityKey];
          if (entry) {
            selectedCity = entry.name;

            if (currentTab === "single") { showEntry(entry); return; }
            if (currentTab === "trends") { showTrends(selectedCity, currentMode); return; }
          }
        }

        if (currentTab === "compare") updateCompareView();
        else if (currentTab === "rankings") renderRankings();
        else if (currentTab === "trends") {
          const tc = document.getElementById("trends-content");
          if (tc) tc.innerHTML = `<div class="message message-info">בחר ${getEntityLabel(currentMode)} במפה כדי לראות נתונים היסטוריים</div>`;
        } else {
          showInfo(
            "מפה לפי " + getModeLabel(currentMode),
            `שנה נבחרת: ${currentYear}<br>לחץ על ${getEntityLabel(currentMode)} במפה כדי לראות נתונים`,
            "info"
          );
        }
      });

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER, POLICE_STATION_LAYER],
        layersMode: 4,
        background: 3,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [MUNICIPAL_LAYER],
        onLoad: () => {
          mapInitialized = true;

          setMode(currentMode);
          setChoroBtnUI();

          try { govmap.onEvent(govmap.events.CLICK).progress(onMapClick); } catch (e) {}

          initModals();
          initAddressSearchUI();

          const toggleBtn = document.getElementById("panelToggleBtn");
          if (toggleBtn) toggleBtn.addEventListener("click", togglePanel);

          const l = document.getElementById("loading");
          if (l) l.style.display = "none";

          showInfo("מפה לפי ישובים/רשויות", `שנה נבחרת: ${currentYear}<br>לחץ על רשות במפה כדי לראות נתונים`, "info");

          console.log("✅ Map initialized successfully");
        }
      });
    }

    window.initGovMap = initGovMap;
    window.switchTab = switchTab;
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.showTrends = showTrends;
    window.renderRankings = renderRankings;
    window.toggleChoropleth = toggleChoropleth;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:14px;color:#333;font-weight:900;">טוען מפה...</div>
  </div>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>🗺️ מפת פשיעה בישראל</h1>
      <p>מצב נוכחי: <strong>ישובים/רשויות</strong><br>ל-10,000 זמין רק כאן</p>

      <div id="header-actions">
        <button id="searchBtn" class="hbtn">🔎 חיפוש כתובת</button>
        <button id="aboutBtn" class="hbtn secondary">ℹ️ אודות</button>
        <button id="panelToggleBtn" class="hbtn secondary" title="כיווץ/הרחבה">⬍ כיווץ</button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">תצוגה</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')">השוואה</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')">היסטוריה</div>
      <div class="tab" data-tab="rankings" onclick="switchTab('rankings')">דירוגים</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <button id="btnModeMuni" class="mode-btn full primary active" onclick="setMode('muni')">🏘️ ישובים</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">🚔 מרחבים</button>
        <button id="btnModeStation" class="mode-btn" onclick="setMode('station')">🏢 תחנות משטרה</button>

        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')">🔢 כמות</button>
        <button id="btnMetricRate" class="mode-btn" onclick="setMetric('rate')" title="זמין רק במצב ישובים">👥 ל-10,000</button>
        <button id="btnChoro" class="mode-btn full" onclick="toggleChoropleth()">
          🎨 צביעה ל-10,000 (ירוק→אדום)
        </button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">שנה:</label>
        <select id="yearSelect"></select>
      </div>

      <div id="quick-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label" id="stat-entities-label">רשויות</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">סה"כ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">ממוצע</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">טוען נתונים...</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-compare">
        <div id="compare-content">
          <div class="message message-info">בחר ישובים במפה והוסף להשוואה</div>
        </div>
      </div>

      <div class="tab-content" id="tab-trends">
        <div id="trends-content">
          <div class="message message-info">בחר רשות במפה לצפייה בהיסטוריה</div>
        </div>
      </div>

      <div class="tab-content" id="tab-rankings">
        <div id="rankings-content">
          <div class="message message-info">טוען דירוגים...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="searchModal" class="modal" aria-hidden="true">
    <div id="searchOverlay" class="modalOverlay"></div>
    <div class="modalCard" role="dialog">
      <div class="modalHeader">
        <div class="modalHeaderTitle">🔎 חיפוש כתובת</div>
        <button id="searchCloseBtn" class="modalClose">×</button>
      </div>
      <div class="modalBody">
        <div style="display:flex; gap:8px;">
          <input id="addrInput" type="text" placeholder="לדוגמה: דיזנגוף 50 תל אביב" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ccc;">
          <button id="addrBtn" style="padding:10px 14px; background:#0066cc; color:white; border:none; border-radius:8px; cursor:pointer;">חפש</button>
        </div>
        <div id="addrResults"></div>
      </div>
    </div>
  </div>

  <div id="aboutModal" class="modal" aria-hidden="true">
    <div id="aboutOverlay" class="modalOverlay"></div>
    <div class="modalCard" role="dialog">
      <div class="modalHeader">
        <div class="modalHeaderTitle">ℹ️ אודות + מקורות</div>
        <button id="aboutCloseBtn" class="modalClose">×</button>
      </div>
      <div class="modalBody">
        <p>מפת פשיעה אינטראקטיבית המבוססת על נתוני משטרת ישראל.</p>
        <ul>
            <li><strong>נתוני פשיעה:</strong> מעובדים ממאגרי מידע משטרתיים (2020-2025).</li>
            <li><strong>אוכלוסייה:</strong> נתוני למ"ס (2019) לחישוב יחס ל-10,000 נפש.</li>
        </ul>
        <p>פותח כשירות לציבור להנגשת מידע.</p>
      </div>
    </div>
  </div>

</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×’×¨×¡×” ××ª×•×§× ×ª (×¦×‘×™×¢×”)</title>

  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <style>
    /* ---------------- CSS ××œ× ---------------- */
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; overflow: hidden; background: #f5f5f5; }
    #map { width: 100%; height: 100%; position: relative; }
    .esri-layer-list, .esri-legend { display: none !important; }
    
    #info-panel {
      position: absolute; top: 15px; left: 15px; z-index: 9999;
      background: white; padding: 0; border-radius: 8px; width: 450px;
      max-height: calc(100vh - 30px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 14px; overflow: hidden; display: flex; flex-direction: column;
    }
    #panel-header { background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; padding: 16px 20px; border-bottom: 1px solid #0052a3; }
    #panel-header h1 { margin: 0; font-size: 18px; font-weight: 600; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.92; line-height: 1.35; }

    #tabs { display: flex; background: #fafafa; border-bottom: 2px solid #e0e0e0; }
    .tab { flex: 1; padding: 12px 10px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s ease; font-size: 13px; font-weight: 600; color: #666; user-select: none; }
    .tab:hover { background: #f0f0f0; color: #333; }
    .tab.active { background: white; border-bottom-color: #0066cc; color: #0066cc; }

    #controls { padding: 16px 20px; background: #fafafa; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
    #controls-row { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; }
    #controls label { font-weight: 600; font-size: 13px; color: #333; white-space: nowrap; min-width: 70px; }
    
    #yearSelect { flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #ccc; font-size: 13px; background: white; cursor: pointer; transition: all 0.2s; }
    #yearSelect:hover { border-color: #0066cc; }
    #yearSelect:focus { outline: none; border-color: #0066cc; box-shadow: 0 0 0 3px rgba(0,102,204,0.1); }

    .mode-switch { display: flex; gap: 8px; margin-bottom: 12px; }
    .mode-btn { flex: 1; padding: 10px 12px; border-radius: 6px; border: 2px solid #ddd; background: white; cursor: pointer; font-size: 13px; font-weight: 800; color: #555; transition: all 0.2s ease; user-select: none; }
    .mode-btn:hover { border-color: #0066cc; color: #0066cc; transform: translateY(-1px); }
    .mode-btn.active { background: #0066cc; border-color: #0066cc; color: white; box-shadow: 0 2px 6px rgba(0,102,204,0.3); }
    .mode-btn.disabled { opacity: 0.5; cursor: not-allowed !important; transform: none !important; box-shadow: none !important; border-color: #ddd !important; color: #666 !important; background: #fff !important; pointer-events: none; }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .stat-card { background: white; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e0e0e0; transition: all 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .stat-value { font-size: 20px; font-weight: 900; color: #0066cc; margin-bottom: 4px; }
    .stat-label { font-size: 10px; color: #777; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }

    #info-content { padding: 20px; overflow-y: auto; flex: 1; min-height: 0; background: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title { font-weight: 900; font-size: 16px; margin-bottom: 16px; color: #222; padding-bottom: 10px; border-bottom: 3px solid #0066cc; }
    #info-body { line-height: 1.6; color: #555; }

    .total-summary { font-size: 28px; font-weight: 900; color: #0066cc; margin: 16px 0 12px 0; text-align: center; padding: 18px; background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%); border-radius: 8px; border: 2px solid #b3d9ff; box-shadow: 0 2px 6px rgba(0,102,204,0.1); }
    .sub-summary { margin-top: 0; margin-bottom: 16px; text-align: center; font-size: 13px; color: #444; }
    .crime-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 12px; }
    .crime-item { background: #fafafa; padding: 14px; border-radius: 8px; border: 1px solid #e0e0e0; border-right: 4px solid #0066cc; transition: all 0.2s ease; display: flex; flex-direction: column; gap: 6px; }
    .crime-item:hover { background: #f0f7ff; border-right-color: #0052a3; transform: translateX(-3px); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
    .crime-name { font-weight: 700; color: #333; font-size: 12px; line-height: 1.4; min-height: 34px; display: flex; align-items: center; }
    .crime-count { font-weight: 900; color: #0066cc; font-size: 16px; }

    .message { padding: 14px 16px; border-radius: 6px; margin-bottom: 12px; font-size: 13px; border-right: 4px solid; line-height: 1.5; }
    .message-info { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }
    .message-warn { background: #fff7e6; color: #7a4a00; border-right-color: #ffb300; }
    .message-error { background: #fff0f0; color: #c00; border-right-color: #ff0000; }

    #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 10000; text-align: center; }
    .spinner { width: 40px; height: 40px; margin: 0 auto 16px; border: 4px solid #e0e0e0; border-top: 4px solid #0066cc; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .compare-city-tag { background: #e7f3ff; color: #0066cc; padding: 8px 14px; border-radius: 6px; border: 1px solid #b3d9ff; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 800; }
    .compare-city-tag button { border: none; background: none; color: #0066cc; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .compare-city-tag button:hover { background: #0066cc; color: white; }
    .add-compare-btn { width: 100%; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 800; cursor: pointer; transition: all 0.2s; margin-bottom: 16px; }
    .add-compare-btn:hover { background: #0052a3; }

    .compare-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; }
    .compare-card { border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .compare-card-title { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .compare-name { font-weight: 900; color: #222; font-size: 14px; max-width: 310px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .compare-badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge { font-size: 11px; font-weight: 900; padding: 6px 10px; border-radius: 999px; border: 1px solid #e0e0e0; background: #fafafa; color: #333; }
    .badge-warn { border-color: #ffcc80; background: #fff7e6; color: #7a4a00; }
    .compare-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
    .kpi { border: 1px solid #eee; background: #fafafa; border-radius: 8px; padding: 10px; text-align: center; }
    .kpi .kpi-value { font-weight: 900; color: #0066cc; font-size: 14px; margin-bottom: 4px; }
    .kpi .kpi-label { font-size: 10px; font-weight: 900; color: #666; text-transform: uppercase; letter-spacing: .4px; }
    .compare-bars-title { margin-top: 12px; font-weight: 900; font-size: 14px; color: #222; }
    .compare-bar { display: flex; align-items: center; gap: 12px; margin: 10px 0; padding: 10px; background: #fafafa; border-radius: 6px; border: 1px solid #e0e0e0; }
    .compare-bar-name { width: 130px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; font-weight: 800; color: #333; }
    .compare-bar-container { flex: 1; height: 28px; background: #f0f0f0; border-radius: 6px; overflow: hidden; position: relative; }
    .compare-bar-fill { height: 100%; background: linear-gradient(90deg, #0066cc 0%, #0080ff 100%); color: white; display: flex; align-items: center; justify-content: flex-end; padding: 0 10px; font-size: 12px; font-weight: 900; transition: width 0.5s ease; white-space: nowrap; min-width: 40px; }

    #aboutModal { display:none; position:fixed; inset:0; z-index:20000; }
    #aboutOverlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }

    .rank-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .rank-controls select { padding: 10px 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 13px; background: #fff; }
    .rank-controls .full { grid-column: 1 / -1; }
    .rank-list { display: grid; gap: 10px; }
    .rank-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 12px; border: 1px solid #e6e6e6; background: #fafafa; border-radius: 10px; }
    .rank-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .rank-num { width: 32px; height: 32px; border-radius: 10px; display: inline-flex; align-items: center; justify-content: center; background: #e7f3ff; color: #0066cc; font-weight: 900; flex: 0 0 auto; }
    .rank-name { font-weight: 900; color: #222; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
    .rank-right { font-weight: 900; color: #0066cc; white-space: nowrap; }
    .rank-sub { font-size: 12px; color: #666; margin-top: 6px; }

    #choropleth-legend { margin-top: 10px; padding: 10px 12px; border-radius: 10px; background: #fff; border: 1px solid #e0e0e0; }
    .legend-title { font-size: 12px; font-weight: 900; color: #333; margin-bottom: 8px; display:flex; justify-content:space-between; gap:10px; align-items:center; }
    .legend-bar { height: 10px; border-radius: 999px; background: linear-gradient(90deg, rgba(255,0,0,0.12), rgba(255,0,0,0.55)); border: 1px solid rgba(200,0,0,0.25); }
    .legend-range { display:flex; justify-content:space-between; font-size: 11px; color:#666; margin-top: 6px; font-weight: 800; }
    #paintStatus { margin-top: 8px; font-size: 12px; color: #666; }

    @media (max-width: 768px) {
      #info-panel { width: calc(100% - 30px); left: 15px; right: 15px; max-height: calc(100vh - 100px); }
      #quick-stats { grid-template-columns: repeat(2, 1fr); }
      .crime-grid { grid-template-columns: 1fr; }
      #panel-header h1 { font-size: 16px; }
      .compare-kpis { grid-template-columns: 1fr; }
      .rank-controls { grid-template-columns: 1fr; }
    }
  </style>

  <script>
    // --- Configuration ---
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    // --- State ---
    let mapInitialized = false;
    let currentYear = "2025";
    let currentTab = "single";
    let currentMode = "muni";   // muni | merhav
    let currentMetric = "abs";  // abs | rate
    
    // Selection
    let selectedCity = null; 
    let selectedCityKey = null; // Normalized key
    let compareList = [];

    // --- Optimized Data Stores ---
    const DataStore = {
        muni: new Map(),   // Key (norm) -> { name, history: { 2020: data, 2021: data... } }
        merhav: new Map(), // Key (norm) -> { name, history: { ... } }
        pop: new Map()     // Key (norm) -> number
    };
    
    // Cache for normalization
    const NormCache = new Map();

    // Rankings State
    let rankingMetric = "total"; // total | type | rate
    let rankingCrimeType = "";
    let rankingTopN = 10;

    // Choropleth State
    let choroplethAllNames = [];
    let choroplethCancelToken = 0;
    let layer125EntitiesCache = null;
    let yearRateMin = 0;
    let yearRateMax = 0;


    // -------------------- 1. Efficient Normalization --------------------
    function normalizeKey(name) {
        if (!name) return "";
        if (NormCache.has(name)) return NormCache.get(name);

        let s = String(name).trim()
            .replace(/[×³×´"']/g, "")
            .replace(/[(){}\[\],.:]/g, "")
            .replace(/Ö¾/g, "-")
            .replace(/\s+/g, " ")
            .trim();
        s = s.replace(/[\s\-]/g, "").toLowerCase();
        
        NormCache.set(name, s);
        return s;
    }

    function getNormVariants(name) {
        if (!name) return [];
        const raw = String(name).trim();
        const normRaw = normalizeKey(raw);
        
        const prefixes = ["×¢×™×¨×™×™×ª", "×¢×™×¨×™×”", "××•×¢×¦×” ××§×•××™×ª", "××•×¢×¦×” ××–×•×¨×™×ª"];
        let base = raw;
        for(let p of prefixes) {
             if (base.startsWith(p)) {
                 base = base.replace(p, "").trim();
                 break;
             }
        }
        const normBase = normalizeKey(base);
        return normRaw === normBase ? [normRaw] : [normRaw, normBase];
    }

    // -------------------- 2. One-Time Data Indexing --------------------
    function initDataIndex() {
        console.time("Indexing");

        if (window.PopulationDB) {
            for (const [name, pop] of Object.entries(window.PopulationDB)) {
                if (!Number.isFinite(Number(pop))) continue;
                const variants = getNormVariants(name);
                variants.forEach(v => DataStore.pop.set(v, Number(pop)));
            }
        }

        if (window.crimeByYear) {
            for (const [year, cities] of Object.entries(window.crimeByYear)) {
                for (const [name, data] of Object.entries(cities)) {
                    const variants = getNormVariants(name);
                    variants.forEach(k => {
                        if (!DataStore.muni.has(k)) {
                            DataStore.muni.set(k, { name: name, history: {} });
                        }
                        DataStore.muni.get(k).history[year] = data;
                    });
                }
            }
        }

        if (window.crimeByYearMerhav) {
            for (const [year, districts] of Object.entries(window.crimeByYearMerhav)) {
                for (const [name, data] of Object.entries(districts)) {
                    const k = normalizeKey(name);
                    if (!DataStore.merhav.has(k)) {
                        DataStore.merhav.set(k, { name: name, history: {} });
                    }
                    DataStore.merhav.get(k).history[year] = data;
                }
            }
        }
        console.timeEnd("Indexing");
        console.log(`Indexed ${DataStore.muni.size} muni, ${DataStore.merhav.size} merhav, ${DataStore.pop.size} pop.`);
    }

    // -------------------- 3. Data Retrieval Helpers --------------------
    function getEntry(name, mode = currentMode) {
        const key = normalizeKey(name);
        const store = mode === 'muni' ? DataStore.muni : DataStore.merhav;
        
        if (store.has(key)) return store.get(key);
        
        if (mode === 'muni') {
            const variants = getNormVariants(name);
            for(let v of variants) {
                if (store.has(v)) return store.get(v);
            }
        }
        return null;
    }

    function getPop(name) {
        const key = normalizeKey(name);
        if (DataStore.pop.has(key)) return DataStore.pop.get(key);
        const variants = getNormVariants(name);
        for(let v of variants) {
            if (DataStore.pop.has(v)) return DataStore.pop.get(v);
        }
        return null;
    }

    function calcRate(total, pop) {
        if (!pop || pop <= 0 || !Number.isFinite(total)) return null;
        return Math.round((total / pop) * 10000 * 10) / 10;
    }

    // -------------------- 4. Logic & Stats --------------------
    function updateQuickStats() {
        const stats = { municipalities: 0, total: 0, avg: 0 };
        const dataSrc = window.crimeByYear?.[currentYear];
        
        if (dataSrc) {
            let total = 0, count = 0;
            for (const key in dataSrc) {
                if (dataSrc[key]?.total) {
                    total += dataSrc[key].total;
                    count++;
                }
            }
            stats.municipalities = count;
            stats.total = total;
            stats.avg = count > 0 ? Math.round(total / count) : 0;
        }

        const elM = document.getElementById("stat-municipalities");
        const elT = document.getElementById("stat-total");
        const elA = document.getElementById("stat-avg");
        if(elM) elM.textContent = stats.municipalities.toLocaleString();
        if(elT) elT.textContent = stats.total.toLocaleString();
        if(elA) elA.textContent = stats.avg.toLocaleString();
    }

    function computeYearRateRange() {
        yearRateMin = 0; yearRateMax = 0;
        const yearData = window.crimeByYear?.[currentYear];
        if (!yearData) return;

        let min = Infinity, max = -Infinity;
        for (const [name, data] of Object.entries(yearData)) {
            const pop = getPop(name);
            const rate = calcRate(data.total, pop);
            if (rate !== null) {
                if (rate < min) min = rate;
                if (rate > max) max = rate;
            }
        }
        
        if (Number.isFinite(min) && Number.isFinite(max)) {
            yearRateMin = Math.floor(min);
            yearRateMax = Math.ceil(max);
            if (yearRateMax <= yearRateMin) yearRateMax = yearRateMin + 1;
        }
        updateLegendUI();
    }

    function updateLegendUI() {
        const minEl = document.getElementById("legendMin");
        const maxEl = document.getElementById("legendMax");
        const yearEl = document.getElementById("legendYear");
        if (minEl) minEl.textContent = yearRateMin.toLocaleString();
        if (maxEl) maxEl.textContent = yearRateMax.toLocaleString();
        if (yearEl) yearEl.textContent = currentYear;
    }

    // -------------------- 5. UI Renderers --------------------
    function showInfo(title, body, type="info") {
        const t = document.getElementById("info-title");
        const b = document.getElementById("info-body");
        if (t) t.textContent = title;
        if (b) b.innerHTML = `<div class="message message-${type}">${body}</div>`;
    }

    function showEntry(entry) {
        if (!entry) return;
        const d = entry.history[currentYear];
        if (!d) {
            showInfo(entry.name, `××™×Ÿ × ×ª×•× ×™× ×œ×©× ×ª ${currentYear}`, "warn");
            return;
        }

        const pop = (currentMode === 'muni') ? getPop(entry.name) : null;
        let html = "";
        
        if (currentMetric === 'rate' && currentMode === 'muni') {
            const rate = calcRate(d.total, pop);
            if (rate === null) {
                html += `<div class="total-summary">${d.total.toLocaleString()} ××™×¨×•×¢×™×</div>`;
                html += `<div class="message message-warn">××™×Ÿ × ×ª×•×Ÿ ××•×›×œ×•×¡×™×™×” (××• ××™×Ÿ ×”×ª×××” ×‘×©×), ×œ× × ×™×ª×Ÿ ×œ×—×©×‘ ×œ-10,000.</div>`;
            } else {
                html += `<div class="total-summary">${rate.toLocaleString()} ×œ-10,000</div>`;
                html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×”: ${pop.toLocaleString()} â€¢ ×¡×”"×›: ${d.total.toLocaleString()}</div>`;
            }
        } else {
            html += `<div class="total-summary">${d.total.toLocaleString()} ××™×¨×•×¢×™×</div>`;
            if (currentMode === 'muni') {
                html += `<div class="sub-summary">××•×›×œ×•×¡×™×™×”: ${pop ? pop.toLocaleString() : "×œ× × ××¦×"}</div>`;
            }
        }

        if (d.breakdown) {
            const sorted = Object.entries(d.breakdown).sort((a,b) => b[1] - a[1]);
            html += `<div class="crime-grid">`;
            html += sorted.map(([k, v]) => `
                <div class="crime-item">
                    <div class="crime-name">${k}</div>
                    <div class="crime-count">${v.toLocaleString()}</div>
                </div>
            `).join('');
            html += `</div>`;
        }

        document.getElementById("info-title").textContent = entry.name;
        document.getElementById("info-body").innerHTML = html;
    }

    function renderRankings() {
        const container = document.getElementById("rankings-content");
        if (!container) return;

        const isMerhav = currentMode === 'merhav';
        const sourceData = isMerhav ? window.crimeByYearMerhav?.[currentYear] : window.crimeByYear?.[currentYear];

        if (!sourceData) {
            container.innerHTML = `<div class="message message-warn">××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×–×•</div>`;
            return;
        }

        const allTypes = new Set();
        Object.values(sourceData).forEach(d => {
            if (d.breakdown) Object.keys(d.breakdown).forEach(t => allTypes.add(t));
        });
        const typesArr = Array.from(allTypes).sort();

        if (rankingMetric === 'type' && !typesArr.includes(rankingCrimeType)) rankingCrimeType = typesArr[0] || "";

        let rows = [];
        for (const [name, d] of Object.entries(sourceData)) {
            let val = 0;
            let extra = null;

            if (rankingMetric === 'total') val = d.total || 0;
            else if (rankingMetric === 'type') val = d.breakdown?.[rankingCrimeType] || 0;
            else if (rankingMetric === 'rate' && !isMerhav) {
                const pop = getPop(name);
                const rate = calcRate(d.total, pop);
                if (rate !== null) {
                    val = rate;
                    extra = { pop, total: d.total };
                } else {
                    continue;
                }
            }
            rows.push({ name, value: val, extra });
        }

        rows.sort((a,b) => b.value - a.value);
        const top = rows.slice(0, rankingTopN);

        const metricOpts = isMerhav 
            ? `<option value="total">×¡×”×´×›</option><option value="type">×¡×•×’ ×¢×‘×™×¨×”</option>`
            : `<option value="total">×¡×”×´×›</option><option value="type">×¡×•×’ ×¢×‘×™×¨×”</option><option value="rate">×œ-10,000</option>`;
        
        let html = `
            <div class="rank-controls">
                <select id="rankMetricSelect">${metricOpts}</select>
                <select id="rankTopNSelect">
                    <option value="5">Top 5</option>
                    <option value="10">Top 10</option>
                    <option value="20">Top 20</option>
                </select>
                <select id="rankCrimeTypeSelect" class="full" ${rankingMetric !== 'type' ? 'disabled' : ''}>
                    ${typesArr.map(t => `<option value="${t}">${t}</option>`).join('')}
                </select>
            </div>
        `;

        html += `<div class="rank-list">`;
        top.forEach((r, idx) => {
            let sub = "";
            if (rankingMetric === 'rate' && r.extra) {
                sub = `<div class="rank-sub">××•×›×œ×•×¡×™×™×”: ${r.extra.pop.toLocaleString()} â€¢ ×¡×”"×›: ${r.extra.total.toLocaleString()}</div>`;
            }
            const valStr = rankingMetric === 'rate' ? `${r.value.toLocaleString()} /10k` : r.value.toLocaleString();
            
            html += `
                <div class="rank-item">
                    <div class="rank-left">
                        <div class="rank-num">${idx+1}</div>
                        <div style="min-width:0;">
                            <div class="rank-name" title="${r.name}">${r.name}</div>
                            ${sub}
                        </div>
                    </div>
                    <div class="rank-right">${valStr}</div>
                </div>
            `;
        });
        html += `</div>`;
        container.innerHTML = html;

        document.getElementById("rankMetricSelect").value = rankingMetric;
        document.getElementById("rankTopNSelect").value = rankingTopN;
        document.getElementById("rankCrimeTypeSelect").value = rankingCrimeType;

        document.getElementById("rankMetricSelect").onchange = (e) => { rankingMetric = e.target.value; renderRankings(); };
        document.getElementById("rankTopNSelect").onchange = (e) => { rankingTopN = parseInt(e.target.value); renderRankings(); };
        document.getElementById("rankCrimeTypeSelect").onchange = (e) => { rankingCrimeType = e.target.value; renderRankings(); };
    }

    function showTrends(name) {
        const container = document.getElementById("trends-content");
        if (!name || !container) {
            if(container) container.innerHTML = `<div class="message message-info">×‘×—×¨ ×™×©×•×‘ ×œ×”×¦×’×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>`;
            return;
        }

        const entry = getEntry(name, 'muni');
        if (!entry) {
             container.innerHTML = `<div class="message message-info">××™×Ÿ ××™×“×¢ ×”×™×¡×˜×•×¨×™ ×¢×‘×•×¨ ${name}</div>`;
             return;
        }

        const years = ["2020", "2021", "2022", "2023", "2024", "2025"];
        const series = [];
        const pop = getPop(entry.name);

        let maxVal = 0;
        years.forEach(y => {
            const d = entry.history[y];
            let val = 0;
            let label = "0";
            
            if (d) {
                if (currentMetric === 'rate') {
                    const r = calcRate(d.total, pop);
                    if (r !== null) { val = r; label = r.toLocaleString() + " /10k"; }
                    else { label = "××™×Ÿ ××•×›×œ×•×¡×™×™×”"; }
                } else {
                    val = d.total;
                    label = val.toLocaleString();
                }
            }
            if (val > maxVal) maxVal = val;
            series.push({ year: y, value: val, label: label, hasData: !!d });
        });

        if(maxVal === 0) maxVal = 1;

        let html = `<h3 style="margin:0 0 16px 0;">${entry.name} - ××’××•×ª</h3>`;
        if (currentMetric === 'rate' && !pop) {
             html += `<div class="message message-warn">××™×Ÿ × ×ª×•× ×™ ××•×›×œ×•×¡×™×™×”, ×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ×’×¨×£ ×œ-10,000.</div>`;
        }

        series.forEach(item => {
            const width = (item.value / maxVal) * 100;
            html += `
                <div class="compare-bar">
                    <div class="compare-bar-name">${item.year}</div>
                    <div class="compare-bar-container">
                        <div class="compare-bar-fill" style="width:${width}%">${item.label}</div>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    // -------------------- 6. Compare System --------------------
    function addToCompare() {
        if (!selectedCity) { alert("×‘×—×¨ ××–×•×¨ ×‘××¤×” ×§×•×“×"); return; }
        if (!compareList.some(c => c.key === selectedCityKey && c.mode === currentMode)) {
            compareList.push({ name: selectedCity, key: selectedCityKey, mode: currentMode });
            updateCompareView();
        }
    }
    function removeFromCompare(key) {
        compareList = compareList.filter(c => c.key !== key);
        updateCompareView();
    }
    function updateCompareView() {
        const container = document.getElementById("compare-content");
        if (!container) return;
        
        const relevant = compareList.filter(c => c.mode === currentMode);
        
        let html = `<button class="add-compare-btn" onclick="addToCompare()">â• ×”×•×¡×£ ${selectedCity || "××ª ×”×‘×—×™×¨×”"} ×œ×”×©×•×•××”</button>`;
        
        if (relevant.length > 0) {
            html += `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">`;
            relevant.forEach(c => {
                html += `<div class="compare-city-tag">${c.name}<button onclick="removeFromCompare('${c.key}')">Ã—</button></div>`;
            });
            html += `</div>`;
        }
        
        if (relevant.length < 2) {
             html += `<div class="message message-info">×‘×—×¨ ×œ×¤×—×•×ª 2 ××–×•×¨×™× ×œ×”×©×•×•××”</div>`;
             container.innerHTML = html;
             return;
        }

        html += `<div class="compare-grid">`;
        const dataRows = relevant.map(item => {
             const entry = getEntry(item.name, item.mode);
             const d = entry?.history[currentYear];
             const total = d?.total || 0;
             const pop = currentMode==='muni' ? getPop(item.name) : null;
             const rate = calcRate(total, pop);
             return { name: item.name, total, pop, rate };
        });

        const isRate = (currentMode === 'muni' && currentMetric === 'rate');
        const vals = dataRows.map(r => isRate ? (r.rate||0) : r.total);
        const max = Math.max(...vals, 1);

        dataRows.forEach(r => {
             const valToShow = isRate ? (r.rate ? r.rate.toLocaleString() : "N/A") : r.total.toLocaleString();
             const label = isRate ? "×œ-10,000" : "×›××•×ª";
             
             html += `
             <div class="compare-card">
                <div class="compare-card-title"><div class="compare-name">${r.name}</div></div>
                <div class="compare-kpis">
                    <div class="kpi"><div class="kpi-value">${r.total.toLocaleString()}</div><div class="kpi-label">×›××•×ª</div></div>
                    <div class="kpi"><div class="kpi-value">${r.pop ? r.pop.toLocaleString() : "-"}</div><div class="kpi-label">××•×›×œ×•×¡×™×™×”</div></div>
                    <div class="kpi"><div class="kpi-value">${valToShow}</div><div class="kpi-label">${label}</div></div>
                </div>
             </div>`;
        });
        html += `</div>`;
        
        html += `<div class="compare-bars-title">×”×©×•×•××” ×’×¨×¤×™×ª</div>`;
        dataRows.sort((a,b) => (isRate ? (b.rate||0)-(a.rate||0) : b.total - a.total));
        dataRows.forEach(r => {
             const val = isRate ? (r.rate||0) : r.total;
             const pct = (val / max) * 100;
             const txt = isRate ? (r.rate ? r.rate + "/10k" : "N/A") : r.total.toLocaleString();
             html += `
                <div class="compare-bar">
                    <div class="compare-bar-name">${r.name}</div>
                    <div class="compare-bar-container"><div class="compare-bar-fill" style="width:${pct}%">${txt}</div></div>
                </div>
             `;
        });

        container.innerHTML = html;
    }


    // -------------------- 7. Map & Choropleth Logic --------------------

    async function onMapClick(e) {
        if (!mapInitialized) return;
        const layerName = currentMode === 'muni' ? MUNICIPAL_LAYER : POLICE_MERHAV_LAYER;
        
        try {
            const resp = await govmap.getLayerData({ LayerName: layerName, Point: e.mapPoint, Radius: 200 });
            const item = resp?.data?.[0] || resp?.Data?.[0];
            if (!item) return;

            const attrs = {};
            (item.Fields || item.Attributes || []).forEach(f => attrs[f.FieldName] = f.Value);
            
            const nameCandidates = ["×©×_×™×©×•×‘", "×©× ×™×©×•×‘", "×©× ×¨×©×•×ª", "NAME", "Shem_Yishuv", "×©× ××¨×—×‘", "SHEM_MERHAV"];
            let rawName = null;
            for(let c of nameCandidates) {
                if (attrs[c]) { rawName = attrs[c]; break; }
            }

            if (!rawName) {
                 for(let k in attrs) {
                     if (k.includes("×©×") || k.includes("NAME")) { rawName = attrs[k]; break; }
                 }
            }

            if (rawName) {
                const entry = getEntry(rawName);
                if (entry) {
                    selectedCity = entry.name;
                    selectedCityKey = normalizeKey(entry.name);
                    
                    if (currentTab === 'compare') updateCompareView();
                    else if (currentTab === 'trends') showTrends(selectedCity);
                    else if (currentTab === 'rankings') renderRankings();
                    else showEntry(entry); 
                } else {
                    showInfo("×œ× × ××¦×", `××™×Ÿ × ×ª×•× ×™× ×¢×‘×•×¨ ${rawName}`, "warn");
                }
            }
        } catch(err) { console.error(err); }
    }

    async function fetchLayerEntities() {
        if (layer125EntitiesCache) return layer125EntitiesCache;
        // FIXED: Sending BOTH casing styles to handle API inconsistencies
        const res = await govmap.getLayerEntities({ layerName:'125' });
        layer125EntitiesCache = res.data || res.Data || [];
        return layer125EntitiesCache;
    }

    function setPaintStatus(msg) {
        const el = document.getElementById("paintStatus");
        if (el) el.textContent = msg;
    }

    async function paintAllMunicipalitiesByRate() {
        if (currentMode !== 'muni' || currentMetric !== 'rate') {
            alert("×¦×‘×™×¢×” ×–××™× ×” ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™× ×•×œ×¤×™ ×œ-10,000");
            return;
        }
        
        choroplethCancelToken++;
        const token = choroplethCancelToken;
        
        setPaintStatus("×˜×•×¢×Ÿ ×’××•××˜×¨×™×”...");
        const entities = await fetchLayerEntities();
        
        setPaintStatus(`××—×©×‘ ×¦×‘×¢×™× ×¢×‘×•×¨ ${entities.length} ×™×©×•×‘×™×...`);
        
        const wkts = [], names = [], symbols = [];
        
        for (const ent of entities) {
            const wkt = ent.wkt || ent.WKT || ent.geometryWKT || (ent.geometry || {}).wkt;
            if (!wkt || !wkt.includes("POLYGON")) continue;

            let entName = "";
            const attrs = {};
            (ent.Fields || []).forEach(f => attrs[f.FieldName] = f.Value);
             const nCandidates = ["×©×_×™×©×•×‘", "×©× ×™×©×•×‘", "×©× ×¨×©×•×ª", "NAME", "Shem_Yishuv"];
             for(let c of nCandidates) { if (attrs[c]) { entName = attrs[c]; break; } }
            
            if (!entName) continue;

            const entry = getEntry(entName, 'muni');
            if (!entry) continue;
            
            const pop = getPop(entry.name);
            const total = entry.history[currentYear]?.total || 0;
            const rate = calcRate(total, pop);
            
            if (rate === null) continue;

            const t = (rate - yearRateMin) / (yearRateMax - yearRateMin || 1);
            const alpha = 0.15 + (Math.max(0, Math.min(1, t)) * 0.6); 
            
            wkts.push(wkt);
            names.push(`__paint_${currentYear}_${wkts.length}`);
            symbols.push({
                outlineColor: [200, 0, 0, 0.5],
                outlineWidth: 1,
                fillColor: [255, 0, 0, alpha]
            });
            
            choroplethAllNames.push(names[names.length-1]);
        }
        
        const batchSize = 250;
        const batches = Math.ceil(wkts.length / batchSize);
        
        for (let i = 0; i < batches; i++) {
            if (token !== choroplethCancelToken) { setPaintStatus("×‘×•×˜×œ"); return; }
            
            const start = i * batchSize;
            const end = Math.min(start + batchSize, wkts.length);
            
            setPaintStatus(`×¦×•×‘×¢... ${end} ××ª×•×š ${wkts.length}`);
            
            const data = {
                wkts: wkts.slice(start, end),
                names: names.slice(start, end),
                geometryType: govmap.geometryType.POLYGON,
                symbols: symbols.slice(start, end),
                clearExisting: false,
                data: { tooltips: new Array(end-start).fill(""), bubbles: [], bubbleUrl: "" }
            };
            
            await govmap.displayGeometries(data);
            await new Promise(r => setTimeout(r, 10)); 
        }
        setPaintStatus(`×”×•×©×œ× (${wkts.length} ×™×©×•×‘×™×)`);
    }

    function clearPaint() {
        choroplethCancelToken++;
        
        if (choroplethAllNames.length > 0) {
            const chunk = 500;
            for (let i = 0; i < choroplethAllNames.length; i += chunk) {
                const part = choroplethAllNames.slice(i, i + chunk);
                try {
                    if (govmap.clearGeometriesByName) {
                         govmap.clearGeometriesByName(part);
                    }
                } catch (e) { console.warn("failed to clear chunk", e); }
            }
        }
        
        setPaintStatus("");
        choroplethAllNames = [];
    }

    // -------------------- 8. Global Controls & Init --------------------
    
    function setMode(mode) {
        currentMode = mode;
        document.getElementById("btnModeMuni").classList.toggle("active", mode === 'muni');
        document.getElementById("btnModeMerhav").classList.toggle("active", mode === 'merhav');
        
        if (mapInitialized) {
            const show = mode === 'muni' ? [MUNICIPAL_LAYER] : [POLICE_MERHAV_LAYER];
            const hide = mode === 'muni' ? [POLICE_MERHAV_LAYER] : [MUNICIPAL_LAYER];
            govmap.setVisibleLayers(show, hide);
        }
        
        updateMetricButtonsUI();
        clearPaint();
        
        if (currentTab === 'rankings') renderRankings();
        else if (currentTab === 'compare') updateCompareView();
        else if (currentTab === 'trends') showTrends(selectedCity);
        else if (selectedCity) {
             const e = getEntry(selectedCity);
             if(e) showEntry(e);
        }
    }

    function setMetric(metric) {
        if (metric === 'rate' && currentMode !== 'muni') {
            alert("×œ× ×–××™×Ÿ ×‘××¨×—×‘×™×"); return;
        }
        currentMetric = metric;
        document.getElementById("btnMetricAbs").classList.toggle("active", metric === 'abs');
        document.getElementById("btnMetricRate").classList.toggle("active", metric === 'rate');
        
        clearPaint();
        if (currentTab === 'rankings') renderRankings();
        else if (currentTab === 'compare') updateCompareView();
        else if (currentTab === 'trends') showTrends(selectedCity);
        else if (selectedCity) {
             const e = getEntry(selectedCity);
             if(e) showEntry(e);
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tab}`));
        
        if (tab === 'rankings') renderRankings();
        else if (tab === 'compare') updateCompareView();
        else if (tab === 'trends') showTrends(selectedCity);
        else if (tab === 'single' && selectedCity) {
             const e = getEntry(selectedCity);
             if(e) showEntry(e);
        }
    }

    function updateMetricButtonsUI() {
        const rateBtn = document.getElementById("btnMetricRate");
        if (currentMode === 'merhav') {
            rateBtn.classList.add("disabled");
            if (currentMetric === 'rate') setMetric('abs');
        } else {
            rateBtn.classList.remove("disabled");
        }
    }

    function initGovMap() {
        console.log("ğŸš€ Starting Init...");
        try {
            initDataIndex(); 
            updateQuickStats();
            computeYearRateRange();
            updateLegendUI();

            const years = Object.keys(window.crimeByYear || {}).sort();
            const sel = document.getElementById("yearSelect");
            if(sel) {
                sel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
                sel.value = currentYear;
                sel.onchange = (e) => {
                    currentYear = e.target.value;
                    updateQuickStats();
                    computeYearRateRange();
                    clearPaint();
                    if(currentTab === 'rankings') renderRankings();
                    else if(currentTab === 'compare') updateCompareView();
                    else if(currentTab === 'trends') showTrends(selectedCity);
                    else if(selectedCity) showEntry(getEntry(selectedCity));
                };
            }
        } catch (e) {
            console.error("Data processing error:", e);
            alert("Data Error: " + e.message);
        }

        document.getElementById("btnPaintAll").onclick = paintAllMunicipalitiesByRate;
        document.getElementById("btnClearPaint").onclick = clearPaint;

        // Safety timeout
        const safetyTimer = setTimeout(() => {
            const loader = document.getElementById("loading");
            if (loader && loader.style.display !== "none") {
                console.warn("âš ï¸ Map timeout, forcing hide loader");
                loader.style.display = "none";
            }
        }, 5000);

        try {
            govmap.createMap("map", {
                token: TOKEN,
                layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER],
                layersMode: 4,
                visibleLayers: [MUNICIPAL_LAYER],
                zoomButtons: true,
                identifyOnClick: false,
                center: { x: 180000, y: 650000 },
                zoomLevel: 2, 
                onLoad: () => {
                    clearTimeout(safetyTimer);
                    mapInitialized = true;
                    setMode('muni');
                    govmap.onEvent(govmap.events.CLICK).progress(onMapClick);
                    
                    const loader = document.getElementById("loading");
                    if(loader) loader.style.display = "none";
                    console.log("âœ… Map loaded!");
                }
            });
        } catch (e) {
            clearTimeout(safetyTimer);
            console.error("Map creation error:", e);
            alert("Map Error: " + e.message);
            document.getElementById("loading").style.display = "none";
        }
    }

    // Modal Logic
    function openAbout() { document.getElementById("aboutModal").style.display = "block"; }
    function closeAbout() { document.getElementById("aboutModal").style.display = "none"; }
    window.addEventListener("load", () => {
         document.getElementById("aboutBtn").onclick = openAbout;
         document.getElementById("aboutCloseBtn").onclick = closeAbout;
         document.getElementById("aboutOverlay").onclick = closeAbout;
    });

    // Expose globals
    window.switchTab = switchTab;
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.initGovMap = initGovMap;

  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:15px;color:#333;font-weight:700;">×˜×•×¢×Ÿ ××¤×”...</div>
  </div>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×” ×‘×™×©×¨××œ</h1>
      <p>××¦×‘ × ×•×›×—×™: <strong>×™×©×•×‘×™×/×¨×©×•×™×•×ª</strong><br>×ª×¦×•×’×ª ××•×›×œ×•×¡×™×™×”/×œ-10,000 ×–××™× ×” ×¨×§ ×›××Ÿ</p>
      <div style="margin-top:10px; display:flex; gap:8px;">
        <button id="aboutBtn" style="padding:8px 12px; border-radius:8px; border:1px solid rgba(255,255,255,.35); background: rgba(255,255,255,.15); color:#fff; font-weight:800; cursor:pointer;">â„¹ï¸ ××•×“×•×ª + ××§×•×¨×•×ª</button>
      </div>
    </div>

    <div id="tabs">
      <div class="tab active" data-tab="single" onclick="switchTab('single')">×ª×¦×•×’×”</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')">×”×©×•×•××”</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')">× ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>
      <div class="tab" data-tab="rankings" onclick="switchTab('rankings')">×“×™×¨×•×’×™×</div>
    </div>

    <div id="controls">
      <div class="mode-switch">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')">ğŸ˜ï¸ ××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')">ğŸš” ××¦×‘ ××¨×—×‘×™×</button>
      </div>

      <div class="mode-switch">
        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')">ğŸ”¢ ×›××•×ª</button>
        <button id="btnMetricRate" class="mode-btn" onclick="setMetric('rate')" title="×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×™×©×•×‘×™×/×¨×©×•×™×•×ª">ğŸ‘¥ ×œ-10,000 ×ª×•×©×‘×™×</button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×‘×—×¨ ×©× ×”:</label>
        <select id="yearSelect"></select>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="btnPaintAll" class="mode-btn" style="flex:1;">ğŸ¨ ×¦×‘×™×¢×” ×œ×›×œ ×”××¨×¥ (×œÖ¾10,000)</button>
        <button id="btnClearPaint" class="mode-btn" style="flex:1;">ğŸ§¹ × ×§×” ×¦×‘×™×¢×”</button>
      </div>
      <div id="paintStatus"></div>

      <div id="choropleth-legend">
        <div class="legend-title">
          <span>××§×¨× ×¦×‘×¢×™× (×œÖ¾10,000)</span>
          <span style="font-size:11px; opacity:.9;">×©× ×”: <strong id="legendYear"></strong></span>
        </div>
        <div class="legend-bar"></div>
        <div class="legend-range">
          <span id="legendMin">0</span>
          <span id="legendMax">0</span>
        </div>
      </div>

      <div id="quick-stats" style="margin-top:12px;">
        <div class="stat-card"><div class="stat-value" id="stat-municipalities">-</div><div class="stat-label">×¨×©×•×™×•×ª</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-total">-</div><div class="stat-label">×¡×”"×› ××™×¨×•×¢×™×</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-avg">-</div><div class="stat-label">×××•×¦×¢</div></div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single">
        <div id="info-title">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div id="info-body"></div>
      </div>
      <div class="tab-content" id="tab-compare">
        <div id="compare-content"><div class="message message-info">×‘×—×¨ ×™×©×•×‘×™×/×¨×©×•×™×•×ª ××• ××¨×—×‘×™× ×‘××¤×” ×•×”×•×¡×£ ×œ×”×©×•×•××”</div></div>
      </div>
      <div class="tab-content" id="tab-trends">
        <div id="trends-content"><div class="message message-info">×‘×—×¨ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× </div></div>
      </div>
      <div class="tab-content" id="tab-rankings">
        <div id="rankings-content"><div class="message message-info">×¤×ª×— ××ª ×”×˜××‘ ×›×“×™ ×œ×”×¦×™×’ ×“×™×¨×•×’×™×â€¦</div></div>
      </div>
    </div>
  </div>

  <div id="aboutModal">
    <div id="aboutOverlay"></div>
    <div role="dialog" aria-modal="true" style="position:relative; width:min(720px, calc(100vw - 30px)); max-height: calc(100vh - 30px); margin: 15px auto; background:#fff; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25); overflow:hidden; display:flex; flex-direction:column;">
      <div style="padding:16px 18px; border-bottom:1px solid #e5e5e5; display:flex; align-items:center; justify-content:space-between; gap:12px; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color:#fff;">
        <div><div style="font-weight:900; font-size:16px;">××•×“×•×ª + ××§×•×¨×•×ª × ×ª×•× ×™×</div></div>
        <button id="aboutCloseBtn" style="border:none; background: rgba(255,255,255,.18); color:#fff; width:38px; height:38px; border-radius:10px; cursor:pointer; font-size:20px; font-weight:900;">Ã—</button>
      </div>
      <div style="padding:16px 18px; overflow:auto;">
          <div style="font-size:13px; color:#333;">
            <strong>×”×¢×¨×•×ª ×—×©×•×‘×•×ª:</strong><br>
            â€¢ × ×ª×•× ×™ ××•×›×œ×•×¡×™×™×” (2019) ××©××©×™× ×œ×—×™×©×•×‘×™× ×™×—×¡×™×™× (×œ-10,000 ×ª×•×©×‘×™×).<br>
            â€¢ ×”× ×ª×•× ×™× ×”×’×•×œ××™×™× × ×œ×§×—×• ××××’×¨×™ ××™×“×¢ ××©×˜×¨×ª×™×™×.<br>
            â€¢ ×”×¦×‘×¢×™× ×‘××¤×” (Choropleth) ××—×•×©×‘×™× ×‘×–××Ÿ ×××ª ×œ×¤×™ ×”×›××•×ª ×”×™×—×¡×™×ª ×‘×›×œ ×©× ×”.
          </div>
      </div>
    </div>
  </div>
</body>
</html>

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×¨×©×•×ª / ×ª×—× ×ª ××©×˜×¨×”</title>

  <!-- ×˜×•×¢×Ÿ ××ª ×”×“××˜×”×‘×™×™×¡×™× -->
  <script src="crimeDB.js"></script>
  <script src="policeDB.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #map { width: 100%; height: 100%; }

    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      width: 380px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      font-size: 14px;
    }

    #mode-switch { 
      margin-bottom: 8px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    
    #mode-switch label {
      margin-left: 15px;
      cursor: pointer;
    }
    
    #info-title { font-weight: bold; margin-bottom: 6px; font-size: 16px; }
    #info-body  { white-space: pre-line; max-height: 60vh; overflow-y: auto; }
    
    .debug-info {
      background: #fff3cd;
      padding: 8px;
      margin-top: 8px;
      border-radius: 4px;
      font-size: 11px;
      border: 1px solid #ffc107;
      max-height: 300px;
      overflow-y: auto;
      direction: ltr;
      text-align: left;
    }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 10000;
    }
  </style>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js"></script>

  <script>
    const MUNICIPAL_LAYER = "125";
    const STATION_LAYER   = "24";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let currentMode = "municipality";
    let mapInitialized = false;

    const muniIndex = {};
    const unitIndex = {};
    
    let detectedMunicipalityField = null;
    let detectedStationField = null;

    /* × ×™×¨××•×œ ×¨×©×•×™×•×ª */
    function normalizeMunicipalityKey(name) {
      let s = (name ?? "").toString().trim();
      s = s.replace(/^×¢×™×¨×™×™×ª\s+/g, "")
           .replace(/^×¢×™×¨×™×”\s+/g, "")
           .replace(/^××•×¢×¦×”\s+××–×•×¨×™×ª\s+/g, "")
           .replace(/^××•×¢×¦×”\s+××§×•××™×ª\s+/g, "");
      s = s.replace(/["×³×´']/g, "");
      s = s.replace(/[\s\-]/g, "");
      return s.toLowerCase();
    }

    /* × ×™×¨××•×œ ×ª×—× ×•×ª */
    function normalizeUnitKey(raw) {
      if (!raw) return "";
      
      let s = raw.toString().trim();
      
      console.log("ğŸ” Raw name from map:", s);
      
      // × ×™×§×•×™ unicode
      s = s.normalize("NFKC")
           .replace(/\p{Cf}/gu, "")
           .replace(/\p{Mn}/gu, "");
      
      // ×”×—×œ×¤×ª ×¨×•×•×—×™× ××™×•×—×“×™×
      s = s.replace(/[\u00A0\u2000-\u200B\u202F\u205F\u3000]/g, " ");
      
      // ×”×¡×¨×ª ×§×™×“×•××•×ª
      s = s.replace(/^×ª×—× ×ª\s+××©×˜×¨×”\s+/gi, "")
           .replace(/^×ª×—× ×ª\s+/gi, "")
           .replace(/^××¨×—×‘\s+/gi, "")
           .replace(/^××©×˜×¨×ª\s+/gi, "")
           .trim();
      
      // ×”×¡×¨×ª ×’×¨×©×™×™×, ××§×¤×™×, ×¨×•×•×—×™×
      s = s.replace(/[×´"×³']/g, "")
           .replace(/[â€“â€”\-]/g, "")
           .replace(/\s+/g, "")
           .toLowerCase();
      
      console.log("ğŸ”‘ Normalized key:", s);
      
      return s;
    }

    /* ×‘× ×™×™×ª ××™× ×“×§×¡×™× */
    function buildIndexes() {
      console.log("ğŸ“‹ Building indexes...");
      
      // ×¨×©×•×™×•×ª
      if (typeof crimeDB !== 'undefined') {
        for (const k in crimeDB) {
          muniIndex[normalizeMunicipalityKey(k)] = { name: k, data: crimeDB[k] };
        }
        console.log("âœ… Municipality index:", Object.keys(muniIndex).length, "entries");
      }
      
      // ×ª×—× ×•×ª ××©×˜×¨×”
      if (typeof policeDB !== 'undefined') {
        for (const k in policeDB) {
          if (k === "Grand Total" || k === "(blank)" || k === "×›×œ ×”××¨×¥") continue;
          
          const rawName = k.toString().trim();
          const key = normalizeUnitKey(rawName);
          
          if (!key) continue;
          
          if (!unitIndex[key]) {
            unitIndex[key] = { name: rawName, data: policeDB[k] };
          } else if (Array.isArray(unitIndex[key])) {
            unitIndex[key].push({ name: rawName, data: policeDB[k] });
          } else {
            unitIndex[key] = [unitIndex[key], { name: rawName, data: policeDB[k] }];
          }
        }
        console.log("âœ… Police station index:", Object.keys(unitIndex).length, "entries");
      }
    }

    /* ×”××¨×ª Fields ×-array ×œ××•×‘×™×™×§×˜ */
    function fieldsToObject(fields) {
      if (!Array.isArray(fields)) return fields;
      const o = {};
      for (const f of fields) {
        if (f.FieldName && f.Value !== undefined) {
          o[f.FieldName] = f.Value;
        }
      }
      return o;
    }

    function pickHebrewField(attrs) {
      for (const k in attrs) {
        if (typeof attrs[k] === "string" && /[\u0590-\u05FF]/.test(attrs[k])) {
          return { key: k, value: attrs[k] };
        }
      }
      return null;
    }

    /* ×–×™×”×•×™ ×©× ×¨×©×•×ª */
    function detectMunicipalityName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw);
      
      console.log("ğŸ›ï¸ Municipality attributes:", attrs);
      
      if (detectedMunicipalityField && attrs[detectedMunicipalityField]) {
        return attrs[detectedMunicipalityField];
      }
      
      const candidates = ["×©× ×¨×©×•×ª", "×©× ×¨×©×•×ª ××§×•××™×ª", "×©× ×™×©×•×‘", "×™×©×•×‘ ×¡×•×¤×™", "SHEM_YISHUV"];
      for (const c of candidates) {
        if (attrs[c]) {
          detectedMunicipalityField = c;
          console.log(`âœ… Found municipality field: ${c} = ${attrs[c]}`);
          return attrs[c];
        }
      }
      
      const any = pickHebrewField(attrs);
      if (any) {
        detectedMunicipalityField = any.key;
        return any.value;
      }
      
      return null;
    }

    /* ×–×™×”×•×™ ×©× ×ª×—× ×” */
    function detectStationName(attrsRaw) {
      const attrs = fieldsToObject(attrsRaw);
      
      console.log("ğŸš“ Station attributes:", attrs);
      
      if (detectedStationField && attrs[detectedStationField]) {
        return attrs[detectedStationField];
      }
      
      const candidates = [
        "×©× ×ª×—× ×”", "×©× ×ª×—× ×ª ××©×˜×¨×”", "×©×", 
        "SHEM_TACHANA", "NAME", "Station_Name",
        "×©× ×‘×¢×‘×¨×™×ª", "×ª×—× ×ª ××©×˜×¨×”"
      ];
      
      for (const c of candidates) {
        if (attrs[c]) {
          detectedStationField = c;
          console.log(`âœ… Found station field: ${c} = ${attrs[c]}`);
          return attrs[c];
        }
      }
      
      const any = pickHebrewField(attrs);
      if (any) {
        detectedStationField = any.key;
        console.log(`âœ… Found Hebrew field: ${any.key} = ${any.value}`);
        return any.value;
      }
      
      return null;
    }

    /* UI */
    function showInfo(title, body) {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").innerHTML = body;
    }

    function showEntry(label, entry) {
      const lines = [];
      const d = entry.data;

      if (d.total !== undefined) {
        lines.push(`<strong>×¡×”×´×› ××™×¨×•×¢×™×: ${d.total.toLocaleString()}</strong>\n`);
      }

      if (d.breakdown && Object.keys(d.breakdown).length > 0) {
        lines.push("\n<strong>×¤×™×¨×•×˜ ×¢×‘×™×¨×•×ª:</strong>");
        const sorted = Object.entries(d.breakdown)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        for (const [k, v] of sorted) {
          lines.push(`â€¢ ${k}: ${v.toLocaleString()}`);
        }
      }

      showInfo(`${label}: ${entry.name}`, lines.join("\n"));
    }

    /* MAP */
    function initGovMap() {
      console.log("ğŸš€ Initializing map...");
      
      buildIndexes();

      try {
        govmap.createMap("map", {
          token: TOKEN,
          layers: [MUNICIPAL_LAYER, STATION_LAYER],
          layersMode: 1,
          background: 2,
          zoomButtons: true,
          identifyOnClick: false,
          onLoad: () => {
            console.log("âœ… Map loaded!");
            document.getElementById('loading').style.display = 'none';
            mapInitialized = true;
            govmap.onEvent(govmap.events.CLICK).progress(onMapClick);
            setMode("municipality");
          }
        });
      } catch (error) {
        console.error("âŒ Error:", error);
        document.getElementById('loading').innerHTML = "×©×’×™××”: " + error.message;
      }
    }

    function setMode(mode) {
      currentMode = mode;
      if (mode === "municipality") {
        govmap.setVisibleLayers([MUNICIPAL_LAYER], [STATION_LAYER]);
        showInfo("××¦×‘: ×¨×©×•×ª ××§×•××™×ª", "×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×”");
      } else {
        govmap.setVisibleLayers([STATION_LAYER], [MUNICIPAL_LAYER]);
        showInfo("××¦×‘: ×ª×—× ×ª ××©×˜×¨×”", "×œ×—×¥ ×¢×œ ×ª×—× ×” ×‘××¤×”");
      }
    }

    async function onMapClick(e) {
      if (!mapInitialized) return;

      const layer = currentMode === "municipality" ? MUNICIPAL_LAYER : STATION_LAYER;

      try {
        const resp = await govmap.getLayerData({
          LayerName: layer,
          Point: e.mapPoint,
          Radius: 300
        });

        const items = resp.data || resp.Data || [];
        if (!items.length) {
          showInfo("×œ× × ××¦×", currentMode === "municipality" ? "××™×Ÿ ×¨×©×•×ª ×‘××–×•×¨ ×–×”" : "××™×Ÿ ×ª×—× ×” ×‘××–×•×¨ ×–×”");
          return;
        }

        const attrs = items[0].Fields || items[0].Attributes || items[0];

        if (currentMode === "municipality") {
          const name = detectMunicipalityName(attrs);
          const key = normalizeMunicipalityKey(name);
          const entry = muniIndex[key];

          if (!entry) {
            const debugInfo = `
<div class="debug-info">
<strong>ğŸ” Debug Info:</strong><br><br>
<strong>Name from GovMap:</strong> ${name}<br>
<strong>Normalized key:</strong> ${key}<br><br>
<strong>All fields:</strong><br>
<pre>${JSON.stringify(fieldsToObject(attrs), null, 2)}</pre><br>
<strong>Sample keys in index:</strong><br>
${Object.keys(muniIndex).slice(0, 10).join(", ")}
</div>`;
            
            showInfo("âŒ ×œ× × ××¦××” ×”×ª×××”", debugInfo);
            return;
          }
          
          showEntry("×¨×©×•×ª", entry);
          
        } else {
          const name = detectStationName(attrs);
          const raw = (name ?? "").toString().trim();
          const key = normalizeUnitKey(raw);
          const hit = unitIndex[key];

          if (!hit) {
            const debugInfo = `
<div class="debug-info">
<strong>ğŸ” Debug Info:</strong><br><br>
<strong>Name from GovMap:</strong> ${raw}<br>
<strong>Normalized key:</strong> ${key}<br><br>
<strong>All fields:</strong><br>
<pre>${JSON.stringify(fieldsToObject(attrs), null, 2)}</pre><br>
<strong>Sample keys in index:</strong><br>
${Object.keys(unitIndex).slice(0, 15).join(", ")}
</div>`;
            
            showInfo("âŒ ×œ× × ××¦××” ×”×ª×××”", debugInfo);
            return;
          }

          if (Array.isArray(hit)) {
            showInfo("âš ï¸ ×›××” ×”×ª×××•×ª", `×©×: ${raw}\n\n` + hit.map(x => `- ${x.name}`).join("\n"));
            return;
          }

          showEntry("×ª×—× ×ª ××©×˜×¨×”", hit);
        }
        
      } catch (error) {
        console.error("Error:", error);
        showInfo("×©×’×™××”", error.message);
      }
    }

    window.addEventListener('load', function() {
      if (typeof govmap !== 'undefined') {
        console.log("âœ… All resources loaded");
        initGovMap();
      } else {
        console.error("âŒ govmap not loaded");
        document.getElementById('loading').innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×ª GovMap";
      }
    });
  </script>
</head>

<body>
  <div id="loading">×˜×•×¢×Ÿ ××¤×”...</div>
  <div id="map"></div>

  <div id="info-panel">
    <div id="mode-switch">
      <label>
        <input type="radio" name="mode" checked onclick="setMode('municipality')">
        ×œ×¤×™ ×¨×©×•×ª ××§×•××™×ª
      </label>
      <label>
        <input type="radio" name="mode" onclick="setMode('station')">
        ×œ×¤×™ ×ª×—× ×ª ××©×˜×¨×”
      </label>
    </div>

    <div id="info-title">××¤×ª ×¤×©×™×¢×”</div>
    <div id="info-body">×××ª×™×Ÿ ×œ×˜×¢×™× ×”...</div>
  </div>
</body>
</html>

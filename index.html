<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>מפת פשיעה לפי רשויות ותחנות משטרה</title>

  <!-- קודם קבצי הדאטה -->
  <script src="crimeDB.js"></script>
  <script src="policeDB.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      direction: rtl;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #info-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 8px;
      padding: 10px 14px;
      min-width: 290px;
      max-width: 380px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      font-size: 14px;
    }

    #info-title {
      font-weight: bold;
      margin-bottom: 4px;
      font-size: 15px;
    }

    #info-body {
      white-space: pre-line;
      line-height: 1.4;
      max-height: 55vh;
      overflow-y: auto;
      margin-top: 6px;
    }

    #mode-switch {
      margin-bottom: 4px;
      font-size: 13px;
    }

    #mode-switch label {
      margin-left: 8px;
      cursor: pointer;
    }
  </style>

  <script type="text/javascript">
    const MUNICIPAL_LAYER = "125"; // רשויות/ישובים
    const STATION_LAYER    = "24"; // שכבת תחנות משטרה
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    let mapInitialized = false;
    let currentMode = "municipality"; // 'municipality' | 'station'

    const crimeIndex   = {};
    const stationIndex = {};
    let detectedMunicipalityField = null;
    let detectedStationField = null;

    // -------- נירמול שמות --------
    function normalizeName(name) {
      let s = (name || "").toString().trim();

      // לרשויות – מסיר טקסט מיותר
      s = s
        .replace(/^מועצה\s+אזורית\s+/, "")
        .replace(/^מועצה\s+מקומית\s+/, "")
        .replace(/^עיריית\s+/, "")
        .replace(/^עיריה\s+/, "");

      s = s
        .replace(/["׳״']/g, "")
        .replace(/[\s\-]/g, "")
        .toLowerCase();

      return s;
    }

    // -------- בניית אינדקסים מה-DBים --------
    function buildIndexes() {
      if (typeof crimeDB === "undefined") {
        console.error("crimeDB לא מוגדר");
      } else {
        for (const key of Object.keys(crimeDB)) {
          const norm = normalizeName(key);
          crimeIndex[norm] = { name: key, data: crimeDB[key] };
        }
        console.log("crimeIndex built:", Object.keys(crimeIndex).length, "entries");
      }

      if (typeof policeDB === "undefined") {
        console.error("policeDB לא מוגדר");
      } else {
        for (const key of Object.keys(policeDB)) {
          const norm = normalizeName(key);
          stationIndex[norm] = { name: key, data: policeDB[key] };
        }
        console.log("stationIndex built:", Object.keys(stationIndex).length, "entries");
      }
    }

    // -------- חיפוש רשומה עבור רשות / תחנה --------
    function findCrimeEntry(index, name) {
      const norm = normalizeName(name);

      if (index[norm]) return index[norm];

      let best = null;
      for (const key in index) {
        if (key === norm) return index[key];
        if (!best && (key.endsWith(norm) || norm.endsWith(key))) {
          best = index[key];
        }
      }
      return best;
    }

    // -------- מפת ה-Fields (אם מגיע כ-array) --------
    function fieldsArrayToObject(arr) {
      if (!Array.isArray(arr)) return arr;
      const obj = {};
      for (const f of arr) {
        if (f && f.FieldName) obj[f.FieldName] = f.Value;
      }
      return obj;
    }

    // -------- יצירת המפה --------
    function initGovMap() {
      buildIndexes();

      function listener() {
        govmap
          .onEvent(govmap.events.CLICK)
          .progress(onMapClick);
      }

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, STATION_LAYER],
        background: 2,
        layersMode: 1,
        zoomButtons: true,
        showXY: true,
        identifyOnClick: false,
        onLoad: () => listener()
      });

      mapInitialized = true;
      console.log("GovMap ready (layers", MUNICIPAL_LAYER, ",", STATION_LAYER, ")");
    }

    // -------- קליק על המפה --------
    async function onMapClick(e) {
      if (!mapInitialized) return;

      const x = e.mapPoint.x;
      const y = e.mapPoint.y;

      const layerToQuery = (currentMode === "municipality") ? MUNICIPAL_LAYER : STATION_LAYER;

      const params = {
        LayerName: layerToQuery,
        Point: { x, y },
        Radius: 250
      };

      try {
        const resp = await govmap.getLayerData(params);
        console.log("getLayerData:", resp);

        const items =
          resp.data ||
          resp.Data ||
          resp.entities ||
          resp.Entities ||
          resp.features ||
          [];

        if (!items.length) {
          showInfo(
            currentMode === "municipality" ? "לא נמצאה רשות / ישוב" : "לא נמצאה תחנת משטרה",
            "אין ישות מתאימה בנקודה הזו או שהשכבה אינה פעילה."
          );
          return;
        }

        const feature = items[0];
        let attrs =
          feature.Attributes ||
          feature.attributes ||
          feature.fields ||
          feature.Fields ||
          feature;

        attrs = fieldsArrayToObject(attrs);
        console.log("feature attrs:", attrs);

        if (currentMode === "municipality") {
          handleMunicipalityClick(attrs);
        } else {
          handleStationClick(attrs);
        }

      } catch (err) {
        console.error("getLayerData error:", err);
        showInfo("שגיאה", err.message || String(err));
      }
    }

    // -------- טיפול בקליק מצב רשות --------
    function handleMunicipalityClick(attrs) {
      const muniName = detectMunicipalityName(attrs);
      if (!muniName) {
        showInfo("לא זוהה שם רשות", "לא נמצא שדה שמתאים לשם רשות מקומית.");
        return;
      }

      const entry = findCrimeEntry(crimeIndex, muniName);
      if (!entry) {
        showInfo(
          `רשות: ${muniName}`,
          "לא נמצאו נתוני פשיעה בקובץ crimeDB עבור רשות זו."
        );
        return;
      }

      showEntry("רשות מקומית", entry);
    }

    // -------- טיפול בקליק מצב תחנה --------
    function handleStationClick(attrs) {
      const stationName = detectStationName(attrs);
      if (!stationName) {
        showInfo("לא זוהה שם תחנה", "לא נמצא שדה שמתאים לשם תחנת משטרה.");
        return;
      }

      const entry = findCrimeEntry(stationIndex, stationName);
      if (!entry) {
        showInfo(
          `תחנה: ${stationName}`,
          "לא נמצאו נתוני פשיעה בקובץ policeDB עבור תחנה זו."
        );
        return;
      }

      showEntry("תחנת משטרה", entry);
    }

    // -------- זיהוי שם רשות --------
    function detectMunicipalityName(attrs) {
      if (!attrs) return null;

      if (detectedMunicipalityField && attrs[detectedMunicipalityField]) {
        return attrs[detectedMunicipalityField];
      }

      const CANDIDATE_FIELDS = [
        "ישוב סופי",
        "שם רשות",
        "שם רשות מקומית",
        "שם ישוב",
        "שם יישוב",
        "שם ישות"
      ];

      for (const field of CANDIDATE_FIELDS) {
        if (attrs[field] && typeof attrs[field] === "string") {
          detectedMunicipalityField = field;
          console.log("Municipality field:", field, "=>", attrs[field]);
          return attrs[field];
        }
      }

      for (const key of Object.keys(attrs)) {
        const val = attrs[key];
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          detectedMunicipalityField = key;
          console.log("Municipality field (fallback):", key, "=>", val);
          return val;
        }
      }

      return null;
    }

    // -------- זיהוי שם תחנה --------
    function detectStationName(attrs) {
      if (!attrs) return null;

      if (detectedStationField && attrs[detectedStationField]) {
        return attrs[detectedStationField];
      }

      const CANDIDATE_FIELDS = [
        "שם תחנה",
        "שם תחנת משטרה",
        "תחנת משטרה",
        "שם ישות"
      ];

      for (const field of CANDIDATE_FIELDS) {
        if (attrs[field] && typeof attrs[field] === "string") {
          detectedStationField = field;
          console.log("Station field:", field, "=>", attrs[field]);
          return attrs[field];
        }
      }

      for (const key of Object.keys(attrs)) {
        const val = attrs[key];
        if (typeof val === "string" && /[\u0590-\u05FF]/.test(val)) {
          detectedStationField = key;
          console.log("Station field (fallback):", key, "=>", val);
          return val;
        }
      }

      return null;
    }

    // -------- הצגת רשומה בפאנל --------
    function showEntry(label, entry) {
      const title = `${label}: ${entry.name}`;
      const data = entry.data;
      const lines = [];

      if (typeof data === "object" && data !== null) {
        if (typeof data.total !== "undefined") {
          lines.push(`סה"כ אירועים: ${data.total}`);
          lines.push("");
        }
        if (typeof data.breakdown === "object" && data.breakdown !== null) {
          lines.push("פירוט לפי קבוצת עבירה:\n");
          for (const k of Object.keys(data.breakdown)) {
            lines.push(`• ${k}: ${data.breakdown[k]}`);
          }
        }
      } else {
        lines.push(String(data));
      }

      showInfo(title, lines.join("\n"));
    }

    function showInfo(title, body) {
      document.getElementById("info-title").textContent = title;
      document.getElementById("info-body").textContent = body;
    }

    // -------- החלפת מצב רשות / תחנה --------
  function setMode(mode) {
  currentMode = mode;

  // מדליקים/מכבים שכבות בהתאם למצב
  // הערה: setVisibleLayers מקבל 2 מערכים: [להדליק], [לכבות]
  try {
    if (mode === "municipality") {
      govmap.setVisibleLayers([MUNICIPAL_LAYER], [STATION_LAYER]);
      showInfo("מצב תצוגה: רשות מקומית", "השכבה הפעילה: רשויות מקומיות. לחץ על רשות כדי לראות נתונים.");
    } else {
      govmap.setVisibleLayers([STATION_LAYER], [MUNICIPAL_LAYER]);
      showInfo("מצב תצוגה: תחנת משטרה", "השכבה הפעילה: תחנות משטרה. לחץ על תחנה כדי לראות נתונים.");
    }
  } catch (e) {
    console.warn("setVisibleLayers failed:", e);
  }
}

  </script>

  <!-- GOVMAP -->
  <script
    src="https://www.govmap.gov.il/govmap/api/govmap.api.js"
    defer
    onload="initGovMap()">
  </script>
</head>

<body>
  <div id="map"></div>

  <div id="info-panel">
    <div id="mode-switch">
      <label>
        <input type="radio" name="mode" value="municipality" checked
               onclick="setMode('municipality')">
        לפי רשות מקומית
      </label>
      <label>
        <input type="radio" name="mode" value="station"
               onclick="setMode('station')">
        לפי תחנת משטרה
      </label>
    </div>
    <div id="info-title">מפת פשיעה</div>
    <div id="info-body">
      בחר מצב תצוגה למעלה ואז לחץ על המפה.
    </div>
  </div>
</body>
</html>

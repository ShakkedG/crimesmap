<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¤×ª ×¤×©×™×¢×” â€“ ×œ×¤×™ ×©× ×” (2020â€“2025) | ×™×©×•×‘×™× / ××¨×—×‘×™×</title>

  <!-- DATA (Processed) -->
  <script src="crimeByYear_2020_2025.js"></script>
  <script src="crimeByYearMerhav.js"></script>
  <script src="PopulationDB.js"></script>

  <style>

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      overflow: hidden;
      background: #f5f5f5;
      font-size: 15px; /* â¬…ï¸ ×”×’×“×œ×ª ×‘×¡×™×¡ ×¤×•× ×˜ */
    }

    #map { width: 100%; height: 100%; position: relative; }

    /* hide ESRI widgets if appear */
    .esri-layer-list, .esri-legend { display: none !important; }

    /* PANEL */
    #info-panel {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: white;
      padding: 0;
      border-radius: 12px;
      width: 430px;
      max-height: calc(100vh - 30px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: height .2s ease, max-height .2s ease;
    }

    #panel-header {
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color: white;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.15);
      flex-shrink: 0;
    }
    #panel-header h1 { margin: 0; font-size: 17px; font-weight: 900; letter-spacing: -0.3px; }
    #panel-header p  { margin: 6px 0 0 0; font-size: 13px; opacity: 0.94; line-height: 1.35; font-weight: 800; }

    #header-actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .hbtn{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.15);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      gap:8px;
      align-items:center;
      user-select:none;
      font-size: 13px;
    }
    .hbtn:active{ transform: translateY(1px); }
    .hbtn.secondary{
      background: rgba(0,0,0,.12);
      border-color: rgba(255,255,255,.22);
    }

    #tabs {
      display: flex;
      gap: 0;
      background: #f3f3f3;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
    }
    .tab {
      flex: 1;
      padding: 11px 8px;
      text-align: center;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      color: #1f1f1f;
      user-select: none;
      white-space: nowrap;
    }
    .tab:hover { background: #f0f0f0; color: #333; }
    .tab.active { background: white; border-bottom-color: #0066cc; color: #0066cc; }

    #controls {
      padding: 12px 14px;
      background: #f3f3f3;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .mode-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    .mode-btn {
      padding: 11px 10px;
      border-radius: 10px;
      border: 2px solid #ddd;
      background: white;
      cursor: pointer;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      color: #111;
      transition: all 0.15s ease;
      user-select: none;
      text-align: center;
    }
    .mode-btn:hover { border-color: #0066cc; color: #0066cc; }
    .mode-btn.active {
      background: #0066cc;
      border-color: #0066cc;
      color: white;
      box-shadow: 0 2px 6px rgba(0,102,204,0.25);
    }
    .mode-btn.disabled {
      opacity: 0.55;
      cursor: not-allowed !important;
      border-color: #ddd !important;
      color: #666 !important;
      background: #fff !important;
      pointer-events: none;
    }
    .mode-btn.full { grid-column: 1 / -1; }

    #controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    #controls label {
      font-weight: 1000;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      color: #333;
      white-space: nowrap;
    }
    #yearSelect {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px; /* â¬…ï¸ ×”×’×“×œ */
      background: white;
      cursor: pointer;
      font-weight: 900;
    }

    #quick-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      border: 2px solid #cfcfcf;
    }
    .stat-value { font-size: 18px; font-weight: 1000; color: #0066cc; margin-bottom: 3px; }
    .stat-label { font-size: 13px; color: #222; font-weight: 1000; letter-spacing: .2px; } /* â¬…ï¸ ×”×’×“×œ */

    #info-content {
      padding: 14px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      background: white;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    #info-title {
      font-weight: 1000;
      font-size: 16px; /* â¬…ï¸ ×”×’×“×œ */
      margin-bottom: 12px;
      color: #222;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    #info-body { line-height: 1.6; color: #111; }

    .total-summary {
      font-size: 26px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      color: #0066cc;
      margin: 12px 0 10px 0;
      text-align: center;
      padding: 14px;
      background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%);
      border-radius: 12px;
      border: 2px solid #b3d9ff;
    }

    .sub-summary {
      margin-top: 0;
      margin-bottom: 12px;
      text-align: center;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      color: #444;
      font-weight: 900;
    }

    .crime-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .crime-item {
      background: #f3f3f3;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #cfcfcf;
      border-right: 4px solid #0066cc;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .crime-name {
      font-weight: 1000;
      color: #333;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      line-height: 1.35;
      min-height: 32px;
      display: flex;
      align-items: center;
    }
    .crime-count { font-weight: 1000; color: #0066cc; font-size: 17px; } /* â¬…ï¸ ×”×’×“×œ */

    .message {
      padding: 12px 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 13.5px; /* â¬…ï¸ ×”×’×“×œ */
      border-right: 4px solid;
      line-height: 1.55;
      font-weight: 800;
    }
    .message-info  { background: #e7f3ff; color: #004080; border-right-color: #0066cc; }
    .message-warn  { background: #fff7e6; color: #7a4a00; border-right-color: #ffb300; }
    .message-error { background: #fff0f0; color: #c00; border-right-color: #ff0000; }

    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 24px 28px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      text-align: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 14px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Compare UI */
    .compare-city-tag {
      background: #e7f3ff;
      color: #0066cc;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #b3d9ff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 1000;
    }
    .compare-city-tag button {
      border: none; background: none; color: #0066cc;
      cursor: pointer; font-size: 18px; line-height: 1;
      padding: 0; width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .compare-city-tag button:hover { background: #0066cc; color: white; }

    .add-compare-btn {
      width: 100%;
      padding: 12px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 1000;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .compare-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
    .compare-card {
      border: 2px solid #cfcfcf;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .compare-card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .compare-name {
      font-weight: 1000;
      color: #222;
      font-size: 14px;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .compare-badges { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .badge {
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      padding: 6px 10px;
      border-radius: 999px;
      border: 2px solid #cfcfcf;
      background: #f3f3f3;
      color: #333;
    }
    .badge-warn {
      border-color: #ffcc80;
      background: #fff7e6;
      color: #7a4a00;
    }
    .compare-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
    .kpi {
      border: 1px solid #eee;
      background: #f3f3f3;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
    }
    .kpi .kpi-value { font-weight: 1000; color: #0066cc; font-size: 14px; margin-bottom: 4px; } /* â¬…ï¸ ×”×’×“×œ */
    .kpi .kpi-label { font-size: 11px; font-weight: 1000; color: #1f1f1f; letter-spacing: .2px; } /* â¬…ï¸ ×”×’×“×œ */

    .compare-bars-title { margin-top: 12px; font-weight: 1000; font-size: 14px; color: #222; }
    .compare-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
      padding: 10px;
      background: #f3f3f3;
      border-radius: 12px;
      border: 2px solid #cfcfcf;
    }
    .compare-bar-name {
      width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 12.5px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      color: #333;
    }
    .compare-bar-container {
      flex: 1;
      height: 28px; /* â¬…ï¸ ×§×¦×ª ×™×•×ª×¨ ×’×‘×•×” */
      background: #f0f0f0;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    .compare-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066cc 0%, #0080ff 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 10px;
      font-size: 13px; /* â¬…ï¸ ×”×’×“×œ */
      font-weight: 1000;
      transition: width 0.35s ease;
      white-space: nowrap;
      min-width: 48px;
    }

    /* MODALS */
    .modal { display:none; position:fixed; inset:0; z-index:20000; }
    .modalOverlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }
    .modalCard {
      position:relative;
      width:min(760px, calc(100vw - 26px));
      max-height: calc(100vh - 26px);
      margin: 13px auto;
      background:#fff;
      border-radius:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHeader {
      padding:14px 16px;
      border-bottom:1px solid #e5e5e5;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
      color:#fff;
    }
    .modalHeaderTitle { font-weight:1000; font-size:15px; }
    .modalClose {
      border:none;
      background: rgba(255,255,255,.18);
      color:#fff;
      width:40px;
      height:40px;
      border-radius:12px;
      cursor:pointer;
      font-size:20px;
      font-weight:1000;
    }
    .modalBody { padding:16px; overflow:auto; }

    /* Search results list */
    #addrResults {
      border: 2px solid #cfcfcf;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      margin-top: 10px;
    }
    .addr-item {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 14px; /* â¬…ï¸ ×”×’×“×œ */
      border-bottom: 1px solid #f0f0f0;
      font-weight: 800;
    }
    .addr-item:last-child { border-bottom: none; }
    .addr-item:hover { background: #f5f9ff; }
    .addr-sub { font-size: 12.5px; color: #1f1f1f; margin-top: 3px; font-weight: 700; }

    /* Collapse behavior (desktop + mobile) */
    #info-panel.collapsed { max-height: 120px; height: 120px; }
    #info-panel.collapsed #tabs,
    #info-panel.collapsed #controls,
    #info-panel.collapsed #info-content { display:none; }

    /* Mobile bottom sheet */
    @media (max-width: 768px) {
      #info-panel{
        left: 0; right: 0; top: auto; bottom: 0;
        width: 100%;
        max-height: none;
        height: 62vh;
        border-radius: 18px 18px 0 0;
      }
      #info-panel.collapsed{ height: 120px; }
      #info-content{ padding: 12px; }
      .crime-grid { grid-template-columns: 1fr; }
      .compare-kpis { grid-template-columns: 1fr; }
      #tabs { overflow-x:auto; }
      #tabs .tab{ min-width: 95px; }
    }
  

    /* --- EXTRA CONTRAST & BIGGER SMALL TEXT (added) --- */
    #info-panel { border: 2px solid rgba(0,0,0,0.12); }
    .stat-value { font-size: 20px !important; font-weight: 1000 !important; }
    .stat-label { font-size: 12px !important; color: #111 !important; }
    .tab { font-size: 13px !important; color: #111 !important; }
    .crime-name { font-size: 13px !important; color: #111 !important; }
    .crime-count { font-size: 17px !important; }
    .message { font-size: 14px !important; }
    .mode-btn { border-width: 3px !important; font-size: 13px !important; }
    .mode-btn.active { box-shadow: 0 4px 14px rgba(0,102,204,0.35) !important; }
    .compare-name { font-size: 15px !important; color: #111 !important; }
    .kpi .kpi-label { font-size: 12px !important; color: #111 !important; }
    .kpi .kpi-value { font-size: 14px !important; }

    /* Make panel header text clearer */
    #panel-header p { font-size: 13px !important; opacity: 1 !important; }

    /* Stronger borders for cards */
    .stat-card, .crime-item, .compare-card, .kpi, .compare-bar { border-color: #bdbdbd !important; }

    /* Better focus for inputs */
    input:focus, select:focus, button:focus { outline: 3px solid rgba(0,102,204,0.35); outline-offset: 2px; }

  </style>

  <script>
    const MUNICIPAL_LAYER = "125";
    const POLICE_MERHAV_LAYER = "200550";
    const TOKEN = "ede9a5fd-7c23-432f-8ffb-d85feffa3f3c";

    // â¬…ï¸ ×©×™× ××ª ×”×§×•×‘×¥ ×”×–×” ×œ×™×“ index.html (××•×ª×” ×ª×™×§×™×™×”)
    const MUNI_BOUNDARIES_GEOJSON_URL = "muni_boundaries_ITM.geojson";

    let mapInitialized = false;
    let currentYear = "2025";
    let yearlyStats = {};
    let currentTab = "single";
    let currentMode = "muni";
    let currentMetric = "abs";

    let selectedCity = null;
    let selectedCityKey = null;
    let compareList = [];

    const muniIndex = {};
    const merhavIndex = {};
    const populationIndex = {};
    const variantsCache = new Map();

    let rankingMetric = "total";
    let rankingCrimeType = "";
    let rankingTopN = 10;

    let lastGeocodeReqId = 0;
    let lastAddrItems = [];
    let lastGeocodeQuery = "";
    let searchTimeout = null;

    let choroplethEnabled = false;
    const CHORO_NAME = "crime_rate_choropleth";

        // -------------------- Choropleth (GeoJSON boundaries) --------------------
    // NOTE:
    // 1) ×× ×—× ×• ×œ× ××©×ª××©×™× ×‘-govmap.getLayerEntities (××§×‘×œ ×œ×¤×¢××™× 500).
    // 2) ×× ×—× ×• ×˜×•×¢× ×™× GeoJSON ×©×œ ×’×‘×•×œ×•×ª (ITM / EPSG:2039) ×•××¦×™×™×¨×™× ××•×ª× ×¢× govmap.displayGeometries.
    // 3) ×—×™×™×‘ ×œ×”×¨×™×¥ ××ª ×”××ª×¨ ×“×¨×š ×©×¨×ª (GitHub Pages / localhost). file:// ×™×¤×™×œ fetch.

    function lerp(a,b,t){ return a + (b-a)*t; }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    // ×¦×‘×¢ "×—×–×§" (×§×•× ×˜×¨×¡×˜ ×’×‘×•×”): ×™×¨×•×§ ×‘×•×”×§ -> ××“×•× ×‘×•×”×§
    function rateToColor(rate, minR, maxR){
      const t = (maxR > minR) ? clamp01((rate - minR) / (maxR - minR)) : 0.5;
      const r = Math.round(lerp(0, 255, t));
      const g = Math.round(lerp(240, 0, t));
      const b = 0;
      return [r,g,b];
    }

    function safeCall(fn, ...args){
      try { return fn(...args); } 
      catch(e) { return null; }
    }

    function clearChoropleth(){
      // govmap ×ª×•××š ×’× ×‘-string ×•×’× ×‘××•×‘×™×™×§×˜, ××– × × ×¡×” ××ª ×©× ×™ ×”×¡×’× ×•× ×•×ª
      safeCall(govmap.clearGeometriesByName, CHORO_NAME);
      safeCall(govmap.clearGeometriesByName, { name: CHORO_NAME });
    }

    function setMunicipalLayerOpacity(opacity){
      if (typeof govmap.setLayerOpacity === "function") {
        try { govmap.setLayerOpacity({ layerName: MUNICIPAL_LAYER, opacity }); } catch(e){}
      }
    }

    // --- Geo helpers (GeoJSON -> WKT POLYGON / MULTIPOLYGON) ---
    function geomToWkt(geom){
      if(!geom) return null;
      const t = geom.type;
      const c = geom.coordinates;

      const ringToStr = (ring) => ring.map(pt => `${pt[0]} ${pt[1]}`).join(",");
      const polyToStr = (poly) => `(${poly.map(ring => `(${ringToStr(ring)})`).join(",")})`;

      if(t === "Polygon"){
        return `POLYGON${polyToStr(c)}`;
      }
      if(t === "MultiPolygon"){
        return `MULTIPOLYGON(${c.map(poly => polyToStr(poly)).join(",")})`;
      }
      return null;
    }

    // × ×¡×™×•×Ÿ "×—×›×" ×œ×”×•×¦×™× ×©× ×¨×©×•×ª ××ª×•×š properties (×›×™ ×‘×§×•×‘×¦×™ ×’×‘×•×œ×•×ª ×™×© ×©×“×•×ª ×©×•× ×™×)
    function getFeatNameFromProps(props){
      if(!props) return null;
      const candidates = [
        "SHEM_YISHUV","×©×_×™×©×•×‘","×©× ×™×™×©×•×‘","×©× ×™×©×•×‘",
        "SHEM_YISHUV_ENG","NAME","Name",
        "SHEM_MOATZA","×©×_×¨×©×•×ª","×©× ×¨×©×•×ª","×©× ×¨×©×•×ª ××§×•××™×ª","×©×_×¨×©×•×ª_××§×•××™×ª",
        "MUNICIPAL_NAME","MUNI_NAME"
      ];
      for(const k of candidates){
        if(props[k]) return String(props[k]).trim();
      }
      // ×× ××™×Ÿ ××¤×ª×— "××•×›×¨" â€“ × × ×¡×” ××ª ×”×¢×¨×š ×”×¨××©×•×Ÿ ×©× ×¨××” ×›××• ×˜×§×¡×˜
      for(const k of Object.keys(props)){
        const v = props[k];
        if(typeof v === "string" && v.trim().length >= 2) return v.trim();
      }
      return null;
    }

    async function loadMuniBoundariesGeoJSON(){
      if (muniGeojsonLoaded || muniGeojsonLoadError) return;

      try{
        const res = await fetch(MUNI_GEOJSON_URL, { cache: "no-store" });
        if(!res.ok) throw new Error(`fetch failed: ${res.status}`);
        const gj = await res.json();

        if(!gj || !Array.isArray(gj.features)){
          throw new Error("GeoJSON invalid: missing features[]");
        }

        muniFeatByKey.clear();

        for(const f of gj.features){
          const props = f.properties || {};
          const nm = getFeatNameFromProps(props);
          const wkt = geomToWkt(f.geometry);
          if(!nm || !wkt) continue;

          const key = normalizeKey(nm);
          if(!key) continue;

          // ×—×œ×§ ××”×’×‘×•×œ×•×ª ×—×•×–×¨×™× ×¢×œ ×¢×¦×× / ×™×© ×›×¤×™×œ×•×™×•×ª: × ×©××•×¨ ×¨××©×•×Ÿ
          if(!muniFeatByKey.has(key)){
            muniFeatByKey.set(key, { name: nm, wkt, props });
          }
        }

        muniGeojsonLoaded = true;
        console.log("âœ… Boundaries loaded:", muniFeatByKey.size);

      } catch(e){
        muniGeojsonLoadError = true;
        console.error("âŒ Failed loading muni GeoJSON:", e);
      }
    }

    function setChoroBtnUI(){
      const btn = document.getElementById("btnChoro");
      if (!btn) return;

      btn.classList.remove("disabled");
      btn.disabled = false;

      // ×× ××™×Ÿ ×’×‘×•×œ×•×ª â€“ × ×¦×™×’ ××¦×‘ ×˜×¢×™× ×”/×©×’×™××” ×•×œ× × ×©×‘×•×¨ ××ª ×”××¤×œ×™×§×¦×™×”
      if (!muniGeojsonLoaded) {
        btn.classList.toggle("active", false);
        btn.textContent = muniGeojsonLoadError
          ? "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×©×’×™××ª GeoJSON)"
          : "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×˜×•×¢×Ÿ ×’×‘×•×œ×•×ª...)";
        btn.title = muniGeojsonLoadError
          ? "×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª muni_boundaries_ITM.geojson. ×•×“× ×©×”×§×•×‘×¥ × ××¦× ×œ×™×“ index.html ×•×©×–×” ×¨×¥ ×“×¨×š ×©×¨×ª."
          : "×˜×•×¢×Ÿ ××ª ×§×•×‘×¥ ×”×’×‘×•×œ×•×ª muni_boundaries_ITM.geojson...";
        return;
      }

      btn.classList.toggle("active", !!choroplethEnabled);
      btn.textContent = choroplethEnabled ? "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000: ×¤×¢×™×œ" : "ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)";
      btn.title = "×¦×‘×™×¢×” ×œ×¤×™ ×¤×©×¢×™× ×œ-10,000 ×ª×•×©×‘×™× (××‘×•×¡×¡ ×’×‘×•×œ×•×ª GeoJSON)";
    }

    async function toggleChoropleth(force){
      // ×¦×‘×™×¢×” ×–××™× ×” ×¨×§ ×‘××¦×‘ ×¨×©×•×™×•×ª
      if (currentMode !== "muni") setMode("muni");

      await loadMuniBoundariesGeoJSON();
      setChoroBtnUI();

      if (!muniGeojsonLoaded) {
        showInfo(
          "×œ× × ×™×ª×Ÿ ×œ×¦×‘×•×¢",
          muniGeojsonLoadError
            ? "× ×›×©×œ ×œ×˜×¢×•×Ÿ ××ª ×§×•×‘×¥ ×”×’×‘×•×œ×•×ª muni_boundaries_ITM.geojson. ×•×“× ×©×”×•× × ××¦× ×œ×™×“ index.html ×•×©×–×” ×¨×¥ ×“×¨×š ×©×¨×ª (×œ× file://)."
            : "×˜×•×¢×Ÿ ×’×‘×•×œ×•×ªâ€¦ × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.",
          "error"
        );
        return;
      }

      choroplethEnabled = (typeof force === "boolean") ? force : !choroplethEnabled;
      setChoroBtnUI();

      if (!mapInitialized) return;

      if (!choroplethEnabled){
        clearChoropleth();
        setMunicipalLayerOpacity(100);
        showInfo("×¦×‘×™×¢×” ×›×•×‘×ª×”", "×—×–×¨×ª×™ ×œ×ª×¦×•×’×” ×¨×’×™×œ×”.", "info");
        return;
      }

      // ×‘×”×¤×¢×œ×ª ×¦×‘×™×¢×” â€“ ×¢×•×‘×¨×™× ×œ××“×“ ×œ-10,000 (×›×“×™ ×©×™×”×™×” ×¢×§×‘×™)
      currentMetric = "rate";
      const bAbs = document.getElementById("btnMetricAbs");
      const bRate = document.getElementById("btnMetricRate");
      if (bAbs) bAbs.classList.remove("active");
      if (bRate) bRate.classList.add("active");

      await renderChoropleth();
    }

    async function renderChoropleth(){
      if (!mapInitialized || !choroplethEnabled) return;
      if (currentMode !== "muni") return;

      const yearData = window.crimeByYear?.[currentYear];
      if (!yearData) {
        showInfo("×©×’×™××”", "××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×©× ×‘×—×¨×”.", "error");
        return;
      }

      // ×‘× ×™×™×ª ×¨×©×•××•×ª ×©×œ: ×©× -> rate + wkt
      const rows = [];
      for (const name in yearData) {
        const d = yearData[name];
        const total = Number(d?.total || 0);
        const pop = getPopulationForAuthority(name);
        const rate = calcRatePer10k(total, pop);
        if (rate == null) continue;

        // ×”×ª×××ª ×©× -> ×¤×™×¦'×¨ ××”-GeoJSON
        // ×™×© ×œ× ×• normalizeKey/nameVariants, ××– × × ×¡×” ×›××” ×•×¨×™××¦×™×•×ª ×›×“×™ ×œ×”×’×“×™×œ hit-rate
        let feat = null;
        const variants = nameVariants(name);
        for (const v of variants) {
          if (muniFeatByKey.has(v)) { feat = muniFeatByKey.get(v); break; }
        }
        if (!feat) {
          const k = normalizeKey(name);
          feat = muniFeatByKey.get(k);
        }
        if (!feat?.wkt) continue;

        rows.push({ name, total, pop, rate, wkt: feat.wkt });
      }

      if (!rows.length){
        showInfo("××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™×", "×œ× × ××¦××• ×¨×©×•×™×•×ª ×¢× ××•×›×œ×•×¡×™×™×” + ×’×‘×•×œ ×›×“×™ ×œ×—×©×‘ ×œ-10,000.", "warn");
        return;
      }

      const rates = rows.map(r => r.rate);
      const minR = Math.min(...rates);
      const maxR = Math.max(...rates);

      // govmap.displayGeometries ×¢×•×‘×“ ×”×›×™ ×™×¦×™×‘ ×¢× wkts + symbols + data
      const wkts = [];
      const names = [];
      const symbols = [];
      const tooltips = [];
      const headers = [];

      const bubbleHTML = `
        <div style="direction:rtl;font-family:Arial;padding:6px 4px;line-height:1.6;">
          <div style="font-weight:1000;font-size:16px;margin-bottom:6px;">{0}</div>
          <div style="font-size:14px;">×œ-10,000: <b style="font-size:16px;">{1}</b></div>
          <div style="font-size:13px;margin-top:4px;opacity:.95;">××•×›×œ×•×¡×™×™×” (2019): <b>{2}</b></div>
          <div style="font-size:13px;opacity:.95;">×¡×”"×› ××™×¨×•×¢×™×: <b>{3}</b></div>
        </div>
      `;

      for (const r of rows) {
        wkts.push(r.wkt);
        names.push(r.name);

        const [rr, gg, bb] = rateToColor(r.rate, minR, maxR);

        // NOTE: alpha ×’×‘×•×” ×œ-fill ×›×“×™ ×©×™×”×™×” "×§×•× ×˜×¨×¡×˜ ××©××¢×•×ª×™"
        const symbol = {
          type: "esriSFS",
          style: "esriSFSSolid",
          color: [rr, gg, bb, 200], // fill alpha (0-255)
          outline: { type: "esriSLS", style: "esriSLSSolid", color: [0, 0, 0, 220], width: 2 }
        };

        symbols.push(symbol);
        tooltips.push(`${r.name} â€¢ ${r.rate.toLocaleString()} /10k`);
        headers.push(r.name);
      }

      // NOTE: ×—×©×•×‘! govmap ××¦×¤×” ×©×”×©×“×•×ª ×™×”×™×• ×‘×ª×•×š data (×•×œ× top-level),
      // ××—×¨×ª × ×•×¦×¨×™× "cannot read property '0'".
      const drawPayload = {
        geometryType: (govmap.geometryType?.POLYGON ?? govmap.geometryType?.Polygon ?? 3),
        wkts,
        symbols,
        clearExisting: true,
        showBubble: true,
        data: {
          tooltips,
          headers,
          bubbleHTML,
          bubbleHTMLParameters: rows.map(r => [
            r.name,
            r.rate.toLocaleString(),
            Number(r.pop).toLocaleString(),
            Number(r.total).toLocaleString()
          ])
        }
      };

      try {
        clearChoropleth();

        const ret = govmap.displayGeometries(drawPayload);
        // govmap ×œ×¤×¢××™× ××—×–×™×¨ promise ×•×œ×¤×¢××™× jqDeferred â€“ × ×ª××•×“×“ ×¢× ×©× ×™×”×:
        if (ret && typeof ret.then === "function") await ret;
        else if (ret && typeof ret.done === "function") await new Promise((res, rej) => ret.done(res).fail(rej));

        // ×¨×§ ××—×¨×™ ×¦×™×•×¨ ××•×¦×œ×— â€“ × ×¡×ª×™×¨ ××ª ×©×›×‘×ª ×”×¨×©×•×™×•×ª ×”××§×•×¨×™×ª
        setMunicipalLayerOpacity(0);

        showInfo(
          "×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000",
          `×™×¨×•×§ = × ××•×š â€¢ ××“×•× = ×’×‘×•×”<br>×˜×•×•×—: <b>${minR.toLocaleString()}</b> ×¢×“ <b>${maxR.toLocaleString()}</b><br><span style="font-size:12px;opacity:.95;">×˜×™×¤: ×œ×—×¥ ×¢×œ ×¤×•×œ×™×’×•×Ÿ ×¦×‘×•×¢ ×›×“×™ ×œ×¨××•×ª bubble.</span>`,
          "info"
        );
      } catch (e) {
        console.error("âŒ displayGeometries failed:", e);
        // ×‘××§×¨×” ×©×œ ×›×©×œ â€“ × ×—×–×™×¨ ×©×›×‘×”
        setMunicipalLayerOpacity(100);
        showInfo("×©×’×™××”", "× ×›×©×œ×ª×™ ×œ×¦×‘×•×¢ ××ª ×”××¤×” (displayGeometries).", "error");
      }
    }

// -------------------- GovMap init --------------------
    function initGovMap() {
      if (!window.crimeByYear || typeof window.crimeByYear !== "object") {
        showInfo("×©×’×™××”", "×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×§×•×‘×¥ ×”× ×ª×•× ×™× crimeByYear_2020_2025.js", "error");
        const l = document.getElementById("loading");
        if (l) l.style.display = "none";
        return;
      }
      if (!window.crimeByYearMerhav) console.warn("âš ï¸ crimeByYearMerhav.js ×œ× × ×˜×¢×Ÿ");

      const popOk = buildPopulationIndex();
      if (!popOk) console.warn("âš ï¸ Population data missing -> rate view will be partially unavailable");

      updateMetricButtonsUI();

      const years = Object.keys(window.crimeByYear).sort();
      const sel = document.getElementById("yearSelect");
      if (!sel) return;
      sel.innerHTML = "";

      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        sel.appendChild(opt);
      });

      currentYear = years.includes("2025") ? "2025" : years[years.length - 1];
      sel.value = currentYear;

      buildMuniIndexForYear(currentYear);
      buildMerhavIndexForYear(currentYear);
      yearlyStats[currentYear] = calculateStats(currentYear);
      updateQuickStats();

      sel.addEventListener("change", e => {
        currentYear = e.target.value;

        buildMuniIndexForYear(currentYear);
        buildMerhavIndexForYear(currentYear);
        yearlyStats[currentYear] = calculateStats(currentYear);
        updateQuickStats();

        selectedCity = null;
        selectedCityKey = null;

        if (choroplethEnabled && currentMode === "muni") renderChoropleth();

        if (currentTab === "compare") updateCompareView();
        else if (currentTab === "trends") {
          const tc = document.getElementById("trends-content");
          if (tc) tc.innerHTML = `<div class="message message-info">×‘×—×¨ ${currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>`;
        } else if (currentTab === "rankings") renderRankings();
        else {
          showInfo(
            "××¤×” ×œ×¤×™ " + (currentMode === "muni" ? "×™×©×•×‘×™×/×¨×©×•×™×•×ª" : "××¨×—×‘×™×"),
            `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ${currentMode === "muni" ? "×¨×©×•×ª" : "××¨×—×‘"} ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`,
            "info"
          );
        }
      });

      govmap.createMap("map", {
        token: TOKEN,
        layers: [MUNICIPAL_LAYER, POLICE_MERHAV_LAYER],
        layersMode: 4,
        background: 3,
        zoomButtons: true,
        identifyOnClick: false,
        visibleLayers: [MUNICIPAL_LAYER],
        onLoad: () => {
          mapInitialized = true;


          // preload GeoJSON boundaries for choropleth
          loadMuniBoundariesGeoJSON().then(setChoroBtnUI);
          setMode(currentMode);
          setChoroBtnUI();

          try { govmap.onEvent(govmap.events.CLICK).progress(onMapClick); } catch (e) {}

          initModals();
          initAddressSearchUI();

          const toggleBtn = document.getElementById("panelToggleBtn");
          if (toggleBtn) toggleBtn.addEventListener("click", togglePanel);

          const l = document.getElementById("loading");
          if (l) l.style.display = "none";

          // ×œ× ×˜×•×¢× ×™× ×’×‘×•×œ×•×ª ×™×©×¨ â€” ×¨×§ ×›×©× ×œ×—×¥ ×¢×œ ×¦×‘×™×¢×” (×›×“×™ ×œ×”××™×¥ ×˜×¢×™× ×”).
          showInfo("××¤×” ×œ×¤×™ ×™×©×•×‘×™×/×¨×©×•×™×•×ª", `×©× ×” × ×‘×—×¨×ª: ${currentYear}<br>×œ×—×¥ ×¢×œ ×¨×©×•×ª ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™×`, "info");

          console.log("âœ… Map initialized successfully");
        }
      });
    }

    window.initGovMap = initGovMap;
    window.switchTab = switchTab;
    window.setMode = setMode;
    window.setMetric = setMetric;
    window.addToCompare = addToCompare;
    window.removeFromCompare = removeFromCompare;
    window.showTrends = showTrends;
    window.renderRankings = renderRankings;
    window.toggleChoropleth = toggleChoropleth;
  </script>

  <script src="https://www.govmap.gov.il/govmap/api/govmap.api.js" defer onload="initGovMap()"></script>
</head>

<body>
  <div id="loading">
    <div class="spinner"></div>
    <div style="font-size:14px;color:#333;font-weight:900;">×˜×•×¢×Ÿ ××¤×”...</div>
  </div>

  <div id="map"></div>

  <div id="info-panel">
    <div id="panel-header">
      <h1>ğŸ—ºï¸ ××¤×ª ×¤×©×™×¢×” ×‘×™×©×¨××œ</h1>
      <p>××¦×‘ × ×•×›×—×™: <strong>×™×©×•×‘×™×/×¨×©×•×™×•×ª</strong><br>×œ-10,000 ×–××™×Ÿ ×¨×§ ×›××Ÿ</p>

      <div id="header-actions">
        <button id="searchBtn" class="hbtn" aria-label="×—×™×¤×•×© ×›×ª×•×‘×ª">ğŸ” ×—×™×¤×•×© ×›×ª×•×‘×ª</button>
        <button id="aboutBtn" class="hbtn secondary" aria-label="××•×“×•×ª ×•××§×•×¨×•×ª">â„¹ï¸ ××•×“×•×ª + ××§×•×¨×•×ª</button>
        <button id="panelToggleBtn" class="hbtn secondary" aria-label="×”×§×˜×Ÿ ××• ×”×’×“×œ ×¤×× ×œ">â– ×”×§×˜×Ÿ</button>
      </div>
    </div>

    <div id="tabs" role="tablist">
      <div class="tab active" data-tab="single" onclick="switchTab('single')" role="tab" aria-selected="true">×ª×¦×•×’×”</div>
      <div class="tab" data-tab="compare" onclick="switchTab('compare')" role="tab" aria-selected="false">×”×©×•×•××”</div>
      <div class="tab" data-tab="trends" onclick="switchTab('trends')" role="tab" aria-selected="false">×”×™×¡×˜×•×¨×™×”</div>
      <div class="tab" data-tab="rankings" onclick="switchTab('rankings')" role="tab" aria-selected="false">×“×™×¨×•×’×™×</div>
    </div>

    <div id="controls">
      <div class="mode-grid">
        <button id="btnModeMuni" class="mode-btn active" onclick="setMode('muni')" aria-label="××¦×‘ ×™×©×•×‘×™× ×•×¨×©×•×™×•×ª">ğŸ˜ï¸ ×™×©×•×‘×™×/×¨×©×•×™×•×ª</button>
        <button id="btnModeMerhav" class="mode-btn" onclick="setMode('merhav')" aria-label="××¦×‘ ××¨×—×‘×™× ××©×˜×¨×ª×™×™×">ğŸš” ××¨×—×‘×™×</button>

        <button id="btnMetricAbs" class="mode-btn active" onclick="setMetric('abs')" aria-label="×ª×¦×•×’×ª ×›××•×ª">ğŸ”¢ ×›××•×ª</button>
        <button id="btnMetricRate" class="mode-btn" aria-label="×ª×¦×•×’×ª ×œ-10,000 ×ª×•×©×‘×™×">ğŸ‘¥ ×œ-10,000</button>

        <button id="btnChoro" class="mode-btn full" onclick="toggleChoropleth()" aria-label="×¦×‘×™×¢×” ×œ×¤×™ ×œ-10,000">
          ğŸ¨ ×¦×‘×™×¢×” ×œ-10,000 (×™×¨×•×§â†’××“×•×)
        </button>
      </div>

      <div id="controls-row">
        <label for="yearSelect">×©× ×”:</label>
        <select id="yearSelect" aria-label="×‘×—×™×¨×ª ×©× ×”"></select>
      </div>

      <div id="quick-stats" role="region" aria-label="×¡×˜×˜×™×¡×˜×™×§×•×ª ××”×™×¨×•×ª">
        <div class="stat-card">
          <div class="stat-value" id="stat-municipalities">-</div>
          <div class="stat-label">×¨×©×•×™×•×ª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">×¡×”"×› ××™×¨×•×¢×™×</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg">-</div>
          <div class="stat-label">×××•×¦×¢</div>
        </div>
      </div>
    </div>

    <div id="info-content">
      <div class="tab-content active" id="tab-single" role="tabpanel">
        <div id="info-title">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        <div id="info-body"></div>
      </div>

      <div class="tab-content" id="tab-compare" role="tabpanel">
        <div id="compare-content">
          <div class="message message-info">×‘×—×¨ ×™×©×•×‘×™×/×¨×©×•×™×•×ª ××• ××¨×—×‘×™× ×‘××¤×” ×•×”×•×¡×£ ×œ×”×©×•×•××”</div>
        </div>
      </div>

      <div class="tab-content" id="tab-trends" role="tabpanel">
        <div id="trends-content">
          <div class="message message-info">×‘×—×¨ ×¨×©×•×ª/××¨×—×‘ ×‘××¤×” ×›×“×™ ×œ×¨××•×ª × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™×</div>
        </div>
      </div>

      <div class="tab-content" id="tab-rankings" role="tabpanel">
        <div id="rankings-content">
          <div class="message message-info">×‘×—×¨ ×©× ×” ×•××¦×‘ ×•××– ×›× ×¡ ×œ×“×™×¨×•×’×™× ×›×“×™ ×œ×¨××•×ª Top 5/10/20.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal" aria-hidden="true">
    <div id="aboutOverlay" class="modalOverlay" aria-hidden="true"></div>
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="××•×“×•×ª ×•××§×•×¨×•×ª">
      <div class="modalHeader">
        <div class="modalHeaderTitle">â„¹ï¸ ××•×“×•×ª + ××§×•×¨×•×ª</div>
        <button id="aboutCloseBtn" class="modalClose" aria-label="×¡×’×•×¨">Ã—</button>
      </div>
      <div class="modalBody">
        <div class="message message-info" style="margin-bottom:12px;">
          ×”××ª×¨ ××¦×™×’ × ×ª×•× ×™ ×¤×©×™×¢×” ×œ×¤×™ ×©× ×” (2020â€“2025) ×‘×©×ª×™ ×ª×¦×•×’×•×ª: <strong>×™×©×•×‘×™×/×¨×©×•×™×•×ª</strong> ×•Ö¾<strong>××¨×—×‘×™×</strong>.
          ×‘××¦×‘ ×™×©×•×‘×™× × ×™×ª×Ÿ ×’× ×œ×”×¦×™×’ <strong>×œÖ¾10,000</strong> ×œ×¤×™ ××•×›×œ×•×¡×™×™×” (×§×•×‘×¥ PopulationDB.js).
        </div>

        <div class="message message-warn" style="margin-top:12px;">
          ×”×¦×‘×™×¢×” ××‘×•×¡×¡×ª ×¢×œ ×§×•×‘×¥ ×’×‘×•×œ×•×ª: <code>muni_boundaries_ITM.geojson</code> (×—×™×™×‘ ×œ×”×™×•×ª ×œ×™×“ index.html).<br>
          ×× ××™×Ÿ ×¦×‘×™×¢×” â€“ ×œ×¨×•×‘ ×–×• ×‘×¢×™×™×ª ×”×ª×××ª ×©××•×ª ××• ×©×”×§×•×‘×¥ ×œ× × ×˜×¢×Ÿ.
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="searchModal" class="modal" aria-hidden="true">
    <div id="searchOverlay" class="modalOverlay" aria-hidden="true"></div>
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="×—×™×¤×•×© ×›×ª×•×‘×ª">
      <div class="modalHeader">
        <div class="modalHeaderTitle">ğŸ” ×—×™×¤×•×© ×›×ª×•×‘×ª</div>
        <button id="searchCloseBtn" class="modalClose" aria-label="×¡×’×•×¨">Ã—</button>
      </div>
      <div class="modalBody">
        <div style="display:flex; gap:10px; align-items:center;">
          <input
            id="addrInput"
            type="text"
            placeholder="×œ×“×•×’××”: ×¢×™× ×ª / ×ª×œ ××‘×™×‘ / ×¨×—×•×‘ + ××¡×¤×¨"
            style="flex:1; padding:12px 12px; border-radius:12px; border:1px solid #ddd; font-size:14px; font-weight:800;"
            aria-label="×”×§×œ×“ ×›×ª×•×‘×ª ×œ×—×™×¤×•×©"
          />
          <button
            id="addrBtn"
            style="padding:12px 14px; border-radius:12px; border:none; background:#0066cc; color:#fff; font-weight:1000; cursor:pointer;"
            aria-label="×—×¤×©"
          >×—×¤×©</button>
        </div>

        <div id="addrResults" aria-label="×ª×•×¦××•×ª ×—×™×¤×•×© ×›×ª×•×‘×ª"></div>

        <div class="message message-info" style="margin-top:12px;">
          ×˜×™×¤: ××¤×©×¨ ×¤×©×•×˜ ×œ×”×§×œ×™×“ ×©× ×™×™×©×•×‘ (×œ××©×œ <strong>×¢×™× ×ª</strong>) â€” ×”×ª×•×¦××•×ª ×™×•×¦×’×• ×¢× ×©× ×‘×¨×•×¨.
        </div>
      </div>
    </div>
  </div>

</body>
</html>
